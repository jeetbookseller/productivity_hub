<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="theme-color" content="#7CB69D" id="theme-color-meta">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Productivity Hub">
  <meta name="application-name" content="Productivity Hub">
  <meta name="description" content="Focus timer, tasks, checklists & quick notes - all in one place">
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAACXBIWXMAAAsTAAALEwEAmpwYAAAGZ0lEQVR4nO3dT4hVdRzG8e+dO+NkOo6aWmkilgUVFBGRCxctItoEQUSbFi1atGkRQS0iWrRpE0EQQbRoEUG0aBFBEBEEQZBFhZGCWVZqjqPO/Ln3dBZxB8aZO3fOved3f7/f+31ecGHR4r7znPN9zjn3d+85A0mSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJElSA3QWuwN/AfuBfcCNwNXAGuB8YBVwDnAWsAI4Cziz/+fl/v/mvwH/9P+3/gD+BP4Afge+B74Evuo//gdwtsCvU5Xa0FcBW4FbgeuAy5v+/3gS+KL/+Bj4CPhogf8vqa429BZgJ3A7cMFi/8M/Af8Cfz/y+RP4rf/nlf5v/rOAs/u/9acvfr/nOuA64Mz+r+GU/h/xw/0PAY8Bry/+V6gytaG3AvcBdwBr+389fRV9/NRz/F/9k0APOL3/T//X8/8f8P0TwJfAMeBt4E3gVOG/DjWkpt6HXt7/zb0C2NZ/bAfO6z+k+p0ADgMHgZeAr0N+XRpTLQ29AtgM3ATcCGwEVob8etSk74H9wEHgPeCPkF+PhlBDQ58GrAe2AFv7fw7/5aipfgdeBZ4D3gn5dakltTb05cD1wA7gZmBtyK9HbfoZ2Ac8D3wa8utRi2pq6POAq4E7gTuBNSG/HpXqGPAi8AzwScivp9FqaOgLgXuAu4BNIb8eVeFj4GngOeBEyK+ngWpo6DOAa4AHgOtDfj2qzVHgEeAp4O+QX09DVN3QlwJ7gHuBc0N+ParbQWAPcCjk11O5qhv6LeC6kF+LmuUocD/wUsivpWLVNrQ0od8kvVOoqqE/Au4HPgj5tUnPAXuB4yG/lkpU1dCbgF3AXf3/kfSjpHPrA5QfGFc19GrgUeAh4IyQX4/0v/4C9gFPhvxaqldNQy8D7qZ0s+sqrJZ9DDwCvBDyaylWNQ19PfAEcEnIr0Ua3iHgYeCNkF9LVdY3fMD3Ag8CDwJrGj6O1LYNwB5gI3Ac+Kzh41RhVQPnvhF4B3g79EnbUqVuA94GPgBubvg8Vdja4LkvBfYDu4FVi/0Bklq3CtgNHKB0xtcNnqfztjV07tuAlym9E0jS//YAL1K66d42aK7OW9vAec8BHgO2hzxhaQwfAQ8Bx8ZdQ+e91/A5NwGvATtCnqg0vp3AQUo3LY6zkE6Z+sIGzrkSeIJyWb0y5ElK+S4F3qR003mjLqDTpmro84HHKZfhU0KeoDSeZZRO+gTYQOmqUR2+us6zGdgN3EbpLkmqX+dGYAOlqz4edbHO2zjmOacuq78Fnqf/3mmpcZcC+4A3gLVjrKNz62Kd0qEeFt0OvA9sowwvSq24jdJZm8ZYQ+dOSue1ZuqDm5dRxlO3hBxQasobwDPAl0OuoXNbi+cpE8I24MqQA0qt2kg5TtgCfDjkGjofD/tJP6F0Tb0v5EBSe/YBz1K67l/Kz/vipv75Z+CR/s/7QQ4iteNbytDCfUNsu/OXSQXtWOwAXcrlgaT2+atUKkhDS0FqaejZ0AclldlQ+sVP/VfRlcDbwOaQJ1y/DnAbpXvGPbWWAzuATSEvBM22doy1dG7r6OucdcD1IU+4ThcCW4HL5nx+M+X9g1K2LSGvBc0yzf/WR1lH5y+jrqEP0fB7oKt3Epjl//+/nwJOhTxhqR0nKN3yL+V/K8+E/LzPhvz+1HuAk//53P85o1NaNnPSaJ31X8rPtXbWvyjjVw8sss0h4HZg/ZTnrN1q4A5gT//POxbbqPPjSef8HHgauG2RTR+k3K962pTnrN065vyyZjm/rPnXsI/SZXuHWM+GKc9VuxvoQOe1kNfTJOln/5TnkjQJ/zZBKkhDS0FqaegPI58AKU2F/yIvFaShpSC1NPTbIQeUyqyi9P0oa+n8YdRN/wM+pEySbwk5sNS8TZTum6N01+cjrKXz12E/8ZeUubzngx5Aat4G4FVK570y5BrqWMqo+0eh/2ik9mwF9lO6b+qDm19SJnq3hRxQatYm4BVK98399WCU9XR+HXWxTul0XQq8ROkoP0Wk5lxK6brXKV034gHOWP/xFnAz8EVH0rBWU7rsd0o3jWPsv1y/hDLYdGfIk5XGsBN4ndJFt4+xjs5GSteMZZqhhnspI+8enagmW0kZWD9I6Z5phlGmfg/0WS2cc+og09vAwZAnLo3uduAtShfNbrMHhxpG+c85p0aN3gMeoNx7eFbLx5IGcRawm9I5B5o68Xw6P0w67+rFFtHp/O+qqZL+aXfFXf/O/Ofc+Z9/t93TzyljhweBn0KelPT/VlMG0TdSumaaPfk/0ww1/Bt1ZsgfSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZJUp/8AxH1zEXbRSeoAAAAASUVORK5CYII=">
  <link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFEklEQVR4nO3dT4hVdRzG8e+dO+NkOo6aWmkilgUVFBGRCxctItoEQUSbFi1atGkRQS0iWrRpE0EQQbRoEUG0aBFBEBEEQZBFhZGCWVZqjqPO/Ln3dBZxB8aZO3fOved3f7/f+31ecGHR4r7znPN9zjn3d+85A0mSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEkta8V+A0PABmAzsBZYC1wEXABcCJwDnA2cBZwJnAGc3v/f/A/wT/9/6w/gD+BP4Hfge+BL4Kv+n38ArT78WhVQ0wdgFXANcCNwPXAFsKrhf+Np4PP+YxT4CPho/v+XCqTpA7AauAPYBdwMrE/9Bk4C/wJ///v4E/it/+fl/r/5zwTOBs7p//b/9Hn/+34V3QgcBp4GXkn9JpWoOswP5i16PjDQ/+v+i99/Onj812dKQWtqKvoA7ADuB24HLkr9JqQ0x4Eh4FngncTvRRmV/QNwVv+39wrg5v5jG7A88XtSGr8Bh4DDwMvA16nfjPJV1g/AcmAzsAO4CdgMrEj8npTOL8BB4ADwLvBP4vejjJXxA3AasAG4Ebil/+dE75WpfQE8DzwPfJL4vZRaWQdgBXA1cCdwJ3BR4vej8voZeAl4BvgsaS+lVcYBOB/YCtwF3JD4vajcPgaeAp4DTiTtpqTKNgDrgVuBe4GtiXtRNRwFngSeAv5K2kyJlG0A3gGuS9yDquswsBf4IGkfJVDGAZDa9helO71HEveRWFkHQOrar5TuxJY+ANIAH6b+AoytBwPPAI+mb6ccVnfwazcDu4G7ga0I/QL8BOwHnknfSjms7PBAN1G6a7sHODd9O+W0Bvh3+WL/g94F3EtBg9rE/URpPOtQ+lbKYU0Hg3k5cD/wILAufTvl9T7wMKVfMJRd0wPwNqXR/cfjl6LK2AE8QemewMqo6QF4Adiaupcy+5LSbxg+nL6Vcmh6AN4H3k3dQ3ntBN6g9Jdhy6npARgCHgP+Tt1Lae0CnqH0F2VLqekBOEJpNG+kbqacbgbeAkYpjWyV0PQAjFAa3d9M3Uv57AS+BW5N3UiZND0AR4D7gHdT91IeDwAvUrpTXHJND8BPlMb0bkj8PsqhBewFDgHXJu6lFJoegH/6/d0F/Ji6l+QuAg5TekxGa+qGEgzA5v5/8P7EfaS2kdJT5LtS95Fa0wPwC6UxvT91H2ltAA4A9wGrU/eSSgqPQrgNeBW4Kn0rSWyk9D7HAng29G/cL1D6m5+dqRtJYQ3wKKXxrG2Jeymdqf0MvJu6iUbdArxG6S5xZXR96h5S+43Sk/L3A2el7qUF6yj9EucIpcdlVEbTlxz/Wg8c/t/XdgI7gO2U/lp0ZbQJeK7/53NKT9hXRke7+NptwI2ULndPSd1MizhC6S6xHo+pfgD+s57S5e92Spe96yntQel9BxwAPgS+6ed9gH84fPHPQXgQmP/S/GfyvxQa9dTF12b7H+j5/49fmv98/n+e/5x/fv7f4+8yv7b4+lz/g/n/r5/75+n/+/Vz/fuf//z8v1fO/5vr1xc/n//18/35v7n4Wjn/OtcsSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkqY7+A2TM4xxUNzJDAAAAAElFTkSuQmCC">
  <link rel="manifest" id="manifest-placeholder" href="manifest.json">
  <title>Productivity Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:'class',theme:{extend:{fontFamily:{nunito:['Nunito','sans-serif']},colors:{cream:{50:'#FDFCFA',100:'#F7F5F0',200:'#EDE9E0'},sage:{100:'#E8F0EA',200:'#C5D9CA',300:'#9DC4A8',400:'#7CB69D',500:'#5A9E78'},terracotta:{100:'#FCEEE9',200:'#F5C9BA',300:'#E9A088',400:'#E07A5F',500:'#C45D42'},sand:{100:'#F5F0E6',200:'#E8DFD0',300:'#D4C5AD'},ocean:{100:'#E6F2F7',200:'#B8D9E8',300:'#83B5D1',400:'#5A9BBF'},lavender:{100:'#F0EDF5',200:'#D5CCE6',300:'#B8A9D4',400:'#9B8AA6'},bark:{300:'#9A8B7A',400:'#7A6B5A',500:'#5C4F43',600:'#3D352D',700:'#2D2720'}}}}}</script>
  <style>
    *{-webkit-tap-highlight-color:transparent;font-family:'Nunito',sans-serif}
    html,body{width:100%;overflow-x:hidden;-webkit-text-size-adjust:100%;text-size-adjust:100%}
    body{margin:0;overscroll-behavior:none;background:linear-gradient(180deg,#F7F5F0 0%,#EDE9E0 100%);min-height:100vh}
    #root{width:100%;overflow-x:hidden}
    .dark body{background:linear-gradient(180deg,#2D2720 0%,#1F1B17 100%)}
    .hide-sb::-webkit-scrollbar{display:none}.hide-sb{-ms-overflow-style:none;scrollbar-width:none}
    .glass{background:rgba(255,255,255,0.85);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border:1px solid rgba(255,255,255,0.6)}
    .dark .glass{background:rgba(45,39,32,0.9);border:1px solid rgba(255,255,255,0.15)}
    .gcard{background:rgba(255,255,255,0.75);backdrop-filter:blur(8px);box-shadow:0 8px 32px rgba(92,79,67,0.08),0 2px 8px rgba(92,79,67,0.04);border:1px solid rgba(255,255,255,0.6)}
    .dark .gcard{background:rgba(45,39,32,0.7);box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1)}
    .soft-shadow{box-shadow:0 4px 20px rgba(92,79,67,0.1),0 2px 8px rgba(92,79,67,0.05)}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
    .anim-float{animation:float 3s ease-in-out infinite}
    .anim-in{animation:fadeIn 0.3s ease-out}
    .sel{-webkit-user-select:text;user-select:text}
    @media(min-width:768px){
      /* ===== TABLET MODE (768px+) ===== */
      /* Todo quadrant grid */
      .md-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
      
      /* Base font bump */
      body{font-size:1.0625rem;line-height:1.7}
      
      /* Remove all truncation on desktop */
      .truncate{overflow:visible!important;text-overflow:unset!important;white-space:normal!important}
      
      /* Inputs: larger text */
      input[type="text"],input[type="date"],input[type="time"],input[type="number"],textarea{
        padding:0.625rem 0.875rem;font-size:0.9375rem;border-radius:0.75rem
      }
      
      /* Modals: wider */
      .modal-content{max-width:32rem}
      
      /* Toast: centered wider */
      .toast-wrap{max-width:28rem;margin:0 auto}
      
      /* Timer: larger display */
      .timer-display{font-size:4.5rem;letter-spacing:0.05em}
      
      /* Scrollbar for desktop */
      ::-webkit-scrollbar{width:6px;height:6px}
      ::-webkit-scrollbar-track{background:transparent}
      ::-webkit-scrollbar-thumb{background:rgba(122,107,90,0.2);border-radius:3px}
      ::-webkit-scrollbar-thumb:hover{background:rgba(122,107,90,0.4)}
      .dark ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.15)}
      .dark ::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.3)}
      
      /* Tab bar: more spacious */
      .tab-bar-inner button{padding:0.75rem 0}
      .tab-bar-inner span{font-size:0.8125rem}
      
      /* More tab sub-buttons: larger */
      .more-sub-btn{padding:0.625rem 1.25rem;font-size:0.9375rem}
      
      /* Help content: larger text */
      .help-section p,.help-section li{font-size:0.9375rem}
    }
    
    @media(min-width:1280px){
      /* ===== WIDE DESKTOP MODE (1280px+) ===== */
      /* Confirm multi-column grid */
      .confirm-grid{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem}
      
      /* Compact item rows â€” no oversized blocks */
      .gcard{padding:0.75rem 1rem}
      
      /* Sticky headers: no top offset needed (no fixed header in wide mode) */
      .sticky-section-header{position:sticky;top:0;z-index:10}
      
      /* Capture wide input area */
      .capture-input{max-width:48rem}
      
      /* Compact timer for side-by-side Focus layout */
      .timer-display{font-size:3.5rem;letter-spacing:0.03em}
    }

    @media(max-width:420px){
      .timer-display{font-size:3.75rem}
    }
  </style>
</head>
<body class="bg-cream-100 dark:bg-bark-700">
<script>
// === PWA Setup (v10.1) ===
// Note: Full PWA install requires HTTPS hosting with separate manifest.json + sw.js files.
// The blob-based approach below provides best-effort support for local/file:// use.
// Use "More â†’ Install" to generate proper PWA files for HTTPS deployment.

const PWA_ICON_192 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFEklEQVR4nO3dT4hVdRzG8e+dO+NkOo6aWmkilgUVFBGRCxctItoEQUSbFi1atGkRQS0iWrRpE0EQQbRoEUG0aBFBEBEEQZBFhZGCWVZqjqPO/Ln3dBZxB8aZO3fOved3f7/f+31ecGHR4r7znPN9zjn3d+85A0mSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEkta8V+A0PABmAzsBZYC1wEXABcCJwDnA2cBZwJnAGc3v/f/A/wT/9/6w/gD+BP4Hfge+BL4Kv+n38ArT78WhVQ0wdgFXANcCNwPXAFsKrhf+Np4PP+YxT4CPho/v+XCqTpA7AauAPYBdwMrE/9Bk4C/wJ///v4E/it/+fl/r/5zwTOBs7p//b/9Hn/+34V3QgcBp4GXkn9JpWoOswP5i16PjDQ/+v+i99/Onj812dKQWtqKvoA7ADuB24HLkr9JqQ0x4Eh4FngncTvRRmV/QNwVv+39wrg5v5jG7A88XtSGr8Bh4DDwMvA16nfjPJV1g/AcmAzsAO4CdgMrEj8npTOL8BB4ADwLvBP4vejjJXxA3AasAG4Ebil/+dE75WpfQE8DzwPfJL4vZRaWQdgBXA1cCdwJ3BR4vej8voZeAl4BvgsaS+lVcYBOB/YCtwF3JD4vajcPgaeAp4DTiTtpqTKNgDrgVuBe4GtiXtRNRwFngSeAv5K2kyJlG0A3gGuS9yDquswsBf4IGkfJVDGAZDa9helO71HEveRWFkHQOrar5TuxJY+ANIAH6b+AoytBwPPAI+mb6ccVnfwazcDu4G7ga0I/QL8BOwHnknfSjms7PBAN1G6a7sHODd9O+W0Bvh3+WL/g94F3EtBg9rE/URpPOtQ+lbKYU0Hg3k5cD/wILAufTvl9T7wMKVfMJRd0wPwNqXR/cfjl6LK2AE8QemewMqo6QF4Adiaupcy+5LSbxg+nL6Vcmh6AN4H3k3dQ3ntBN6g9Jdhy6npARgCHgP+Tt1Lae0CnqH0F2VLqekBOEJpNG+kbqacbgbeAkYpjWyV0PQAjFAa3d9M3Uv57AS+BW5N3UiZND0AR4D7gHdT91IeDwAvUrpTXHJND8BPlMb0bkj8PsqhBewFDgHXJu6lFJoegH/6/d0F/Ji6l+QuAg5TekxGa+qGEgzA5v5/8P7EfaS2kdJT5LtS95Ja0wPwC6UxvT91H2ltAA4A9wGrU/eSSgqPQrgNeBW4Kn0rSWyk9D7HAng29G/cL1D6m5+dqRtJYQ3wKKXxrG2Jeymdqf0MvJu6iUbdArxG6S5xZXR96h5S+43Sk/L3A2el7qUF6yj9EucIpcdlVEbTlxz/Wg8c/t/XdgI7gO2U/lp0ZbQJeK7/53NKT9hXRke7+NptwI2ULndPSd1MizhC6S6xHo+pfgD+s57S5e92Spe96yntQel9BxwAPgS+6ed9gH84fPHPQXgQmP/S/GfyvxQa9dTF12b7H+j5/49fmv98/n+e/5x/fv7f4+8yv7b4+lz/g/n/r5/75+n/+/Vz/fuf//z8v1fO/5vr1xc/n//18/35v7n4Wjn/OtcsSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkqY7+A2TM4xxUNzJDAAAAAElFTkSuQmCC";
const PWA_ICON_180 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAACXBIWXMAAAsTAAALEwEAmpwYAAAGZ0lEQVR4nO3dT4hVdRzG8e+dO+NkOo6aWmkilgUVFBGRCxctItoEQUSbFi1atGkRQS0iWrRpE0EQQbRoEUG0aBFBEBEEQZBFhZGCWVZqjqPO/Ln3dBZxB8aZO3fOved3f7/f+31ecGHR4r7znPN9zjn3d+85A0mSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJElSA3QWuwN/AfuBfcCNwNXAGuB8YBVwDnAWsAI4Cziz/+fl/v/mvwH/9P+3/gD+BP4Afge+B74Evuo//gdwtsCvU5Xa0FcBW4FbgeuAy5v+/3gS+KL/+Bj4CPhogf8vqa429BZgJ3A7cMFi/8M/Af8Cfz/y+RP4rf/nlf5v/rOAs/u/9acvfr/nOuA64Mz+r+GU/h/xw/0PAY8Bry/+V6gytaG3AvcBdwBr+389fRV9/NRz/F/9k0APOL3/T//X8/8f8P0TwJfAMeBt4E3gVOG/DjWkpt6HXt7/zb0C2NZ/bAfO6z+k+p0ADgMHgZeAr0N+XRpTLQ29AtgM3ATcCGwEVob8etSk74H9wEHgPeCPkF+PhlBDQ58GrAe2AFv7fw7/5aipfgdeBZ4D3gn5dakltTb05cD1wA7gZmBtyK9HbfoZ2Ac8D3wa8utRi2pq6POAq4E7gTuBNSG/HpXqGPAi8AzwScivp9FqaOgLgXuAu4BNIb8eVeFj4GngOeBEyK+ngWpo6DOAa4AHgOtDfj2qzVHgEeAp4O+QX09DVN3QlwJ7gHuBc0N+ParbQWAPcCjk11O5qhv6LeC6kF+LmuUocD/wUsivpWLVNrQ0od8kvVOoqqE/Au4HPgj5tUnPAXuB4yG/lkpU1dCbgF3AXf3/kfSjpHPrA5QfGFc19GrgUeAh4IyQX4/0v/4C9gFPhvxaqldNQy8D7qZ0s+sqrJZ9DDwCvBDyaylWNQ19PfAEcEnIr0Ua3iHgYeCNkF9LVdY3fMD3Ag8CDwJrGj6O1LYNwB5gI3Ac+Kzh41RhVQPnvhF4B3g79EnbUqVuA94GPgBubvg8Vdja4LkvBfYDu4FVi/0Bklq3CtgNHKB0xtcNnqfztjV07tuAlym9E0jS//YAL1K66d42aK7OW9vAec8BHgO2hzxhaQwfAQ8Bx8ZdQ+e91/A5NwGvATtCnqg0vp3AQUo3LY6zkE6Z+sIGzrkSeIJyWb0y5ElK+S4F3qR003mjLqDTpmro84HHKZfhU0KeoDSeZZRO+gTYQOmqUR2+us6zGdgN3EbpLkmqX+dGYAOlqz4edbHO2zjmOacuq78Fnqf/3mmpcZcC+4A3gLVjrKNz62Kd0qEeFt0OvA9sowwvSq24jdJZm8ZYQ+dOSue1ZuqDm5dRxlO3hBxQasobwDPAl0OuoXNbi+cpE8I24MqQA0qt2kg5TtgCfDjkGjofD/tJP6F0Tb0v5EBSe/YBz1K67l/Kz/vipv75Z+CR/s/7QQ4iteNbytDCfUNsu/OXSQXtWOwAXcrlgaT2+atUKkhDS0FqaejZ0AclldlQ+sVP/VfRlcDbwOaQJ1y/DnAbpXvGPbWWAzuATSEvBM22doy1dG7r6OucdcD1IU+4ThcCW4HL5nx+M+X9g1K2LSGvBc0yzf/WR1lH5y+jrqEP0fB7oKt3Epjl//+/nwJOhTxhqR0nKN3yL+V/K8+E/LzPhvz+1HuAk//53P85o1NaNnPSaJ31X8rPtXbWvyjjVw8sss0h4HZg/ZTnrN1q4A5gT//POxbbqPPjSef8HHgauG2RTR+k3K962pTnrN065vyyZjm/rPnXsI/SZXuHWM+GKc9VuxvoQOe1kNfTJOln/5TnkjQJ/zZBKkhDS0FqaegPI58AKU2F/yIvFaShpSC1NPTbIQeUyqyi9P0oa+n8YdRN/wM+pEySbwk5sNS8TZTum6N01+cjrKXz12E/8ZeUubzngx5Aat4G4FVK570y5BrqWMqo+0eh/2ik9mwF9lO6b+qDm19SJnq3hRxQatYm4BVK98399WCU9XR+HXWxTul0XQq8ROkoP0Wk5lxK6brXKV034gHOWP/xFnAz8EVH0rBWU7rsd0o3jWPsv1y/hDLYdGfIk5XGsBN4ndJFt4+xjs5GSteMZZqhhnspI+8enagmW0kZWD9I6Z5phlGmfg/0WS2cc+og09vAwZAnLo3uduAtShfNbrMHhxpG+c85p0aN3gMeoNx7eFbLx5IGcRawm9I5B5o68Xw6P0w67+rFFtHp/O+qqZL+aXfFXf/O/Ofc+Z9/t93TzyljhweBn0KelPT/VlMG0TdSumaaPfk/0ww1/Bt1ZsgfSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZJUp/8AxH1zEXbRSeoAAAAASUVORK5CYII=";
const PWA_ICON_SVG = "data:image/svg+xml," + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" rx="96" fill="#7CB69D"/><circle cx="256" cy="220" r="100" fill="#fff" opacity="0.35"/><circle cx="256" cy="220" r="60" fill="#fff" opacity="0.55"/><circle cx="256" cy="220" r="30" fill="#fff"/><rect x="156" y="360" width="200" height="20" rx="10" fill="#fff" opacity="0.5"/><rect x="186" y="400" width="140" height="14" rx="7" fill="#fff" opacity="0.3"/></svg>');

const manifestData = {
  name: "Productivity Hub",
  short_name: "Productivity",
  description: "Focus timer, tasks, checklists & quick notes - all in one place",
  id: "productivity-hub-pwa",
  start_url: window.location.pathname || "/",
  scope: "/",
  display: "standalone",
  orientation: "any",
  background_color: "#F7F5F0",
  theme_color: "#7CB69D",
  prefer_related_applications: false,
  categories: ["productivity", "utilities"],
  icons: [
    { src: PWA_ICON_192, sizes: "192x192", type: "image/png", purpose: "any maskable" },
    { src: PWA_ICON_180, sizes: "180x180", type: "image/png", purpose: "any maskable" },
    { src: PWA_ICON_SVG, sizes: "512x512", type: "image/svg+xml", purpose: "any" }
  ]
};

// Apply blob manifest as best-effort fallback (works for some browsers)
const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
const manifestURL = URL.createObjectURL(manifestBlob);
document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);

// PWA Install Prompt â€” capture beforeinstallprompt for use in-app
window.__pwaInstallPrompt = null;
window.__pwaInstalled = false;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  window.__pwaInstallPrompt = e;
  window.dispatchEvent(new Event('pwa-prompt-ready'));
});
window.addEventListener('appinstalled', () => {
  window.__pwaInstalled = true;
  window.__pwaInstallPrompt = null;
  window.dispatchEvent(new Event('pwa-installed'));
});

// Service Worker Registration (blob-based, best-effort for local use)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    const CACHE_NAME = 'productivity-hub-v12';
    const swCode = `
      const CACHE_NAME = '${CACHE_NAME}';
      self.addEventListener('install', (e) => {
        self.skipWaiting();
        e.waitUntil(
          caches.open(CACHE_NAME).then(cache => {
            return cache.addAll([self.location.href]).catch(() => {});
          })
        );
      });
      self.addEventListener('activate', (e) => {
        e.waitUntil(
          caches.keys().then(names =>
            Promise.all(names.filter(n => n !== CACHE_NAME).map(n => caches.delete(n)))
          ).then(() => clients.claim())
        );
      });
      self.addEventListener('fetch', (e) => {
        if (e.request.url.endsWith('/manifest.json')) {
          e.respondWith(new Response(JSON.stringify(${JSON.stringify(manifestData)}), {
            headers: {'Content-Type': 'application/json'}
          }));
          return;
        }
        if (e.request.mode === 'navigate') {
          e.respondWith(
            fetch(e.request).then(response => {
              const clone = response.clone();
              caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
              return response;
            }).catch(() => caches.match(e.request))
          );
          return;
        }
        e.respondWith(
          caches.match(e.request).then(cached => cached || fetch(e.request).then(response => {
            if (response.ok && e.request.method === 'GET') {
              const clone = response.clone();
              caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
            }
            return response;
          }).catch(() => cached))
        );
      });
    `;
    const swBlob = new Blob([swCode], {type: 'application/javascript'});
    const swURL = URL.createObjectURL(swBlob);
    navigator.serviceWorker.register(swURL, {scope: './'}).then(() => {
      console.log('Service Worker registered (blob-based, limited scope)');
    }).catch((err) => {
      console.log('Service Worker registration skipped:', err.message);
    });
  });
}

// Helper: Generate proper PWA files for HTTPS deployment
window.__generatePWAFiles = () => {
  const swContent = `const CACHE_NAME = 'productivity-hub-v12';
const APP_FILE = self.location.pathname.replace('/sw.js', '/') || '/';

self.addEventListener('install', (e) => {
  self.skipWaiting();
  e.waitUntil(
    caches.open(CACHE_NAME).then(cache => cache.addAll([APP_FILE]).catch(() => {}))
  );
});

self.addEventListener('activate', (e) => {
  e.waitUntil(
    caches.keys().then(names =>
      Promise.all(names.filter(n => n !== CACHE_NAME).map(n => caches.delete(n)))
    ).then(() => clients.claim())
  );
});

self.addEventListener('fetch', (e) => {
  if (e.request.mode === 'navigate') {
    e.respondWith(
      fetch(e.request).then(response => {
        const clone = response.clone();
        caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
        return response;
      }).catch(() => caches.match(e.request))
    );
    return;
  }
  e.respondWith(
    caches.match(e.request).then(cached => cached || fetch(e.request).then(response => {
      if (response.ok && e.request.method === 'GET') {
        const clone = response.clone();
        caches.open(CACHE_NAME).then(cache => cache.put(e.request, clone));
      }
      return response;
    }).catch(() => cached))
  );
});`;

  const manifestContent = JSON.stringify({
    name: "Productivity Hub",
    short_name: "Productivity",
    description: "Focus timer, tasks, checklists & quick notes - all in one place",
    id: "productivity-hub-pwa",
    start_url: "./",
    scope: "./",
    display: "standalone",
    orientation: "any",
    background_color: "#F7F5F0",
    theme_color: "#7CB69D",
    prefer_related_applications: false,
    categories: ["productivity", "utilities"],
    icons: [
      { src: "icon-192.png", sizes: "192x192", type: "image/png", purpose: "any maskable" },
      { src: "icon-512.svg", sizes: "512x512", type: "image/svg+xml", purpose: "any" }
    ]
  }, null, 2);

  return { sw: swContent, manifest: manifestContent };
};
</script>
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const{useState,useEffect,useRef,useMemo,useCallback,createContext,useContext}=React;

// App Version
const APP_VERSION = '16.9';
const TEST_RUNNER_SRC='test_runner.jsx';
const TEST_RUNNER_LOAD_TIMEOUT_MS=8000;
let testRunnerLoadPromise=null;
const loadTestRunner=(onProgress=()=>{})=>{
  if(window.TestRunner)return Promise.resolve(window.TestRunner);
  if(testRunnerLoadPromise)return testRunnerLoadPromise;
  testRunnerLoadPromise=new Promise(async(resolve,reject)=>{
    const timeoutId=setTimeout(()=>reject(new Error(`Test suite load timed out after ${Math.round(TEST_RUNNER_LOAD_TIMEOUT_MS/1000)}s.`)),TEST_RUNNER_LOAD_TIMEOUT_MS);
    try{
      onProgress({stage:'Downloading test suite...',pct:20});
      const res=await fetch(TEST_RUNNER_SRC,{cache:'no-cache'});
      if(!res.ok)throw new Error(`Failed to load test suite file (${res.status}).`);
      const src=await res.text();
      if(!window.Babel||typeof window.Babel.transform!=='function'){
        throw new Error('Babel runtime is unavailable.');
      }
      onProgress({stage:'Compiling test suite...',pct:60});
      const transformed=window.Babel.transform(src,{presets:['react']});
      onProgress({stage:'Initializing test suite...',pct:85});
      (new Function(transformed.code))();
      if(!window.TestRunner)throw new Error('Test suite failed to initialize.');
      onProgress({stage:'Ready',pct:100});
      clearTimeout(timeoutId);
      resolve(window.TestRunner);
    }catch(err){
      clearTimeout(timeoutId);
      reject(err);
    }
  }).catch(err=>{
    testRunnerLoadPromise=null;
    throw err;
  });
  return testRunnerLoadPromise;
};

// Icons - More visible with less transparency
const I={
  Focus:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.35"/><circle cx="12" cy="12" r="6" fill="currentColor" opacity="0.55"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg>,
  List:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><rect x="3" y="4" width="18" height="16" rx="3" fill="currentColor" opacity="0.3"/><rect x="6" y="8" width="3" height="2" rx="1" fill="currentColor"/><rect x="6" y="12" width="3" height="2" rx="1" fill="currentColor"/><rect x="11" y="8" width="7" height="2" rx="1" fill="currentColor" opacity="0.85"/><rect x="11" y="12" width="6" height="2" rx="1" fill="currentColor" opacity="0.85"/></svg>,
  Check:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><rect x="3" y="3" width="18" height="18" rx="4" fill="currentColor" opacity="0.3"/><path d="M8 12L11 15L16 9" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Bell:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M12 3C8.5 3 6 5.5 6 9V14L4 17H20L18 14V9C18 5.5 15.5 3 12 3Z" fill="currentColor" opacity="0.3"/><path d="M12 3C8.5 3 6 5.5 6 9V14L4 17H20L18 14V9C18 5.5 15.5 3 12 3Z" stroke="currentColor" strokeWidth="2" fill="none"/><circle cx="12" cy="3" r="2" fill="currentColor"/><path d="M10 17C10 18.5 10.8 20 12 20C13.2 20 14 18.5 14 17" stroke="currentColor" strokeWidth="2"/></svg>,
  Notes:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><rect x="4" y="3" width="16" height="18" rx="2" fill="currentColor" opacity="0.3"/><path d="M8 7H16M8 11H16M8 15H13" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></svg>,
  Settings:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="4" fill="currentColor"/><path d="M12 2V5M12 19V22M4.93 4.93L7.05 7.05M16.95 16.95L19.07 19.07M2 12H5M19 12H22M4.93 19.07L7.05 16.95M16.95 7.05L19.07 4.93" stroke="currentColor" strokeWidth="2" strokeLinecap="round" opacity="0.65"/></svg>,
  Help:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.25"/><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2" fill="none"/><path d="M9 9C9 7.34 10.34 6 12 6C13.66 6 15 7.34 15 9C15 10.31 14.17 11.42 13 11.83V13" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><circle cx="12" cy="17" r="1.5" fill="currentColor"/></svg>,
  Play:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.25"/><path d="M10 8L16 12L10 16V8Z" fill="currentColor"/></svg>,
  Pause:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.25"/><rect x="9" y="8" width="2" height="8" rx="1" fill="currentColor"/><rect x="13" y="8" width="2" height="8" rx="1" fill="currentColor"/></svg>,
  Reset:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M4 12C4 7.58 7.58 4 12 4C16.42 4 20 7.58 20 12C20 16.42 16.42 20 12 20C9.79 20 7.79 19.1 6.34 17.66" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"/><path d="M4 8V12H8" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Plus:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M12 5V19M5 12H19" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"/></svg>,
  Edit:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M16 3L21 8L8 21H3V16L16 3Z" fill="currentColor" opacity="0.25"/><path d="M16 3L21 8L8 21H3V16L16 3Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Broom:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M12 2L12 10M8 10H16L17 22H7L8 10Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Trash:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M6 7H18L17 20H7L6 7Z" fill="currentColor" opacity="0.25"/><path d="M4 7H20M10 11V16M14 11V16M6 7L7 20H17L18 7M9 7V4H15V7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Share:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="18" cy="5" r="3" fill="currentColor"/><circle cx="6" cy="12" r="3" fill="currentColor"/><circle cx="18" cy="19" r="3" fill="currentColor"/><path d="M8.5 10.5L15.5 6.5M8.5 13.5L15.5 17.5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" opacity="0.6"/></svg>,
  Drag:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="9" cy="6" r="2" fill="currentColor"/><circle cx="15" cy="6" r="2" fill="currentColor"/><circle cx="9" cy="12" r="2" fill="currentColor"/><circle cx="15" cy="12" r="2" fill="currentColor"/><circle cx="9" cy="18" r="2" fill="currentColor"/><circle cx="15" cy="18" r="2" fill="currentColor"/></svg>,
  Down:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M6 9L12 15L18 9" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Up:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M6 15L12 9L18 15" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Sun:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="5" fill="currentColor"/><path d="M12 2V4M12 20V22M4 12H2M22 12H20M5.64 5.64L4.22 4.22M19.78 19.78L18.36 18.36M5.64 18.36L4.22 19.78M19.78 4.22L18.36 5.64" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></svg>,
  Moon:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"/></svg>,
  Phone:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><rect x="6" y="2" width="12" height="20" rx="2" fill="currentColor" opacity="0.25"/><rect x="6" y="2" width="12" height="20" rx="2" stroke="currentColor" strokeWidth="2"/><circle cx="12" cy="18" r="1" fill="currentColor"/></svg>,
  X:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M6 6L18 18M18 6L6 18" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"/></svg>,
  Restore:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M3 12C3 7.02 7.02 3 12 3C16.98 3 21 7.02 21 12C21 16.98 16.98 21 12 21C9.51 21 7.27 19.96 5.64 18.26" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><path d="M3 17V12H8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Done:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.25"/><path d="M8 12L11 15L16 9" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Info:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.25"/><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/><path d="M12 16V12M12 8H12.01" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"/></svg>,
  Calendar:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><rect x="3" y="4" width="18" height="18" rx="2" fill="currentColor" opacity="0.25"/><path d="M3 10H21M8 2V6M16 2V6" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" strokeWidth="2" fill="none"/></svg>,
  Test:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Copy:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><rect x="9" y="9" width="13" height="13" rx="2" stroke="currentColor" strokeWidth="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></svg>,
  Download:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><polyline points="7 10 12 15 17 10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></svg>,
  Review:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><rect x="3" y="3" width="18" height="18" rx="3" fill="currentColor" opacity="0.25"/><path d="M7 12L10 15L17 9" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M3 8H21" stroke="currentColor" strokeWidth="1.5" opacity="0.4"/></svg>,
  MoreV:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="5" r="2" fill="currentColor"/><circle cx="12" cy="12" r="2" fill="currentColor"/><circle cx="12" cy="19" r="2" fill="currentColor"/></svg>,
};

// Empty States (small but v4-style)
const Empty={
  List:()=><div className="flex flex-col items-center py-4 anim-in"><svg width="48" height="48" viewBox="0 0 100 100" fill="none" className="anim-float opacity-70"><rect x="20" y="15" width="60" height="60" rx="8" fill="#E8F0EA" stroke="#7CB69D" strokeWidth="3"/><rect x="30" y="30" width="10" height="3" rx="1.5" fill="#7CB69D"/><rect x="45" y="30" width="25" height="3" rx="1.5" fill="#9DC4A8"/><rect x="30" y="42" width="10" height="3" rx="1.5" fill="#7CB69D"/><rect x="45" y="42" width="20" height="3" rx="1.5" fill="#9DC4A8"/></svg><p className="text-bark-400 dark:text-sand-300 text-xs font-medium mt-2">Empty list</p></div>,
  NoLists:({onCreate})=><div className="flex flex-col items-center justify-center py-12 anim-in"><svg width="64" height="64" viewBox="0 0 100 100" fill="none" className="anim-float opacity-70 mb-4"><rect x="15" y="10" width="60" height="70" rx="8" fill="#E8F0EA" stroke="#7CB69D" strokeWidth="2.5"/><rect x="25" y="25" width="10" height="3" rx="1.5" fill="#7CB69D"/><rect x="40" y="25" width="30" height="3" rx="1.5" fill="#9DC4A8"/><rect x="25" y="37" width="10" height="3" rx="1.5" fill="#7CB69D"/><rect x="40" y="37" width="25" height="3" rx="1.5" fill="#9DC4A8"/><rect x="25" y="49" width="10" height="3" rx="1.5" fill="#7CB69D"/><rect x="40" y="49" width="35" height="3" rx="1.5" fill="#9DC4A8"/><path d="M70 65L80 75M80 65L70 75" stroke="#7CB69D" strokeWidth="3" strokeLinecap="round"/></svg><h3 className="text-lg font-bold text-bark-600 dark:text-sand-100 mb-2">ðŸ“‹ No Checklists Yet</h3><p className="text-sm text-bark-500 dark:text-sand-300 text-center mb-6 max-w-xs">Create your first checklist to start organizing!</p><button onClick={onCreate} className="px-6 py-3 bg-sage-400 text-white rounded-xl font-semibold shadow-sm hover:bg-sage-500 transition-colors flex items-center gap-2"><I.Plus s={20}/>Create Checklist</button></div>,
  Tasks:()=><div className="flex items-center justify-center py-1.5"><span className="text-bark-400/40 dark:text-sand-300/30 text-xs">No tasks</span></div>,
  Focus:()=><div className="flex flex-col items-center py-4 anim-in"><svg width="56" height="56" viewBox="0 0 100 100" fill="none" className="anim-float opacity-70"><circle cx="50" cy="50" r="35" fill="#E8F0EA" stroke="#7CB69D" strokeWidth="3"/><circle cx="50" cy="50" r="20" fill="#C5D9CA" opacity="0.5"/><circle cx="50" cy="50" r="8" fill="#7CB69D"/></svg><p className="text-bark-400 dark:text-sand-300 text-xs font-medium mt-2">Add tasks from Clarify â€¢ Max 5</p></div>,
  Remind:()=><div className="flex flex-col items-center py-4 anim-in"><svg width="48" height="48" viewBox="0 0 100 100" fill="none" className="anim-float opacity-70"><path d="M50 20C38 20 30 30 30 42V55L24 65H76L70 55V42C70 30 62 20 50 20Z" fill="#FCEEE9" stroke="#E07A5F" strokeWidth="2.5"/><circle cx="50" cy="20" r="4" fill="#E07A5F"/></svg><p className="text-bark-400 dark:text-sand-300 text-xs font-medium mt-2">No reminders</p></div>,
  Notes:()=><div className="flex flex-col items-center py-6 anim-in"><svg width="48" height="48" viewBox="0 0 100 100" fill="none" className="anim-float opacity-70"><rect x="20" y="15" width="60" height="70" rx="6" fill="#E6F2F7" stroke="#5A9BBF" strokeWidth="2.5"/><circle cx="32" cy="35" r="3" fill="#5A9BBF"/><rect x="42" y="33" width="28" height="4" rx="2" fill="#5A9BBF" opacity="0.5"/><circle cx="32" cy="50" r="3" fill="#5A9BBF"/><rect x="42" y="48" width="22" height="4" rx="2" fill="#5A9BBF" opacity="0.5"/><circle cx="32" cy="65" r="3" fill="#5A9BBF"/><rect x="42" y="63" width="30" height="4" rx="2" fill="#5A9BBF" opacity="0.5"/></svg><p className="text-bark-400 dark:text-sand-300 text-sm font-medium mt-3">Start your quick notes</p><p className="text-bark-400/50 dark:text-sand-300/50 text-xs">Press Enter to add bullets</p></div>,
};

// IndexedDB Storage
const DB_NAME='ProductivityHub';
const DB_VERSION=1;
const STORE_NAME='data';

// Initialize IndexedDB
const initDB=()=>new Promise((resolve,reject)=>{
  const req=indexedDB.open(DB_NAME,DB_VERSION);
  req.onerror=()=>reject(req.error);
  req.onsuccess=()=>resolve(req.result);
  req.onupgradeneeded=e=>{const db=e.target.result;if(!db.objectStoreNames.contains(STORE_NAME))db.createObjectStore(STORE_NAME);};
});

// Storage with IndexedDB + localStorage fallback
const S={
  // Get value from IndexedDB
  get:async(k,d)=>{
    try{
      const db=await initDB();
      return new Promise((resolve,reject)=>{
        const tx=db.transaction(STORE_NAME,'readonly');
        const store=tx.objectStore(STORE_NAME);
        const req=store.get(k);
        req.onsuccess=()=>resolve(req.result!==undefined?req.result:d);
        req.onerror=()=>resolve(d);
      });
    }catch{
      // Fallback to localStorage
      try{const i=localStorage.getItem('ph3_'+k);return i?JSON.parse(i):d;}catch{return d;}
    }
  },
  
  // Set value in IndexedDB
  set:async(k,v)=>{
    try{
      const db=await initDB();
      return new Promise((resolve,reject)=>{
        const tx=db.transaction(STORE_NAME,'readwrite');
        const store=tx.objectStore(STORE_NAME);
        const req=store.put(v,k);
        req.onsuccess=()=>resolve();
        req.onerror=()=>resolve();
      });
    }catch{
      // Fallback to localStorage
      try{localStorage.setItem('ph3_'+k,JSON.stringify(v));}catch{}
    }
  },
  
  // Export all data
  exp:async()=>{
    try{
      const db=await initDB();
      return new Promise((resolve,reject)=>{
        const tx=db.transaction(STORE_NAME,'readonly');
        const store=tx.objectStore(STORE_NAME);
        const req=store.getAllKeys();
        req.onsuccess=async()=>{
          const keys=req.result;
          const d={};
          for(const k of keys){
            const val=await S.get(k);
            if(val!==undefined)d[k]=val;
          }
          resolve(d);
        };
        req.onerror=()=>resolve({});
      });
    }catch{
      // Fallback to localStorage
      const d={};
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(k.startsWith('ph3_'))d[k.replace('ph3_','')]=JSON.parse(localStorage.getItem(k));
      }
      return d;
    }
  },
  
  // Import data
  imp:async(d)=>{
    try{
      const db=await initDB();
      const tx=db.transaction(STORE_NAME,'readwrite');
      const store=tx.objectStore(STORE_NAME);
      for(const[k,v]of Object.entries(d)){
        store.put(v,k);
      }
      return new Promise((resolve)=>{
        tx.oncomplete=()=>resolve();
        tx.onerror=()=>resolve();
      });
    }catch{
      // Fallback to localStorage
      Object.entries(d).forEach(([k,v])=>localStorage.setItem('ph3_'+k,JSON.stringify(v)));
    }
  },
  
  // Clear all data
  clr:async()=>{
    try{
      const db=await initDB();
      return new Promise((resolve,reject)=>{
        const tx=db.transaction(STORE_NAME,'readwrite');
        const store=tx.objectStore(STORE_NAME);
        const req=store.clear();
        req.onsuccess=()=>resolve();
        req.onerror=()=>resolve();
      });
    }catch{
      // Fallback to localStorage
      const ks=[];
      for(let i=0;i<localStorage.length;i++){
        const k=localStorage.key(i);
        if(k.startsWith('ph3_'))ks.push(k);
      }
      ks.forEach(k=>localStorage.removeItem(k));
    }
  },
  
  // Synchronous get for initial load (returns null, triggers async load)
  getSync:(k,d)=>{
    try{const i=localStorage.getItem('ph3_'+k);return i?JSON.parse(i):d;}catch{return d;}
  }
};

// Unique ID generator (safer than Date.now() alone)
const uid=()=>Date.now().toString(36)+'-'+Math.random().toString(36).slice(2,9);

// Native Notifications
const notify=(title,body)=>{
  if(!('Notification'in window))return;
  if(Notification.permission==='granted'){new Notification(title,{body,icon:'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%237CB69D"/></svg>'});}
  else if(Notification.permission!=='denied'){Notification.requestPermission().then(p=>{if(p==='granted')new Notification(title,{body});});}
};
const reqNotifyPerm=()=>{if('Notification'in window&&Notification.permission==='default')Notification.requestPermission();};

// Theme
const ThemeCtx=createContext();
const ThemeProv=({children})=>{
  const[theme,setTheme]=useState(()=>S.getSync('theme','system'));
  useEffect(()=>{S.get('theme','system').then(v=>{if(v!==theme)setTheme(v);});},[]);
  useEffect(()=>{S.set('theme',theme);const r=document.documentElement,m=document.getElementById('theme-color-meta');if(theme==='system'){const p=window.matchMedia('(prefers-color-scheme:dark)').matches;r.classList.toggle('dark',p);m.content=p?'#2D2720':'#F7F5F0';}else{r.classList.toggle('dark',theme==='dark');m.content=theme==='dark'?'#2D2720':'#F7F5F0';}},[theme]);
  return<ThemeCtx.Provider value={{theme,setTheme}}>{children}</ThemeCtx.Provider>;
};

// Desktop check
const useDesk=()=>{const[d,setD]=useState(window.innerWidth>=768);useEffect(()=>{const h=()=>setD(window.innerWidth>=768);window.addEventListener('resize',h);return()=>window.removeEventListener('resize',h);},[]);return d;};
const useWide=()=>{const[w,setW]=useState(window.innerWidth>=1280);useEffect(()=>{const h=()=>setW(window.innerWidth>=1280);window.addEventListener('resize',h);return()=>window.removeEventListener('resize',h);},[]);return w;};
// Custom hook for IndexedDB persisted state
const usePersistedState=(key,defaultValue)=>{
  const[state,setState]=useState(()=>S.getSync(key,defaultValue));
  const[loaded,setLoaded]=useState(false);
  
  // Load from IndexedDB on mount
  useEffect(()=>{
    S.get(key,defaultValue).then(val=>{
      setState(val);
      setLoaded(true);
    });
  },[key]);
  
  // Save to IndexedDB on change
  useEffect(()=>{
    if(loaded){
      S.set(key,state);
    }
  },[key,state,loaded]);
  
  return[state,setState];
};

// Constants
const PRESETS={classic:{work:25,shortBreak:5,longBreak:15,l:'Classic'},long:{work:50,shortBreak:10,longBreak:30,l:'Long'},short:{work:15,shortBreak:3,longBreak:10,l:'Short'},custom:{work:25,shortBreak:5,longBreak:15,l:'Custom'}};
const QUADS=[{id:'ui',l:'Do First',sub:'Urgent + Important',clr:'from-terracotta-300 to-terracotta-200',dclr:'dark:from-terracotta-500/30 dark:to-terracotta-400/15',bdr:'border-terracotta-400',dbdr:'dark:border-terracotta-500/50',txt:'text-terracotta-500',dtxt:'dark:text-terracotta-300'},{id:'ni',l:'Schedule',sub:'Not Urgent + Important',clr:'from-ocean-300 to-ocean-200',dclr:'dark:from-ocean-400/30 dark:to-ocean-300/15',bdr:'border-ocean-400',dbdr:'dark:border-ocean-400/50',txt:'text-ocean-400',dtxt:'dark:text-ocean-300'},{id:'un',l:'Delegate',sub:'Urgent + Not Important',clr:'from-sand-300 to-sand-200',dclr:'dark:from-sand-300/25 dark:to-sand-200/15',bdr:'border-sand-300',dbdr:'dark:border-sand-300/40',txt:'text-bark-500',dtxt:'dark:text-sand-200'},{id:'nn',l:'Eliminate',sub:'Not Urgent + Not Important',clr:'from-lavender-300 to-lavender-200',dclr:'dark:from-lavender-400/30 dark:to-lavender-300/15',bdr:'border-lavender-300',dbdr:'dark:border-lavender-400/40',txt:'text-lavender-400',dtxt:'dark:text-lavender-300'}];
const CATS=[{id:'work',l:'Work',clr:'bg-ocean-300',e:'ðŸ’¼'},{id:'personal',l:'Personal',clr:'bg-lavender-300',e:'ðŸ '},{id:'health',l:'Health',clr:'bg-sage-400',e:'ðŸ’ª'},{id:'learning',l:'Learning',clr:'bg-terracotta-300',e:'ðŸ“š'}];

// Share helper
const shareItem=(item,type)=>{
  let t='';
  if(type==='task'){t=`ðŸ“‹ Task: ${item.text}\n`;if(item.deadline)t+=`ðŸ“… ${item.deadline}\n`;}
  else if(type==='list')t=`ðŸ“ ${item.text}\n`;
  else if(type==='reminder')t=`ðŸ”” ${item.text} at ${item.time}\n`;
  else if(type==='note')t=`ðŸ“„ ${item.title}\n${'â”€'.repeat(20)}\n${item.content}\n`;
  if(item.notes)t+=`Notes: ${item.notes}\n`;
  if(type==='task'&&item.subtasks?.length>0){t+=`Subtasks:\n`;item.subtasks.forEach(s=>{t+=`${s.done?'âœ…':'â˜'} ${s.text}\n`;});}
  t+=`\nâ€” Productivity Hub`;
  if(navigator.share)navigator.share({text:t}).catch(()=>{});else{navigator.clipboard.writeText(t);return true;}
  return false;
};

// Utils
const genICS=(r)=>{const n=new Date(),[h,m]=(r.time||'09:00').split(':'),e=r.date?new Date(r.date):new Date();e.setHours(parseInt(h),parseInt(m),0,0);if(e<n)e.setDate(e.getDate()+1);const f=d=>d.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z',end=new Date(e.getTime()+15*60000);return`BEGIN:VCALENDAR\nVERSION:2.0\nBEGIN:VEVENT\nUID:${Date.now()}@ph\nDTSTAMP:${f(n)}\nDTSTART:${f(e)}\nDTEND:${f(end)}\nSUMMARY:${r.text||'Reminder'}\nEND:VEVENT\nEND:VCALENDAR`;};
const dlFile=(c,fn,t='text/plain')=>{const b=new Blob([c],{type:t}),u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=fn;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);};

// Subtasks
const Subtasks=({items=[],onChange,ro=false})=>{
  const[n,setN]=useState('');
  const add=()=>{if(!n.trim())return;onChange([...items,{id:uid(),text:n,done:false}]);setN('');};
  return(
    <div className="space-y-1.5">
      {items.map(s=>(
        <div key={s.id} className="flex items-center gap-2 pl-1">
          <button onClick={()=>!ro&&onChange(items.map(x=>x.id===s.id?{...x,done:!x.done}:x))} className={`w-4 h-4 rounded-full border-2 flex items-center justify-center text-xs ${s.done?'bg-sage-400 border-sage-400 text-white':'border-sage-300'}`}>{s.done&&'âœ“'}</button>
          <span className={`flex-1 text-sm sel ${s.done?'line-through text-bark-400/50':'text-bark-600 dark:text-sand-200'}`}>{s.text}</span>
          {!ro&&<button onClick={()=>onChange(items.filter(x=>x.id!==s.id))} className="text-bark-400/50 text-xs hover:text-terracotta-400">âœ•</button>}
        </div>
      ))}
      {!ro&&<div className="flex gap-2 pl-1"><input type="text" value={n} onChange={e=>setN(e.target.value)} onKeyDown={e=>e.key==='Enter'&&add()} placeholder="Add subtask..." className="flex-1 text-sm bg-transparent border-b border-sand-300 dark:border-bark-500 focus:outline-none focus:border-sage-400 py-1 text-bark-600 dark:text-sand-200"/><button onClick={add} className="text-sage-500 text-sm font-semibold">+</button></div>}
    </div>
  );
};

// Quick Add Component
const QuickAdd=({placeholder,onAdd,buttonText='Add'})=>{
  const[val,setVal]=useState('');
  const[focused,setFocused]=useState(false);
  const handleAdd=()=>{if(val.trim()){onAdd(val.trim());setVal('');setFocused(false);}};
  return(
    <div className={`gcard rounded-2xl p-3 md:p-4 transition-all ${focused?'ring-2 ring-sage-400':''}`}>
      <div className="flex gap-2 md:gap-3">
        <input 
          type="text" 
          value={val} 
          onChange={e=>setVal(e.target.value)} 
          onFocus={()=>setFocused(true)}
          onBlur={()=>setTimeout(()=>setFocused(false),200)}
          onKeyDown={e=>{if(e.key==='Enter')handleAdd();if(e.key==='Escape'){setVal('');setFocused(false);}}}
          placeholder={placeholder}
          className="flex-1 bg-transparent focus:outline-none text-bark-600 dark:text-sand-100 placeholder-bark-400/50 md:text-base md:py-1"
        />
        {val.trim()&&<button onClick={handleAdd} className="px-4 md:px-5 py-1.5 md:py-2 bg-sage-400 rounded-lg md:rounded-xl text-white font-semibold text-sm md:text-base">{buttonText}</button>}
      </div>
    </div>
  );
};

// Unified Action Menu (v16.8 - P0)
const ActionMenu=({title,actions,onClose})=>(
  <div className="fixed inset-0 bg-bark-700/40 backdrop-blur-sm flex items-center justify-center z-40" onClick={onClose}>
    <div className="gcard w-full max-w-xs rounded-2xl overflow-hidden anim-in mx-4" onClick={e=>e.stopPropagation()}>
      {title&&<div className="px-4 py-3 border-b border-sand-200 dark:border-bark-500"><p className="font-bold text-bark-600 dark:text-sand-100 truncate">{title}</p></div>}
      {actions.map((a,i)=>(
        <button key={i} onClick={()=>{a.action();onClose();}} className={`w-full px-4 py-3 flex items-center gap-3 hover:bg-sage-100 dark:hover:bg-sage-400/20 transition-colors text-left ${i>0?'border-t border-sand-200 dark:border-bark-500':''}`}>
          {a.icon}
          <span className={`font-medium ${a.danger?'text-terracotta-500 dark:text-terracotta-300':'text-bark-600 dark:text-sand-100'}`}>{a.label}</span>
          {a.sub&&<span className="text-xs text-bark-400/50 ml-auto">{a.sub}</span>}
        </button>
      ))}
    </div>
  </div>
);

// Unified Confirm Dialog (v16.8 - P0)
const ConfirmDialog=({title,text,onConfirm,onCancel,confirmText="Delete",isDestructive=true,icon:Icon=I.Trash})=>(
  <div className="fixed inset-0 bg-bark-700/60 backdrop-blur-sm flex items-center justify-center z-50 p-3" onClick={onCancel}>
    <div className="gcard w-full max-w-sm rounded-2xl p-5 anim-in" onClick={e=>e.stopPropagation()}>
      <div className="text-center mb-4">
        <div className={`w-16 h-16 ${isDestructive?'bg-terracotta-100 dark:bg-terracotta-400/20':'bg-ocean-100 dark:bg-ocean-400/20'} rounded-full flex items-center justify-center mx-auto mb-3`}><Icon s={32} c={isDestructive?"text-terracotta-400":"text-ocean-400"}/></div>
        <h3 className="text-lg font-bold text-bark-600 dark:text-sand-100 mb-2">{title}</h3>
        <p className="text-sm text-bark-500 dark:text-sand-300">{text}</p>
      </div>
      <div className="flex gap-2">
        <button onClick={onCancel} className="flex-1 py-2.5 bg-sand-200 dark:bg-bark-600 rounded-lg font-semibold text-bark-600 dark:text-sand-200 text-sm">Cancel</button>
        <button onClick={onConfirm} className={`flex-1 py-2.5 rounded-lg font-semibold text-white text-sm ${isDestructive?'bg-terracotta-400':'bg-sage-400'}`}>{confirmText}</button>
      </div>
    </div>
  </div>
);

// List Menu Component
// Batch Selection Checkbox (v10.3)
const SelCheck=({checked,onToggle})=>(
  <button onClick={e=>{e.stopPropagation();onToggle();}} className={`w-6 h-6 rounded-md border-2 flex items-center justify-center flex-shrink-0 transition-all ${checked?'bg-sage-400 border-sage-400 text-white':'border-bark-300 dark:border-sand-300'}`} aria-label={checked?'Deselect':'Select'}>{checked&&<span className="text-sm font-bold">âœ“</span>}</button>
);

// Bulk Action Bar (v10.4)
const BulkActionBar=({count,section,allCount,onSelectAll,onDeselectAll,onAction,onCancel})=>{
  const allSelected=count===allCount&&allCount>0;
  const showDone=section==='todos'||section==='lists';
  const showNoteActions=section==='notes';
  return(
    <div className="fixed bottom-[72px] left-0 right-0 px-3 pb-2 anim-in" style={{zIndex:25}}>
      <div className="glass rounded-2xl soft-shadow max-w-lg md:max-w-2xl mx-auto">
        <div className="flex items-center justify-between px-4 py-2 border-b border-sand-200/50 dark:border-bark-500/30">
          <div className="flex items-center gap-2">
            <span className="font-bold text-sage-500 text-sm">{count} selected</span>
            <button onClick={allSelected?onDeselectAll:onSelectAll} className="text-xs font-semibold text-ocean-400 hover:text-ocean-500 transition-colors">{allSelected?'Deselect All':'Select All'}</button>
          </div>
          <button onClick={onCancel} className="p-1.5 rounded-lg hover:bg-sand-200 dark:hover:bg-bark-600 text-bark-400 transition-colors" aria-label="Cancel selection"><I.X s={18}/></button>
        </div>
        <div className="flex items-center justify-around px-2 py-2.5">
          {showDone&&<button onClick={()=>onAction('done')} className="flex flex-col items-center gap-1 px-3 py-1.5 rounded-xl hover:bg-sage-100 dark:hover:bg-sage-400/20 transition-colors" aria-label="Mark done"><I.Done s={22} c="text-sage-500"/><span className="text-xs font-semibold text-sage-600 dark:text-sage-300">{section==='lists'?'Toggle':'Done'}</span></button>}
          {showNoteActions&&<button onClick={()=>onAction('clarify')} className="flex flex-col items-center gap-1 px-3 py-1.5 rounded-xl hover:bg-sage-100 dark:hover:bg-sage-400/20 transition-colors" aria-label="Move to Clarify"><I.Check s={22} c="text-sage-500"/><span className="text-xs font-semibold text-sage-600 dark:text-sage-300">Clarify</span></button>}
          {showNoteActions&&<button onClick={()=>onAction('strike')} className="flex flex-col items-center gap-1 px-3 py-1.5 rounded-xl hover:bg-ocean-100 dark:hover:bg-ocean-400/20 transition-colors" aria-label="Strikethrough"><span className="text-bark-400 font-bold text-lg line-through">S</span><span className="text-xs font-semibold text-ocean-600 dark:text-ocean-300">Strike</span></button>}
          <button onClick={()=>onAction('delete')} className="flex flex-col items-center gap-1 px-3 py-1.5 rounded-xl hover:bg-terracotta-100 dark:hover:bg-terracotta-400/20 transition-colors" aria-label="Delete selected"><I.Trash s={22} c="text-terracotta-400"/><span className="text-xs font-semibold text-terracotta-500 dark:text-terracotta-300">Delete</span></button>
        </div>
      </div>
    </div>
  );
};

const LinkPicker=({task,lists,onLink,onCreate,onUnlink,onClose})=>{
  const[newName,setNewName]=useState('');
  return(
  <div className="fixed inset-0 bg-bark-700/60 backdrop-blur-sm flex items-center justify-center z-50 p-3" onClick={onClose}>
    <div className="gcard w-full max-w-sm rounded-2xl p-5 anim-in" onClick={e=>e.stopPropagation()}>
      <div className="flex items-center justify-between mb-3"><h3 className="font-bold text-bark-600 dark:text-sand-100">ðŸ“‹ Link Checklist</h3><button onClick={onClose} className="text-bark-400"><I.X s={20}/></button></div>
      <p className="text-xs text-bark-500 dark:text-sand-200 mb-3">Link <strong>"{task.text}"</strong> to a checklist:</p>
      {task.linkedList&&<button onClick={()=>{onUnlink(task.id);onClose();}} className="w-full mb-3 py-2.5 px-4 rounded-xl bg-terracotta-100 dark:bg-terracotta-400/20 text-terracotta-500 text-sm font-semibold text-left">âœ• Remove current link</button>}
      <div className="space-y-1.5 max-h-48 overflow-y-auto hide-sb mb-3">{lists.map(l=><button key={l.id} onClick={()=>{onLink(task.id,l.id);onClose();}} className={`w-full py-2.5 px-4 rounded-xl text-sm font-medium text-left transition-colors ${task.linkedList===l.id?'bg-sage-400 text-white':'gcard text-bark-600 dark:text-sand-100 hover:bg-sage-50 dark:hover:bg-sage-400/10'}`}>{l.name}<span className="ml-2 text-xs opacity-60">({l.items.filter(i=>!i.done).length}/{l.items.length})</span></button>)}</div>
      <div className="flex gap-2"><input type="text" value={newName} onChange={e=>setNewName(e.target.value)} placeholder="New checklist name..." onKeyDown={e=>{if(e.key==='Enter'&&newName.trim()){onCreate(task.id,newName.trim());onClose();}}} className="flex-1 bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500"/><button onClick={()=>{if(newName.trim()){onCreate(task.id,newName.trim());onClose();}}} className="px-4 py-2 bg-sage-400 rounded-lg text-white text-sm font-semibold">Create</button></div>
    </div>
  </div>
  );
};

// Edit Modal
const EditModal=({item,type,onSave,onClose,onDelete})=>{
  const[text,setText]=useState(item?.text||item?.title||'');
  const[content,setContent]=useState(item?.content||'');
  const[notes,setNotes]=useState(item?.notes||'');
  const[subtasks,setSub]=useState(item?.subtasks||[]);
  const[section,setSec]=useState(item?.section||'');
  const[quad,setQuad]=useState(item?.quad||'nn');
  const[cat,setCat]=useState(item?.cat||null);
  const[time,setTime]=useState(item?.time||'09:00');
  const[date,setDate]=useState(item?.date||new Date().toISOString().split('T')[0]);
  const[deadline,setDl]=useState(item?.deadline||'');
  
  const save=()=>{
    if(!text.trim())return;
    if(type==='note')onSave({...item,title:text,content,notes});
    else if(type==='list')onSave({...item,text,notes,section});
    else if(type==='todo')onSave({...item,text,notes,subtasks,quad,cat,deadline});
    else if(type==='reminder')onSave({...item,text,time,date});
    onClose();
  };

  return(
    <div className="fixed inset-0 bg-bark-700/60 backdrop-blur-sm flex items-center justify-center z-40 p-3" onClick={onClose}>
      <div className="gcard w-full max-w-md md:max-w-lg rounded-2xl p-4 md:p-6 max-h-[90vh] overflow-y-auto anim-in modal-content" onClick={e=>e.stopPropagation()}>
        <div className="flex items-center justify-between mb-3">
          <h3 className="font-bold text-bark-600 dark:text-sand-100">{item?.id?'Edit':'New'} {type==='note'?'Note':type==='list'?'Item':type==='todo'?'Task':'Reminder'}</h3>
          <button onClick={onClose} className="text-bark-400"><I.X s={22}/></button>
        </div>
        <div className="space-y-3">
          <div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">{type==='note'?'Title':'Text'}</label><input type="text" value={text} onChange={e=>setText(e.target.value)} className="w-full bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500 text-sm" placeholder={type==='reminder'?'e.g. Take medicine':'Enter text...'}/></div>
          {type==='note'&&<div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Content</label><textarea value={content} onChange={e=>setContent(e.target.value)} className="w-full bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500 min-h-24 text-sm"/></div>}
          {type==='list'&&<div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Section</label><input type="text" value={section} onChange={e=>setSec(e.target.value)} className="w-full bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500 text-sm"/></div>}
          {type==='todo'&&<>
            <div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Priority</label><div className="grid grid-cols-2 gap-1.5">{QUADS.map(q=><button key={q.id} onClick={()=>setQuad(q.id)} className={`p-2 rounded-lg border-2 text-left text-xs ${quad===q.id?`${q.bdr} bg-gradient-to-r ${q.clr}`:'border-sand-200 dark:border-bark-500'}`}><span className={`font-semibold ${q.txt}`}>{q.l}</span></button>)}</div></div>
            <div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Category</label><div className="flex flex-wrap gap-1.5">{CATS.map(c=><button key={c.id} onClick={()=>setCat(cat===c.id?null:c.id)} className={`px-2.5 py-1 rounded-full text-xs font-medium ${cat===c.id?`${c.clr} text-white`:'bg-sand-100 dark:bg-bark-600 text-bark-600 dark:text-sand-200'}`}>{c.e} {c.l}</button>)}</div></div>
            <div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Deadline</label><input type="date" value={deadline} onChange={e=>setDl(e.target.value)} className="w-full bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500 text-sm"/></div>
          </>}
          {type==='reminder'&&<>
            <div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Date</label><input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500 text-sm"/></div>
            <div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Time</label><input type="time" value={time} onChange={e=>setTime(e.target.value)} className="w-full bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500 text-sm"/></div>
          </>}
          {type!=='reminder'&&<div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Notes</label><textarea value={notes} onChange={e=>setNotes(e.target.value)} className="w-full bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500 min-h-16 text-sm"/></div>}
          {type==='todo'&&<div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Subtasks</label><Subtasks items={subtasks} onChange={setSub}/></div>}
        </div>
        <div className="flex gap-2 mt-4">
          {type==='list'&&item?.id&&<button onClick={()=>{if(confirm('Delete this item?')){onDelete?.();onClose();}}} className="py-2.5 px-4 bg-terracotta-100 dark:bg-terracotta-400/20 rounded-lg font-semibold text-terracotta-500 dark:text-terracotta-300 text-sm hover:bg-terracotta-200 transition-colors"><I.Trash s={16} c="inline mr-1"/>Delete</button>}
          <button onClick={onClose} className="flex-1 py-2.5 bg-sand-200 dark:bg-bark-600 rounded-lg font-semibold text-bark-600 dark:text-sand-200 text-sm">Cancel</button><button onClick={save} className="flex-1 py-2.5 bg-sage-400 rounded-lg font-semibold text-white text-sm">Save</button></div>
      </div>
    </div>
  );
};

// Help Modal - Compact App Navigation
const AboutModal=({onClose,isWelcome})=>(
  <div className="fixed inset-0 bg-bark-700/60 backdrop-blur-sm flex items-center justify-center z-50 p-2" onClick={onClose}>
    <div className="gcard w-full max-w-sm md:max-w-lg rounded-2xl p-5 md:p-6 anim-in" onClick={e=>e.stopPropagation()}>
      {isWelcome?(<div className="text-center mb-4"><div className="text-3xl mb-1">ðŸŒ¿</div><h2 className="text-lg md:text-xl font-extrabold text-bark-600 dark:text-sand-100">Welcome to Productivity Hub</h2><p className="text-sm text-bark-400 dark:text-sand-300 mt-0.5">Your all-in-one productivity system</p></div>):(<div className="flex items-center justify-between mb-3"><h2 className="text-base md:text-lg font-bold text-bark-600 dark:text-sand-100">ðŸŒ¿ About Productivity Hub</h2><button onClick={onClose} className="text-bark-400 hover:text-bark-600"><I.X s={20}/></button></div>)}
      <div className="space-y-2">
        <div><span className="font-bold text-bark-600 dark:text-sand-100">ðŸ“ Capture</span><span className="text-sm text-bark-500 dark:text-sand-200"> â€” Brain dump everything. No organizing yet.</span></div>
        <div><span className="font-bold text-bark-600 dark:text-sand-100">ðŸŽ¯ Clarify</span><span className="text-sm text-bark-500 dark:text-sand-200"> â€” Sort by urgency & importance. Tap to toggle done. â‹® for actions.</span></div>
        <div><span className="font-bold text-bark-600 dark:text-sand-100">â± Focus</span><span className="text-sm text-bark-500 dark:text-sand-200"> â€” Queue 3â€“5 tasks. Work in timed sessions.</span></div>
        <div><span className="font-bold text-bark-600 dark:text-sand-100">âœ… Confirm</span><span className="text-sm text-bark-500 dark:text-sand-200"> â€” Checklists for tasks. Link from Clarify to break work into steps.</span></div>
        <div><span className="font-bold text-bark-600 dark:text-sand-100">ðŸ“Š Review</span><span className="text-sm text-bark-500 dark:text-sand-200"> â€” Weekly stats, streaks & insights.</span></div>
      </div>
      <div className="mt-3 text-center"><p className="text-sm font-bold text-sage-500 dark:text-sage-400">Capture â†’ Clarify â†’ Focus â†’ Confirm â†’ Review â†’ Repeat</p></div>
      <p className="mt-3 text-xs text-center text-bark-400 dark:text-sand-300">ðŸ“š Visit <strong className="text-bark-600 dark:text-sand-100">More â†’ Explainer</strong> for the full guide</p>
      <button onClick={onClose} className="w-full mt-3 py-2.5 bg-sage-400 rounded-xl font-bold text-white text-sm hover:bg-sage-500 transition-colors">{isWelcome?'Get Started':'Got it!'}</button>
    </div>
  </div>
);

// Streak Heatmap (GitHub-style)
const Heatmap=({dHist,met})=>{
  const[sel,setSel]=useState(null);
  const weeks=13,days=7;
  const today=new Date();
  const todayStr=today.toDateString();

  // Build grid data: 13 weeks Ã— 7 days
  const cells=useMemo(()=>{
    const arr=[];
    const startOff=(weeks*days)-1;
    for(let i=startOff;i>=0;i--){
      const d=new Date(today);d.setDate(d.getDate()-i);
      const ds=d.toDateString();
      const isFuture=d>today&&ds!==todayStr;
      const hist=dHist.find(x=>x.date===ds);
      const isToday=ds===todayStr;
      const p=isToday?met.d.p:(hist?.p||0);
      const t=isToday?met.d.t:(hist?.t||0);
      const m=isToday?met.d.m:(hist?.m||0);
      arr.push({date:d,ds,p,t,m,isFuture,isToday,day:d.getDay()});
    }
    return arr;
  },[dHist,met.d]);

  // Compute streaks
  const{cur,longest}=useMemo(()=>{
    let c=0,l=0,streak=0;
    for(let i=0;i<=((weeks*days)-1);i++){
      const d=new Date(today);d.setDate(d.getDate()-i);
      const ds=d.toDateString();
      const hist=dHist.find(x=>x.date===ds);
      const isToday=ds===todayStr;
      const p=isToday?met.d.p:(hist?.p||0);
      const t=isToday?met.d.t:(hist?.t||0);
      if(p>0||t>0){streak++;if(streak>l)l=streak;}
      else{if(i===0){streak=0;}else{if(c===0)c=streak;break;}}
    }
    if(c===0)c=streak;
    return{cur:c,longest:l};
  },[dHist,met.d]);

  // Color by pomodoro count
  const clr=(p,isFuture)=>{
    if(isFuture)return'bg-transparent';
    if(p===0)return'bg-sand-200/60 dark:bg-bark-600/40';
    if(p<=1)return'bg-sage-200 dark:bg-sage-400/30';
    if(p<=3)return'bg-sage-300 dark:bg-sage-400/50';
    if(p<=5)return'bg-sage-400 dark:bg-sage-400/70';
    return'bg-sage-600 dark:bg-sage-500';
  };

  // Arrange into columns (weeks). Each column = 7 days (Sun-Sat)
  const cols=[];
  for(let w=0;w<weeks;w++){cols.push(cells.slice(w*days,(w+1)*days));}

  const mLabels=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const dLabels=['','M','','W','','F',''];

  return(
    <div className="gcard rounded-2xl p-4">
      <div className="flex items-center justify-between mb-3">
        <h3 className="font-bold text-bark-600 dark:text-sand-100">ðŸ”¥ Streak</h3>
        <div className="flex gap-3 text-xs">
          <span className="text-bark-500 dark:text-sand-200"><span className="font-bold text-terracotta-400">{cur}</span> day{cur!==1?'s':''} current</span>
          <span className="text-bark-500 dark:text-sand-200"><span className="font-bold text-sage-500">{longest}</span> longest</span>
        </div>
      </div>
      <div className="flex gap-0.5 overflow-x-auto hide-sb">
        <div className="flex flex-col gap-0.5 mr-1 pt-4">
          {dLabels.map((l,i)=><div key={i} className="h-3 text-[9px] leading-3 text-bark-400/50 dark:text-sand-300/50 text-right pr-0.5">{l}</div>)}
        </div>
        {cols.map((wk,wi)=>{
          const firstDay=wk[0]?.date;
          const showMonth=wi===0||(firstDay&&firstDay.getDate()<=7);
          return(
            <div key={wi} className="flex flex-col gap-0.5">
              <div className="h-3 text-[9px] leading-3 text-bark-400/50 dark:text-sand-300/50 text-center">{showMonth&&firstDay?mLabels[firstDay.getMonth()]:''}</div>
              {wk.map((c,di)=>(
                <div key={di} onClick={()=>!c.isFuture&&setSel(sel?.ds===c.ds?null:c)} title={c.isFuture?'':`${c.date.toLocaleDateString()}: ${c.p}ðŸ… ${c.t}âœ“ ${c.m}m`}
                  className={`w-3 h-3 rounded-[2px] cursor-pointer transition-all ${clr(c.p,c.isFuture)} ${c.isToday?'ring-1 ring-terracotta-300 dark:ring-terracotta-400':''} ${sel?.ds===c.ds?'ring-1 ring-ocean-400':''}`}/>
              ))}
            </div>
          );
        })}
      </div>
      <div className="flex items-center gap-1 mt-2 justify-end">
        <span className="text-[9px] text-bark-400/50 dark:text-sand-300/50">Less</span>
        {[0,1,2,4,6].map(v=><div key={v} className={`w-2.5 h-2.5 rounded-[2px] ${clr(v,false)}`}/>)}
        <span className="text-[9px] text-bark-400/50 dark:text-sand-300/50">More</span>
      </div>
      {sel&&!sel.isFuture&&(
        <div className="mt-3 p-3 rounded-xl bg-sand-50 dark:bg-bark-600/50 flex items-center gap-4">
          <div className="text-sm font-medium text-bark-600 dark:text-sand-100">{sel.date.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'})}</div>
          <div className="flex gap-3 text-xs text-bark-500 dark:text-sand-200">
            <span>ðŸ… {sel.p}</span><span>âœ“ {sel.t}</span><span>â± {sel.m}m</span>
          </div>
        </div>
      )}
    </div>
  );
};

// Mini Chart
const Chart=({data,label,clr='bg-sage-400'})=>{
  const max=Math.max(...data.map(d=>d.v),1);
  return<div className="gcard rounded-xl p-3"><h4 className="text-sm font-bold text-bark-600 dark:text-sand-100 mb-3">{label}</h4><div className="flex items-end gap-1 h-16">{data.map((d,i)=><div key={i} className="flex-1 flex flex-col items-center gap-0.5"><div className={`w-full ${clr} rounded-t`} style={{height:`${(d.v/max)*100}%`,minHeight:d.v>0?'3px':'0'}}/><span className="text-xs text-bark-400/60">{d.l}</span></div>)}</div></div>;
};

// Isolated FocusTimer Component with useReducer
const FocusTimer=React.memo(({tSet,onComplete,onUpdatePoms,onUpdateMetrics,onUpdateFocus,onUpdateTodos,activeTaskId,activeTaskText,onTick})=>{
  const[state,dispatch]=React.useReducer((s,a)=>{
    switch(a.type){
      case'SET_MODE':return{...s,mode:a.mode,left:a.left,run:false};
      case'SET_LEFT':return{...s,left:a.left};
      case'TOGGLE_RUN':return{...s,run:!s.run};
      case'SET_RUN':return{...s,run:a.run};
      case'SET_WAKE':return{...s,wake:a.wake};
      default:return s;
    }
  },{mode:'work',left:tSet.work*60,run:false,wake:true});
  
  const{mode,left,run,wake}=state;
  const wakeRef=useRef(null);
  const intRef=useRef(null);
  
  const fmt=s=>{const m=Math.floor(s/60),sec=s%60;return`${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;};
  const prog=useMemo(()=>{const t=mode==='work'?tSet.work*60:mode==='shortBreak'?tSet.shortBreak*60:tSet.longBreak*60;return((t-left)/t)*100;},[left,mode,tSet]);
  
  const switchMode=useRef((m)=>{
    const d=m==='work'?tSet.work:m==='shortBreak'?tSet.shortBreak:tSet.longBreak;
    dispatch({type:'SET_MODE',mode:m,left:d*60});
  }).current;
  
  const timerDone=useRef(()=>{
    dispatch({type:'SET_RUN',run:false});
    if('vibrate'in navigator)navigator.vibrate([200,100,200]);
    try{const c=new AudioContext(),o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=700;o.start();o.stop(c.currentTime+0.4);}catch{}
    if(mode==='work'){
      onComplete(mode,activeTaskId,()=>switchMode(onUpdatePoms()%4===0?'longBreak':'shortBreak'));
    }else{
      switchMode('work');
      notify('â˜€ï¸ Break Complete!','Ready to focus again?');
    }
  }).current;
  
  useEffect(()=>{if(!run){const d=mode==='work'?tSet.work:mode==='shortBreak'?tSet.shortBreak:tSet.longBreak;dispatch({type:'SET_LEFT',left:d*60});}},[tSet,mode,run]);
  
  useEffect(()=>{
    const req=async()=>{if(wake&&run&&'wakeLock'in navigator){try{wakeRef.current=await navigator.wakeLock.request('screen');}catch{}}};
    const rel=()=>{wakeRef.current?.release();wakeRef.current=null;};
    if(wake&&run)req();else rel();
    return()=>rel();
  },[wake,run]);
  
  useEffect(()=>{
    if(run&&left>0)intRef.current=setInterval(()=>dispatch({type:'SET_LEFT',left:Math.max(0,left-1)}),1000);
    else if(left<=0&&run)timerDone();
    return()=>clearInterval(intRef.current);
  },[run,left]);
  
  useEffect(()=>{if(onTick)onTick({left,run,mode});},[left,run,mode]);
  
  return(
    <div className={`rounded-3xl p-6 md:p-8 relative overflow-hidden soft-shadow ${mode==='work'?'bg-gradient-to-br from-sage-300 to-sage-400':mode==='shortBreak'?'bg-gradient-to-br from-ocean-300 to-ocean-400':'bg-gradient-to-br from-lavender-300 to-lavender-400'}`}>
      <div className="absolute inset-0 bg-white/20 transition-all duration-1000 origin-left" style={{transform:`scaleX(${prog/100})`}}/>
      <div className="relative z-10">
        <div className="flex justify-center gap-2 md:gap-3 mb-5 md:mb-6">{['work','shortBreak','longBreak'].map(m=><button key={m} onClick={()=>switchMode(m)} className={`px-4 md:px-6 py-1.5 md:py-2 rounded-full text-sm md:text-base font-semibold transition-all ${mode===m?'bg-white/40 text-white':'bg-white/20 text-white/80'}`}>{m==='work'?'Focus':m==='shortBreak'?'Short':'Long'}</button>)}</div>
        <div className="text-7xl md:text-8xl font-extrabold text-center mb-3 md:mb-5 text-white drop-shadow-sm tracking-tight timer-display">{fmt(left)}</div>
        {activeTaskText&&<div className="text-center text-white/90 text-sm mb-4 font-medium sel">ðŸŽ¯ {activeTaskText}</div>}
        <div className="flex justify-center gap-3">
          <button onClick={()=>{if(!run)reqNotifyPerm();dispatch({type:'TOGGLE_RUN'});}} aria-label={run?'Pause timer':'Start timer'} className="px-8 md:px-10 py-3 md:py-3.5 bg-white rounded-2xl font-bold flex items-center gap-2 text-lg md:text-xl text-bark-600 soft-shadow">{run?<><I.Pause s={22}/>Pause</>:<><I.Play s={22}/>Start</>}</button>
          <button onClick={()=>switchMode(mode)} aria-label="Reset timer" className="p-3 bg-white/30 rounded-2xl text-white"><I.Reset s={24}/></button>
        </div>
        <div className="flex items-center justify-center gap-2 mt-4"><span className="text-sm text-white/80 font-medium">Keep awake</span><button onClick={()=>dispatch({type:'SET_WAKE',wake:!wake})} aria-label={wake?'Disable keep awake':'Enable keep awake'} className={`w-11 h-6 rounded-full transition-colors p-0.5 ${wake?'bg-white/40':'bg-black/20'}`}><div className={`w-5 h-5 bg-white rounded-full transition-transform shadow-sm ${wake?'translate-x-5':'translate-x-0'}`}/></button></div>
      </div>
    </div>
  );
},(prev,next)=>prev.tSet===next.tSet&&prev.activeTaskId===next.activeTaskId&&prev.activeTaskText===next.activeTaskText&&prev.onTick===next.onTick);

// useAppData â€” shared persisted data state and CRUD handlers (v16.2 refactor Step 1)
function useAppData(){
  // Data
  const[lists,setLists]=usePersistedState('lists',[]);
  const[todos,setTodos]=usePersistedState('todos',[]);
  const[reminders,setReminders]=usePersistedState('reminders',[]);
  const[notes,setNotes]=usePersistedState('notes',[]);
  const[focus,setFocus]=usePersistedState('focus',[]);
  const[activeF,setActiveF]=useState(null);

  // Timer
  const[preset,setPreset]=usePersistedState('preset','classic');
  const[customT,setCustomT]=usePersistedState('customT',{work:25,shortBreak:5,longBreak:15});
  const tSet=useMemo(()=>preset==='custom'?customT:PRESETS[preset],[preset,customT]);
  const[poms,setPoms]=usePersistedState('poms',0);

  // Metrics
  const[met,setMet]=usePersistedState('met',{d:{p:0,t:0,m:0,date:new Date().toDateString()},w:{p:0,t:0,m:0}});
  const[fHist,setFHist]=usePersistedState('fHist',[]);
  const[dHist,setDHist]=usePersistedState('dHist',[]);

  // Day rotation: archive yesterday's stats to dHist
  const runDayRotationForTest=(todayOverride=null)=>{
    const today=todayOverride||new Date().toDateString();
    if(met.d.date&&met.d.date!==today){
      if(met.d.p>0||met.d.t>0||met.d.m>0){
        setDHist(h=>{const filtered=h.filter(x=>x.date!==met.d.date);return[...filtered,{date:met.d.date,p:met.d.p,t:met.d.t,m:met.d.m}].slice(-180);});
      }
      const oldDate=new Date(met.d.date);
      const nowDate=new Date(today);
      const isNewWeek=nowDate.getDay()===0||oldDate.getDay()>nowDate.getDay()||(nowDate-oldDate)>=7*864e5;
      setMet(p=>({d:{p:0,t:0,m:0,date:today},w:isNewWeek?{p:0,t:0,m:0}:p.w}));
      return true;
    }
    return false;
  };
  useEffect(()=>{
    runDayRotationForTest();
  },[]);

  // Toast
  const[toast,setToast]=useState(null);
  const showT=m=>{setToast(m);setTimeout(()=>setToast(null),2000);};

  // Tab navigation
  const[tab,setTab]=usePersistedState('tab','notes');
  const[selList,setSelList]=usePersistedState('selList','');

  // Keep selected checklist valid globally (not just in ConfirmSection)
  useEffect(()=>{
    if(lists.length===0){
      if(selList!=='')setSelList('');
      return;
    }
    if(!lists.find(l=>l.id===selList))setSelList(lists[0].id);
  },[lists,selList,setSelList]);

  // Timer completion callbacks
  const handleTimerComplete=(mode,activeTaskId,switchToBreak)=>{
    setFHist(h=>[...h.slice(-500),{hr:new Date().getHours()}]);
    const nc=poms+1;
    setPoms(nc);
    setMet(p=>({...p,d:{...p.d,p:p.d.p+1,m:p.d.m+tSet.work},w:{...p.w,p:p.w.p+1,m:p.w.m+tSet.work}}));
    if(activeTaskId){
      setFocus(f=>f.map(t=>t.id===activeTaskId?{...t,poms:(t.poms||0)+1}:t));
      setTodos(t=>t.map(x=>x.id===activeTaskId?{...x,poms:(x.poms||0)+1}:x));
    }
    switchToBreak();
    notify('ðŸŒ¿ Great Focus!',nc%4===0?'Time for a long break (15 min)':'Time for a short break (5 min)');
    showT('ðŸŒ¿ Great focus!');
  };

  const handleUpdatePoms=()=>{
    const nc=poms+1;
    setPoms(nc);
    return nc;
  };

  // CRUD handlers
  const clearCompleted=(section)=>{
    if(section==='todos'){const cnt=todos.filter(t=>t.done).length;if(cnt===0)return showT('No completed tasks');setTodos(t=>t.filter(x=>!x.done));setFocus(f=>f.filter(x=>!todos.find(t=>t.id===x.id&&t.done)));showT(`ðŸ§¹ ${cnt} cleared`);}
  };

  const addFocus=t=>{if(focus.length>=5)return showT('ðŸŒ¿ Max 5');if(!focus.find(x=>x.id===t.id)){setFocus([...focus,{...t}]);showT('âœ¨ Added');}};
  const doneFocus=id=>{setTodos(t=>t.map(x=>x.id===id?{...x,done:true}:x));setFocus(f=>f.filter(x=>x.id!==id));setMet(p=>({...p,d:{...p.d,t:p.d.t+1},w:{...p.w,t:p.w.t+1}}));if(activeF===id)setActiveF(null);showT('ðŸŽ‰ Done!');};
  const doneList=(lid,iid)=>{setLists(ls=>ls.map(l=>l.id===lid?{...l,items:l.items.map(i=>i.id===iid?{...i,done:!i.done}:i)}:l));};
  const doneTodo=id=>{setTodos(t=>t.map(x=>x.id===id?{...x,done:true}:x));setFocus(f=>f.filter(x=>x.id!==id));setMet(p=>({...p,d:{...p.d,t:p.d.t+1},w:{...p.w,t:p.w.t+1}}));showT('âœ… Done!');};
  const undoneTodo=id=>{setTodos(t=>t.map(x=>x.id===id?{...x,done:false}:x));showT('â†©ï¸ Restored');};
  const deleteTodo=id=>{setTodos(t=>t.filter(x=>x.id!==id));showT('ðŸ—‘ Deleted');};
  const linkTask=(taskId,listId)=>{setTodos(t=>t.map(x=>x.id===taskId?{...x,linkedList:listId}:x));showT('ðŸ“‹ Linked!');};
  const unlinkTask=(taskId)=>{setTodos(t=>t.map(x=>x.id===taskId?{...x,linkedList:undefined}:x));showT('Unlinked');};
  const openLinkedList=(task)=>{if(task.linkedList){setSelList(task.linkedList);setTab('lists');}};
  const createAndLink=(taskId,name)=>{const id=uid();setLists(ls=>[...ls,{id,name,items:[]}]);linkTask(taskId,id);setSelList(id);};
  const deleteListItem=(lid,iid)=>{setLists(ls=>ls.map(l=>l.id===lid?{...l,items:l.items.filter(i=>i.id!==iid)}:l));showT('ðŸ—‘ Deleted');};
  const deleteReminder=id=>{setReminders(r=>r.filter(x=>x.id!==id));showT('ðŸ—‘ Deleted');};

  const updateListName=(listId,newName)=>{
    if(!newName.trim())return;
    setLists(ls=>ls.map(l=>l.id===listId?{...l,name:newName.trim()}:l));
    showT('âœï¸ List renamed!');
  };

  const deleteList=(listId)=>{
    setLists(ls=>ls.filter(l=>l.id!==listId));
    showT('ðŸ—‘ List deleted!');
  };

  const saveItem=(type,item,listId=null)=>{
    if(type==='note'){if(item.id)setNotes(n=>n.map(x=>x.id===item.id?{...item,upAt:new Date().toISOString()}:x));else setNotes(n=>[...n,{...item,id:uid(),crAt:new Date().toISOString()}]);}
    else if(type==='list'){if(item.id)setLists(ls=>ls.map(l=>l.id===listId?{...l,items:l.items.map(i=>i.id===item.id?item:i)}:l));else setLists(ls=>ls.map(l=>l.id===listId?{...l,items:[...l.items,{...item,id:uid()}]}:l));}
    else if(type==='todo'){if(item.id){setTodos(t=>t.map(x=>x.id===item.id?item:x));setFocus(f=>f.map(x=>x.id===item.id?item:x));}else setTodos(t=>[...t,{...item,id:uid(),poms:0}]);}
    else if(type==='reminder'){if(item.id)setReminders(r=>r.map(x=>x.id===item.id?item:x));else setReminders(r=>[...r,{...item,id:uid(),on:true}]);}
    showT('âœ¨ Saved!');
  };

  const seedSampleData=()=>{
    const now=new Date().toISOString();
    const today=new Date().toDateString();
    setTodos(t=>{if(t.length>0)return t;return[
      {id:uid(),text:'Try adding a task here',quad:'ui',pri:'high',cat:'personal',done:false,poms:0},
      {id:uid(),text:'Schedule tasks with deadlines',quad:'ni',pri:'medium',cat:'learning',done:false,poms:0},
      {id:uid(),text:'Use â˜ header checkbox for bulk select',quad:'nn',pri:'low',cat:'personal',done:false,poms:0},
    ];});
    setNotes(n=>{if(n.length>0)return n;return[
      {id:uid(),text:'Welcome! Jot quick thoughts here',date:today,crAt:now},
      {id:uid(),text:'Tap any note to edit, use â‹® for actions',date:today,crAt:now},
    ];});
    setLists(ls=>{if(ls.some(l=>l.items.length>0))return ls;return[
      {id:uid(),name:'Getting Started',items:[{id:uid(),text:'Explore each tab',done:false},{id:uid(),text:'Start a Focus session',done:false},{id:uid(),text:'Check the Review tab',done:false}]},
    ];});
  };

  // Derived data
  const wkData=useMemo(()=>{const days=['S','M','T','W','T','F','S'],td=new Date();return Array.from({length:7},(_,i)=>{const d=new Date(td);d.setDate(d.getDate()-(6-i));const ds=d.toDateString(),dd=dHist.find(x=>x.date===ds);return{l:days[d.getDay()],v:ds===met.d.date?met.d.p:(dd?.p||0)};});},[dHist,met.d]);
  const doneCount=todos.filter(t=>t.done).length;

  return{
    // Data state
    lists,setLists,todos,setTodos,reminders,setReminders,notes,setNotes,
    focus,setFocus,activeF,setActiveF,
    // Timer config
    preset,setPreset,customT,setCustomT,tSet,poms,setPoms,
    // Metrics
    met,setMet,fHist,setFHist,dHist,setDHist,
    // Toast
    toast,showT,
    // Tab/nav
    tab,setTab,selList,setSelList,
    // Handlers
    handleTimerComplete,handleUpdatePoms,clearCompleted,
    addFocus,doneFocus,doneList,doneTodo,undoneTodo,deleteTodo,
    linkTask,unlinkTask,openLinkedList,createAndLink,
    deleteListItem,deleteReminder,updateListName,deleteList,saveItem,
    seedSampleData,
    // Test helper
    runDayRotationForTest,
    // Derived
    wkData,doneCount,
  };
}

// AppDataCtx â€” shared data context (v16.2 refactor Step 2)
const AppDataCtx=React.createContext(null);
function AppDataProv({children}){
  const data=useAppData();
  return React.createElement(AppDataCtx.Provider,{value:data},children);
}
function useApp(){const ctx=useContext(AppDataCtx);if(!ctx)throw new Error('useApp must be inside AppDataProv');return ctx;}

// CaptureSection â€” extracted from rNotes() (v16.2 refactor Step 3)
function CaptureSection({wide,selMode,selSection,selIds,toggleSelId,enterSelMode,exitSelMode}){
  const{notes,setNotes,todos,setTodos,showT}=useApp();
  const[newBullet,setNewBullet]=useState('');
  const[editingNote,setEditingNote]=useState(null);
  const[noteMenu,setNoteMenu]=useState(null);
  const[confirmDeleteNote,setConfirmDeleteNote]=useState(null);
  const bulletRef=React.useRef(null);
  const today=new Date().toISOString().split('T')[0];

  const notesByDate=useMemo(()=>{
    const groups={};
    notes.forEach(n=>{
      const d=n.date||new Date(n.crAt).toISOString().split('T')[0];
      if(!groups[d])groups[d]=[];
      groups[d].push(n);
    });
    return Object.entries(groups).sort((a,b)=>b[0].localeCompare(a[0]));
  },[notes]);

  const addBullet=(text)=>{
    if(!text.trim())return;
    const newNote={id:uid(),text:text.trim(),date:today,crAt:new Date().toISOString()};
    setNotes([newNote,...notes]);
  };

  const handleBulletKeyDown=(e)=>{
    if(e.key==='Enter'&&!e.shiftKey){
      e.preventDefault();
      addBullet(newBullet);
      setNewBullet('');
    }
  };

  const formatDateHeader=(dateStr)=>{
    const d=new Date(dateStr+'T12:00:00');
    const now=new Date();
    const todayStr=now.toISOString().split('T')[0];
    const yesterday=new Date(now);yesterday.setDate(yesterday.getDate()-1);
    const yesterdayStr=yesterday.toISOString().split('T')[0];
    if(dateStr===todayStr)return'Today';
    if(dateStr===yesterdayStr)return'Yesterday';
    return d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
  };

  const deleteBullet=(id)=>setNotes(notes.filter(n=>n.id!==id));
  const updateBullet=(id,text)=>{if(!text.trim()){deleteBullet(id);}else{setNotes(notes.map(n=>n.id===id?{...n,text:text.trim()}:n));}setEditingNote(null);};

  React.useEffect(()=>{
    const thirtyDays=30*24*60*60*1000;
    const now=Date.now();
    const toRemove=notes.filter(n=>n.struck&&n.struckAt&&(now-n.struckAt>thirtyDays));
    if(toRemove.length>0)setNotes(prev=>prev.filter(n=>!toRemove.find(r=>r.id===n.id)));
  },[notes.length]);

  const toggleStrike=(id)=>setNotes(notes.map(n=>n.id===id?{...n,struck:!n.struck,struckAt:!n.struck?Date.now():null}:n));
  const noteToTodo=(note)=>{setTodos(t=>[{id:uid(),text:note.text||note.title||note.content,quad:'nn',poms:0,done:false},...t]);setNotes(notes.map(n=>n.id===note.id?{...n,struck:true,struckAt:Date.now()}:n));showT('ðŸ“‹ Copied to Clarify + struck');};

  const inSel=selMode&&selSection==='notes';
  return(
    <div className="space-y-4">
      <div className={`sticky ${wide?"top-0 -mx-8":"top-0 -mx-4 md:-mx-8"} z-10 glass px-4 md:px-6 py-3 md:py-4 mb-4`}>
        {inSel?<div className="flex items-center justify-center relative"><button onClick={exitSelMode} className="absolute left-0 px-3 py-1.5 bg-sand-200 dark:bg-bark-600 rounded-lg text-bark-600 dark:text-sand-100 text-sm font-semibold">âœ• Cancel</button><h2 className="text-lg md:text-xl font-bold text-sage-500">{selIds.size} selected</h2></div>
        :<div className="flex items-center justify-center relative">
          {notes.length>0&&<button onClick={()=>enterSelMode('notes',null)} className="absolute left-0 w-7 h-7 rounded-md border-2 border-bark-300 dark:border-sand-300 flex items-center justify-center hover:border-sage-400 transition-colors" aria-label="Select items"><span className="sr-only">Select</span></button>}
          <h2 className="text-lg md:text-xl font-bold text-bark-600 dark:text-sand-100">ðŸ“ Capture</h2>
        </div>}
      </div>

      <div className={`gcard rounded-2xl p-4 ${wide?'capture-input':''}`}>
        <div className="flex items-start gap-3">
          <span className="text-sage-400 mt-1 text-lg">â€¢</span>
          <textarea
            ref={bulletRef}
            value={newBullet}
            onChange={e=>setNewBullet(e.target.value)}
            onKeyDown={handleBulletKeyDown}
            placeholder="Quick note... (Enter to add)"
            rows={1}
            className="flex-1 bg-transparent focus:outline-none text-bark-600 dark:text-sand-100 placeholder-bark-400/50 resize-none text-base leading-relaxed"
            style={{minHeight:'28px'}}
          />
        </div>
        {newBullet.trim()&&<div className="flex justify-end mt-2"><button onClick={()=>{addBullet(newBullet);setNewBullet('');}} className="px-4 py-1.5 bg-sage-400 rounded-lg text-white font-semibold text-sm">Add</button></div>}
      </div>

      {notesByDate.length===0?<Empty.Notes/>:notesByDate.map(([date,dayNotes])=>(
        <div key={date} className="space-y-2">
          <div className="flex items-center gap-2 px-1">
            <span className="text-sm font-bold text-bark-600/70 dark:text-sand-200/70 uppercase tracking-wider">{formatDateHeader(date)}</span>
            <div className="flex-1 h-px bg-sand-200 dark:bg-bark-500/50"/>
          </div>
          <div className="gcard rounded-2xl p-3 space-y-1">
            {dayNotes.map(n=>{
              const isSel=inSel&&selIds.has(n.id);
              let touchData={x:0,y:0,moved:false,menuTap:false};
              const onTS=(e)=>{const t=e.touches?e.touches[0]:null;if(t)touchData={x:t.clientX,y:t.clientY,moved:false,menuTap:false};};
              const onTM=(e)=>{const t=e.touches?e.touches[0]:null;if(t&&(Math.abs(t.clientX-touchData.x)>10||Math.abs(t.clientY-touchData.y)>10))touchData.moved=true;};
              const handleTap=(e)=>{if(touchData.moved||touchData.menuTap)return;if(e?.target?.closest?.('[data-menu-btn]'))return;if(inSel)toggleSelId(n.id);else if(!selMode&&!editingNote)setEditingNote({id:n.id,text:n.text||n.title||n.content||''});};
              return(
                <div key={n.id} onTouchStart={onTS} onTouchMove={onTM} onTouchEnd={handleTap} onContextMenu={e=>{e.preventDefault();setNoteMenu(n);}} onClick={(e)=>{if(e.target?.closest?.('[data-menu-btn]'))return;if(e.type==='click'&&!('ontouchstart' in window)){if(inSel)toggleSelId(n.id);else if(!selMode&&!editingNote)setEditingNote({id:n.id,text:n.text||n.title||n.content||''});}}} className={`flex items-center gap-2 py-2 px-2 rounded-lg cursor-pointer transition-colors ${isSel?'bg-sage-100 dark:bg-sage-400/20':'hover:bg-sand-100 dark:hover:bg-bark-600/50'}`}>
                  {inSel&&<SelCheck checked={isSel} onToggle={()=>toggleSelId(n.id)}/>}
                  {!inSel&&<span className={`flex-shrink-0 ${n.struck?'text-bark-400/40':'text-sage-400'}`}>â€¢</span>}
                  {editingNote&&editingNote.id===n.id?
                    <input autoFocus type="text" value={editingNote.text} onChange={e=>setEditingNote({...editingNote,text:e.target.value})} onKeyDown={e=>{if(e.key==='Enter'){e.preventDefault();updateBullet(n.id,editingNote.text);}if(e.key==='Escape')setEditingNote(null);}} onBlur={()=>updateBullet(n.id,editingNote.text)} onClick={e=>e.stopPropagation()} className="flex-1 bg-transparent focus:outline-none text-bark-700 dark:text-sand-100 border-b-2 border-sage-400 font-medium"/>
                  :<span className={`flex-1 sel leading-relaxed ${n.struck?'line-through text-bark-400/50 dark:text-sand-300/40':'text-bark-700 dark:text-cream-100 font-medium'}`}>{n.text||n.title||n.content}</span>}
                  {!inSel&&!editingNote&&<button data-menu-btn onTouchStart={e=>{touchData.menuTap=true;}} onClick={e=>{e.stopPropagation();e.preventDefault();setNoteMenu(n);}} className="p-2 rounded-lg text-bark-600 dark:text-sand-200 hover:text-bark-700 dark:hover:text-white hover:bg-sand-200 dark:hover:bg-bark-500 transition-colors flex-shrink-0" aria-label="More options"><I.MoreV s={18}/></button>}
                </div>
              );
            })}
          </div>
        </div>
      ))}
      {noteMenu&&<ActionMenu title={noteMenu.text||noteMenu.title||noteMenu.content} onClose={()=>setNoteMenu(null)} actions={[
        {label:'Edit',icon:<I.Edit s={18} c="text-ocean-400"/>,action:()=>{setEditingNote({id:noteMenu.id,text:noteMenu.text||noteMenu.title||noteMenu.content||''});}},
        {label:'Copy Text',icon:<I.Copy s={18} c="text-bark-400"/>,action:()=>{navigator.clipboard.writeText(noteMenu.text||noteMenu.title||noteMenu.content||'');showT('ðŸ“‹ Copied!');}},
        {label:'Promote to Clarify',icon:<I.Check s={18} c="text-sage-500"/>,sub:'copy + strike',action:()=>noteToTodo(noteMenu)},
        {label:noteMenu.struck?'Remove Strikethrough':'Strikethrough',icon:<span className="w-[18px] h-[18px] flex items-center justify-center font-bold text-sm text-bark-400 line-through">S</span>,action:()=>toggleStrike(noteMenu.id)},
        {label:'Delete',icon:<I.Trash s={18} c="text-terracotta-400"/>,danger:true,action:()=>setConfirmDeleteNote(noteMenu)}
      ]}/>}
      {confirmDeleteNote&&<ConfirmDialog title="Delete note?" text="This action cannot be undone." confirmText="Delete" onConfirm={()=>{deleteBullet(confirmDeleteNote.id);setConfirmDeleteNote(null);}} onCancel={()=>setConfirmDeleteNote(null)}/>}
    </div>
  );
}

// ClarifySection â€” extracted from rTodos() (v16.2 refactor Step 4)
function ClarifySection({wide,desk,selMode,selSection,selIds,toggleSelId,enterSelMode,exitSelMode,setEdit,setLinkPicker}){
  const{todos,setTodos,doneTodo,undoneTodo,deleteTodo,addFocus,focus,openLinkedList,clearCompleted,doneCount,saveItem,showT}=useApp();
  const[expQ,setExpQ]=useState({ui:true,ni:true,un:true,nn:true});
  const[dragQ,setDragQ]=useState(null);
  const moveTodoQuad=(tid,nq)=>{setTodos(t=>t.map(x=>x.id===tid?{...x,quad:nq}:x));setDragQ(null);showT(`â†’ ${QUADS.find(q=>q.id===nq)?.l}`);};
  const[taskMenu,setTaskMenu]=useState(null);
  const[confirmDeleteTask,setConfirmDeleteTask]=useState(null);
  const hasFocus=taskMenu&&focus.find(x=>x.id===taskMenu.id);

  const content=QUADS.map(q=>{
    const tasks=todos.filter(t=>t.quad===q.id).sort((a,b)=>(a.done?1:0)-(b.done?1:0));
    const isExp=expQ[q.id];
    const vis=isExp?tasks:tasks.slice(0,2);
    return(
      <div key={q.id} className={`rounded-2xl border-2 ${q.bdr} ${q.dbdr} overflow-hidden transition-all ${dragQ&&dragQ!==q.id?'ring-2 ring-sage-300 ring-offset-1':''}`}
        onDragOver={e=>{e.preventDefault();e.dataTransfer.dropEffect='move';}}
        onDrop={e=>{e.preventDefault();const tid=e.dataTransfer.getData('text/plain');if(tid&&q.id!==todos.find(x=>x.id===tid)?.quad)moveTodoQuad(tid,q.id);}}>
        <button onClick={()=>setExpQ({...expQ,[q.id]:!isExp})} className={`w-full p-2 md:p-3 bg-gradient-to-r ${q.clr} ${q.dclr} flex items-center justify-between`}><div><h3 className={`font-bold text-sm md:text-base ${q.txt} ${q.dtxt}`}>{q.l}</h3><p className="text-[11px] md:text-xs text-bark-500/60 dark:text-sand-300/50">{q.sub}</p></div><div className="flex items-center gap-2"><span className={`text-sm md:text-base font-semibold ${q.txt} ${q.dtxt}`}>{tasks.length}</span>{isExp?<I.Up s={16} c={`${q.txt} ${q.dtxt}`}/>:<I.Down s={16} c={`${q.txt} ${q.dtxt}`}/>}</div></button>
        <div className={`bg-white/40 dark:bg-white/5 ${tasks.length>0?'p-2 md:p-3':'p-1'}`}>
          {tasks.length===0?<Empty.Tasks/>:(
            <div className="space-y-1.5">
              {vis.map(t=>{
                const inSel=selMode&&selSection==='todos';
                const isSel=inSel&&selIds.has(t.id);
                return(
                  <div key={t.id} className="gcard rounded-xl overflow-hidden">
                  <div draggable={!t.done&&!selMode&&desk} onDragStart={e=>{e.dataTransfer.setData('text/plain',t.id);e.dataTransfer.effectAllowed='move';setDragQ(q.id);}} onDragEnd={()=>setDragQ(null)} onContextMenu={e=>{e.preventDefault();setTaskMenu(t);}} onClick={()=>{if(inSel)toggleSelId(t.id);else if(!selMode&&!t.done)doneTodo(t.id);else if(!selMode&&t.done)undoneTodo(t.id);}} className={`p-3 md:px-3 md:py-2 flex items-center gap-2 md:gap-2.5 transition-colors cursor-pointer ${t.done?'opacity-70':''} ${isSel?'ring-2 ring-sage-400 bg-sage-50 dark:bg-sage-400/10':'hover:bg-sand-50 dark:hover:bg-bark-600/50'}`}>
                    {inSel&&<SelCheck checked={isSel} onToggle={()=>toggleSelId(t.id)}/>}
                    {!inSel&&<button onClick={e=>{e.stopPropagation();t.done?undoneTodo(t.id):doneTodo(t.id);}} className={`w-6 h-6 md:w-5 md:h-5 rounded-full border-2 flex items-center justify-center group flex-shrink-0 transition-all ${t.done?'bg-sage-400 border-sage-400':'border-sage-400 hover:bg-sage-400'}`}><span className={`text-sm md:text-xs font-semibold ${t.done?'text-white':'text-sage-400 group-hover:text-white'}`}>âœ“</span></button>}
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2">
                        <span className={`font-semibold sel md:text-sm md:leading-snug leading-relaxed ${t.done?'line-through text-bark-400 dark:text-sand-300':'text-bark-700 dark:text-cream-100'}`}>{t.text}</span>
                        {t.linkedList&&<span className="text-xs opacity-60" title="Linked checklist">ðŸ“‹</span>}
                      </div>
                      {(t.cat||t.deadline||t.subtasks?.length>0)&&(
                        <div className="flex items-center gap-2 flex-wrap text-xs mt-1">
                          {t.cat&&<span className="px-2 py-0.5 rounded-full bg-sage-100 dark:bg-sage-400/20 text-sage-600 dark:text-sage-300 font-medium">{CATS.find(c=>c.id===t.cat)?.e} {CATS.find(c=>c.id===t.cat)?.l}</span>}
                          {t.deadline&&<span className="px-2 py-0.5 rounded-full bg-ocean-100 dark:bg-ocean-400/20 text-ocean-500 dark:text-ocean-300 font-medium">ðŸ“… {t.deadline}</span>}
                          {t.subtasks?.length>0&&<span className="px-2 py-0.5 rounded-full bg-lavender-100 dark:bg-lavender-400/20 text-lavender-500 dark:text-lavender-300 font-medium">â˜‘ï¸ {t.subtasks.filter(x=>x.done).length}/{t.subtasks.length}</span>}
                        </div>
                      )}
                      {t.poms>0&&<div className="flex items-center gap-1.5 mt-1"><span className="text-terracotta-400 font-bold text-sm">ðŸ… {t.poms}</span></div>}
                    </div>
                    {!inSel&&<button onClick={e=>{e.stopPropagation();setTaskMenu(t);}} className="p-1.5 rounded-lg text-bark-600 dark:text-sand-200 hover:text-bark-700 dark:hover:text-white hover:bg-sand-200 dark:hover:bg-bark-500 transition-colors flex-shrink-0" aria-label="More options"><I.MoreV s={18}/></button>}
                  </div>
                </div>
              );})}
              {tasks.length>2&&!isExp&&<button onClick={()=>setExpQ({...expQ,[q.id]:true})} className="w-full py-2 text-center text-sm text-bark-400/60 font-medium">Show {tasks.length-2} more...</button>}
            </div>
          )}
        </div>
      </div>
    );
  });
  return(
    <div className="space-y-4">
      <div className={`sticky ${wide?"top-0 -mx-8":"top-0 -mx-4 md:-mx-8"} z-10 glass px-4 md:px-6 py-3 md:py-4 mb-4`}>
        {selMode&&selSection==='todos'?<div className="flex items-center justify-center relative"><button onClick={exitSelMode} className="absolute left-0 px-3 py-1.5 bg-sand-200 dark:bg-bark-600 rounded-lg text-bark-600 dark:text-sand-100 text-sm font-semibold">âœ• Cancel</button><h2 className="text-lg md:text-xl font-bold text-sage-500">{selIds.size} selected</h2></div>:
        <div className="flex items-center justify-center relative">
          {todos.length>0&&<button onClick={()=>enterSelMode('todos',null)} className="absolute left-0 w-7 h-7 rounded-md border-2 border-bark-300 dark:border-sand-300 flex items-center justify-center hover:border-sage-400 transition-colors" aria-label="Select items"><span className="sr-only">Select</span></button>}
          <h2 className="text-lg md:text-xl font-bold text-bark-600 dark:text-sand-100">ðŸ“‹ Clarify</h2>
          <div className="absolute right-0 flex items-center gap-2">{doneCount>0&&<button onClick={()=>clearCompleted('todos')} className="px-3 py-1.5 rounded-lg bg-sand-200 dark:bg-bark-600 text-bark-500 dark:text-sand-200 text-xs font-semibold hover:bg-terracotta-100 hover:text-terracotta-500 transition-colors" aria-label="Clear completed tasks">ðŸ§¹ {doneCount}</button>}<button onClick={()=>setEdit({type:'todo',item:{}})} aria-label="Add new task" className="p-2 rounded-xl bg-sage-400 text-white shadow-sm hover:bg-sage-500 transition-colors"><I.Plus s={20}/></button></div>
        </div>}
      </div>
      <div className={desk?'md-grid':'space-y-3'}>{content}</div>
      <div className={desk?'max-w-[calc(50%-0.5rem)]':''}><QuickAdd placeholder="Quick add task..." onAdd={text=>saveItem('todo',{text,quad:'nn',poms:0})}/></div>
      {taskMenu&&<ActionMenu title={taskMenu.text} onClose={()=>setTaskMenu(null)} actions={[
        taskMenu.done?{label:'Mark Undone',icon:<I.Restore s={18} c="text-ocean-400"/>,action:()=>undoneTodo(taskMenu.id)}:{label:'Mark Done',icon:<I.Done s={18} c="text-sage-500"/>,action:()=>doneTodo(taskMenu.id)},
        !taskMenu.done&&{label:'Edit',icon:<I.Edit s={18} c="text-ocean-400"/>,action:()=>setEdit({type:'todo',item:taskMenu})},
        !taskMenu.done&&!hasFocus&&{label:'â†’ Focus Queue',icon:<I.Focus s={18} c="text-sage-500"/>,action:()=>addFocus(taskMenu)},
        !taskMenu.done&&!taskMenu.linkedList&&{label:'ðŸ“‹ Link Checklist',icon:<I.List s={18} c="text-terracotta-400"/>,action:()=>setLinkPicker(taskMenu)},
        taskMenu.linkedList&&{label:'ðŸ“‹ Open Checklist',icon:<I.List s={18} c="text-sage-500"/>,action:()=>openLinkedList(taskMenu)},
        {label:'Delete',icon:<I.Trash s={18} c="text-terracotta-400"/>,danger:true,action:()=>setConfirmDeleteTask(taskMenu)}
      ].filter(Boolean)}/>}
      {confirmDeleteTask&&<ConfirmDialog title="Delete task?" text="This action cannot be undone." confirmText="Delete" onConfirm={()=>{deleteTodo(confirmDeleteTask.id);setConfirmDeleteTask(null);}} onCancel={()=>setConfirmDeleteTask(null)}/>}
    </div>
  );
}

// FocusSection â€” extracted from rFocus() (v16.2 refactor Step 5)
function FocusSection({wide,desk,onTimerTick}){
  const{tSet,poms,met,focus,setFocus,activeF,setActiveF,handleTimerComplete,handleUpdatePoms,doneFocus}=useApp();
  const[dragI,setDragI]=useState(null);
  const[dragO,setDragO]=useState(null);
  const handleDS=i=>setDragI(i);
  const handleDO=(e,i)=>{e.preventDefault();setDragO(i);};
  const handleDE=()=>{if(dragI!==null&&dragO!==null&&dragI!==dragO){const n=[...focus],[d]=n.splice(dragI,1);n.splice(dragO,0,d);setFocus(n);}setDragI(null);setDragO(null);};

  const statsCards=[{v:poms,l:'Session',i:'ðŸ…',c:'text-terracotta-400'},{v:met.d.t,l:'Tasks',i:'âœ“',c:'text-sage-500'},{v:`${met.d.m}m`,l:'Focus',i:'â±',c:'text-ocean-400'}].map((s,i)=><div key={i} className="gcard rounded-xl p-3 md:p-4 text-center"><div className={`text-xl md:text-2xl font-bold ${s.c}`}>{s.v}</div><div className="text-[11px] md:text-xs text-bark-400/60 dark:text-sand-300/60 font-medium">{s.i} {s.l}</div></div>);

  const renderQueue=(compact)=>(<>
    <div className="flex items-center justify-between mb-3 px-1"><h3 className="font-bold text-bark-600 dark:text-sand-100 flex items-center gap-2"><I.Focus s={20} c="text-sage-500"/>Focus Queue<span className="text-sm font-normal text-bark-400/50 dark:text-sand-300/50">({focus.length}/5)</span></h3><span className="text-xs text-bark-400/50 dark:text-sand-300/50 font-medium">Drag to reorder</span></div>
    <div className="space-y-2">
      {focus.map((t,i)=>(
        <div key={t.id} draggable={desk} onDragStart={()=>handleDS(i)} onDragOver={e=>handleDO(e,i)} onDragEnd={handleDE} onClick={()=>setActiveF(t.id===activeF?null:t.id)} className={`gcard ${compact?'rounded-2xl px-3 py-2':'rounded-2xl p-4'} focus-item flex items-center gap-${compact?'2.5':'3 md:gap-4'} cursor-grab active:cursor-grabbing transition-all ${activeF===t.id?'ring-2 ring-sage-400':''} ${dragI===i?'opacity-50':''} ${dragO===i?'ring-2 ring-sage-300':''}`}>
          <div className="text-bark-400/30 dark:text-sand-300/30" aria-hidden="true"><I.Drag s={20}/></div>
          <button onClick={e=>{e.stopPropagation();doneFocus(t.id);}} aria-label="Complete task" className="w-7 h-7 rounded-full border-2 border-sage-400 hover:bg-sage-400 flex items-center justify-center transition-colors flex-shrink-0 group"><span className="text-sage-400 group-hover:text-white text-sm">âœ“</span></button>
          <div className="flex-1 min-w-0"><span className="block truncate text-bark-600 dark:text-sand-100 font-medium sel">{t.text}</span>{t.cat&&<span className="text-xs text-bark-400/60 dark:text-sand-300/60">{CATS.find(c=>c.id===t.cat)?.e} {CATS.find(c=>c.id===t.cat)?.l}</span>}</div>
          {t.poms>0&&<span className="text-terracotta-400 text-sm font-semibold">ðŸ…{t.poms}</span>}
          <button onClick={e=>{e.stopPropagation();setFocus(focus.filter(x=>x.id!==t.id));if(activeF===t.id)setActiveF(null);}} aria-label="Remove from focus queue" className="text-bark-400/40 hover:text-terracotta-400 transition-colors">â†</button>
        </div>
      ))}
      {focus.length===0&&<Empty.Focus/>}
    </div>
  </>);

  return(
    <div className="space-y-5">
      <div className={`sticky ${wide?"top-0 -mx-8":"top-0 -mx-4 md:-mx-8"} z-10 glass px-4 md:px-6 py-3 md:py-4 mb-4`}>
        <h2 className="text-lg md:text-xl font-bold text-bark-600 dark:text-sand-100 text-center">ðŸŽ¯ Focus</h2>
      </div>
      <div className="flex flex-col md:flex-row gap-5 md:gap-6 items-start">
        <div className="w-full md:flex-1 min-w-0 space-y-4">
          <FocusTimer tSet={tSet} onComplete={handleTimerComplete} onUpdatePoms={handleUpdatePoms} activeTaskId={activeF} activeTaskText={activeF?focus.find(t=>t.id===activeF)?.text:null} onTick={onTimerTick}/>
          <div className="grid grid-cols-3 gap-2 md:gap-3">{statsCards}</div>
        </div>
        <div className="w-full md:flex-1 min-w-0">{renderQueue(desk)}</div>
      </div>
    </div>
  );
}

// ConfirmSection â€” extracted from rLists() + rListContent() (v16.2 refactor Step 6)
function ConfirmSection({wide,desk,selMode,selSection,selIds,toggleSelId,enterSelMode,exitSelMode,setEdit}){
  const{lists,setLists,todos,selList,setSelList,doneList,doneTodo,saveItem,showT,setTab}=useApp();
  const{updateListName,deleteList}=useApp();
  const[newList,setNewList]=useState('');
  const[showNew,setShowNew]=useState(false);
  const[editListId,setEditListId]=useState(null);
  const[editListName,setEditListName]=useState('');
  const[activeListMenu,setActiveListMenu]=useState(null);
  const[confirmDeleteList,setConfirmDeleteList]=useState(null);
  const handleUpdateListName=(listId,newName)=>{updateListName(listId,newName);setEditListId(null);setEditListName('');};
  const handleDeleteList=(listId)=>{deleteList(listId);setActiveListMenu(null);};

  const rListContent=(cl,isSecondary)=>{
    if(!cl)return null;
    const secs=[...new Set(cl.items.map(i=>i.section)||[])];
    const linkedTask=todos.find(t=>t.linkedList===cl.id);
    const allDone=cl.items.length>0&&cl.items.every(i=>i.done);
    return(
      <div className="space-y-3">
        <div className="flex items-center justify-between px-1">
          <h3 className="font-bold text-bark-600 dark:text-sand-100 text-sm md:text-base truncate">{cl.name}</h3>
          <button onClick={()=>setEdit({type:'list',item:{},listId:cl.id})} className="p-1.5 rounded-lg bg-sage-400 text-white hover:bg-sage-500 transition-colors flex-shrink-0"><I.Plus s={16}/></button>
        </div>
        {linkedTask&&<div className={`p-2.5 rounded-xl flex items-center justify-between ${allDone?'bg-sage-100 dark:bg-sage-400/20 border border-sage-300 dark:border-sage-400/40':'gcard'}`}><div className="flex items-center gap-2 min-w-0"><span className="text-xs">ðŸŽ¯</span><span className="text-sm font-medium text-bark-600 dark:text-sand-100 truncate">{linkedTask.text}</span></div>{allDone&&!linkedTask.done?<button onClick={()=>{doneTodo(linkedTask.id);showT('ðŸŽ‰ Task completed!');}} className="px-3 py-1 bg-sage-400 text-white rounded-lg text-xs font-bold flex-shrink-0 ml-2">âœ“ Done</button>:<button onClick={()=>{setTab('todos');}} className="text-xs text-ocean-400 font-medium flex-shrink-0 ml-2">View â†’</button>}</div>}
        {secs.length>0?secs.map(s=>(
          <div key={s} className="space-y-1.5">
            <h4 className="text-xs font-bold text-bark-400/60 dark:text-sand-300/50 uppercase tracking-wider px-2">{s}</h4>
            <div className="space-y-1.5">
            {cl.items.filter(i=>i.section===s).sort((a,b)=>(a.done?1:0)-(b.done?1:0)).map(item=>{
              const inSel=selMode&&selSection==='lists';
              const isSel=inSel&&selIds.has(item.id);
              return(
                <div key={item.id} className="gcard rounded-xl overflow-hidden">
                <div onClick={()=>{if(inSel)toggleSelId(item.id);else if(!selMode)doneList(cl.id,item.id);}} onContextMenu={e=>{e.preventDefault();setEdit({type:'list',item,listId:cl.id});}} className={`p-3 md:px-3 md:py-2 flex items-center gap-2 md:gap-2.5 cursor-pointer transition-colors ${item.done?'opacity-70':''} ${isSel?'ring-2 ring-sage-400 bg-sage-50 dark:bg-sage-400/10':'hover:bg-sand-50 dark:hover:bg-bark-600/50'}`}>
                  {inSel&&<SelCheck checked={isSel} onToggle={()=>toggleSelId(item.id)}/>}
                  {!inSel&&<button onClick={e=>{e.stopPropagation();doneList(cl.id,item.id);}} className={`w-6 h-6 md:w-5 md:h-5 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0 ${item.done?'bg-sage-400 border-sage-400':'border-bark-300 dark:border-sand-300 hover:border-sage-400'}`}>{item.done&&<span className="text-white text-sm md:text-xs">âœ“</span>}</button>}
                  <div className="flex-1 min-w-0">
                    <span className={`block font-medium sel md:text-sm ${item.done?'line-through text-bark-400/60':'text-bark-700 dark:text-cream-100'}`}>{item.text}</span>
                    {item.notes&&<p className="text-xs text-bark-500 dark:text-sand-300 mt-1 truncate sel">ðŸ“ {item.notes}</p>}
                  </div>
                  {!inSel&&<button onClick={e=>{e.stopPropagation();setEdit({type:'list',item,listId:cl.id});}} className="p-1.5 rounded-lg text-bark-600 dark:text-sand-200 hover:text-bark-700 dark:hover:text-white hover:bg-sand-200 dark:hover:bg-bark-500 transition-colors flex-shrink-0" aria-label="More options"><I.MoreV s={18}/></button>}
                </div>
              </div>
            );})}
            </div>
          </div>
        )):<Empty.List/>}
        <QuickAdd placeholder="Quick add item..." onAdd={text=>saveItem('list',{text},cl.id)}/>
      </div>
    );
  };

  const cl=lists.find(l=>l.id===selList);
  const otherLists=lists.filter(l=>l.id!==selList);
  const secondList=desk&&otherLists.length>0?otherLists[0]:null;

  if(lists.length===0){
    return(
      <div className="space-y-4">
        <div className={`sticky ${wide?"top-0 -mx-8":"top-0 -mx-4 md:-mx-8"} z-10 glass px-4 md:px-6 py-3 md:py-4 mb-4`}>
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg md:text-xl font-bold text-bark-600 dark:text-sand-100">âœ… Confirm</h2>
          </div>
        </div>
        <Empty.NoLists onCreate={()=>setShowNew(true)}/>
        {showNew&&<div className="flex gap-2 mb-4"><input type="text" value={newList} onChange={e=>setNewList(e.target.value)} placeholder="Checklist name..." className="flex-1 gcard rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100" onKeyDown={e=>{if(e.key==='Enter'&&newList.trim()){const id=uid();setLists([...lists,{id,name:newList,items:[]}]);setSelList(id);setNewList('');setShowNew(false);}}}/><button onClick={()=>{if(newList.trim()){const id=uid();setLists([...lists,{id,name:newList,items:[]}]);setSelList(id);setNewList('');setShowNew(false);}}} className="px-4 py-2 bg-sage-400 rounded-xl text-white font-semibold">Add</button><button onClick={()=>setShowNew(false)} className="px-3 py-2 gcard rounded-xl text-bark-500" aria-label="Cancel">âœ•</button></div>}
      </div>
    );
  }

  return(
    <div className="space-y-4">
      <div className={`sticky ${wide?"top-0 -mx-8":"top-0 -mx-4 md:-mx-8"} z-10 glass px-4 md:px-6 py-3 md:py-4 mb-4`}>
        <div className="flex items-center justify-between mb-3">
          {selMode&&selSection==='lists'?<div className="flex items-center justify-center relative w-full"><button onClick={exitSelMode} className="absolute left-0 px-3 py-1.5 bg-sand-200 dark:bg-bark-600 rounded-lg text-bark-600 dark:text-sand-100 text-sm font-semibold">âœ• Cancel</button><h2 className="text-lg md:text-xl font-bold text-sage-500">{selIds.size} selected</h2></div>:<>
          <div className="flex items-center justify-center relative w-full">
            {cl&&cl.items.length>0&&<button onClick={()=>enterSelMode('lists',null)} className="absolute left-0 w-7 h-7 rounded-md border-2 border-bark-300 dark:border-sand-300 flex items-center justify-center hover:border-sage-400 transition-colors" aria-label="Select items"><span className="sr-only">Select</span></button>}
            <h2 className="text-lg md:text-xl font-bold text-bark-600 dark:text-sand-100">âœ… Confirm</h2>
            <button onClick={()=>setEdit({type:'list',item:{},listId:selList})} aria-label="Add item to list" className="absolute right-0 p-2 rounded-xl bg-sage-400 text-white shadow-sm hover:bg-sage-500 transition-colors"><I.Plus s={20}/></button>
          </div></>}
        </div>
        {editListId?<div className="flex gap-2 mb-2"><input type="text" value={editListName} onChange={e=>setEditListName(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')handleUpdateListName(editListId,editListName);if(e.key==='Escape'){setEditListId(null);setEditListName('');}}} autoFocus className="flex-1 gcard rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100" placeholder="Checklist name..."/><button onClick={()=>handleUpdateListName(editListId,editListName)} className="px-4 py-2 bg-sage-400 rounded-xl text-white font-semibold">Save</button><button onClick={()=>{setEditListId(null);setEditListName('');}} className="px-3 py-2 gcard rounded-xl text-bark-500" aria-label="Cancel">âœ•</button></div>:null}
        <div className="flex gap-2 overflow-x-auto pb-2 hide-sb">{lists.map(l=>{
          return <button key={l.id} onClick={()=>setSelList(l.id)} onContextMenu={e=>{e.preventDefault();setActiveListMenu(l);}} className={`px-4 md:px-5 py-2 md:py-2.5 rounded-2xl whitespace-nowrap font-semibold transition-all flex items-center gap-2 md:text-base ${selList===l.id?'bg-sage-400 text-white soft-shadow':'bg-sand-100 dark:bg-bark-600 text-bark-600 dark:text-sand-100'}`}>{l.name}{l.items.length>0&&<span className={`px-2 py-0.5 rounded-full text-xs ${selList===l.id?'bg-white/30':'bg-sage-100 dark:bg-sage-400/30 text-sage-600 dark:text-sage-300'}`}>{l.items.filter(i=>!i.done).length}</span>}</button>;
        })}<button onClick={()=>setShowNew(true)} aria-label="Create new list" className="px-4 py-2 rounded-2xl bg-sand-100 dark:bg-bark-600 whitespace-nowrap text-bark-600 dark:text-sand-100 font-semibold"><I.Plus s={18} c="inline"/></button></div>
      </div>
      {showNew&&<div className="flex gap-2 mb-4"><input type="text" value={newList} onChange={e=>setNewList(e.target.value)} placeholder="Checklist name..." className="flex-1 gcard rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100" onKeyDown={e=>{if(e.key==='Enter'&&newList.trim()){const id=uid();setLists([...lists,{id,name:newList,items:[]}]);setSelList(id);setNewList('');setShowNew(false);}}}/><button onClick={()=>{if(newList.trim()){const id=uid();setLists([...lists,{id,name:newList,items:[]}]);setSelList(id);setNewList('');setShowNew(false);}}} className="px-4 py-2 bg-sage-400 rounded-xl text-white font-semibold">Add</button><button onClick={()=>setShowNew(false)} className="px-3 py-2 gcard rounded-xl text-bark-500" aria-label="Cancel">âœ•</button></div>}
      {cl&&!desk&&<button onClick={()=>{let t=`ðŸ“‹ ${cl.name}\n${'â”€'.repeat(20)}\n\n`;[...new Set(cl.items.map(i=>i.section))].forEach(s=>{t+=`ã€${s}ã€‘\n`;cl.items.filter(i=>i.section===s).forEach(i=>{t+=`${i.done?'âœ…':'â˜'} ${i.text}\n`;});t+='\n';});if(navigator.share)navigator.share({title:cl.name,text:t}).catch(()=>{});else{navigator.clipboard.writeText(t);showT('ðŸ“‹ Copied!');}}} className="w-full py-2.5 gcard rounded-2xl text-ocean-400 text-sm font-semibold flex items-center justify-center gap-2 mb-4"><I.Share s={18}/>Share "{cl.name}"</button>}
      {desk?(
        <div className="grid grid-cols-2 gap-6 items-start">
          <div className="gcard rounded-2xl p-4">{rListContent(cl)}</div>
          {secondList?<div className="gcard rounded-2xl p-4">{rListContent(secondList,true)}</div>:<div/>}
        </div>
      ):(
        <>{rListContent(cl)}</>
      )}
      {activeListMenu&&<ActionMenu title={activeListMenu.name} onClose={()=>setActiveListMenu(null)} actions={[
        {label:'Edit Name',icon:<I.Edit s={18} c="text-ocean-400"/>,action:()=>{setEditListId(activeListMenu.id);setEditListName(activeListMenu.name);}},
        {label:'Delete Checklist',icon:<I.Trash s={18} c="text-terracotta-400"/>,danger:true,action:()=>{if(lists.length===1)showT('Cannot delete last list');else setConfirmDeleteList(activeListMenu);}}
      ]}/>}
      {confirmDeleteList&&<ConfirmDialog title={`Delete "${confirmDeleteList.name}"?`} text="This checklist and its items will be permanently removed." confirmText="Delete" onConfirm={()=>{handleDeleteList(confirmDeleteList.id);setConfirmDeleteList(null);}} onCancel={()=>setConfirmDeleteList(null)}/>}
      {/* Note: Single-list delete protection handled in action logic above */}
    </div>
  );
}

// ReviewSection â€” extracted from rReview() (v16.2 refactor Step 7)
function ReviewSection({wide}){
  const{todos,notes,focus,met,dHist,wkData}=useApp();
  const qc=QUADS.map(q=>({...q,n:todos.filter(t=>t.quad===q.id&&!t.done).length}));
  const cc=CATS.map(c=>({...c,n:todos.filter(t=>t.cat===c.id&&!t.done).length})).filter(c=>c.n>0);
  const active=todos.filter(t=>!t.done).length;
  const done=todos.filter(t=>t.done).length;
  const overdue=todos.filter(t=>!t.done&&t.deadline&&t.deadline<new Date().toISOString().split('T')[0]);
  const nWeek=notes.filter(n=>{const d=new Date(n.crAt||n.date);return Date.now()-d.getTime()<7*864e5;}).length;
  const struck=notes.filter(n=>n.struck).length;

  const ins=[];
  if(qc[0].n>5)ins.push({e:'ðŸ”¥',t:'Overloaded',m:`${qc[0].n} urgent+important tasks. Delegate or schedule some.`});
  if(qc[3].n>3)ins.push({e:'ðŸ—‘',t:'Clean up',m:`${qc[3].n} tasks in Eliminate. Review if still needed.`});
  if(overdue.length>0)ins.push({e:'â°',t:`${overdue.length} overdue`,m:overdue.map(t=>t.text).slice(0,2).join(', ')+(overdue.length>2?'...':'')});
  if(focus.length===0&&active>0)ins.push({e:'ðŸŽ¯',t:'Empty focus queue',m:'Pick 1â€“3 tasks to focus on today.'});
  if(focus.length>=4)ins.push({e:'ðŸŒ¿',t:'Focus queue full',m:'Finish current tasks before adding more.'});
  if(struck>3)ins.push({e:'ðŸ“',t:'Struck notes',m:`${struck} struck notes. Clear or convert to tasks.`});
  if(nWeek>10)ins.push({e:'ðŸ’¡',t:'Active capture',m:`${nWeek} notes this week. Promote the best to Clarify.`});
  if(done>0&&active>0)ins.push({e:'ðŸ“Š',t:'Completion',m:`${done}/${done+active} (${Math.round(done/(done+active)*100)}%)`});
  if(met.w.p>0)ins.push({e:'ðŸ…',t:`${met.w.p} pomodoros`,m:`${Math.floor(met.w.m/60)}h ${met.w.m%60}m deep focus this week.`});
  if(ins.length===0)ins.push({e:'âœ¨',t:'Looking good!',m:'No issues found. Keep it up.'});

  const sug=[];
  if(qc[1].n>0)sug.push(`Schedule time for ${qc[1].n} important task${qc[1].n>1?'s':''}`);
  if(overdue.length>0)sug.push('Reschedule or complete overdue tasks');
  if(active>10)sug.push('Eliminate low-value tasks to reduce overwhelm');
  if(focus.length<3&&active>0)sug.push('Add top priorities to Focus queue');
  if(struck>0)sug.push(`Convert or delete ${struck} struck notes`);

  const weekStats=<div className="gcard rounded-2xl p-4"><h3 className="font-bold text-bark-600 dark:text-sand-100 mb-3">This Week</h3><div className="grid grid-cols-3 gap-3 text-center"><div><div className="text-2xl font-bold text-terracotta-400">{met.w.p}</div><div className="text-xs text-bark-400/50 dark:text-sand-300/50">ðŸ… Pomodoros</div></div><div><div className="text-2xl font-bold text-sage-500">{met.w.t}</div><div className="text-xs text-bark-400/50 dark:text-sand-300/50">âœ“ Tasks</div></div><div><div className="text-2xl font-bold text-ocean-400">{Math.floor(met.w.m/60)}h{met.w.m%60>0?`${met.w.m%60}m`:''}</div><div className="text-xs text-bark-400/50 dark:text-sand-300/50">â± Focus</div></div></div></div>;
  const matrixCard=<div className="gcard rounded-2xl p-4"><h3 className="font-bold text-bark-600 dark:text-sand-100 mb-3">Matrix Overview</h3><div className="grid grid-cols-2 gap-2">{qc.map(q=><div key={q.id} className={`rounded-xl p-3 bg-gradient-to-r ${q.clr} ${q.dclr} border ${q.bdr} ${q.dbdr}`}><div className={`text-lg font-bold ${q.txt} ${q.dtxt}`}>{q.n}</div><div className="text-xs text-bark-500/70 dark:text-sand-300/50">{q.l}</div></div>)}</div>{cc.length>0&&<div className="flex flex-wrap gap-2 mt-3">{cc.map(c=><span key={c.id} className="px-2 py-1 rounded-full text-xs font-medium bg-sand-100 dark:bg-bark-600 text-bark-600 dark:text-sand-200">{c.e} {c.l}: {c.n}</span>)}</div>}</div>;
  const insightsCard=<div className="gcard rounded-2xl p-4"><h3 className="font-bold text-bark-600 dark:text-sand-100 mb-3">Insights</h3><div className="space-y-2">{ins.map((x,i)=><div key={i} className="flex items-start gap-3 p-3 rounded-xl bg-sand-50 dark:bg-bark-600/50"><span className="text-lg">{x.e}</span><div><div className="font-semibold text-sm text-bark-600 dark:text-sand-100">{x.t}</div><div className="text-xs text-bark-500 dark:text-sand-300">{x.m}</div></div></div>)}</div></div>;
  const actionsCard=sug.length>0?<div className="gcard rounded-2xl p-4"><h3 className="font-bold text-bark-600 dark:text-sand-100 mb-3">ðŸ’¡ Next Actions</h3><div className="space-y-2">{sug.map((s,i)=><div key={i} className="flex items-start gap-2 text-sm text-bark-600 dark:text-sand-100"><span className="text-sage-500 mt-0.5">â†’</span><span>{s}</span></div>)}</div></div>:null;

  return(
    <div className="space-y-4">
      <div className={`sticky ${wide?"top-0 -mx-8":"top-0 -mx-4 md:-mx-8"} z-10 glass px-4 md:px-6 py-3 md:py-4 mb-4`}>
        <h2 className="text-lg md:text-xl font-bold text-bark-600 dark:text-sand-100 text-center">ðŸ“Š Review</h2>
      </div>
      <div className="grid grid-cols-1 xl:grid-cols-2 gap-4">
        <div className="space-y-4 order-1 xl:order-1 xl:col-start-1 xl:row-start-1">
          {weekStats}
          <Chart data={wkData} label="Weekly Pomodoros ðŸ…" clr="bg-terracotta-400"/>
        </div>
        <div className="space-y-4 order-2 xl:order-3 xl:col-start-2 xl:row-start-1">
          <Heatmap dHist={dHist} met={met}/>
          {insightsCard}
          {actionsCard}
        </div>
        <div className="order-3 xl:order-2 xl:col-start-1 xl:row-start-2">{matrixCard}</div>
      </div>
    </div>
  );
}

// SettingsSection â€” extracted from rMore() (v16.2 refactor Step 8)
function SettingsSection({desk}){
  const{theme,setTheme}=useContext(ThemeCtx);
  const{preset,setPreset,customT,setCustomT,showT}=useApp();
  const[moreSub,setMoreSub]=useState('settings');
  const[settExp,setSettExp]=useState({});
  const[helpExp,setHelpExp]=useState({});
  const[testSuiteState,setTestSuiteState]=useState({loading:false,error:'',pct:0,stage:''});
  const toggleHelp=(k)=>setHelpExp(s=>({...s,[k]:!s[k]}));
  const TestRunnerComp=window.TestRunner;

  useEffect(()=>{
    let active=true;
    if(moreSub!=='test')return undefined;
    if(window.TestRunner){
      setTestSuiteState({loading:false,error:'',pct:100,stage:'Ready'});
      return undefined;
    }
    setTestSuiteState({loading:true,error:'',pct:5,stage:'Starting...'});
    loadTestRunner((p)=>{if(active)setTestSuiteState(s=>({...s,loading:true,error:'',pct:p.pct,stage:p.stage}));})
      .then(()=>{if(active)setTestSuiteState({loading:false,error:'',pct:100,stage:'Ready'});})
      .catch((err)=>{if(active)setTestSuiteState({loading:false,error:err?.message||'Failed to load test suite.',pct:0,stage:''});});
    return()=>{active=false;};
  },[moreSub]);

  const themeCard=<div className="gcard rounded-2xl p-4"><h3 className="font-bold mb-3 text-bark-600 dark:text-sand-100 flex items-center gap-2"><I.Sun s={20} c="text-terracotta-400"/>Theme</h3><div className="flex gap-2">{[{id:'light',i:<I.Sun s={18}/>,l:'Light'},{id:'dark',i:<I.Moon s={18}/>,l:'Dark'},{id:'system',i:<I.Phone s={18}/>,l:'System'}].map(t=><button key={t.id} onClick={()=>setTheme(t.id)} className={`flex-1 py-2.5 rounded-xl font-semibold transition-all flex items-center justify-center gap-1.5 ${theme===t.id?'bg-sage-400 text-white':'bg-sand-100 dark:bg-bark-600 text-bark-600 dark:text-sand-100'}`}>{t.i}{t.l}</button>)}</div></div>;
  const timerCard=<div className="gcard rounded-2xl p-4"><h3 className="font-bold mb-3 text-bark-600 dark:text-sand-100 flex items-center gap-2"><I.Focus s={20} c="text-sage-500"/>Timer Duration</h3><div className="space-y-2">{Object.entries(PRESETS).map(([k,p])=><button key={k} onClick={()=>setPreset(k)} className={`w-full py-3 rounded-xl font-semibold transition-all text-left px-4 ${preset===k?'bg-sage-400 text-white':'bg-sand-100 dark:bg-bark-600 text-bark-600 dark:text-sand-100'}`}>{p.l} ({p.work}/{p.shortBreak}/{p.longBreak})</button>)}</div>{preset==='custom'&&<div className="mt-4 space-y-3">{[{k:'work',l:'Focus (min)'},{k:'shortBreak',l:'Short Break'},{k:'longBreak',l:'Long Break'}].map(({k,l})=><div key={k} className="flex items-center justify-between"><span className="text-bark-500/70 dark:text-sand-300 font-medium">{l}</span><input type="number" min="1" max="120" value={customT[k]} onChange={e=>setCustomT({...customT,[k]:parseInt(e.target.value)||1})} className="w-20 bg-sand-100 dark:bg-bark-600 rounded-xl px-3 py-2 text-center text-bark-600 dark:text-sand-100 font-semibold"/></div>)}</div>}</div>;
  const dataCard=<div className="gcard rounded-2xl p-4"><h3 className="font-bold mb-3 text-bark-600 dark:text-sand-100">ðŸ’¾ Data</h3><div className="space-y-2"><button onClick={async()=>{const data=await S.exp();dlFile(JSON.stringify(data,null,2),`backup-${new Date().toISOString().split('T')[0]}.json`,'application/json');showT('ðŸ’¾ Saved!');}} className="w-full py-3 bg-ocean-100 text-ocean-400 rounded-xl font-semibold">ðŸ“¤ Export Backup</button><label className="w-full py-3 bg-sage-100 text-sage-600 rounded-xl font-semibold flex items-center justify-center cursor-pointer">ðŸ“¥ Import Backup<input type="file" accept=".json" onChange={async e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=async ev=>{try{await S.imp(JSON.parse(ev.target.result));showT('âœ… Done!');setTimeout(()=>location.reload(),1000);}catch{showT('âŒ Error');}};r.readAsText(f);}} className="hidden"/></label><button onClick={async()=>{if(confirm('Reset all data?')){await S.clr();location.reload();}}} className="w-full py-3 bg-terracotta-100 text-terracotta-500 rounded-xl font-semibold">ðŸ—‘ Reset All</button></div></div>;
  const installContent=<div className="space-y-2"><div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-3"><span className="font-semibold text-bark-600 dark:text-sand-100">ðŸŽ iOS:</span><span className="text-sm text-bark-500 dark:text-sand-200 ml-2">Safari â†’ Share â†’ Add to Home Screen</span></div><div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-3"><span className="font-semibold text-bark-600 dark:text-sand-100">ðŸ¤– Android:</span><span className="text-sm text-bark-500 dark:text-sand-200 ml-2">Chrome â†’ â‹® â†’ Add to Home screen</span></div><div className="bg-lavender-50 dark:bg-bark-600/50 rounded-xl p-3"><span className="font-semibold text-bark-600 dark:text-sand-100">ðŸ’» Desktop:</span><span className="text-sm text-bark-500 dark:text-sand-200 ml-2">Chrome/Edge â†’ Install icon in URL bar</span></div></div>;
  const deskModeContent=<><p className="text-sm text-bark-500 dark:text-sand-200 mb-2">At 768px+ the app uses tablet layout. At 1280px+ a full desktop layout with sidebar.</p><div className="space-y-2"><div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-3"><h4 className="font-semibold text-bark-600 dark:text-sand-100 text-sm mb-1">Layouts</h4><ul className="text-xs text-bark-500 dark:text-sand-200 space-y-0.5"><li>â€¢ Sidebar replaces bottom tab bar</li><li>â€¢ Focus: timer + queue side-by-side</li><li>â€¢ Clarify/Confirm: 2-column grids</li><li>â€¢ Review: 2-column dashboard</li></ul></div><div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-3"><h4 className="font-semibold text-bark-600 dark:text-sand-100 text-sm mb-1">Interactions</h4><ul className="text-xs text-bark-500 dark:text-sand-200 space-y-0.5"><li>â€¢ Right-click â†’ action menu on any item</li><li>â€¢ Drag-and-drop in Focus Queue & matrix</li><li>â€¢ Live timer countdown in Focus tab label</li></ul></div></div></>;

  const responsiveInfoCard=(key,title,content)=>(
    <>
      <div className="hidden md:block gcard rounded-2xl p-4">
        <h3 className="font-bold text-bark-600 dark:text-sand-100 mb-3">{title}</h3>
        {content}
      </div>
      <div className="md:hidden gcard rounded-2xl overflow-hidden">
        <button onClick={()=>setSettExp(s=>({...s,[key]:!s[key]}))} className="w-full p-4 flex items-center justify-between">
          <h3 className="font-bold text-bark-600 dark:text-sand-100">{title}</h3>
          {settExp[key]?<I.Up s={16} c="text-bark-400 dark:text-sand-300"/>:<I.Down s={16} c="text-bark-400 dark:text-sand-300"/>}
        </button>
        {settExp[key]&&<div className="px-4 pb-4">{content}</div>}
      </div>
    </>
  );

  const helpSection=(key,title,content)=>(
    <div className="gcard rounded-2xl overflow-hidden">
      <button onClick={()=>!desk&&toggleHelp(key)} className={`w-full ${desk?'p-5':'p-4'} flex items-center justify-between text-left`}>
        <h3 className="text-xl font-bold text-bark-600 dark:text-sand-100">{title}</h3>
        {!desk&&(helpExp[key]?<I.Up s={16} c="text-bark-400 dark:text-sand-300"/>:<I.Down s={16} c="text-bark-400 dark:text-sand-300"/>)}
      </button>
      {(desk||helpExp[key])&&<div className={`${desk?'px-5 pb-5':'px-4 pb-4'}`}>{content}</div>}
    </div>
  );

  return(
    <div className="space-y-4">
      <div className="flex gap-2 md:gap-3 overflow-x-auto hide-sb">{[{id:'settings',l:'âš™ï¸ Settings'},{id:'help',l:'ðŸ“– Explainer'},{id:'test',l:'ðŸ§ª Test'}].map(t=><button key={t.id} onClick={()=>setMoreSub(t.id)} className={`px-4 md:px-5 py-2 md:py-2.5 rounded-2xl whitespace-nowrap font-semibold transition-all md:text-base more-sub-btn ${moreSub===t.id?'bg-sage-400 text-white soft-shadow':'gcard text-bark-600 dark:text-sand-100'}`}>{t.l}</button>)}</div>
      {moreSub==='settings'&&(
        <div className="flex flex-col md:flex-row gap-4">
          <div className="flex-1 min-w-0 space-y-4">
            {themeCard}
            <div className="md:hidden">{timerCard}</div>
            {dataCard}
            {responsiveInfoCard('desk','ðŸ–¥ï¸ Desktop Mode',deskModeContent)}
          </div>
          <div className="flex-1 min-w-0 space-y-4">
            <div className="hidden md:block">{timerCard}</div>
            {responsiveInfoCard('pwa','ðŸ“² Install as App',installContent)}
          </div>
        </div>
      )}
      {moreSub==='settings'&&<div className="text-center text-sm text-bark-400/60 dark:text-sand-300/50 pt-2"><p>Productivity Hub v{APP_VERSION}</p></div>}
      {moreSub==='help'&&(
        <div className={`pb-8 ${desk?'max-w-5xl mx-auto':''}`}> {/* Keep desk check for max-width constraint on help */}
          <div className="gcard rounded-2xl p-6 mb-6">
            <h2 className="text-2xl font-extrabold text-bark-600 dark:text-sand-100 mb-4">ðŸ“š Complete Guide</h2>
            <p className="text-bark-500 dark:text-sand-200">Productivity Hub combines the Bullet Journal method, GTD (Getting Things Done), Deep Work, and the Eisenhower Matrix into one seamless workflow.</p>
          </div>
          <div className={`${desk?'grid grid-cols-2 gap-5':'space-y-3'}`}>
          {helpSection('wf','ðŸ”„ The Workflow',<>
            <p className="text-bark-500 dark:text-sand-200 mb-4">Every productivity system follows one cycle. Ours has five steps, each mapped to a tab:</p>
            <div className="space-y-3">
              <div className="bg-lavender-50 dark:bg-bark-600/50 rounded-xl p-4"><div className="flex items-start gap-3"><span className="text-2xl">ðŸ“</span><div><div className="font-bold text-bark-600 dark:text-sand-100">1. Capture</div><div className="text-sm text-bark-500 dark:text-sand-200">Get everything out of your head. Jot quick bullet notes â€” ideas, tasks, thoughts, anything. Don't organize yet, just capture. Tap to edit inline, use â‹® menu for actions (promote to Clarify, strikethrough, delete), or use the â˜ header checkbox for bulk operations.</div></div></div></div>
              <div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-4"><div className="flex items-start gap-3"><span className="text-2xl">ðŸ“‹</span><div><div className="font-bold text-bark-600 dark:text-sand-100">2. Clarify</div><div className="text-sm text-bark-500 dark:text-sand-200">Decide what each item means. Place tasks in the Eisenhower Matrix: Do First, Schedule, Delegate, or Eliminate. Add categories, deadlines, and subtasks. Drag tasks between quadrants to re-prioritize. Tap any task to toggle done/undone. Use â‹® menu or right-click (desktop) for actions: edit, add to Focus Queue, link a checklist, or delete.</div></div></div></div>
              <div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-4"><div className="flex items-start gap-3"><span className="text-2xl">ðŸŽ¯</span><div><div className="font-bold text-bark-600 dark:text-sand-100">3. Focus</div><div className="text-sm text-bark-500 dark:text-sand-200">Pick 3â€“5 tasks for today's Focus Queue. Use the Pomodoro timer: 25 min work, 5 min break. After 4 cycles, take a longer break. On desktop, timer and queue display side-by-side. When the timer is running, a live countdown replaces the Focus tab label.</div></div></div></div>
              <div className="bg-terracotta-50 dark:bg-bark-600/50 rounded-xl p-4"><div className="flex items-start gap-3"><span className="text-2xl">âœ…</span><div><div className="font-bold text-bark-600 dark:text-sand-100">4. Confirm</div><div className="text-sm text-bark-500 dark:text-sand-200">Use checklists to break tasks into steps. Link a checklist to a Clarify task via â‹® menu â†’ Link Checklist. When all items are checked, you'll be prompted to mark the task done. Tap items to toggle done, use â‹® to edit or delete, and â˜ header checkbox for bulk operations.</div></div></div></div>
              <div className="bg-sand-100 dark:bg-bark-600/50 rounded-xl p-4"><div className="flex items-start gap-3"><span className="text-2xl">ðŸ“Š</span><div><div className="font-bold text-bark-600 dark:text-sand-100">5. Review</div><div className="text-sm text-bark-500 dark:text-sand-200">Check your weekly stats, matrix balance, and insights. The Review tab analyzes your patterns â€” overloaded quadrants, overdue tasks, unprocessed notes â€” and suggests next actions. On desktop, displays as a 2-column dashboard. Do this weekly.</div></div></div></div>
            </div>
          </>)}
          {helpSection('daily','ðŸš€ Daily Workflow',<div className="space-y-3">
              <div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Morning (5 min)</h4><ol className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>1. Open <strong>Capture</strong> â€” jot anything on your mind</li><li>2. Go to <strong>Clarify</strong> â€” review matrix, drag tasks to correct quadrants</li><li>3. Tap â†’ on 3â€“5 tasks to add them to <strong>Focus</strong> queue</li><li>4. Optionally check <strong>Confirm</strong> for any process checklists</li></ol></div>
              <div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Work Sessions (2â€“4 hours)</h4><ol className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>1. Open <strong>Focus</strong>, tap a task to activate it</li><li>2. Start Pomodoro â€” 25 min of deep work</li><li>3. Take 5 min break, then repeat</li><li>4. After 4 pomodoros, take a 15 min long break</li><li>5. Quick-capture stray thoughts in <strong>Capture</strong> to stay focused</li></ol></div>
              <div className="bg-terracotta-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">End of Day (5 min)</h4><ol className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>1. Clear completed tasks (ðŸ§¹ button in Clarify)</li><li>2. Process any unread <strong>Capture</strong> notes â†’ strikethrough or â†’ Clarify</li><li>3. Glance at <strong>Review</strong> for today's pomodoro count and streak</li><li>4. Set priorities for tomorrow in <strong>Clarify</strong></li></ol></div>
            </div>)}
          {helpSection('bj','ðŸ““ Bullet Journal Method',<>
            <p className="text-bark-500 dark:text-sand-200 mb-4">The Capture tab is inspired by Ryder Carroll's Bullet Journal â€” a rapid logging system that clears your mind so you can focus.</p>
            <div className="space-y-3">
              <div className="bg-lavender-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Rapid Logging</h4><ul className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>â€¢ <strong>Capture everything</strong> â€” tasks, ideas, thoughts, questions</li><li>â€¢ <strong>One bullet per thought</strong> â€” keep it short and atomic</li><li>â€¢ <strong>Press Enter</strong> to add instantly, no friction</li><li>â€¢ <strong>Don't organize yet</strong> â€” that's what Clarify is for</li></ul></div>
              <div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Migration (Processing Notes)</h4><ul className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>â€¢ <strong>Tap:</strong> Edit a note inline â€” refine its text instantly</li><li>â€¢ <strong>â‹® Menu:</strong> Tap the 3-dot icon for Edit, Promote to Clarify, Strikethrough, or Delete</li><li>â€¢ <strong>Right-click (desktop):</strong> Opens the same action menu as â‹®</li><li>â€¢ <strong>â˜ Checkbox (top-right):</strong> Enter selection mode for bulk actions â€” Move to Clarify, Strikethrough, Delete</li><li>â€¢ <strong>Auto-clear:</strong> Struck-through notes are automatically removed after 30 days</li></ul></div>
              <div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Day Sections</h4><p className="text-sm text-bark-500 dark:text-sand-200">Notes are automatically grouped by day â€” Today, Yesterday, and past dates. This creates a natural timeline of your thinking, just like a physical journal.</p></div>
            </div>
          </>)}
          {helpSection('gtd','ðŸ“Š GTD Weekly Review',<>
            <p className="text-bark-500 dark:text-sand-200 mb-4">David Allen's Getting Things Done weekly review is the "critical success factor" of the system. The Review tab makes this easy.</p>
            <div className="space-y-3">
              <div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Weekly Review Checklist</h4><ol className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>1. <strong>Get Clear</strong> â€” Process all Capture notes (migrate or strike)</li><li>2. <strong>Get Current</strong> â€” Review Clarify matrix, update or delete stale tasks</li><li>3. <strong>Get Creative</strong> â€” Check Review insights, act on suggestions</li></ol></div>
              <div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">What the Review Tab Shows</h4><ul className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>â€¢ <strong>Weekly stats:</strong> Pomodoros, tasks completed, focus time</li><li>â€¢ <strong>Streak heatmap:</strong> GitHub-style 13-week grid â€” darker = more pomodoros. Tap any day for details</li><li>â€¢ <strong>Streak counter:</strong> Current consecutive active days and your longest streak</li><li>â€¢ <strong>Matrix overview:</strong> How many active tasks in each quadrant</li><li>â€¢ <strong>Insights:</strong> Overloaded quadrants, overdue tasks, unprocessed notes</li><li>â€¢ <strong>Next actions:</strong> Specific suggestions based on your patterns</li></ul></div>
              <div className="bg-terracotta-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">The Review Loop</h4><p className="text-sm text-bark-500 dark:text-sand-200">Review closes the loop. Insights from Review feed back into Capture and Clarify â€” tasks you need to add, priorities to shift, habits to change. This is what makes the system self-improving.</p></div>
            </div>
          </>)}
          {helpSection('pom','ðŸ… Pomodoro Technique',<>
            <p className="text-bark-500 dark:text-sand-200 mb-4">The Pomodoro Technique breaks work into focused 25-minute intervals with breaks, preventing burnout and improving concentration.</p>
            <div className="space-y-3">
              <div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">How It Works</h4><ul className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>â€¢ Work Session: 25 minutes of focused work</li><li>â€¢ Short Break: 5 minutes to rest</li><li>â€¢ Repeat 4 times</li><li>â€¢ Long Break: 15 minutes after 4 cycles</li></ul></div>
              <div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Using the Timer</h4><ol className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>1. Tap Focus tab</li><li>2. Tap a task from Focus Queue to activate it</li><li>3. Press Start for 25-minute session</li><li>4. Take break when timer ends</li><li>5. Customize durations in More â†’ Settings</li></ol></div>
            </div>
          </>)}
          {helpSection('dw','ðŸŽ¯ Deep Work & Focus Queue',<>
            <p className="text-bark-500 dark:text-sand-200 mb-4">Deep Work (Cal Newport) means sustained concentration on cognitively demanding tasks. Our Focus Queue limits you to 3-5 tasks to maximize focus.</p>
            <div className="space-y-3">
              <div className="bg-lavender-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Why Limit Tasks?</h4><ul className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>â€¢ Forces prioritization of what truly matters</li><li>â€¢ Reduces context-switching mental overhead</li><li>â€¢ Prevents overwhelm and decision fatigue</li><li>â€¢ Improves focus quality and depth</li></ul></div>
              <div className="bg-terracotta-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Choose Your Limit</h4><p className="text-sm text-bark-500 dark:text-sand-200 mb-2"><strong>3 Tasks:</strong> For highly complex work, maximum focus, easily distracted</p><p className="text-sm text-bark-500 dark:text-sand-200"><strong>5 Tasks:</strong> For varied responsibilities, 8+ hour days, need flexibility</p></div>
            </div>
          </>)}
          {helpSection('matrix','ðŸ“Š Urgent/Important Matrix',<>
            <p className="text-bark-500 dark:text-sand-200 mb-4">The Eisenhower Box helps categorize tasks by urgency and importance to focus on what truly matters.</p>
            <div className="grid grid-cols-2 gap-2 mb-4">
              <div className="bg-terracotta-100 dark:bg-terracotta-400/20 rounded-xl p-3"><div className="font-bold text-terracotta-600 dark:text-terracotta-300 mb-1">Q1: Do First</div><div className="text-xs text-bark-500 dark:text-sand-200">Urgent & Important</div><div className="text-xs text-bark-400 dark:text-sand-300 mt-1">Crises, deadlines</div></div>
              <div className="bg-sage-100 dark:bg-sage-400/20 rounded-xl p-3"><div className="font-bold text-sage-600 dark:text-sage-300 mb-1">Q2: Schedule</div><div className="text-xs text-bark-500 dark:text-sand-200">Not Urgent & Important</div><div className="text-xs text-bark-400 dark:text-sand-300 mt-1">Planning, prevention</div></div>
              <div className="bg-ocean-100 dark:bg-ocean-400/20 rounded-xl p-3"><div className="font-bold text-ocean-600 dark:text-ocean-300 mb-1">Q3: Delegate</div><div className="text-xs text-bark-500 dark:text-sand-200">Urgent & Not Important</div><div className="text-xs text-bark-400 dark:text-sand-300 mt-1">Interruptions, emails</div></div>
              <div className="bg-sand-200 dark:bg-bark-500/20 rounded-xl p-3"><div className="font-bold text-bark-600 dark:text-sand-200 mb-1">Q4: Eliminate</div><div className="text-xs text-bark-500 dark:text-sand-200">Not Urgent & Not Important</div><div className="text-xs text-bark-400 dark:text-sand-300 mt-1">Time wasters</div></div>
            </div>
            <div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">In Productivity Hub</h4><ul className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>â€¢ <strong>Q1:</strong> High Priority, Due Today</li><li>â€¢ <strong>Q2:</strong> Medium Priority, add to Focus Queue</li><li>â€¢ <strong>Q3:</strong> Low Priority or Delegate</li><li>â€¢ <strong>Q4:</strong> New tasks default here â€” drag upward as priorities become clear</li></ul></div>
          </>)}
          </div>
          <div className="text-center text-sm text-bark-400 dark:text-sand-300 mt-6">
            <p>Tap <strong>? icon</strong> (top-right) for quick App Navigation reference</p>
          </div>
        </div>
      )}
      {moreSub==='test'&&<>
        {testSuiteState.loading&&!TestRunnerComp&&<div className="gcard rounded-2xl p-5 text-sm text-bark-500 dark:text-sand-200">
          <div className="flex items-center justify-between mb-2"><span>{testSuiteState.stage||'Loading test suite...'}</span><span className="font-semibold text-sage-500">{Math.max(0,Math.min(100,testSuiteState.pct||0))}%</span></div>
          <div className="h-2 bg-sand-200 dark:bg-bark-600 rounded-full overflow-hidden"><div className="h-full bg-sage-400 rounded-full transition-all duration-300" style={{width:`${Math.max(0,Math.min(100,testSuiteState.pct||0))}%`}}/></div>
        </div>}
        {!testSuiteState.loading&&testSuiteState.error&&!TestRunnerComp&&<div className="gcard rounded-2xl p-5 text-sm text-terracotta-500 dark:text-terracotta-300">{testSuiteState.error}</div>}
        {TestRunnerComp&&<TestRunnerComp onShowToast={showT}/>}
        <div className="text-center pt-4"><span className="text-xs font-normal text-lavender-400 bg-lavender-100 dark:bg-lavender-400/20 px-3 py-1 rounded-full">v{APP_VERSION}</span></div>
      </>}
    </div>
  );
}

// Main App â€” thin layout shell (sidebar/tab-bar + content area) (v16.2 refactor Step 9)
function App(){
  const desk=useDesk();
  const wide=useWide();
  const{lists,setLists,todos,setTodos,notes,setNotes,
    setFocus,setMet,
    toast,showT,tab,setTab,selList,
    linkTask,unlinkTask,createAndLink,
    deleteListItem,saveItem,seedSampleData}=useApp();

  const[timerInfo,setTimerInfo]=useState({left:0,run:false,mode:'work'});
  const onTimerTick=useCallback((info)=>setTimerInfo(info),[]);
  const fmtSidebar=s=>{const m=Math.floor(s/60),sec=s%60;return`${m}:${sec.toString().padStart(2,'0')}`;};
  const[showHelp,setShowHelp]=useState(false);
  const[seenAbout,setSeenAbout]=usePersistedState('seenAbout',false);
  const[showWelcome,setShowWelcome]=useState(false);
  const[seenChecked,setSeenChecked]=useState(false);
  useEffect(()=>{S.get('seenAbout',false).then(v=>{if(v===false)setShowWelcome(true);setSeenChecked(true);});},[]);

  const[edit,setEdit]=useState(null);
  const[selMode,setSelMode]=useState(false);
  const[selSection,setSelSection]=useState(null);
  const[selIds,setSelIds]=useState(new Set());
  const[bulkConfirm,setBulkConfirm]=useState(null);
  const exitSelMode=()=>{setSelMode(false);setSelSection(null);setSelIds(new Set());setBulkConfirm(null);};
  const toggleSelId=(id)=>setSelIds(prev=>{const n=new Set(prev);if(n.has(id))n.delete(id);else n.add(id);return n;});
  const enterSelMode=(section,firstId)=>{setSelMode(true);setSelSection(section);setSelIds(firstId?new Set([firstId]):new Set());};
  const getAllIdsForSection=()=>{
    if(selSection==='todos')return todos.map(t=>t.id);
    if(selSection==='lists'){const cl=lists.find(l=>l.id===selList);return cl?cl.items.map(i=>i.id):[];}
    if(selSection==='notes')return notes.map(n=>n.id);
    return[];
  };
  const selectAll=()=>setSelIds(new Set(getAllIdsForSection()));
  const deselectAll=()=>setSelIds(new Set());
  const executeBulk=(action,sIds,sec)=>{
    const ids=[...sIds];const cnt=ids.length;
    if(sec==='todos'){
      if(action==='done'){setTodos(t=>t.map(x=>sIds.has(x.id)?{...x,done:true}:x));setFocus(f=>f.filter(x=>!sIds.has(x.id)));setMet(p=>({...p,d:{...p.d,t:p.d.t+cnt},w:{...p.w,t:p.w.t+cnt}}));showT(`âœ… ${cnt} task${cnt>1?'s':''} done`);}
      if(action==='delete'){setTodos(t=>t.filter(x=>!sIds.has(x.id)));setFocus(f=>f.filter(x=>!sIds.has(x.id)));showT(`ðŸ—‘ ${cnt} deleted`);}
    }else if(sec==='lists'){
      const lid=selList;
      if(action==='done'){setLists(ls=>ls.map(l=>l.id===lid?{...l,items:l.items.map(i=>sIds.has(i.id)?{...i,done:!i.done}:i)}:l));showT(`âœ… ${cnt} toggled`);}
      if(action==='delete'){setLists(ls=>ls.map(l=>l.id===lid?{...l,items:l.items.filter(i=>!sIds.has(i.id))}:l));showT(`ðŸ—‘ ${cnt} deleted`);}
    }else if(sec==='notes'){
      if(action==='delete'){setNotes(n=>n.filter(x=>!sIds.has(x.id)));showT(`ðŸ—‘ ${cnt} deleted`);}
      if(action==='strike'){setNotes(n=>n.map(x=>sIds.has(x.id)?{...x,struck:!x.struck,struckAt:!x.struck?Date.now():null}:x));showT(`${cnt} toggled`);}
      if(action==='clarify'){const toMove=notes.filter(x=>sIds.has(x.id));setTodos(t=>[...toMove.map(x=>({id:uid(),text:x.text||x.title||x.content,quad:'nn',poms:0,done:false})),...t]);setNotes(n=>n.map(x=>sIds.has(x.id)?{...x,struck:true,struckAt:Date.now()}:x));showT(`ðŸ“‹ ${cnt} copied to Clarify`);}
    }
    exitSelMode();
  };
  const bulkAction=(action)=>{
    if(selIds.size===0)return;
    if(action==='delete'&&selIds.size>=3){setBulkConfirm({ids:new Set(selIds),section:selSection});return;}
    executeBulk(action,selIds,selSection);
  }; 
  const[linkPicker,setLinkPicker]=useState(null);
  const tabs=[{id:'notes',Ic:I.Notes,l:'Capture'},{id:'todos',Ic:I.Check,l:'Clarify'},{id:'focus',Ic:I.Focus,l:'Focus'},{id:'lists',Ic:I.List,l:'Confirm'},{id:'review',Ic:I.Review,l:'Review'},{id:'more',Ic:I.Settings,l:'More'}];
  const onTabClick=(id)=>{setTab(id);if(selMode)exitSelMode();};
  const renderTabButton=({id,Ic,l},variant)=>{
    const isFR=id==='focus'&&timerInfo.run;
    if(variant==='sidebar'){
      return(
        <button key={id} onClick={()=>onTabClick(id)} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-semibold transition-all ${tab===id?'bg-sage-400/15 text-sage-600 dark:text-sage-300':'text-bark-500 dark:text-sand-300 hover:bg-sand-100 dark:hover:bg-bark-600/50'}`}>
          <Ic s={20}/><span className="flex-1 text-left">{isFR?fmtSidebar(timerInfo.left):l}</span>{isFR&&<span className={`w-2 h-2 rounded-full flex-shrink-0 ${timerInfo.mode==='work'?'bg-sage-400':'bg-ocean-400'} animate-pulse`}/>}
        </button>
      );
    }
    return(
      <button key={id} onClick={()=>onTabClick(id)} className={`flex-1 py-2 flex flex-col items-center gap-1 transition-all ${tab===id?'text-sage-500':'text-bark-400 dark:text-sand-200'}`}>
        <div className="relative"><Ic s={28}/>{isFR&&<span className={`absolute -top-0.5 -right-0.5 w-2 h-2 rounded-full ${timerInfo.mode==='work'?'bg-sage-400':'bg-ocean-400'} animate-pulse`}/>}</div>
        <span className={`text-xs font-bold ${tab===id?'':'opacity-70'}`}>{isFR?fmtSidebar(timerInfo.left):l}</span>
      </button>
    );
  };
  const renderActiveSection=()=>{
    if(tab==='focus')return <div className="xl:max-w-none max-w-2xl mx-auto"><FocusSection wide={wide} desk={desk} onTimerTick={onTimerTick}/></div>;
    if(tab==='lists')return <ConfirmSection wide={wide} desk={desk} selMode={selMode} selSection={selSection} selIds={selIds} toggleSelId={toggleSelId} enterSelMode={enterSelMode} exitSelMode={exitSelMode} setEdit={setEdit}/>;
    if(tab==='todos')return <ClarifySection wide={wide} desk={desk} selMode={selMode} selSection={selSection} selIds={selIds} toggleSelId={toggleSelId} enterSelMode={enterSelMode} exitSelMode={exitSelMode} setEdit={setEdit} setLinkPicker={setLinkPicker}/>;
    if(tab==='notes')return <CaptureSection wide={wide} selMode={selMode} selSection={selSection} selIds={selIds} toggleSelId={toggleSelId} enterSelMode={enterSelMode} exitSelMode={exitSelMode}/>;
    if(tab==='review')return <ReviewSection wide={wide}/>;
    if(tab==='more')return <SettingsSection desk={desk}/>;
    return null;
  };

  return(
    <div className="min-h-screen flex flex-col xl:flex-row xl:h-screen xl:overflow-hidden">
      {/* Sidebar (Desktop) */}
      <div className="hidden xl:flex w-56 flex-shrink-0 glass border-r border-sand-200/50 dark:border-bark-500/30 flex-col" style={{paddingTop:'max(12px, env(safe-area-inset-top))'}}>
        <div className="px-5 py-4 border-b border-sand-200/30 dark:border-bark-500/20">
          <h1 className="text-lg font-extrabold text-bark-600 dark:text-sand-100">Productivity Hub <span className="text-[10px] font-normal text-lavender-400 bg-lavender-100 dark:bg-lavender-400/20 px-1.5 py-0.5 rounded-full ml-1">Î±</span></h1>
        </div>
        <nav className="flex-1 py-3 px-3 space-y-1 overflow-y-auto">
          {tabs.map(t=>renderTabButton(t,'sidebar'))}
        </nav>
        <div className="px-3 py-3 border-t border-sand-200/30 dark:border-bark-500/20">
          <button onClick={()=>setShowHelp(true)} className="w-full flex items-center gap-3 px-3 py-2 rounded-xl text-sm font-medium text-bark-400 dark:text-sand-300 hover:bg-sand-100 dark:hover:bg-bark-600/50 transition-colors"><I.Help s={18}/><span>Help</span></button>
        </div>
      </div>

      {/* Header (Mobile) */}
      <div className="xl:hidden glass px-4 md:px-8 py-3 md:py-4 sticky top-0 z-20 flex items-center justify-between gap-2" style={{paddingTop:'max(12px, env(safe-area-inset-top))'}}>
        <div className="w-10 md:w-12"/>
        <h1 className="flex-1 min-w-0 text-lg md:text-2xl font-extrabold text-center text-bark-600 dark:text-sand-100 whitespace-nowrap overflow-hidden text-ellipsis">Productivity Hub <span className="text-xs md:text-sm font-normal text-lavender-400 bg-lavender-100 dark:bg-lavender-400/20 px-2 py-0.5 rounded-full ml-1">Î±</span></h1>
        <button onClick={()=>setShowHelp(true)} aria-label="Show help" className="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center text-bark-400 dark:text-sand-300 hover:text-sage-500 transition-colors"><I.Help s={26}/></button>
      </div>

      {/* Main Content */}
      <div className="w-full flex-1 overflow-y-auto">
      <div className="px-4 md:px-8 pt-0 md:pt-6 xl:pt-6 pb-28 md:pb-32 xl:pb-6 mx-auto max-w-lg md:max-w-5xl xl:max-w-none">
        {renderActiveSection()}
      </div>
      </div>

      {selMode&&<BulkActionBar count={selIds.size} section={selSection} allCount={getAllIdsForSection().length} onSelectAll={selectAll} onDeselectAll={deselectAll} onAction={bulkAction} onCancel={exitSelMode}/>}

      {/* Bottom Bar (Mobile) */}
      <div className="xl:hidden fixed bottom-0 left-0 right-0 glass border-t border-sand-200/50 dark:border-bark-500/30" style={{paddingBottom:'max(16px, env(safe-area-inset-bottom))'}}>
        <div className="flex justify-around max-w-lg md:max-w-5xl mx-auto py-2 tab-bar-inner">
          {tabs.map(t=>renderTabButton(t,'mobile'))}
        </div>
      </div>

      {toast&&<div className="fixed top-20 left-4 right-4 z-50 flex justify-center"><div className="gcard px-5 py-3 rounded-2xl anim-in text-bark-600 dark:text-sand-100 font-semibold">{toast}</div></div>}
      {showHelp&&<AboutModal onClose={()=>setShowHelp(false)} isWelcome={false}/>}
      {showWelcome&&<AboutModal onClose={()=>{setShowWelcome(false);setSeenAbout(true);seedSampleData();}} isWelcome={true}/>}
      {edit&&<EditModal item={edit.item} type={edit.type} onSave={item=>saveItem(edit.type,item,edit.listId)} onClose={()=>setEdit(null)} onDelete={edit.type==='list'&&edit.item?.id?()=>{deleteListItem(edit.listId,edit.item.id);}:undefined}/>}
      {linkPicker&&<LinkPicker task={linkPicker} lists={lists} onLink={linkTask} onCreate={createAndLink} onUnlink={unlinkTask} onClose={()=>setLinkPicker(null)}/>}
      {bulkConfirm&&<ConfirmDialog title={`Delete ${bulkConfirm.ids.size} items?`} text="This action cannot be undone." confirmText={`Delete ${bulkConfirm.ids.size}`} onConfirm={()=>{executeBulk('delete',bulkConfirm.ids,bulkConfirm.section);setBulkConfirm(null);}} onCancel={()=>setBulkConfirm(null)}/>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<ThemeProv><AppDataProv><App/></AppDataProv></ThemeProv>);
</script>
</body>
</html>
