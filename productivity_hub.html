<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#7CB69D" id="theme-color-meta">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Productivity Hub">
  <meta name="application-name" content="Productivity Hub">
  <meta name="description" content="Focus timer, tasks, checklists & quick notes - all in one place">
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAACXBIWXMAAAsTAAALEwEAmpwYAAAGZ0lEQVR4nO3dT4hVdRzG8e+dO+NkOo6aWmkilgUVFBGRCxctItoEQUSbFi1atGkRQS0iWrRpE0EQQbRoEUG0aBFBEBEEQZBFhZGCWVZqjqPO/Ln3dBZxB8aZO3fOved3f7/f+31ecGHR4r7znPN9zjn3d+85A0mSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJElSA3QWuwN/AfuBfcCNwNXAGuB8YBVwDnAWsAI4Cziz/+fl/v/mvwH/9P+3/gD+BP4Afge+B74Evuo//gdwtsCvU5Xa0FcBW4FbgeuAy5v+/3gS+KL/+Bj4CPhogf8vqa429BZgJ3A7cMFi/8M/Af8Cfz/y+RP4rf/nlf5v/rOAs/u/9acvfr/nOuA64Mz+r+GU/h/xw/0PAY8Bry/+V6gytaG3AvcBdwBr+389fRV9/NRz/F/9k0APOL3/T//X8/8f8P0TwJfAMeBt4E3gVOG/DjWkpt6HXt7/zb0C2NZ/bAfO6z+k+p0ADgMHgZeAr0N+XRpTLQ29AtgM3ATcCGwEVob8etSk74H9wEHgPeCPkF+PhlBDQ58GrAe2AFv7fw7/5aipfgdeBZ4D3gn5dakltTb05cD1wA7gZmBtyK9HbfoZ2Ac8D3wa8utRi2pq6POAq4E7gTuBNSG/HpXqGPAi8AzwScivp9FqaOgLgXuAu4BNIb8eVeFj4GngOeBEyK+ngWpo6DOAa4AHgOtDfj2qzVHgEeAp4O+QX09DVN3QlwJ7gHuBc0N+ParbQWAPcCjk11O5qhv6LeC6kF+LmuUocD/wUsivpWLVNrQ0od8kvVOoqqE/Au4HPgj5tUnPAXuB4yG/lkpU1dCbgF3AXf3/kfSjpHPrA5QfGFc19GrgUeAh4IyQX4/0v/4C9gFPhvxaqldNQy8D7qZ0s+sqrJZ9DDwCvBDyaylWNQ19PfAEcEnIr0Ua3iHgYeCNkF9LVdY3fMD3Ag8CDwJrGj6O1LYNwB5gI3Ac+Kzh41RhVQPnvhF4B3g79EnbUqVuA94GPgBubvg8Vdja4LkvBfYDu4FVi/0Bklq3CtgNHKB0xtcNnqfztjV07tuAlym9E0jS//YAL1K66d42aK7OW9vAec8BHgO2hzxhaQwfAQ8Bx8ZdQ+e91/A5NwGvATtCnqg0vp3AQUo3LY6zkE6Z+sIGzrkSeIJyWb0y5ElK+S4F3qR003mjLqDTpmro84HHKZfhU0KeoDSeZZRO+gTYQOmqUR2+us6zGdgN3EbpLkmqX+dGYAOlqz4edbHO2zjmOacuq78Fnqf/3mmpcZcC+4A3gLVjrKNz62Kd0qEeFt0OvA9sowwvSq24jdJZm8ZYQ+dOSue1ZuqDm5dRxlO3hBxQasobwDPAl0OuoXNbi+cpE8I24MqQA0qt2kg5TtgCfDjkGjofD/tJP6F0Tb0v5EBSe/YBz1K67l/Kz/vipv75Z+CR/s/7QQ4iteNbytDCfUNsu/OXSQXtWOwAXcrlgaT2+atUKkhDS0FqaejZ0AclldlQ+sVP/VfRlcDbwOaQJ1y/DnAbpXvGPbWWAzuATSEvBM22doy1dG7r6OucdcD1IU+4ThcCW4HL5nx+M+X9g1K2LSGvBc0yzf/WR1lH5y+jrqEP0fB7oKt3Epjl//+/nwJOhTxhqR0nKN3yL+V/K8+E/LzPhvz+1HuAk//53P85o1NaNnPSaJ31X8rPtXbWvyjjVw8sss0h4HZg/ZTnrN1q4A5gT//POxbbqPPjSef8HHgauG2RTR+k3K962pTnrN065vyyZjm/rPnXsI/SZXuHWM+GKc9VuxvoQOe1kNfTJOln/5TnkjQJ/zZBKkhDS0FqaegPI58AKU2F/yIvFaShpSC1NPTbIQeUyqyi9P0oa+n8YdRN/wM+pEySbwk5sNS8TZTum6N01+cjrKXz12E/8ZeUubzngx5Aat4G4FVK570y5BrqWMqo+0eh/2ik9mwF9lO6b+qDm19SJnq3hRxQatYm4BVK98399WCU9XR+HXWxTul0XQq8ROkoP0Wk5lxK6brXKV034gHOWP/xFnAz8EVH0rBWU7rsd0o3jWPsv1y/hDLYdGfIk5XGsBN4ndJFt4+xjs5GSteMZZqhhnspI+8enagmW0kZWD9I6Z5phlGmfg/0WS2cc+og09vAwZAnLo3uduAtShfNbrMHhxpG+c85p0aN3gMeoNx7eFbLx5IGcRawm9I5B5o68Xw6P0w67+rFFtHp/O+qqZL+aXfFXf/O/Ofc+Z9/t93TzyljhweBn0KelPT/VlMG0TdSumaaPfk/0ww1/Bt1ZsgfSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZJUp/8AxH1zEXbRSeoAAAAASUVORK5CYII=">
  <link rel="icon" type="image/png" sizes="192x192" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAFEklEQVR4nO3dT4hVdRzG8e+dO+NkOo6aWmkilgUVFBGRCxctItoEQUSbFi1atGkRQS0iWrRpE0EQQbRoEUG0aBFBEBEEQZBFhZGCWVZqjqPO/Ln3dBZxB8aZO3fOved3f7/f+31ecGHR4r7znPN9zjn3d+85A0mSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEmSJEkta8V+A0PABmAzsBZYC1wEXABcCJwDnA2cBZwJnAGc3v/f/A/wT/9/6w/gD+BP4Hfge+BL4Kv+n38ArT78WhVQ0wdgFXANcCNwPXAFsKrhf+Np4PP+YxT4CPho/v+XCqTpA7AauAPYBdwMrE/9Bk4C/wJ///v4E/it/+fl/r/5zwTOBs7p//b/9Hn/+34V3QgcBp4GXkn9JpWoOswP5i16PjDQ/+v+i99/Onj812dKQWtqKvoA7ADuB24HLkr9JqQ0x4Eh4FngncTvRRmV/QNwVv+39wrg5v5jG7A88XtSGr8Bh4DDwMvA16nfjPJV1g/AcmAzsAO4CdgMrEj8npTOL8BB4ADwLvBP4vejjJXxA3AasAG4Ebil/+dE75WpfQE8DzwPfJL4vZRaWQdgBXA1cCdwJ3BR4vej8voZeAl4BvgsaS+lVcYBOB/YCtwF3JD4vajcPgaeAp4DTiTtpqTKNgDrgVuBe4GtiXtRNRwFngSeAv5K2kyJlG0A3gGuS9yDquswsBf4IGkfJVDGAZDa9helO71HEveRWFkHQOrar5TuxJY+ANIAH6b+AoytBwPPAI+mb6ccVnfwazcDu4G7ga0I/QL8BOwHnknfSjms7PBAN1G6a7sHODd9O+W0Bvh3+WL/g94F3EtBg9rE/URpPOtQ+lbKYU0Hg3k5cD/wILAufTvl9T7wMKVfMJRd0wPwNqXR/cfjl6LK2AE8QemewMqo6QF4Adiaupcy+5LSbxg+nL6Vcmh6AN4H3k3dQ3ntBN6g9Jdhy6npARgCHgP+Tt1Lae0CnqH0F2VLqekBOEJpNG+kbqacbgbeAkYpjWyV0PQAjFAa3d9M3Uv57AS+BW5N3UiZND0AR4D7gHdT91IeDwAvUrpTXHJND8BPlMb0bkj8PsqhBewFDgHXJu6lFJoegH/6/d0F/Ji6l+QuAg5TekxGa+qGEgzA5v5/8P7EfaS2kdJT5LtS95Fa0wPwC6UxvT91H2ltAA4A9wGrU/eSSgqPQrgNeBW4Kn0rSWyk9D7HAng29G/cL1D6m5+dqRtJYQ3wKKXxrG2Jeymdqf0MvJu6iUbdArxG6S5xZXR96h5S+43Sk/L3A2el7qUF6yj9EucIpcdlVEbTlxz/Wg8c/t/XdgI7gO2U/lp0ZbQJeK7/53NKT9hXRke7+NptwI2ULndPSd1MizhC6S6xHo+pfgD+s57S5e92Spe96yntQel9BxwAPgS+6ed9gH84fPHPQXgQmP/S/GfyvxQa9dTF12b7H+j5/49fmv98/n+e/5x/fv7f4+8yv7b4+lz/g/n/r5/75+n/+/Vz/fuf//z8v1fO/5vr1xc/n//18/35v7n4Wjn/OtcsSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkSZIkqY7+A2TM4xxUNzJDAAAAAElFTkSuQmCC">
  <link rel="manifest" id="manifest-placeholder" href="manifest.json">
  <title>Productivity Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:'class',theme:{extend:{fontFamily:{nunito:['Nunito','sans-serif']},colors:{cream:{50:'#FDFCFA',100:'#F7F5F0',200:'#EDE9E0'},sage:{100:'#E8F0EA',200:'#C5D9CA',300:'#9DC4A8',400:'#7CB69D',500:'#5A9E78'},terracotta:{100:'#FCEEE9',200:'#F5C9BA',300:'#E9A088',400:'#E07A5F',500:'#C45D42'},sand:{100:'#F5F0E6',200:'#E8DFD0',300:'#D4C5AD'},ocean:{100:'#E6F2F7',200:'#B8D9E8',300:'#83B5D1',400:'#5A9BBF'},lavender:{100:'#F0EDF5',200:'#D5CCE6',300:'#B8A9D4',400:'#9B8AA6'},bark:{300:'#9A8B7A',400:'#7A6B5A',500:'#5C4F43',600:'#3D352D',700:'#2D2720'}}}}}</script>
  <!-- Local multi-file requirement: keep this HTML with ./styles/app.css, ./scripts/pwa_setup.js, and ./scripts/app_core.js. -->
  <link rel="stylesheet" href="./styles/app.css">
</head>
<body class="bg-cream-100 dark:bg-bark-700">
<noscript>
  <div style="max-width:760px;margin:48px auto;padding:20px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font-family:Nunito,sans-serif;line-height:1.5">
    <h2 style="margin:0 0 8px">JavaScript is required</h2>
    <p style="margin:0">Enable JavaScript and open `productivity_hub.html` in a regular browser.</p>
  </div>
</noscript>
<div id="root">
  <div id="boot-fallback" style="max-width:760px;margin:48px auto;padding:20px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;font-family:Nunito,sans-serif;line-height:1.5">
    <h2 style="margin:0 0 8px">Loading Productivity Hub...</h2>
    <p id="boot-fallback-msg" style="margin:0">If this does not change, open this file in Chrome, Safari, or Firefox (not IDE preview).</p>
  </div>
</div>
<script>
(function(){
  const msgEl=()=>document.getElementById('boot-fallback-msg');
  const setMsg=(msg,color)=>{
    const el=msgEl();
    if(!el)return;
    el.textContent=msg;
    if(color)el.style.color=color;
  };
  window.__PH_BOOT_PHASE=(msg)=>setMsg(msg);
  window.__PH_BOOT_FAIL=(msg)=>setMsg(msg||'Startup failed. Open browser console for details.','#b91c1c');
  window.__PH_BOOT_DONE=()=>{
    const fallback=document.getElementById('boot-fallback');
    if(fallback)fallback.remove();
  };
  window.addEventListener('error',e=>{
    if(e?.message)window.__PH_BOOT_FAIL('JavaScript error: '+e.message);
  });
  window.addEventListener('unhandledrejection',e=>{
    const reason=e&&e.reason&&e.reason.message?e.reason.message:String(e.reason||'unknown');
    window.__PH_BOOT_FAIL('Unhandled promise error: '+reason);
  });
  window.__PH_BOOT_PHASE('Loading scripts...');
})();
</script>
<script src="./scripts/pwa_setup.js" onload="window.__PH_BOOT_PHASE&&window.__PH_BOOT_PHASE('Loaded scripts/pwa_setup.js')" onerror="window.__PH_BOOT_FAIL&&window.__PH_BOOT_FAIL('Failed to load scripts/pwa_setup.js')"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js" onload="window.__PH_BOOT_PHASE&&window.__PH_BOOT_PHASE('Loaded React')" onerror="window.__PH_BOOT_FAIL&&window.__PH_BOOT_FAIL('Failed to load React from CDN')"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" onload="window.__PH_BOOT_PHASE&&window.__PH_BOOT_PHASE('Loaded ReactDOM')" onerror="window.__PH_BOOT_FAIL&&window.__PH_BOOT_FAIL('Failed to load ReactDOM from CDN')"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js" onload="window.__PH_BOOT_PHASE&&window.__PH_BOOT_PHASE('Loaded Babel runtime')" onerror="window.__PH_BOOT_FAIL&&window.__PH_BOOT_FAIL('Failed to load Babel from CDN')"></script>
<script src="./scripts/app_core.js" onload="window.__PH_BOOT_PHASE&&window.__PH_BOOT_PHASE('Loaded scripts/app_core.js')" onerror="window.__PH_BOOT_FAIL&&window.__PH_BOOT_FAIL('Failed to load scripts/app_core.js')"></script>
<script>
if(!window.React||!window.ReactDOM||!window.Babel){
  window.__PH_BOOT_FAIL&&window.__PH_BOOT_FAIL('Required CDN scripts are missing (React/ReactDOM/Babel).');
  const root=document.getElementById('root');
  if(root){
    root.innerHTML='<div style="max-width:720px;margin:48px auto;padding:20px;border:1px solid #e5e7eb;border-radius:12px;font-family:Nunito,sans-serif;line-height:1.5"><h2 style="margin:0 0 8px">App failed to bootstrap</h2><p style="margin:0 0 8px">Required CDN scripts did not load (React/ReactDOM/Babel).</p><p style="margin:0">Check internet access and reload.</p></div>';
  }
}
</script>
<script type="text/babel">
/* == BEGIN: Block A == */
(()=>{
const{useState,useEffect,useRef,useMemo,useCallback,createContext,useContext}=React;
const PH=window.PH_CORE;
if(!PH){
  window.__PH_BOOT_FAIL&&window.__PH_BOOT_FAIL('window.PH_CORE is missing. Ensure scripts/app_core.js is next to the HTML file.');
  const root=document.getElementById('root');
  if(root){
    root.innerHTML='<div style="max-width:720px;margin:48px auto;padding:20px;border:1px solid #e5e7eb;border-radius:12px;font-family:Nunito,sans-serif;line-height:1.5"><h2 style="margin:0 0 8px">App failed to bootstrap</h2><p style="margin:0 0 8px">`window.PH_CORE` is missing.</p><p style="margin:0 0 8px">Expected local files next to this HTML:</p><ul style="margin:0 0 8px 18px"><li>styles/app.css</li><li>scripts/pwa_setup.js</li><li>scripts/app_core.js</li></ul><p style="margin:0">Open from the project root (not a copied standalone HTML file).</p></div>';
  }
  throw new Error('PH_CORE failed to load. Ensure ./scripts/app_core.js loads before Babel scripts.');
}
const{APP_VERSION,initDB,S,uid,notify,reqNotifyPerm,PRESETS,QUADS,CATS,shareItem,genICS,dlFile}=PH;

// Icons - More visible with less transparency
const I={
  Focus:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.35"/><circle cx="12" cy="12" r="6" fill="currentColor" opacity="0.55"/><circle cx="12" cy="12" r="3" fill="currentColor"/></svg>,
  List:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><rect x="3" y="4" width="18" height="16" rx="3" fill="currentColor" opacity="0.3"/><rect x="6" y="8" width="3" height="2" rx="1" fill="currentColor"/><rect x="6" y="12" width="3" height="2" rx="1" fill="currentColor"/><rect x="11" y="8" width="7" height="2" rx="1" fill="currentColor" opacity="0.85"/><rect x="11" y="12" width="6" height="2" rx="1" fill="currentColor" opacity="0.85"/></svg>,
  Check:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><rect x="3" y="3" width="18" height="18" rx="4" fill="currentColor" opacity="0.3"/><path d="M8 12L11 15L16 9" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Bell:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M12 3C8.5 3 6 5.5 6 9V14L4 17H20L18 14V9C18 5.5 15.5 3 12 3Z" fill="currentColor" opacity="0.3"/><path d="M12 3C8.5 3 6 5.5 6 9V14L4 17H20L18 14V9C18 5.5 15.5 3 12 3Z" stroke="currentColor" strokeWidth="2" fill="none"/><circle cx="12" cy="3" r="2" fill="currentColor"/><path d="M10 17C10 18.5 10.8 20 12 20C13.2 20 14 18.5 14 17" stroke="currentColor" strokeWidth="2"/></svg>,
  Notes:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><rect x="4" y="3" width="16" height="18" rx="2" fill="currentColor" opacity="0.3"/><path d="M8 7H16M8 11H16M8 15H13" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></svg>,
  Settings:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="4" fill="currentColor"/><path d="M12 2V5M12 19V22M4.93 4.93L7.05 7.05M16.95 16.95L19.07 19.07M2 12H5M19 12H22M4.93 19.07L7.05 16.95M16.95 7.05L19.07 4.93" stroke="currentColor" strokeWidth="2" strokeLinecap="round" opacity="0.65"/></svg>,
  Help:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.25"/><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2" fill="none"/><path d="M9 9C9 7.34 10.34 6 12 6C13.66 6 15 7.34 15 9C15 10.31 14.17 11.42 13 11.83V13" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><circle cx="12" cy="17" r="1.5" fill="currentColor"/></svg>,
  Play:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.25"/><path d="M10 8L16 12L10 16V8Z" fill="currentColor"/></svg>,
  Pause:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.25"/><rect x="9" y="8" width="2" height="8" rx="1" fill="currentColor"/><rect x="13" y="8" width="2" height="8" rx="1" fill="currentColor"/></svg>,
  Reset:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M4 12C4 7.58 7.58 4 12 4C16.42 4 20 7.58 20 12C20 16.42 16.42 20 12 20C9.79 20 7.79 19.1 6.34 17.66" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"/><path d="M4 8V12H8" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Plus:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M12 5V19M5 12H19" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"/></svg>,
  Edit:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M16 3L21 8L8 21H3V16L16 3Z" fill="currentColor" opacity="0.25"/><path d="M16 3L21 8L8 21H3V16L16 3Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Broom:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M12 2L12 10M8 10H16L17 22H7L8 10Z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Trash:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M6 7H18L17 20H7L6 7Z" fill="currentColor" opacity="0.25"/><path d="M4 7H20M10 11V16M14 11V16M6 7L7 20H17L18 7M9 7V4H15V7" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Share:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="18" cy="5" r="3" fill="currentColor"/><circle cx="6" cy="12" r="3" fill="currentColor"/><circle cx="18" cy="19" r="3" fill="currentColor"/><path d="M8.5 10.5L15.5 6.5M8.5 13.5L15.5 17.5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" opacity="0.6"/></svg>,
  Drag:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="9" cy="6" r="2" fill="currentColor"/><circle cx="15" cy="6" r="2" fill="currentColor"/><circle cx="9" cy="12" r="2" fill="currentColor"/><circle cx="15" cy="12" r="2" fill="currentColor"/><circle cx="9" cy="18" r="2" fill="currentColor"/><circle cx="15" cy="18" r="2" fill="currentColor"/></svg>,
  Down:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M6 9L12 15L18 9" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Up:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M6 15L12 9L18 15" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Sun:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="5" fill="currentColor"/><path d="M12 2V4M12 20V22M4 12H2M22 12H20M5.64 5.64L4.22 4.22M19.78 19.78L18.36 18.36M5.64 18.36L4.22 19.78M19.78 4.22L18.36 5.64" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></svg>,
  Moon:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" fill="currentColor"/></svg>,
  Phone:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><rect x="6" y="2" width="12" height="20" rx="2" fill="currentColor" opacity="0.25"/><rect x="6" y="2" width="12" height="20" rx="2" stroke="currentColor" strokeWidth="2"/><circle cx="12" cy="18" r="1" fill="currentColor"/></svg>,
  X:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M6 6L18 18M18 6L6 18" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"/></svg>,
  Restore:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M3 12C3 7.02 7.02 3 12 3C16.98 3 21 7.02 21 12C21 16.98 16.98 21 12 21C9.51 21 7.27 19.96 5.64 18.26" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><path d="M3 17V12H8" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Done:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.25"/><path d="M8 12L11 15L16 9" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Info:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="12" r="10" fill="currentColor" opacity="0.25"/><circle cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="2"/><path d="M12 16V12M12 8H12.01" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round"/></svg>,
  Calendar:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><rect x="3" y="4" width="18" height="18" rx="2" fill="currentColor" opacity="0.25"/><path d="M3 10H21M8 2V6M16 2V6" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" strokeWidth="2" fill="none"/></svg>,
  Test:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>,
  Copy:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><rect x="9" y="9" width="13" height="13" rx="2" stroke="currentColor" strokeWidth="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></svg>,
  Download:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/><polyline points="7 10 12 15 17 10" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/><line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" strokeWidth="2" strokeLinecap="round"/></svg>,
  Review:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><rect x="3" y="3" width="18" height="18" rx="3" fill="currentColor" opacity="0.25"/><path d="M7 12L10 15L17 9" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"/><path d="M3 8H21" stroke="currentColor" strokeWidth="1.5" opacity="0.4"/></svg>,
  MoreV:({s=24,c=""})=><svg width={s} height={s} viewBox="0 0 24 24" fill="none" className={c}><circle cx="12" cy="5" r="2" fill="currentColor"/><circle cx="12" cy="12" r="2" fill="currentColor"/><circle cx="12" cy="19" r="2" fill="currentColor"/></svg>,
};

// Empty States (small but v4-style)
const Empty={
  List:()=><div className="flex flex-col items-center py-4 anim-in"><svg width="48" height="48" viewBox="0 0 100 100" fill="none" className="anim-float opacity-70"><rect x="20" y="15" width="60" height="60" rx="8" fill="#E8F0EA" stroke="#7CB69D" strokeWidth="3"/><rect x="30" y="30" width="10" height="3" rx="1.5" fill="#7CB69D"/><rect x="45" y="30" width="25" height="3" rx="1.5" fill="#9DC4A8"/><rect x="30" y="42" width="10" height="3" rx="1.5" fill="#7CB69D"/><rect x="45" y="42" width="20" height="3" rx="1.5" fill="#9DC4A8"/></svg><p className="text-bark-400 dark:text-sand-300 text-xs font-medium mt-2">Empty list</p></div>,
  NoLists:({onCreate})=><div className="flex flex-col items-center justify-center py-12 anim-in"><svg width="64" height="64" viewBox="0 0 100 100" fill="none" className="anim-float opacity-70 mb-4"><rect x="15" y="10" width="60" height="70" rx="8" fill="#E8F0EA" stroke="#7CB69D" strokeWidth="2.5"/><rect x="25" y="25" width="10" height="3" rx="1.5" fill="#7CB69D"/><rect x="40" y="25" width="30" height="3" rx="1.5" fill="#9DC4A8"/><rect x="25" y="37" width="10" height="3" rx="1.5" fill="#7CB69D"/><rect x="40" y="37" width="25" height="3" rx="1.5" fill="#9DC4A8"/><rect x="25" y="49" width="10" height="3" rx="1.5" fill="#7CB69D"/><rect x="40" y="49" width="35" height="3" rx="1.5" fill="#9DC4A8"/><path d="M70 65L80 75M80 65L70 75" stroke="#7CB69D" strokeWidth="3" strokeLinecap="round"/></svg><h3 className="text-lg font-bold text-bark-600 dark:text-sand-100 mb-2">üìã No Checklists Yet</h3><p className="text-sm text-bark-500 dark:text-sand-300 text-center mb-6 max-w-xs">Create your first checklist to start organizing!</p><button onClick={onCreate} className="px-6 py-3 bg-sage-400 text-white rounded-xl font-semibold shadow-sm hover:bg-sage-500 transition-colors flex items-center gap-2"><I.Plus s={20}/>Create Checklist</button></div>,
  Tasks:()=><div className="flex items-center justify-center py-1.5"><span className="text-bark-400/40 dark:text-sand-300/30 text-xs">No tasks</span></div>,
  Focus:()=><div className="flex flex-col items-center py-4 anim-in"><svg width="56" height="56" viewBox="0 0 100 100" fill="none" className="anim-float opacity-70"><circle cx="50" cy="50" r="35" fill="#E8F0EA" stroke="#7CB69D" strokeWidth="3"/><circle cx="50" cy="50" r="20" fill="#C5D9CA" opacity="0.5"/><circle cx="50" cy="50" r="8" fill="#7CB69D"/></svg><p className="text-bark-400 dark:text-sand-300 text-xs font-medium mt-2">Add tasks from Clarify ‚Ä¢ Max 5</p></div>,
  Remind:()=><div className="flex flex-col items-center py-4 anim-in"><svg width="48" height="48" viewBox="0 0 100 100" fill="none" className="anim-float opacity-70"><path d="M50 20C38 20 30 30 30 42V55L24 65H76L70 55V42C70 30 62 20 50 20Z" fill="#FCEEE9" stroke="#E07A5F" strokeWidth="2.5"/><circle cx="50" cy="20" r="4" fill="#E07A5F"/></svg><p className="text-bark-400 dark:text-sand-300 text-xs font-medium mt-2">No reminders</p></div>,
  Notes:()=><div className="flex flex-col items-center py-6 anim-in"><svg width="48" height="48" viewBox="0 0 100 100" fill="none" className="anim-float opacity-70"><rect x="20" y="15" width="60" height="70" rx="6" fill="#E6F2F7" stroke="#5A9BBF" strokeWidth="2.5"/><circle cx="32" cy="35" r="3" fill="#5A9BBF"/><rect x="42" y="33" width="28" height="4" rx="2" fill="#5A9BBF" opacity="0.5"/><circle cx="32" cy="50" r="3" fill="#5A9BBF"/><rect x="42" y="48" width="22" height="4" rx="2" fill="#5A9BBF" opacity="0.5"/><circle cx="32" cy="65" r="3" fill="#5A9BBF"/><rect x="42" y="63" width="30" height="4" rx="2" fill="#5A9BBF" opacity="0.5"/></svg><p className="text-bark-400 dark:text-sand-300 text-sm font-medium mt-3">Start your quick notes</p><p className="text-bark-400/50 dark:text-sand-300/50 text-xs">Press Enter to add bullets</p></div>,
};

// Theme
const ThemeCtx=createContext();
const ThemeProv=({children})=>{
  const[theme,setTheme]=useState(()=>S.getSync('theme','system'));
  useEffect(()=>{S.get('theme','system').then(v=>{if(v!==theme)setTheme(v);});},[]);
  useEffect(()=>{S.set('theme',theme);const r=document.documentElement,m=document.getElementById('theme-color-meta');if(theme==='system'){const p=window.matchMedia('(prefers-color-scheme:dark)').matches;r.classList.toggle('dark',p);m.content=p?'#2D2720':'#F7F5F0';}else{r.classList.toggle('dark',theme==='dark');m.content=theme==='dark'?'#2D2720':'#F7F5F0';}},[theme]);
  return<ThemeCtx.Provider value={{theme,setTheme}}>{children}</ThemeCtx.Provider>;
};

// Desktop check
const useDesk=()=>{const[d,setD]=useState(window.innerWidth>=768);useEffect(()=>{const h=()=>setD(window.innerWidth>=768);window.addEventListener('resize',h);return()=>window.removeEventListener('resize',h);},[]);return d;};
const useWide=()=>{const[w,setW]=useState(window.innerWidth>=1280);useEffect(()=>{const h=()=>setW(window.innerWidth>=1280);window.addEventListener('resize',h);return()=>window.removeEventListener('resize',h);},[]);return w;};
// Custom hook for IndexedDB persisted state
const usePersistedState=(key,defaultValue)=>{
  const[state,setState]=useState(()=>S.getSync(key,defaultValue));
  const[loaded,setLoaded]=useState(false);
  const timerRef=useRef(null);

  // Load from IndexedDB on mount
  useEffect(()=>{
    S.get(key,defaultValue).then(val=>{
      setState(val);
      setLoaded(true);
    });
  },[key]);

  // Debounced save to IndexedDB on change (~300ms)
  useEffect(()=>{
    if(loaded){
      clearTimeout(timerRef.current);
      timerRef.current=setTimeout(()=>S.set(key,state),300);
    }
    return()=>clearTimeout(timerRef.current);
  },[key,state,loaded]);

  return[state,setState];
};

// Animated close hook ‚Äî sets closing=true, plays exit animation, then calls onClose (v16.11)
const useAnimatedClose=(onClose)=>{
  const[closing,setClosing]=useState(false);
  const triggerClose=useCallback(()=>setClosing(true),[]);
  useEffect(()=>{
    if(!closing)return;
    const timer=setTimeout(()=>onClose(),200);
    return()=>clearTimeout(timer);
  },[closing]);// intentionally excludes onClose ‚Äî it's stable within modal lifetime
  return{closing,triggerClose};
};

// Subtasks
const Subtasks=({items=[],onChange,ro=false})=>{
  const[n,setN]=useState('');
  const add=()=>{if(!n.trim())return;onChange([...items,{id:uid(),text:n,done:false}]);setN('');};
  return(
    <div className="space-y-1.5">
      {items.map(s=>(
        <div key={s.id} className="flex items-center gap-2 pl-1">
          <button onClick={()=>!ro&&onChange(items.map(x=>x.id===s.id?{...x,done:!x.done}:x))} className={`w-4 h-4 rounded-full border-2 flex items-center justify-center text-xs ${s.done?'bg-sage-400 border-sage-400 text-white':'border-sage-300'}`}>{s.done&&'‚úì'}</button>
          <span className={`flex-1 text-sm sel ${s.done?'line-through text-bark-400/50':'text-bark-600 dark:text-sand-200'}`}>{s.text}</span>
          {!ro&&<button onClick={()=>onChange(items.filter(x=>x.id!==s.id))} className="text-bark-400/50 text-xs hover:text-terracotta-400">‚úï</button>}
        </div>
      ))}
      {!ro&&<div className="flex gap-2 pl-1"><input type="text" value={n} onChange={e=>setN(e.target.value)} onKeyDown={e=>e.key==='Enter'&&add()} placeholder="Add subtask..." className="flex-1 text-sm bg-transparent border-b border-sand-300 dark:border-bark-500 focus:outline-none focus:border-sage-400 py-1 text-bark-600 dark:text-sand-200"/><button onClick={add} className="text-sage-500 text-sm font-semibold">+</button></div>}
    </div>
  );
};

// Quick Add Component
const QuickAdd=({placeholder,onAdd,buttonText='Add'})=>{
  const[val,setVal]=useState('');
  const[focused,setFocused]=useState(false);
  const handleAdd=()=>{if(val.trim()){onAdd(val.trim());setVal('');setFocused(false);}};
  return(
    <div className={`gcard rounded-2xl p-3 md:p-4 transition-all ${focused?'ring-2 ring-sage-400':''}`}>
      <div className="flex gap-2 md:gap-3">
        <input 
          type="text" 
          value={val} 
          onChange={e=>setVal(e.target.value)} 
          onFocus={()=>setFocused(true)}
          onBlur={()=>setTimeout(()=>setFocused(false),200)}
          onKeyDown={e=>{if(e.key==='Enter')handleAdd();if(e.key==='Escape'){setVal('');setFocused(false);}}}
          placeholder={placeholder}
          className="flex-1 bg-transparent focus:outline-none text-bark-600 dark:text-sand-100 placeholder-bark-400/50 md:text-base md:py-1"
        />
        {val.trim()&&<button onClick={handleAdd} className="px-4 md:px-5 py-1.5 md:py-2 bg-sage-400 rounded-lg md:rounded-xl text-white font-semibold text-sm md:text-base">{buttonText}</button>}
      </div>
    </div>
  );
};

// List Menu Component
// Batch Selection Checkbox (v10.3)
const SelCheck=({checked,onToggle})=>(
  <button onClick={e=>{e.stopPropagation();onToggle();}} className={`w-6 h-6 rounded-md border-2 flex items-center justify-center flex-shrink-0 transition-all ${checked?'bg-sage-400 border-sage-400 text-white':'border-bark-300 dark:border-sand-300'}`} aria-label={checked?'Deselect':'Select'}>{checked&&<span className="text-sm font-bold">‚úì</span>}</button>
);

// Bulk Action Bar (v10.4)
const BulkActionBar=({count,section,allCount,onSelectAll,onDeselectAll,onAction,onCancel})=>{
  const allSelected=count===allCount&&allCount>0;
  const showDone=section==='todos'||section==='lists';
  const showNoteActions=section==='notes';
  return(
    <div className="fixed bottom-[72px] left-0 right-0 px-3 pb-2 anim-in" style={{zIndex:25}}>
      <div className="glass rounded-2xl soft-shadow max-w-lg md:max-w-2xl mx-auto">
        <div className="flex items-center justify-between px-4 py-2 border-b border-sand-200/50 dark:border-bark-500/30">
          <div className="flex items-center gap-2">
            <span className="font-bold text-sage-500 text-sm">{count} selected</span>
            <button onClick={allSelected?onDeselectAll:onSelectAll} className="text-xs font-semibold text-ocean-400 hover:text-ocean-500 transition-colors">{allSelected?'Deselect All':'Select All'}</button>
          </div>
          <button onClick={onCancel} className="p-1.5 rounded-lg hover:bg-sand-200 dark:hover:bg-bark-600 text-bark-400 transition-colors" aria-label="Cancel selection"><I.X s={18}/></button>
        </div>
        <div className="flex items-center justify-around px-2 py-2.5">
          {showDone&&<button onClick={()=>onAction('done')} className="flex flex-col items-center gap-1 px-3 py-1.5 rounded-xl hover:bg-sage-100 dark:hover:bg-sage-400/20 transition-colors" aria-label="Mark done"><I.Done s={22} c="text-sage-500"/><span className="text-xs font-semibold text-sage-600 dark:text-sage-300">{section==='lists'?'Toggle':'Done'}</span></button>}
          {showNoteActions&&<button onClick={()=>onAction('clarify')} className="flex flex-col items-center gap-1 px-3 py-1.5 rounded-xl hover:bg-sage-100 dark:hover:bg-sage-400/20 transition-colors" aria-label="Move to Clarify"><I.Check s={22} c="text-sage-500"/><span className="text-xs font-semibold text-sage-600 dark:text-sage-300">Clarify</span></button>}
          {showNoteActions&&<button onClick={()=>onAction('strike')} className="flex flex-col items-center gap-1 px-3 py-1.5 rounded-xl hover:bg-ocean-100 dark:hover:bg-ocean-400/20 transition-colors" aria-label="Strikethrough"><span className="text-bark-400 font-bold text-lg line-through">S</span><span className="text-xs font-semibold text-ocean-600 dark:text-ocean-300">Strike</span></button>}
          <button onClick={()=>onAction('delete')} className="flex flex-col items-center gap-1 px-3 py-1.5 rounded-xl hover:bg-terracotta-100 dark:hover:bg-terracotta-400/20 transition-colors" aria-label="Delete selected"><I.Trash s={22} c="text-terracotta-400"/><span className="text-xs font-semibold text-terracotta-500 dark:text-terracotta-300">Delete</span></button>
        </div>
      </div>
    </div>
  );
};

// Unified ContextMenu (v16.9) ‚Äî replaces TaskMenu, NoteMenu, ListMenu
const ContextMenu=({title,items,onClose,position})=>{
  const{closing,triggerClose}=useAnimatedClose(onClose);
  const pos=!!position;
  return(
    <div className={pos?"fixed inset-0 z-30":"fixed inset-0 bg-bark-700/40 backdrop-blur-sm flex items-center justify-center z-40"} onClick={triggerClose}>
      <div className={pos?`gcard rounded-xl shadow-lg overflow-hidden${closing?' anim-out':''}`:`gcard w-full max-w-xs rounded-2xl overflow-hidden anim-in${closing?' anim-out':''} mx-4`} style={pos?{position:'absolute',top:position.y,left:position.x}:undefined} onClick={e=>e.stopPropagation()}>
        {title&&<div className="px-4 py-3 border-b border-sand-200 dark:border-bark-500"><p className="font-bold text-bark-600 dark:text-sand-100 truncate">{title}</p></div>}
        {items.map((item,i)=>(
          <button key={i} onClick={()=>{item.onClick();triggerClose();}} className={`menu-btn ${item.borderTop?'menu-btn-border':''} ${item.variant==='danger'?'hover:bg-terracotta-100 dark:hover:bg-terracotta-400/20':'hover:bg-sage-100 dark:hover:bg-sage-400/20'}`}>
            {item.icon}<span className="font-medium text-bark-600 dark:text-sand-100">{item.label}</span>{item.extra&&item.extra}
          </button>
        ))}
      </div>
    </div>
  );
};

// Unified ConfirmDialog (v16.9) ‚Äî replaces DeleteConfirmation, BulkDeleteConfirm
const ConfirmDialog=({icon,iconBg,title,message,confirmLabel,onConfirm,onCancel,variant})=>{
  const[closing,setClosing]=useState(false);
  const[doConfirm,setDoConfirm]=useState(false);
  useEffect(()=>{
    if(!closing)return;
    const timer=setTimeout(()=>doConfirm?onConfirm():onCancel(),200);
    return()=>clearTimeout(timer);
  },[closing,doConfirm]);
  const triggerCancel=useCallback(()=>setClosing(true),[]);
  const triggerConfirm=useCallback(()=>{setDoConfirm(true);setClosing(true);},[]);
  return(
  <div className="fixed inset-0 bg-bark-700/60 backdrop-blur-sm flex items-center justify-center z-50 p-3" onClick={triggerCancel}>
    <div className={`gcard w-full max-w-sm rounded-2xl p-5 anim-in${closing?' anim-out':''}`} onClick={e=>e.stopPropagation()}>
      <div className="text-center mb-4">
        <div className={`w-16 h-16 ${iconBg} rounded-full flex items-center justify-center mx-auto mb-3`}>{icon}</div>
        <h3 className="text-lg font-bold text-bark-600 dark:text-sand-100 mb-2">{title}</h3>
        <p className="text-sm text-bark-500 dark:text-sand-300">{message}</p>
      </div>
      <div className="flex gap-2">
        {variant==='info'?
          <button onClick={triggerCancel} className="flex-1 py-2.5 bg-ocean-400 rounded-lg font-semibold text-white text-sm">OK</button>
        :<><button onClick={triggerCancel} className="flex-1 py-2.5 bg-sand-200 dark:bg-bark-600 rounded-lg font-semibold text-bark-600 dark:text-sand-200 text-sm">Cancel</button>
          <button onClick={triggerConfirm} className="flex-1 py-2.5 bg-terracotta-400 rounded-lg font-semibold text-white text-sm">{confirmLabel||'Confirm'}</button></>}
      </div>
    </div>
  </div>
  );
};

// StickyHeader (v16.10) ‚Äî unified sticky section header wrapper
const StickyHeader=({children})=>(
  <div data-testid="sticky-header" className="sticky top-14 md:top-16 xl:top-0 -mx-4 md:-mx-8 z-10 glass px-4 md:px-6 py-3 md:py-4 mb-4">
    {children}
  </div>
);

const LinkPicker=({task,lists,onLink,onCreate,onUnlink,onClose})=>{
  const{closing,triggerClose}=useAnimatedClose(onClose);
  const[newName,setNewName]=useState('');
  return(
  <div className="fixed inset-0 bg-bark-700/60 backdrop-blur-sm flex items-center justify-center z-50 p-3" onClick={triggerClose}>
    <div className={`gcard w-full max-w-sm rounded-2xl p-5 anim-in${closing?' anim-out':''}`} onClick={e=>e.stopPropagation()}>
      <div className="flex items-center justify-between mb-3"><h3 className="font-bold text-bark-600 dark:text-sand-100">üìã Link Checklist</h3><button onClick={triggerClose} className="text-bark-400"><I.X s={20}/></button></div>
      <p className="text-xs text-bark-500 dark:text-sand-200 mb-3">Link <strong>"{task.text}"</strong> to a checklist:</p>
      {task.linkedList&&<button onClick={()=>{onUnlink(task.id);triggerClose();}} className="w-full mb-3 py-2.5 px-4 rounded-xl bg-terracotta-100 dark:bg-terracotta-400/20 text-terracotta-500 text-sm font-semibold text-left">‚úï Remove current link</button>}
      <div className="space-y-1.5 max-h-48 overflow-y-auto hide-sb mb-3">{lists.map(l=><button key={l.id} onClick={()=>{onLink(task.id,l.id);triggerClose();}} className={`w-full py-2.5 px-4 rounded-xl text-sm font-medium text-left transition-colors ${task.linkedList===l.id?'bg-sage-400 text-white':'gcard text-bark-600 dark:text-sand-100 hover:bg-sage-50 dark:hover:bg-sage-400/10'}`}>{l.name}<span className="ml-2 text-xs opacity-60">({l.items.filter(i=>!i.done).length}/{l.items.length})</span></button>)}</div>
      <div className="flex gap-2"><input type="text" value={newName} onChange={e=>setNewName(e.target.value)} placeholder="New checklist name..." onKeyDown={e=>{if(e.key==='Enter'&&newName.trim()){onCreate(task.id,newName.trim());triggerClose();}}} className="flex-1 bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500"/><button onClick={()=>{if(newName.trim()){onCreate(task.id,newName.trim());triggerClose();}}} className="px-4 py-2 bg-sage-400 rounded-lg text-white text-sm font-semibold">Create</button></div>
    </div>
  </div>
  );
};

// Edit Modal
const EditModal=({item,type,onSave,onClose,onDelete})=>{
  const{closing,triggerClose}=useAnimatedClose(onClose);
  const[text,setText]=useState(item?.text||item?.title||'');
  const[content,setContent]=useState(item?.content||'');
  const[notes,setNotes]=useState(item?.notes||'');
  const[subtasks,setSub]=useState(item?.subtasks||[]);
  const[section,setSec]=useState(item?.section||'');
  const[quad,setQuad]=useState(item?.quad||'nn');
  const[cat,setCat]=useState(item?.cat||null);
  const[time,setTime]=useState(item?.time||'09:00');
  const[date,setDate]=useState(item?.date||new Date().toISOString().split('T')[0]);
  const[deadline,setDl]=useState(item?.deadline||'');

  const save=()=>{
    if(!text.trim())return;
    if(type==='note')onSave({...item,title:text,content,notes});
    else if(type==='list')onSave({...item,text,notes,section});
    else if(type==='todo')onSave({...item,text,notes,subtasks,quad,cat,deadline});
    else if(type==='reminder')onSave({...item,text,time,date});
    triggerClose();
  };

  return(
    <div className="fixed inset-0 bg-bark-700/60 backdrop-blur-sm flex items-center justify-center z-40 p-3" onClick={triggerClose}>
      <div className={`gcard w-full max-w-md md:max-w-lg rounded-2xl p-4 md:p-6 max-h-[90vh] overflow-y-auto anim-in${closing?' anim-out':''} modal-content`} onClick={e=>e.stopPropagation()}>
        <div className="flex items-center justify-between mb-3">
          <h3 className="font-bold text-bark-600 dark:text-sand-100">{item?.id?'Edit':'New'} {type==='note'?'Note':type==='list'?'Item':type==='todo'?'Task':'Reminder'}</h3>
          <button onClick={triggerClose} className="text-bark-400"><I.X s={22}/></button>
        </div>
        <div className="space-y-3">
          <div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">{type==='note'?'Title':'Text'}</label><input type="text" value={text} onChange={e=>setText(e.target.value)} className="w-full bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500 text-sm" placeholder={type==='reminder'?'e.g. Take medicine':'Enter text...'}/></div>
          {type==='note'&&<div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Content</label><textarea value={content} onChange={e=>setContent(e.target.value)} className="w-full bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500 min-h-24 text-sm"/></div>}
          {type==='list'&&<div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Section</label><input type="text" value={section} onChange={e=>setSec(e.target.value)} className="w-full bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500 text-sm"/></div>}
          {type==='todo'&&<>
            <div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Priority</label><div className="grid grid-cols-2 gap-1.5">{QUADS.map(q=><button key={q.id} onClick={()=>setQuad(q.id)} className={`p-2 rounded-lg border-2 text-left text-xs ${quad===q.id?`${q.bdr} bg-gradient-to-r ${q.clr}`:'border-sand-200 dark:border-bark-500'}`}><span className={`font-semibold ${q.txt}`}>{q.l}</span></button>)}</div></div>
            <div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Category</label><div className="flex flex-wrap gap-1.5">{CATS.map(c=><button key={c.id} onClick={()=>setCat(cat===c.id?null:c.id)} className={`px-2.5 py-1 rounded-full text-xs font-medium ${cat===c.id?`${c.clr} text-white`:'bg-sand-100 dark:bg-bark-600 text-bark-600 dark:text-sand-200'}`}>{c.e} {c.l}</button>)}</div></div>
            <div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Deadline</label><input type="date" value={deadline} onChange={e=>setDl(e.target.value)} className="w-full bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500 text-sm"/></div>
          </>}
          {type==='reminder'&&<>
            <div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Date</label><input type="date" value={date} onChange={e=>setDate(e.target.value)} className="w-full bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500 text-sm"/></div>
            <div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Time</label><input type="time" value={time} onChange={e=>setTime(e.target.value)} className="w-full bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500 text-sm"/></div>
          </>}
          {type!=='reminder'&&<div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Notes</label><textarea value={notes} onChange={e=>setNotes(e.target.value)} className="w-full bg-cream-100 dark:bg-bark-600 rounded-lg px-3 py-2.5 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100 border border-sand-200 dark:border-bark-500 min-h-16 text-sm"/></div>}
          {type==='todo'&&<div><label className="text-xs font-semibold text-bark-400/70 mb-1 block">Subtasks</label><Subtasks items={subtasks} onChange={setSub}/></div>}
        </div>
        <div className="flex gap-2 mt-4">
          {type==='list'&&item?.id&&<button onClick={()=>{if(confirm('Delete this item?')){onDelete?.();triggerClose();}}} className="py-2.5 px-4 bg-terracotta-100 dark:bg-terracotta-400/20 rounded-lg font-semibold text-terracotta-500 dark:text-terracotta-300 text-sm hover:bg-terracotta-200 transition-colors"><I.Trash s={16} c="inline mr-1"/>Delete</button>}
          <button onClick={triggerClose} className="flex-1 py-2.5 bg-sand-200 dark:bg-bark-600 rounded-lg font-semibold text-bark-600 dark:text-sand-200 text-sm">Cancel</button><button onClick={save} className="flex-1 py-2.5 bg-sage-400 rounded-lg font-semibold text-white text-sm">Save</button></div>
      </div>
    </div>
  );
};

// Help Modal - Compact App Navigation
const AboutModal=({onClose,isWelcome})=>{
  const{closing,triggerClose}=useAnimatedClose(onClose);
  return(
  <div className="fixed inset-0 bg-bark-700/60 backdrop-blur-sm flex items-center justify-center z-50 p-2" onClick={triggerClose}>
    <div className={`gcard w-full max-w-sm md:max-w-lg rounded-2xl p-5 md:p-6 anim-in${closing?' anim-out':''}`} onClick={e=>e.stopPropagation()}>
      {isWelcome?(<div className="text-center mb-4"><div className="text-3xl mb-1">üåø</div><h2 className="text-lg md:text-xl font-extrabold text-bark-600 dark:text-sand-100">Welcome to Productivity Hub</h2><p className="text-sm text-bark-400 dark:text-sand-300 mt-0.5">Your all-in-one productivity system</p></div>):(<div className="flex items-center justify-between mb-3"><h2 className="text-base md:text-lg font-bold text-bark-600 dark:text-sand-100">üåø About Productivity Hub</h2><button onClick={triggerClose} className="text-bark-400 hover:text-bark-600"><I.X s={20}/></button></div>)}
      <div className="space-y-2">
        <div><span className="font-bold text-bark-600 dark:text-sand-100">üìù Capture</span><span className="text-sm text-bark-500 dark:text-sand-200"> ‚Äî Brain dump everything. No organizing yet.</span></div>
        <div><span className="font-bold text-bark-600 dark:text-sand-100">üéØ Clarify</span><span className="text-sm text-bark-500 dark:text-sand-200"> ‚Äî Sort by urgency & importance. Tap to toggle done. ‚ãÆ for actions.</span></div>
        <div><span className="font-bold text-bark-600 dark:text-sand-100">‚è± Focus</span><span className="text-sm text-bark-500 dark:text-sand-200"> ‚Äî Queue 3‚Äì5 tasks. Work in timed sessions.</span></div>
        <div><span className="font-bold text-bark-600 dark:text-sand-100">‚úÖ Confirm</span><span className="text-sm text-bark-500 dark:text-sand-200"> ‚Äî Checklists for tasks. Link from Clarify to break work into steps.</span></div>
        <div><span className="font-bold text-bark-600 dark:text-sand-100">üìä Review</span><span className="text-sm text-bark-500 dark:text-sand-200"> ‚Äî Weekly stats, streaks & insights.</span></div>
      </div>
      <div className="mt-3 text-center"><p className="text-sm font-bold text-sage-500 dark:text-sage-400">Capture ‚Üí Clarify ‚Üí Focus ‚Üí Confirm ‚Üí Review ‚Üí Repeat</p></div>
      <p className="mt-3 text-xs text-center text-bark-400 dark:text-sand-300">üìö Visit <strong className="text-bark-600 dark:text-sand-100">More ‚Üí Explainer</strong> for the full guide</p>
      <button onClick={triggerClose} className="w-full mt-3 py-2.5 bg-sage-400 rounded-xl font-bold text-white text-sm hover:bg-sage-500 transition-colors">{isWelcome?'Get Started':'Got it!'}</button>
    </div>
  </div>
  );
};
window.PH_BLOCK_A=Object.freeze({
  useState,useEffect,useRef,useMemo,useCallback,createContext,useContext,
  APP_VERSION,initDB,S,uid,notify,reqNotifyPerm,PRESETS,QUADS,CATS,shareItem,genICS,dlFile,
  I,Empty,ThemeCtx,ThemeProv,useDesk,useWide,usePersistedState,useAnimatedClose,
  Subtasks,QuickAdd,SelCheck,BulkActionBar,ContextMenu,ConfirmDialog,StickyHeader,LinkPicker,EditModal,AboutModal
});
})();
/* == END: Block A == */
</script>
<script type="text/babel">
/* == BEGIN: Block B == */
(()=>{
const PH_BLOCK_A_B=window.PH_BLOCK_A;
if(!PH_BLOCK_A_B)throw new Error('Block A exports missing. Cannot initialize Block B.');
const{
  useState,useEffect,useRef,useMemo,useCallback,createContext,useContext,
  APP_VERSION,initDB,S,uid,notify,reqNotifyPerm,PRESETS,QUADS,CATS,shareItem,genICS,dlFile,
  I,Empty,ThemeCtx,ThemeProv,useDesk,useWide,usePersistedState,useAnimatedClose,
  Subtasks,QuickAdd,SelCheck,BulkActionBar,ContextMenu,ConfirmDialog,StickyHeader,LinkPicker,EditModal,AboutModal
}=PH_BLOCK_A_B;
// Streak Heatmap (GitHub-style)
const Heatmap=({dHist,met})=>{
  const[sel,setSel]=useState(null);
  const weeks=13,days=7;
  const today=new Date();
  const todayStr=today.toDateString();

  // Build grid data: 13 weeks √ó 7 days
  const cells=useMemo(()=>{
    const arr=[];
    const startOff=(weeks*days)-1;
    for(let i=startOff;i>=0;i--){
      const d=new Date(today);d.setDate(d.getDate()-i);
      const ds=d.toDateString();
      const isFuture=d>today&&ds!==todayStr;
      const hist=dHist.find(x=>x.date===ds);
      const isToday=ds===todayStr;
      const p=isToday?met.d.p:(hist?.p||0);
      const t=isToday?met.d.t:(hist?.t||0);
      const m=isToday?met.d.m:(hist?.m||0);
      arr.push({date:d,ds,p,t,m,isFuture,isToday,day:d.getDay()});
    }
    return arr;
  },[dHist,met.d]);

  // Compute streaks
  const{cur,longest}=useMemo(()=>{
    let c=0,l=0,streak=0;
    for(let i=0;i<=((weeks*days)-1);i++){
      const d=new Date(today);d.setDate(d.getDate()-i);
      const ds=d.toDateString();
      const hist=dHist.find(x=>x.date===ds);
      const isToday=ds===todayStr;
      const p=isToday?met.d.p:(hist?.p||0);
      const t=isToday?met.d.t:(hist?.t||0);
      if(p>0||t>0){streak++;if(streak>l)l=streak;}
      else{if(i===0){streak=0;}else{if(c===0)c=streak;break;}}
    }
    if(c===0)c=streak;
    return{cur:c,longest:l};
  },[dHist,met.d]);

  // Color by pomodoro count
  const clr=(p,isFuture)=>{
    if(isFuture)return'bg-transparent';
    if(p===0)return'bg-sand-200/60 dark:bg-bark-600/40';
    if(p<=1)return'bg-sage-200 dark:bg-sage-400/30';
    if(p<=3)return'bg-sage-300 dark:bg-sage-400/50';
    if(p<=5)return'bg-sage-400 dark:bg-sage-400/70';
    return'bg-sage-600 dark:bg-sage-500';
  };

  // Arrange into columns (weeks). Each column = 7 days (Sun-Sat)
  const cols=[];
  for(let w=0;w<weeks;w++){cols.push(cells.slice(w*days,(w+1)*days));}

  const mLabels=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const dLabels=['','M','','W','','F',''];

  return(
    <div className="section-card">
      <div className="flex items-center justify-between mb-3">
        <h3 className="font-bold text-bark-600 dark:text-sand-100">üî• Streak</h3>
        <div className="flex gap-3 text-xs">
          <span className="text-bark-500 dark:text-sand-200"><span className="font-bold text-terracotta-400">{cur}</span> day{cur!==1?'s':''} current</span>
          <span className="text-bark-500 dark:text-sand-200"><span className="font-bold text-sage-500">{longest}</span> longest</span>
        </div>
      </div>
      <div className="flex gap-0.5 overflow-x-auto hide-sb">
        <div className="flex flex-col gap-0.5 mr-1 pt-4">
          {dLabels.map((l,i)=><div key={i} className="h-3 text-[9px] leading-3 text-bark-400/50 dark:text-sand-300/50 text-right pr-0.5">{l}</div>)}
        </div>
        {cols.map((wk,wi)=>{
          const firstDay=wk[0]?.date;
          const showMonth=wi===0||(firstDay&&firstDay.getDate()<=7);
          return(
            <div key={wi} className="flex flex-col gap-0.5">
              <div className="h-3 text-[9px] leading-3 text-bark-400/50 dark:text-sand-300/50 text-center">{showMonth&&firstDay?mLabels[firstDay.getMonth()]:''}</div>
              {wk.map((c,di)=>(
                <div key={di} onClick={()=>!c.isFuture&&setSel(sel?.ds===c.ds?null:c)} title={c.isFuture?'':`${c.date.toLocaleDateString()}: ${c.p}üçÖ ${c.t}‚úì ${c.m}m`}
                  className={`w-3 h-3 rounded-[2px] cursor-pointer transition-all ${clr(c.p,c.isFuture)} ${c.isToday?'ring-1 ring-terracotta-300 dark:ring-terracotta-400':''} ${sel?.ds===c.ds?'ring-1 ring-ocean-400':''}`}/>
              ))}
            </div>
          );
        })}
      </div>
      <div className="flex items-center gap-1 mt-2 justify-end">
        <span className="text-[9px] text-bark-400/50 dark:text-sand-300/50">Less</span>
        {[0,1,2,4,6].map(v=><div key={v} className={`w-2.5 h-2.5 rounded-[2px] ${clr(v,false)}`}/>)}
        <span className="text-[9px] text-bark-400/50 dark:text-sand-300/50">More</span>
      </div>
      {sel&&!sel.isFuture&&(
        <div className="mt-3 p-3 rounded-xl bg-sand-50 dark:bg-bark-600/50 flex items-center gap-4">
          <div className="text-sm font-medium text-bark-600 dark:text-sand-100">{sel.date.toLocaleDateString(undefined,{weekday:'short',month:'short',day:'numeric'})}</div>
          <div className="flex gap-3 text-xs text-bark-500 dark:text-sand-200">
            <span>üçÖ {sel.p}</span><span>‚úì {sel.t}</span><span>‚è± {sel.m}m</span>
          </div>
        </div>
      )}
    </div>
  );
};

// Mini Chart
const Chart=({data,label,clr='bg-sage-400'})=>{
  const max=Math.max(...data.map(d=>d.v),1);
  return<div className="gcard rounded-xl p-3"><h4 className="text-sm font-bold text-bark-600 dark:text-sand-100 mb-3">{label}</h4><div className="flex items-end gap-1 h-16">{data.map((d,i)=><div key={i} className="flex-1 flex flex-col items-center gap-0.5"><div className={`w-full ${clr} rounded-t`} style={{height:`${(d.v/max)*100}%`,minHeight:d.v>0?'3px':'0'}}/><span className="text-xs text-bark-400/60">{d.l}</span></div>)}</div></div>;
};

// ============================================
// TEST APP FEATURE - Alpha Version
// ============================================
const TEST_SUITE_VERSION='2.1.0';
const TEST_BASELINE_DATE='2026-02-19';
const TIER_ORDER=['T0','T1','T2'];
const TIER_TARGETS={T0:1,T1:1,T2:0.9};
const TEST_RUNNER_LAZY_DELAY_MS=60;
const REQUIRED_PH_CORE_KEYS=['APP_VERSION','initDB','S','uid','notify','reqNotifyPerm','PRESETS','QUADS','CATS','shareItem','genICS','dlFile'];

const createTestRunnerModel=()=>{
  const manifest=Object.freeze({
    suiteVersion:TEST_SUITE_VERSION,
    baselineDate:TEST_BASELINE_DATE,
    tierOrder:[...TIER_ORDER],
    tierTargets:{...TIER_TARGETS},
    counts:Object.freeze({total:45,T0:11,T1:15,T2:19})
  });
  let cachedTests=null;
  let loadCount=0;
  return{
    getSuiteManifest(){return manifest;},
    loadTestCases(builder){
      if(!cachedTests){
        cachedTests=builder();
        loadCount++;
      }
      return cachedTests;
    },
    getLoadStats(){return{loaded:!!cachedTests,loadCount};}
  };
};

let __testRunnerFactoryCache=null;
let __testRunnerFactoryCreateCount=0;
const peekTestRunner=()=>__testRunnerFactoryCache;
const getTestRunner=async()=>{
  if(!__testRunnerFactoryCache){
    await new Promise(resolve=>setTimeout(resolve,TEST_RUNNER_LAZY_DELAY_MS));
    __testRunnerFactoryCache=TestRunnerInner;
    __testRunnerFactoryCreateCount++;
  }
  return __testRunnerFactoryCache;
};
const __resetTestRunnerCacheForTests=()=>{
  __testRunnerFactoryCache=null;
  __testRunnerFactoryCreateCount=0;
};
const __getTestRunnerCacheStats=()=>({
  hasCache:!!__testRunnerFactoryCache,
  createCount:__testRunnerFactoryCreateCount
});
window.__PH_RESET_TEST_RUNNER_CACHE=__resetTestRunnerCacheForTests;

const TestRunnerInner=({onShowToast})=>{
  const[running,setRunning]=useState(false);
  const[results,setResults]=useState(null);
  const[progress,setProgress]=useState({current:0,total:0,step:''});

  const modelRef=useRef(null);
  if(!modelRef.current)modelRef.current=createTestRunnerModel();
  const runnerModel=modelRef.current;
  const suiteManifest=runnerModel.getSuiteManifest();
  const SUITE_VERSION=suiteManifest.suiteVersion;
  const BASELINE_DATE=suiteManifest.baselineDate;

  const delay=(ms)=>new Promise(r=>setTimeout(r,ms));
  const normalizeErr=(err)=>err&&err.message?err.message:String(err||'Unknown error');
  const assert=(cond,msg='Assertion failed')=>{if(!cond)throw new Error(msg);};
  const assertEq=(actual,expected,msg)=>{if(actual!==expected)throw new Error(msg||`Expected ${JSON.stringify(expected)}, got ${JSON.stringify(actual)}`);};
  const assertIncludes=(value,needle,msg)=>{if(typeof value!=='string'||!value.includes(needle))throw new Error(msg||`Expected to include \"${needle}\"`);};

  const waitFor=(predicate,{timeout=2200,interval=25,message='Condition timed out'}={})=>new Promise((resolve,reject)=>{
    const started=Date.now();
    const tick=()=>{
      try{
        if(predicate())return resolve();
      }catch{}
      if(Date.now()-started>=timeout)return reject(new Error(message));
      setTimeout(tick,interval);
    };
    tick();
  });

  const runWithTimeout=(promise,ms,label)=>new Promise((resolve,reject)=>{
    const timer=setTimeout(()=>reject(new Error(`Timeout after ${ms}ms (${label})`)),ms);
    Promise.resolve(promise).then(v=>{clearTimeout(timer);resolve(v);}).catch(e=>{clearTimeout(timer);reject(e);});
  });

  const makeCleanupRegistry=()=>{
    const stack=[];
    return{
      add(fn){if(typeof fn==='function')stack.push(fn);},
      async runAll(){
        const errors=[];
        for(let i=stack.length-1;i>=0;i--){
          try{await stack[i]();}catch(err){errors.push(normalizeErr(err));}
        }
        if(errors.length)throw new Error(`Cleanup failed: ${errors.join(' | ')}`);
      }
    };
  };

  const setInputValue=(el,val)=>{
    assert(el,'Input element not found');
    const proto=Object.getPrototypeOf(el);
    const desc=proto&&Object.getOwnPropertyDescriptor(proto,'value');
    if(desc&&desc.set)desc.set.call(el,val);
    else el.value=val;
    el.dispatchEvent(new Event('input',{bubbles:true}));
    el.dispatchEvent(new Event('change',{bubbles:true}));
  };

  const findByText=(root,text,selector='*')=>Array.from(root.querySelectorAll(selector)).find(el=>((el.textContent||'').replace(/\s+/g,' ').trim()).includes(text));
  const findButtonByText=(root,text)=>findByText(root,text,'button');
  const isTouchEnvironment=()=>('ontouchstart' in window)||(navigator&&navigator.maxTouchPoints>0);
  const tapElement=(el)=>{
    assert(el,'Element not found for tap');
    if(isTouchEnvironment()){
      try{el.dispatchEvent(new Event('touchstart',{bubbles:true,cancelable:true}));}catch{}
      try{el.dispatchEvent(new Event('touchend',{bubbles:true,cancelable:true}));}catch{}
      return;
    }
    el.dispatchEvent(new MouseEvent('click',{bubbles:true}));
  };

  const withDomFixture=async(cleanupRegistry,fn)=>{
    const mount=document.createElement('div');
    mount.setAttribute('data-test-fixture','ph');
    mount.style.position='fixed';
    mount.style.left='-9999px';
    mount.style.top='-9999px';
    mount.style.width='520px';
    mount.style.maxHeight='80vh';
    mount.style.overflow='auto';
    document.body.appendChild(mount);
    cleanupRegistry.add(async()=>{
      try{if(mount.__root)mount.__root.unmount();}catch{}
      if(mount.parentNode)mount.parentNode.removeChild(mount);
    });
    return fn(mount);
  };

  const withStorageFixture=async(cleanupRegistry,fn)=>{
    const prefix=`__TEST__${uid()}_`;
    const touched=new Set();
    const fx={
      prefix,
      key:(name)=>{const k=prefix+name;touched.add(k);return k;},
      track:(key)=>{if(typeof key==='string'&&key.startsWith(prefix))touched.add(key);return key;}
    };
    cleanupRegistry.add(async()=>{
      for(const k of touched){await S.set(k,undefined);}
    });
    return fn(fx);
  };

  const withStorageSnapshot=async(cleanupRegistry,fn)=>{
    const snapshot=await S.exp();
    cleanupRegistry.add(async()=>{
      await S.clr();
      await S.imp(snapshot);
    });
    await S.clr();
    return fn(snapshot);
  };

  const withAppDataHarness=async(cleanupRegistry,fn)=>{
    const blockC=window.PH_BLOCK_C;
    assert(blockC&&typeof blockC.useAppData==='function','PH_BLOCK_C.useAppData is unavailable');
    return withDomFixture(cleanupRegistry,async mount=>{
      const bridge={app:null};
      function HookHarness(){
        bridge.app=blockC.useAppData();
        return null;
      }
      const root=ReactDOM.createRoot(mount);
      mount.__root=root;
      root.render(React.createElement(HookHarness));
      await waitFor(()=>bridge.app&&Array.isArray(bridge.app.todos),{timeout:3500,message:'useAppData harness failed to initialize'});
      return fn(()=>bridge.app,mount);
    });
  };

  const withSectionHarness=async(cleanupRegistry,SectionComp,sectionProps,fn)=>{
    const blockC=window.PH_BLOCK_C;
    assert(blockC&&blockC.AppDataProv&&blockC.useApp,'PH_BLOCK_C section exports unavailable');
    return withDomFixture(cleanupRegistry,async mount=>{
      const bridge={app:null};
      function Probe(){
        bridge.app=blockC.useApp();
        return null;
      }
      function Harness(){
        return React.createElement(
          blockC.AppDataProv,
          null,
          React.createElement(
            React.Fragment,
            null,
            React.createElement(SectionComp,sectionProps),
            React.createElement(Probe)
          )
        );
      }
      const root=ReactDOM.createRoot(mount);
      mount.__root=root;
      root.render(React.createElement(Harness));
      await waitFor(()=>bridge.app&&mount.textContent.length>0,{timeout:3500,message:'Section harness failed to mount'});
      return fn({mount,getApp:()=>bridge.app});
    });
  };

  const withSettingsHarness=async(cleanupRegistry,fn)=>{
    const blockA=window.PH_BLOCK_A;
    const blockC=window.PH_BLOCK_C;
    assert(blockA&&blockA.ThemeProv,'PH_BLOCK_A.ThemeProv is unavailable');
    assert(blockC&&blockC.AppDataProv&&blockC.SettingsSection,'Settings section exports unavailable');
    return withDomFixture(cleanupRegistry,async mount=>{
      function Harness(){
        return React.createElement(
          blockA.ThemeProv,
          null,
          React.createElement(
            blockC.AppDataProv,
            null,
            React.createElement(blockC.SettingsSection,{desk:false})
          )
        );
      }
      const root=ReactDOM.createRoot(mount);
      mount.__root=root;
      root.render(React.createElement(Harness));
      await waitFor(()=>mount.querySelectorAll('.more-sub-btn').length>=3,{timeout:3500,message:'Settings harness failed to mount'});
      return fn(mount);
    });
  };

  const buildTestCases=()=>[
    {
      id:'t0.shell.assets-loaded',
      name:'Shell links/scripts are present and loaded',
      tier:'T0',
      area:'Boot Contracts',
      async run({assert}){
        const cssLink=Array.from(document.querySelectorAll('link[rel="stylesheet"]')).find(l=>(l.getAttribute('href')||'').includes('styles/app.css'));
        assert(cssLink,'Missing stylesheet link for styles/app.css');
        const cssLoaded=Array.from(document.styleSheets).some(ss=>{
          const href=(ss.href||ss.ownerNode?.getAttribute?.('href')||'');
          return href.includes('styles/app.css');
        });
        assert(cssLoaded,'styles/app.css is not loaded');
        const pwaScript=Array.from(document.querySelectorAll('script[src]')).find(s=>(s.getAttribute('src')||'').includes('scripts/pwa_setup.js'));
        const coreScript=Array.from(document.querySelectorAll('script[src]')).find(s=>(s.getAttribute('src')||'').includes('scripts/app_core.js'));
        assert(pwaScript,'Missing scripts/pwa_setup.js');
        assert(coreScript,'Missing scripts/app_core.js');
      }
    },
    {
      id:'t0.contract.ph-core-keys',
      name:'PH_CORE contract keys are present and callable',
      tier:'T0',
      area:'Boot Contracts',
      async run({assert}){
        const core=window.PH_CORE;
        assert(core,'window.PH_CORE missing');
        for(const key of REQUIRED_PH_CORE_KEYS){assert(key in core,`PH_CORE missing ${key}`);}
        assert(typeof core.initDB==='function','PH_CORE.initDB must be a function');
        assert(typeof core.S.get==='function'&&typeof core.S.set==='function','PH_CORE.S get/set missing');
        assert(typeof core.S.exp==='function'&&typeof core.S.imp==='function'&&typeof core.S.clr==='function'&&typeof core.S.getSync==='function','PH_CORE.S exp/imp/clr/getSync missing');
        assert(typeof core.uid==='function','PH_CORE.uid must be a function');
      }
    },
    {
      id:'t0.contract.pwa-generator',
      name:'PWA generator returns valid non-empty files',
      tier:'T0',
      area:'Boot Contracts',
      async run({assert,assertIncludes}){
        assert(typeof window.__generatePWAFiles==='function','window.__generatePWAFiles missing');
        const files=window.__generatePWAFiles();
        assert(files&&typeof files==='object','__generatePWAFiles must return object');
        assert(typeof files.sw==='string'&&files.sw.trim().length>0,'Service worker content missing');
        assert(typeof files.manifest==='string'&&files.manifest.trim().length>0,'Manifest content missing');
        assertIncludes(files.sw,'self.addEventListener','sw content should include service worker listeners');
        assertIncludes(files.manifest,'"name"','manifest should include app name');
      }
    },
    {
      id:'t0.contract.babel-blocks-and-bridges',
      name:'Babel block markers and block bridges are available',
      tier:'T0',
      area:'Boot Contracts',
      async run({assert,assertIncludes}){
        const scripts=Array.from(document.querySelectorAll('script[type="text/babel"]'));
        assert(scripts.length>=4,'Expected 4 text/babel script blocks');
        const fullText=scripts.map(s=>s.textContent||'').join('\n');
        for(const marker of ['BEGIN: Block A','BEGIN: Block B','BEGIN: Block C','BEGIN: Block D'])assertIncludes(fullText,marker,`Missing marker: ${marker}`);
        assert(window.PH_BLOCK_A&&window.PH_BLOCK_B&&window.PH_BLOCK_C,'Expected PH_BLOCK_A/B/C bridge exports');
      }
    },
    {
      id:'t0.storage.set-get-semantics',
      name:'Storage set/get semantics are deterministic',
      tier:'T0',
      area:'Storage Contract',
      async run({withStorageFixture,assertEq}){
        await withStorageFixture(async fx=>{
          const key=fx.key('set_get');
          const payload={ok:true,count:2};
          await S.set(key,payload);
          const loaded=await S.get(key,null);
          assertEq(loaded.ok,true,'S.get should return stored object');
          assertEq(loaded.count,2,'S.get should preserve object values');
          await S.set(key,undefined);
          const fallback=await S.get(key,'fallback');
          assertEq(fallback,'fallback','S.get should return default after clearing key');
        });
      }
    },
    {
      id:'t0.storage.exp-imp-roundtrip',
      name:'Storage export/import round-trip works for test keys',
      tier:'T0',
      area:'Storage Contract',
      async run({withStorageFixture,assert}){
        await withStorageFixture(async fx=>{
          const k1=fx.key('exp_a');
          const k2=fx.key('exp_b');
          const payload={[k1]:{v:1},[k2]:'value'};
          await S.imp(payload);
          const exported=await S.exp();
          assert(k1 in exported,'S.exp missing imported key 1');
          assert(k2 in exported,'S.exp missing imported key 2');
          const val=await S.get(k2,null);
          assert(val==='value','S.get should return imported value');
        });
      }
    },
    {
      id:'t0.storage.getSync-semantics',
      name:'S.getSync follows localStorage fallback semantics',
      tier:'T0',
      area:'Storage Contract',
      async run({assertEq}){
        const logicalKey=`__TEST__${uid()}_sync`;
        const storageKey=`ph3_${logicalKey}`;
        localStorage.setItem(storageKey,JSON.stringify({ready:true}));
        const found=S.getSync(logicalKey,null);
        assertEq(found.ready,true,'S.getSync should read localStorage fallback value');
        localStorage.removeItem(storageKey);
        const fallback=S.getSync(logicalKey,'none');
        assertEq(fallback,'none','S.getSync should return default when key missing');
      }
    },
    {
      id:'t0.storage.clr-semantics',
      name:'S.clr clears data in isolated snapshot',
      tier:'T0',
      area:'Storage Contract',
      async run({withStorageSnapshot,assertEq}){
        await withStorageSnapshot(async()=>{
          const key=`__TEST__${uid()}_clr`;
          await S.set(key,'x');
          const before=await S.get(key,null);
          assertEq(before,'x','Failed to set pre-clear key');
          await S.clr();
          const after=await S.get(key,null);
          assertEq(after,null,'S.clr should clear key');
        });
      }
    },
    {
      id:'t0.contract.version-source',
      name:'Test report version is sourced from PH_CORE',
      tier:'T0',
      area:'Boot Contracts',
      async run({assertEq}){
        assertEq(APP_VERSION,window.PH_CORE.APP_VERSION,'APP_VERSION must match PH_CORE.APP_VERSION');
      }
    },
    {
      id:'t0.contract.test-runner-lazy-api',
      name:'PH_BLOCK_B exposes lazy loader APIs for test runner',
      tier:'T0',
      area:'Boot Contracts',
      async run({assert,assertEq}){
        const blockB=window.PH_BLOCK_B;
        assert(blockB,'PH_BLOCK_B missing');
        assert(typeof blockB.getTestRunner==='function','PH_BLOCK_B.getTestRunner missing');
        assert(typeof blockB.peekTestRunner==='function','PH_BLOCK_B.peekTestRunner missing');
        assert(typeof blockB.createTestRunnerModel==='function','PH_BLOCK_B.createTestRunnerModel missing');
        if(typeof blockB.__resetTestRunnerCache==='function')blockB.__resetTestRunnerCache();
        assertEq(blockB.peekTestRunner(),null,'peekTestRunner should be empty after reset');
      }
    },
    {
      id:'t0.contract.test-runner-model-lazy-registry',
      name:'Test runner model keeps manifest eager and test cases lazy',
      tier:'T0',
      area:'Boot Contracts',
      async run({assert,assertEq}){
        const model=createTestRunnerModel();
        const manifest=model.getSuiteManifest();
        assert(typeof manifest.suiteVersion==='string'&&manifest.suiteVersion.length>0,'Manifest suiteVersion missing');
        assert(typeof manifest.baselineDate==='string'&&manifest.baselineDate.length>0,'Manifest baselineDate missing');
        assertEq(model.getLoadStats().loaded,false,'Model should start unloaded');
        let buildCount=0;
        const first=model.loadTestCases(()=>{
          buildCount++;
          return[{id:'stub',name:'Stub',tier:'T0',area:'Harness',run:async()=>{}}];
        });
        const second=model.loadTestCases(()=>{
          buildCount++;
          return[];
        });
        assertEq(buildCount,1,'loadTestCases should build only once');
        assert(first===second,'loadTestCases should return cached registry');
        assertEq(model.getLoadStats().loaded,true,'Model should report loaded after first build');
        assertEq(model.getLoadStats().loadCount,1,'Model load count should be exactly one');
      }
    },
    {
      id:'t1.capture.note-crud-render',
      name:'Capture note create/edit/delete updates rendered output',
      tier:'T1',
      area:'Capture Workflow',
      async run({withStorageSnapshot,withSectionHarness,waitFor,setInputValue,findByText,findButtonByText,tapElement,assert}){
        await withStorageSnapshot(async()=>{
          await withSectionHarness(window.PH_BLOCK_C.CaptureSection,{wide:false,selMode:false,selSection:null,selIds:new Set(),toggleSelId:()=>{},enterSelMode:()=>{},exitSelMode:()=>{}},async({mount})=>{
            const input=mount.querySelector('textarea[placeholder*="Quick note"]');
            assert(input,'Capture quick-note input missing');
            setInputValue(input,'T1 note create');
            input.dispatchEvent(new KeyboardEvent('keydown',{key:'Enter',bubbles:true}));
            await waitFor(()=>mount.textContent.includes('T1 note create'),{timeout:2000,message:'Created note not rendered'});

            const noteText=findByText(mount,'T1 note create','span');
            assert(noteText,'Created note text node missing');
            tapElement(noteText);
            await waitFor(()=>mount.querySelector('input[type="text"]'),{timeout:2400,message:'Inline editor did not open'});
            const editInput=mount.querySelector('input[type="text"]');
            setInputValue(editInput,'T1 note updated');
            editInput.dispatchEvent(new KeyboardEvent('keydown',{key:'Enter',bubbles:true}));
            await waitFor(()=>!mount.querySelector('input[type="text"]'),{timeout:1500,message:'Inline editor did not close after Enter save'});
            await waitFor(()=>mount.textContent.includes('T1 note updated'),{timeout:2000,message:'Updated note not rendered'});

            const menuBtn=mount.querySelector('[data-menu-btn]');
            assert(menuBtn,'Note menu button missing');
            menuBtn.dispatchEvent(new MouseEvent('click',{bubbles:true}));
            await waitFor(()=>findButtonByText(mount,'Delete'),{timeout:1200,message:'Delete action not shown'});
            findButtonByText(mount,'Delete').dispatchEvent(new MouseEvent('click',{bubbles:true}));
            await waitFor(()=>!mount.textContent.includes('T1 note updated'),{timeout:2200,message:'Deleted note still rendered'});
          });
        });
      }
    },
    {
      id:'t1.capture.promote-copy-strike',
      name:'Capture promote copies to Clarify and strikes note',
      tier:'T1',
      area:'Workflow Crossover',
      async run({withStorageSnapshot,withSectionHarness,waitFor,setInputValue,findButtonByText,assert}){
        await withStorageSnapshot(async()=>{
          await withSectionHarness(window.PH_BLOCK_C.CaptureSection,{wide:false,selMode:false,selSection:null,selIds:new Set(),toggleSelId:()=>{},enterSelMode:()=>{},exitSelMode:()=>{}},async({mount,getApp})=>{
            const input=mount.querySelector('textarea[placeholder*="Quick note"]');
            setInputValue(input,'Promote me to Clarify');
            input.dispatchEvent(new KeyboardEvent('keydown',{key:'Enter',bubbles:true}));
            await waitFor(()=>getApp().notes.length===1,{timeout:2000,message:'Expected one note before promote'});
            const noteId=getApp().notes[0].id;

            const menuBtn=mount.querySelector('[data-menu-btn]');
            assert(menuBtn,'Note menu button missing');
            menuBtn.dispatchEvent(new MouseEvent('click',{bubbles:true}));
            await waitFor(()=>findButtonByText(mount,'Promote to Clarify'),{timeout:1200,message:'Promote action not shown'});
            findButtonByText(mount,'Promote to Clarify').dispatchEvent(new MouseEvent('click',{bubbles:true}));

            await waitFor(()=>getApp().todos.some(t=>t.text==='Promote me to Clarify'),{timeout:2200,message:'Promoted todo not created'});
            await waitFor(()=>{
              const n=getApp().notes.find(x=>x.id===noteId);
              return !!(n&&n.struck&&n.struckAt);
            },{timeout:2200,message:'Promoted note was not struck'});
          });
        });
      }
    },
    {
      id:'t1.clarify.done-undone-counts',
      name:'Clarify done/undone toggles update done count',
      tier:'T1',
      area:'Clarify Workflow',
      async run({withStorageSnapshot,withAppDataHarness,waitFor,assertEq}){
        await withStorageSnapshot(async()=>{
          await withAppDataHarness(async getApp=>{
            getApp().saveItem('todo',{text:'Toggle done todo',quad:'ui',cat:'work',done:false,subtasks:[]});
            await waitFor(()=>getApp().todos.some(t=>t.text==='Toggle done todo'),{timeout:2200,message:'Todo was not created'});
            const todoId=getApp().todos.find(t=>t.text==='Toggle done todo').id;
            const baseDone=getApp().doneCount;

            getApp().doneTodo(todoId);
            await waitFor(()=>getApp().todos.find(t=>t.id===todoId)?.done===true,{timeout:1800,message:'Todo not marked done'});
            assertEq(getApp().doneCount,baseDone+1,'doneCount should increment after doneTodo');

            getApp().undoneTodo(todoId);
            await waitFor(()=>getApp().todos.find(t=>t.id===todoId)?.done===false,{timeout:1800,message:'Todo not marked undone'});
            assertEq(getApp().doneCount,baseDone,'doneCount should reset after undoneTodo');
          });
        });
      }
    },
    {
      id:'t1.confirm.checklist-operations',
      name:'Confirm checklist add/toggle/delete is reflected in UI',
      tier:'T1',
      area:'Confirm Workflow',
      async run({withStorageSnapshot,withSectionHarness,waitFor,findByText,assert}){
        await withStorageSnapshot(async()=>{
          const listId=`list_${uid()}`;
          await S.imp({lists:[{id:listId,name:'T1 Checklist',items:[]}],selList:listId});
          await withSectionHarness(window.PH_BLOCK_C.ConfirmSection,{wide:false,desk:false,selMode:false,selSection:null,selIds:new Set(),toggleSelId:()=>{},enterSelMode:()=>{},exitSelMode:()=>{},setEdit:()=>{}},async({mount,getApp})=>{
            await waitFor(()=>getApp().lists.some(l=>l.id===listId),{timeout:3200,message:'Checklist state did not initialize'});
            await waitFor(()=>getApp().selList===listId,{timeout:2600,message:'Checklist selection did not apply'});
            await waitFor(()=>{
              const tabBtns=Array.from(mount.querySelectorAll('button'));
              return tabBtns.some(b=>((b.textContent||'').includes('T1 Checklist')));
            },{timeout:3200,message:'Checklist tab not rendered'});

            getApp().saveItem('list',{text:'T1 item',section:'Inbox'},listId);
            await waitFor(()=>getApp().lists.find(l=>l.id===listId)?.items.some(i=>i.text==='T1 item'),{timeout:2200,message:'Checklist item state did not update'});
            await waitFor(()=>mount.textContent.includes('T1 item'),{timeout:3200,message:'Checklist item not rendered'});
            const itemId=getApp().lists.find(l=>l.id===listId).items[0].id;

            getApp().doneList(listId,itemId);
            await waitFor(()=>getApp().lists.find(l=>l.id===listId).items.find(i=>i.id===itemId)?.done===true,{timeout:1800,message:'Checklist item not toggled done'});
            const itemText=findByText(mount,'T1 item','span');
            assert(itemText&&itemText.className.includes('line-through'),'Done item should show line-through class');

            getApp().deleteListItem(listId,itemId);
            await waitFor(()=>!mount.textContent.includes('T1 item'),{timeout:2200,message:'Checklist item not removed from UI'});
          });
        });
      }
    },
    {
      id:'t1.focus.timer-transition',
      name:'Focus timer transitions work -> break -> work',
      tier:'T1',
      area:'Focus Workflow',
      async run({withDomFixture,waitFor,findButtonByText,assert}){
        await S.set('focusTimerState',undefined);
        await withDomFixture(async mount=>{
          const completed=[];
          const root=ReactDOM.createRoot(mount);
          mount.__root=root;
          root.render(React.createElement(FocusTimer,{tSet:{work:0,shortBreak:0,longBreak:0},onComplete:(mode)=>{completed.push(mode);},activeTaskId:null,activeTaskText:null,onTick:()=>{}}));
          await waitFor(()=>findButtonByText(mount,'Start'),{timeout:1500,message:'Start button not rendered'});
          findButtonByText(mount,'Start').dispatchEvent(new MouseEvent('click',{bubbles:true}));
          await waitFor(()=>completed.length===1&&completed[0]==='work',{timeout:2000,message:'Timer completion callback did not fire for work mode'});
          const focusBtn=findButtonByText(mount,'Focus');
          assert(!!focusBtn,'Focus mode button missing after completion');
          focusBtn.dispatchEvent(new MouseEvent('click',{bubbles:true}));
          await waitFor(()=>findButtonByText(mount,'Focus')?.className.includes('bg-white/40'),{timeout:1200,message:'Timer did not settle in work mode'});
        });
      }
    },
    {
      id:'t1.focus.timer-persists-across-remount',
      name:'Focus timer preserves in-flight state across remount',
      tier:'T1',
      area:'Focus Workflow',
      async run({withDomFixture,waitFor,findButtonByText,assert}){
        await S.set('focusTimerState',undefined);
        await withDomFixture(async mount=>{
          const root=ReactDOM.createRoot(mount);
          mount.__root=root;
          root.render(React.createElement(FocusTimer,{tSet:{work:1,shortBreak:1,longBreak:1},onComplete:()=>{},activeTaskId:null,activeTaskText:null,onTick:()=>{}}));
          await waitFor(()=>findButtonByText(mount,'Start'),{timeout:1500,message:'Start button not rendered'});
          findButtonByText(mount,'Start').dispatchEvent(new MouseEvent('click',{bubbles:true}));
          await waitFor(()=>{const d=mount.querySelector('.timer-display');return d&&d.textContent!=='01:00';},{timeout:2500,message:'Timer did not begin counting down'});
          const beforeUnmount=mount.querySelector('.timer-display').textContent;
          root.unmount();

          const root2=ReactDOM.createRoot(mount);
          mount.__root=root2;
          root2.render(React.createElement(FocusTimer,{tSet:{work:1,shortBreak:1,longBreak:1},onComplete:()=>{},activeTaskId:null,activeTaskText:null,onTick:()=>{}}));
          await waitFor(()=>mount.querySelector('.timer-display'),{timeout:1200,message:'Timer did not remount'});
          const afterRemount=mount.querySelector('.timer-display').textContent;
          assert(afterRemount===beforeUnmount||afterRemount<'01:00','Timer reset to full duration after remount');
        });
      }
    },
    {
      id:'t1.focus.timer-complete-passes-elapsed-seconds',
      name:'Focus completion callback receives elapsed seconds',
      tier:'T1',
      area:'Focus Workflow',
      async run({withDomFixture,waitFor,findButtonByText,assert}){
        await S.set('focusTimerState',undefined);
        await withDomFixture(async mount=>{
          let elapsedSec=null;
          const root=ReactDOM.createRoot(mount);
          mount.__root=root;
          root.render(React.createElement(FocusTimer,{tSet:{work:0.02,shortBreak:1,longBreak:1},onComplete:(_mode,_taskId,elapsed)=>{elapsedSec=elapsed;return'shortBreak';},activeTaskId:null,activeTaskText:null,onTick:()=>{}}));
          await waitFor(()=>findButtonByText(mount,'Start'),{timeout:1500,message:'Start button not rendered'});
          findButtonByText(mount,'Start').dispatchEvent(new MouseEvent('click',{bubbles:true}));
          await waitFor(()=>typeof elapsedSec==='number',{timeout:3000,message:'Elapsed seconds not provided on completion'});
          assert(elapsedSec>=1&&elapsedSec<=2,`Expected elapsed seconds around 1-2, got ${elapsedSec}`);
        });
      }
    },
    {
      id:'t1.focus.done-focus-updates-metrics',
      name:'Focus completion updates queue, task state, and metrics',
      tier:'T1',
      area:'Focus Workflow',
      async run({withStorageSnapshot,withAppDataHarness,waitFor,assertEq}){
        await withStorageSnapshot(async()=>{
          await withAppDataHarness(async getApp=>{
            const taskId=`task_${uid()}`;
            getApp().setTodos([{id:taskId,text:'Focus me',quad:'ui',done:false,poms:0}]);
            getApp().setFocus([{id:taskId,text:'Focus me',quad:'ui',done:false,poms:0}]);
            await waitFor(()=>getApp().focus.length===1,{timeout:1200,message:'Focus queue not initialized'});
            const baseDone=getApp().met.w.t;
            getApp().doneFocus(taskId);
            await waitFor(()=>!getApp().focus.some(t=>t.id===taskId),{timeout:1800,message:'Task not removed from focus queue'});
            await waitFor(()=>getApp().todos.find(t=>t.id===taskId)?.done===true,{timeout:1800,message:'Linked todo not marked done'});
            assertEq(getApp().met.w.t,baseDone+1,'Weekly done metric should increment on doneFocus');
          });
        });
      }
    },
    {
      id:'t1.workflow.link-open-unlink',
      name:'Task checklist link/open/unlink behavior is consistent',
      tier:'T1',
      area:'Workflow Crossover',
      async run({withStorageSnapshot,withAppDataHarness,waitFor,assertEq}){
        await withStorageSnapshot(async()=>{
          await withAppDataHarness(async getApp=>{
            const taskId=`task_${uid()}`;
            const listId=`list_${uid()}`;
            getApp().setTodos([{id:taskId,text:'Linked task',quad:'ni',done:false,poms:0}]);
            getApp().setLists([{id:listId,name:'Linked list',items:[]}]);
            await waitFor(()=>getApp().todos.length===1&&getApp().lists.length===1,{timeout:1200,message:'Failed to seed todo/list'});

            getApp().linkTask(taskId,listId);
            await waitFor(()=>getApp().todos.find(t=>t.id===taskId)?.linkedList===listId,{timeout:1500,message:'Task did not link to checklist'});

            getApp().openLinkedList(getApp().todos.find(t=>t.id===taskId));
            await waitFor(()=>getApp().tab==='lists'&&getApp().selList===listId,{timeout:1500,message:'openLinkedList did not route to checklist'});

            getApp().unlinkTask(taskId);
            await waitFor(()=>getApp().todos.find(t=>t.id===taskId)?.linkedList===undefined,{timeout:1500,message:'Task link was not removed'});
            assertEq(getApp().tab,'lists','Current tab should remain lists after unlink');
          });
        });
      }
    },
    {
      id:'t1.storage.workflow-export-import',
      name:'Workflow export/import round-trip through S is lossless',
      tier:'T1',
      area:'Workflow Data',
      async run({withStorageSnapshot,assertEq,assert}){
        await withStorageSnapshot(async()=>{
          const payload={
            todos:[{id:'t1',text:'Task',quad:'ui',done:false,poms:0}],
            lists:[{id:'l1',name:'List',items:[{id:'i1',text:'Item',done:false,section:'Inbox'}]}],
            notes:[{id:'n1',text:'Note',crAt:new Date().toISOString()}]
          };
          await S.imp(payload);
          const exported=await S.exp();
          assert(Array.isArray(exported.todos)&&exported.todos.length===1,'Exported todos should contain imported data');
          await S.clr();
          await S.imp(payload);
          const todos=await S.get('todos',[]);
          const lists=await S.get('lists',[]);
          assertEq(todos[0].text,'Task','Imported todo text mismatch');
          assertEq(lists[0].items.length,1,'Imported checklist items mismatch');
        });
      }
    },
    {
      id:'t1.review.derived-shape',
      name:'Review derived data and heatmap shape are valid',
      tier:'T1',
      area:'Review Workflow',
      async run({withStorageSnapshot,withSectionHarness,waitFor,assert}){
        await withStorageSnapshot(async()=>{
          await withSectionHarness(window.PH_BLOCK_C.ReviewSection,{wide:false},async({mount,getApp})=>{
            const today=new Date().toDateString();
            const yesterday=new Date(Date.now()-864e5).toDateString();
            getApp().setMet({d:{p:2,t:1,m:50,date:today},w:{p:6,t:3,m:150}});
            getApp().setDHist([{date:yesterday,p:1,t:1,m:25}]);
            await waitFor(()=>getApp().wkData.length===7,{timeout:1500,message:'wkData should have 7 points'});
            assert(getApp().wkData.every(d=>typeof d.l==='string'&&typeof d.v==='number'),'wkData points should have {l,v} shape');
            await waitFor(()=>mount.textContent.includes('This Week')&&mount.textContent.includes('Matrix Overview'),{timeout:1800,message:'Review cards did not render'});
            const heatmapCells=mount.querySelectorAll('div[title]');
            assert(heatmapCells.length>=20,'Heatmap did not render expected cell tooltips');
          });
        });
      }
    },
    {
      id:'t1.utility.uid-unique-format',
      name:'UID generation remains unique and formatted',
      tier:'T1',
      area:'Utility Contracts',
      async run({assert}){
        const ids=new Set(Array.from({length:40},()=>uid()));
        assert(ids.size===40,'uid() should generate unique IDs');
        for(const id of ids)assert(typeof id==='string'&&id.includes('-'),'uid() should contain hyphenated format');
      }
    },
    {
      id:'t1.utility.ics-generation-contract',
      name:'ICS generator returns expected calendar contract',
      tier:'T1',
      area:'Utility Contracts',
      async run({assertIncludes}){
        const ics=genICS({text:'T1 Event',time:'10:30',date:'2030-01-01'});
        assertIncludes(ics,'BEGIN:VCALENDAR','ICS should include calendar header');
        assertIncludes(ics,'BEGIN:VEVENT','ICS should include event block');
        assertIncludes(ics,'SUMMARY:T1 Event','ICS should include summary text');
      }
    },
    {
      id:'t1.batch.selcheck-toggle-callback',
      name:'Batch selection checkbox triggers toggle callback',
      tier:'T1',
      area:'Batch Selection',
      async run({withDomFixture,waitFor,assertEq}){
        await withDomFixture(async mount=>{
          let toggles=0;
          const root=ReactDOM.createRoot(mount);
          mount.__root=root;
          root.render(React.createElement(SelCheck,{checked:false,onToggle:()=>{toggles++;}}));
          await waitFor(()=>mount.querySelector('button'),{timeout:800,message:'SelCheck button not rendered'});
          mount.querySelector('button').dispatchEvent(new MouseEvent('click',{bubbles:true}));
          assertEq(toggles,1,'SelCheck should trigger onToggle exactly once per click');
        });
      }
    },
    {
      id:'t1.batch.bulkactionbar-routing',
      name:'BulkActionBar routes select/deselect/action callbacks',
      tier:'T1',
      area:'Batch Selection',
      async run({withDomFixture,waitFor,findButtonByText,assertEq,assert}){
        await withDomFixture(async mount=>{
          const actions=[];
          let selectAllCount=0;
          let deselectAllCount=0;
          let cancelCount=0;
          const root=ReactDOM.createRoot(mount);
          mount.__root=root;

          const renderBar=(count,allCount)=>root.render(React.createElement(BulkActionBar,{
            count,
            section:'todos',
            allCount,
            onSelectAll:()=>{selectAllCount++;},
            onDeselectAll:()=>{deselectAllCount++;},
            onAction:(action)=>actions.push(action),
            onCancel:()=>{cancelCount++;}
          }));

          renderBar(1,3);
          await waitFor(()=>findButtonByText(mount,'Select All')&&findButtonByText(mount,'Done')&&findButtonByText(mount,'Delete'),{timeout:1200,message:'BulkActionBar controls not rendered'});
          findButtonByText(mount,'Select All').dispatchEvent(new MouseEvent('click',{bubbles:true}));
          findButtonByText(mount,'Done').dispatchEvent(new MouseEvent('click',{bubbles:true}));
          findButtonByText(mount,'Delete').dispatchEvent(new MouseEvent('click',{bubbles:true}));
          const cancelBtn=mount.querySelector('button[aria-label="Cancel selection"]');
          assert(cancelBtn,'Cancel selection button missing');
          cancelBtn.dispatchEvent(new MouseEvent('click',{bubbles:true}));

          renderBar(3,3);
          await waitFor(()=>findButtonByText(mount,'Deselect All'),{timeout:1200,message:'Deselect All control not rendered'});
          findButtonByText(mount,'Deselect All').dispatchEvent(new MouseEvent('click',{bubbles:true}));

          assertEq(selectAllCount,1,'Select All callback should fire once');
          assertEq(deselectAllCount,1,'Deselect All callback should fire once');
          assertEq(cancelCount,1,'Cancel callback should fire once');
          assertEq(actions.join(','),'done,delete','Bulk actions should fire in clicked order');
        });
      }
    },
    {
      id:'t2.css.menu-btn-computed',
      name:'.menu-btn CSS applies computed interaction styles',
      tier:'T2',
      area:'CSS/UX',
      async run({assert}){
        const el=document.createElement('button');
        el.className='menu-btn';
        el.textContent='menu';
        document.body.appendChild(el);
        const st=getComputedStyle(el);
        const displayOk=st.display==='flex'||st.display==='inline-flex';
        const alignOk=st.textAlign==='left'||st.textAlign==='start';
        document.body.removeChild(el);
        assert(displayOk,'.menu-btn should set display:flex');
        assert(alignOk,'.menu-btn should set text-align:left');
      }
    },
    {
      id:'t2.css.section-card-computed',
      name:'.section-card CSS applies visual card surface',
      tier:'T2',
      area:'CSS/UX',
      async run({assert}){
        const el=document.createElement('div');
        el.className='section-card';
        el.textContent='card';
        document.body.appendChild(el);
        const st=getComputedStyle(el);
        const bf=(st.backdropFilter||'').toLowerCase();
        const wbf=(st.webkitBackdropFilter||'').toLowerCase();
        const hasBackdrop=(bf&&bf!=='none')||(wbf&&wbf!=='none');
        const hasFallback=(st.boxShadow&&st.boxShadow!=='none')&&(st.borderRadius&&st.borderRadius!=='0px');
        document.body.removeChild(el);
        assert(hasBackdrop||hasFallback,'.section-card should apply backdrop-filter or equivalent card styling');
      }
    },
    {
      id:'t2.css.anim-out-runtime',
      name:'anim-out class maps to active fadeOut animation',
      tier:'T2',
      area:'Animation',
      async run({assert}){
        const el=document.createElement('div');
        el.className='anim-out';
        document.body.appendChild(el);
        const st=getComputedStyle(el);
        const animName=(st.animationName||'').toLowerCase();
        const animDuration=st.animationDuration||'0s';
        document.body.removeChild(el);
        assert(!(animName==='none'&&animDuration==='0s'),'anim-out should map to fadeOut animation');
      }
    },
    {
      id:'t2.sticky-header.runtime',
      name:'StickyHeader renders in sections with sticky class contract',
      tier:'T2',
      area:'Layout UX',
      async run({withStorageSnapshot,withSectionHarness,assert,waitFor}){
        await withStorageSnapshot(async()=>{
          await withSectionHarness(window.PH_BLOCK_C.CaptureSection,{wide:false,selMode:false,selSection:null,selIds:new Set(),toggleSelId:()=>{},enterSelMode:()=>{},exitSelMode:()=>{}},async({mount})=>{
            await waitFor(()=>mount.querySelector('[data-testid="sticky-header"]'),{timeout:1200,message:'Sticky header missing'});
            const header=mount.querySelector('[data-testid="sticky-header"]');
            assert(header.className.includes('sticky'),'Sticky header should include sticky class');
            assert(header.className.includes('top-14'),'Sticky header should include mobile top offset');
            assert(header.className.includes('xl:top-0'),'Sticky header should include wide top offset');
          });
        });
      }
    },
    {
      id:'t2.responsive.sidebar-tabbar-classes',
      name:'Responsive class gating exists for sidebar and tab bar',
      tier:'T2',
      area:'Layout UX',
      async run({assert,assertIncludes}){
        const sidebar=document.querySelector('[data-testid="sidebar-nav"]');
        const tabBar=document.querySelector('[data-testid="bottom-tab-bar"]');
        assert(sidebar,'Sidebar nav not found');
        assert(tabBar,'Bottom tab bar not found');
        assertIncludes(sidebar.className,'hidden','Sidebar should be hidden on smaller screens');
        assertIncludes(sidebar.className,'xl:flex','Sidebar should become visible on wide screens');
        assertIncludes(tabBar.className,'xl:hidden','Bottom tab bar should hide on wide screens');
      }
    },
    {
      id:'t2.modal.contextmenu-anim-close',
      name:'ContextMenu applies anim-out class before close callback',
      tier:'T2',
      area:'Animation',
      async run({withDomFixture,waitFor,assert}){
        await withDomFixture(async mount=>{
          let closed=false;
          const root=ReactDOM.createRoot(mount);
          mount.__root=root;
          root.render(React.createElement(ContextMenu,{title:'Menu',items:[{icon:React.createElement('span',null,'x'),label:'Action',onClick:()=>{}}],onClose:()=>{closed=true;},position:null}));
          await waitFor(()=>mount.querySelector('.gcard'),{timeout:1200,message:'ContextMenu not rendered'});
          const menuCard=mount.querySelector('.gcard');
          const overlay=mount.firstElementChild;
          overlay.dispatchEvent(new MouseEvent('click',{bubbles:true}));
          await waitFor(()=>menuCard.className.includes('anim-out'),{timeout:600,message:'ContextMenu did not apply anim-out class'});
          await waitFor(()=>closed===true,{timeout:800,message:'ContextMenu did not invoke onClose'});
          assert(closed,'ContextMenu close callback not triggered');
        });
      }
    },
    {
      id:'t2.toast.lifecycle-fade-state',
      name:'Toast lifecycle toggles fade state then clears',
      tier:'T2',
      area:'Animation',
      async run({withStorageSnapshot,withAppDataHarness,waitFor,assertEq}){
        await withStorageSnapshot(async()=>{
          await withAppDataHarness(async getApp=>{
            getApp().showT('Lifecycle toast');
            await waitFor(()=>getApp().toast==='Lifecycle toast',{timeout:800,message:'Toast message did not appear'});
            assertEq(getApp().toastFading,false,'Toast should not fade immediately');
            await waitFor(()=>getApp().toastFading===true,{timeout:1900,message:'Toast did not enter fade state'});
            await waitFor(()=>getApp().toast===null,{timeout:2600,message:'Toast did not clear after lifecycle'});
          });
        });
      }
    },
    {
      id:'t2.tab.anim-in-runtime',
      name:'Active tab content keeps anim-in runtime class',
      tier:'T2',
      area:'Layout UX',
      async run({assert}){
        const tabContent=document.querySelector('[data-testid="tab-content"]');
        assert(tabContent,'Tab content container not found');
        assert(tabContent.className.includes('anim-in'),'Tab content should include anim-in class');
      }
    },
    {
      id:'t2.theme.light-dark-system-runtime',
      name:'Theme provider applies light/dark/system runtime toggles',
      tier:'T2',
      area:'Theme UX',
      async run({withStorageSnapshot,withDomFixture,waitFor,assert}){
        await withStorageSnapshot(async()=>{
          await withDomFixture(async mount=>{
            const{ThemeProv,ThemeCtx}=window.PH_BLOCK_A;
            assert(ThemeProv&&ThemeCtx,'Theme exports unavailable');
            const prevDark=document.documentElement.classList.contains('dark');
            let api=null;
            function Probe(){api=React.useContext(ThemeCtx);return null;}
            const root=ReactDOM.createRoot(mount);
            mount.__root=root;
            root.render(React.createElement(ThemeProv,null,React.createElement(Probe)));
            await waitFor(()=>api&&typeof api.setTheme==='function',{timeout:2200,message:'Theme context unavailable'});

            api.setTheme('dark');
            await waitFor(()=>document.documentElement.classList.contains('dark'),{timeout:1500,message:'Dark theme class not applied'});
            api.setTheme('light');
            await waitFor(()=>!document.documentElement.classList.contains('dark'),{timeout:1500,message:'Light theme class not applied'});

            const prefersDark=!!(window.matchMedia&&window.matchMedia('(prefers-color-scheme:dark)').matches);
            api.setTheme('system');
            await waitFor(()=>document.documentElement.classList.contains('dark')===prefersDark,{timeout:1800,message:'System theme did not follow media preference'});

            if(prevDark)document.documentElement.classList.add('dark');
            else document.documentElement.classList.remove('dark');
          });
        });
      }
    },
    {
      id:'t2.contextmenu.backdrop-close-callback',
      name:'ContextMenu backdrop click triggers close callback',
      tier:'T2',
      area:'Unified Components',
      async run({withDomFixture,waitFor,assert}){
        await withDomFixture(async mount=>{
          let closed=0;
          const root=ReactDOM.createRoot(mount);
          mount.__root=root;
          root.render(React.createElement(ContextMenu,{title:'Menu',items:[{icon:React.createElement('span',null,'x'),label:'Action',onClick:()=>{}}],onClose:()=>{closed++;},position:null}));
          await waitFor(()=>mount.firstElementChild,{timeout:1000,message:'ContextMenu overlay not rendered'});
          mount.firstElementChild.dispatchEvent(new MouseEvent('click',{bubbles:true}));
          await waitFor(()=>closed===1,{timeout:900,message:'ContextMenu onClose not called from backdrop'});
          assert(closed===1,'Backdrop click should close exactly once');
        });
      }
    },
    {
      id:'t2.contextmenu.item-click-callback-close',
      name:'ContextMenu item click triggers item callback and close',
      tier:'T2',
      area:'Unified Components',
      async run({withDomFixture,waitFor,findButtonByText,assertEq}){
        await withDomFixture(async mount=>{
          let clicked=0;
          let closed=0;
          const root=ReactDOM.createRoot(mount);
          mount.__root=root;
          root.render(React.createElement(ContextMenu,{title:'Menu',items:[{icon:React.createElement('span',null,'x'),label:'Edit',onClick:()=>{clicked++;}}],onClose:()=>{closed++;},position:null}));
          await waitFor(()=>findButtonByText(mount,'Edit'),{timeout:1000,message:'ContextMenu item not rendered'});
          findButtonByText(mount,'Edit').dispatchEvent(new MouseEvent('click',{bubbles:true}));
          await waitFor(()=>clicked===1,{timeout:400,message:'ContextMenu item callback did not fire'});
          await waitFor(()=>closed===1,{timeout:1000,message:'ContextMenu did not close after item click'});
          assertEq(clicked,1,'Item callback should fire once');
          assertEq(closed,1,'Close callback should fire once');
        });
      }
    },
    {
      id:'t2.confirmdialog.confirm-callback',
      name:'ConfirmDialog confirm action triggers onConfirm',
      tier:'T2',
      area:'Unified Components',
      async run({withDomFixture,waitFor,findButtonByText,assertEq}){
        await withDomFixture(async mount=>{
          let confirmed=0;
          let cancelled=0;
          const root=ReactDOM.createRoot(mount);
          mount.__root=root;
          root.render(React.createElement(ConfirmDialog,{icon:React.createElement('span',null,'!'),iconBg:'bg-terracotta-100',title:'Delete?',message:'Confirm delete',confirmLabel:'Delete',onConfirm:()=>{confirmed++;},onCancel:()=>{cancelled++;},variant:'danger'}));
          await waitFor(()=>findButtonByText(mount,'Delete')&&findButtonByText(mount,'Cancel'),{timeout:1200,message:'ConfirmDialog buttons not rendered'});
          findButtonByText(mount,'Delete').dispatchEvent(new MouseEvent('click',{bubbles:true}));
          await waitFor(()=>confirmed===1,{timeout:1000,message:'onConfirm was not called'});
          assertEq(confirmed,1,'Confirm callback should fire once');
          assertEq(cancelled,0,'Cancel callback should not fire during confirm');
        });
      }
    },
    {
      id:'t2.confirmdialog.cancel-callback',
      name:'ConfirmDialog cancel action triggers onCancel',
      tier:'T2',
      area:'Unified Components',
      async run({withDomFixture,waitFor,findButtonByText,assertEq}){
        await withDomFixture(async mount=>{
          let confirmed=0;
          let cancelled=0;
          const root=ReactDOM.createRoot(mount);
          mount.__root=root;
          root.render(React.createElement(ConfirmDialog,{icon:React.createElement('span',null,'!'),iconBg:'bg-terracotta-100',title:'Delete?',message:'Confirm delete',confirmLabel:'Delete',onConfirm:()=>{confirmed++;},onCancel:()=>{cancelled++;},variant:'danger'}));
          await waitFor(()=>findButtonByText(mount,'Cancel'),{timeout:1200,message:'Cancel button not rendered'});
          findButtonByText(mount,'Cancel').dispatchEvent(new MouseEvent('click',{bubbles:true}));
          await waitFor(()=>cancelled===1,{timeout:1000,message:'onCancel was not called'});
          assertEq(cancelled,1,'Cancel callback should fire once');
          assertEq(confirmed,0,'Confirm callback should not fire during cancel');
        });
      }
    },
    {
      id:'t2.settings.test-runner-default-absent',
      name:'Settings keeps test runner unmounted before first Test tab click',
      tier:'T2',
      area:'Settings UX',
      async run({withStorageSnapshot,withSettingsHarness,assert}){
        await withStorageSnapshot(async()=>{
          if(window.PH_BLOCK_B&&typeof window.PH_BLOCK_B.__resetTestRunnerCache==='function')window.PH_BLOCK_B.__resetTestRunnerCache();
          await withSettingsHarness(async mount=>{
            assert(!mount.querySelector('[data-testid="test-runner-root"]'),'Test runner should not mount by default');
            assert(!mount.querySelector('[data-testid="test-runner-loading"]'),'Loading marker should not show by default');
            assert(!mount.querySelector('[data-testid="test-runner-error"]'),'Error marker should not show by default');
          });
        });
      }
    },
    {
      id:'t2.settings.test-runner-first-click-lazy-load',
      name:'Settings first Test click shows loader then mounts test runner',
      tier:'T2',
      area:'Settings UX',
      async run({withStorageSnapshot,withSettingsHarness,waitFor,assert}){
        await withStorageSnapshot(async()=>{
          if(window.PH_BLOCK_B&&typeof window.PH_BLOCK_B.__resetTestRunnerCache==='function')window.PH_BLOCK_B.__resetTestRunnerCache();
          await withSettingsHarness(async mount=>{
            const testTab=Array.from(mount.querySelectorAll('.more-sub-btn')).find(btn=>((btn.textContent||'').includes('Test')));
            assert(testTab,'Test sub-tab button missing');
            testTab.dispatchEvent(new MouseEvent('click',{bubbles:true}));
            let sawLoading=false;
            await waitFor(()=>{
              const loading=mount.querySelector('[data-testid="test-runner-loading"]');
              if(loading)sawLoading=true;
              return sawLoading||!!mount.querySelector('[data-testid="test-runner-root"]');
            },{timeout:2400,message:'No lazy-load marker found after Test tab click'});
            await waitFor(()=>mount.querySelector('[data-testid="test-runner-root"]'),{timeout:3600,message:'Test runner root did not mount'});
            assert(sawLoading,'Expected loading marker during first lazy load');
          });
        });
      }
    },
    {
      id:'t2.settings.test-runner-persists-after-tab-switch',
      name:'Settings reuses loaded runner after switching away and back',
      tier:'T2',
      area:'Settings UX',
      async run({withStorageSnapshot,withSettingsHarness,waitFor,assert,assertEq}){
        await withStorageSnapshot(async()=>{
          const blockB=window.PH_BLOCK_B;
          if(blockB&&typeof blockB.__resetTestRunnerCache==='function')blockB.__resetTestRunnerCache();
          await withSettingsHarness(async mount=>{
            const findSubTab=(label)=>Array.from(mount.querySelectorAll('.more-sub-btn')).find(btn=>((btn.textContent||'').includes(label)));
            const testTab=findSubTab('Test');
            const helpTab=findSubTab('Explainer');
            assert(testTab&&helpTab,'Settings sub-tabs are missing');
            testTab.dispatchEvent(new MouseEvent('click',{bubbles:true}));
            await waitFor(()=>mount.querySelector('[data-testid="test-runner-root"]'),{timeout:3600,message:'Initial test runner mount failed'});
            helpTab.dispatchEvent(new MouseEvent('click',{bubbles:true}));
            await waitFor(()=>mount.textContent.includes('Complete Guide'),{timeout:2000,message:'Help tab content did not render'});
            testTab.dispatchEvent(new MouseEvent('click',{bubbles:true}));
            await waitFor(()=>mount.querySelector('[data-testid="test-runner-root"]'),{timeout:2000,message:'Runner did not remount after switching back'});
            assert(!mount.querySelector('[data-testid="test-runner-loading"]'),'Runner should be reused without loading on second open');
            if(blockB&&typeof blockB.__getTestRunnerCacheStats==='function'){
              assertEq(blockB.__getTestRunnerCacheStats().createCount,1,'Runner factory should initialize exactly once');
            }
          });
        });
      }
    },
    {
      id:'t2.layout.sticky-tabs-no-top-gap-all-breakpoints',
      name:'Sticky-header tabs use zero top gap across breakpoints',
      tier:'T2',
      area:'Layout UX',
      async run({assert}){
        const blockD=window.PH_BLOCK_D;
        assert(blockD&&typeof blockD.getMainContentTopPadClass==='function','PH_BLOCK_D.getMainContentTopPadClass missing');
        for(const tabId of ['notes','todos','focus','lists','review']){
          const cls=blockD.getMainContentTopPadClass(tabId)||'';
          assert(cls.includes('pt-0')&&cls.includes('md:pt-0')&&cls.includes('xl:pt-0'),`Expected zero top-gap classes for tab ${tabId}`);
          assert(!cls.includes('pt-4')&&!cls.includes('md:pt-6')&&!cls.includes('xl:pt-6'),`Sticky tab ${tabId} should not use More top-gap classes`);
        }
      }
    },
    {
      id:'t2.layout.more-top-gap-preserved-all-breakpoints',
      name:'More tab keeps top gap and flips correctly with sticky tabs',
      tier:'T2',
      area:'Layout UX',
      async run({assert}){
        const blockD=window.PH_BLOCK_D;
        assert(blockD&&typeof blockD.getMainContentTopPadClass==='function','PH_BLOCK_D.getMainContentTopPadClass missing');
        const moreClass=blockD.getMainContentTopPadClass('more')||'';
        assert(moreClass.includes('pt-4')&&moreClass.includes('md:pt-6')&&moreClass.includes('xl:pt-6'),'Expected More top-gap classes');
        assert(!moreClass.includes('md:pt-0')&&!moreClass.includes('xl:pt-0'),'More top-gap class should not include sticky zero-gap tokens');
        const stickyClass=blockD.getMainContentTopPadClass('notes')||'';
        assert(stickyClass.includes('pt-0')&&stickyClass.includes('md:pt-0')&&stickyClass.includes('xl:pt-0'),'Expected sticky-tab zero top-gap class tokens');
        assert(moreClass!==stickyClass,'More and sticky tab classes must differ');
        assert(blockD.getMainContentTopPadClass('more')===moreClass,'More tab class should be deterministic on repeated calls');
        const wrap=document.querySelector('[data-testid="main-content-wrap"]');
        assert(wrap,'Main content wrapper not found');
        const wrapClass=wrap.className||'';
        assert(wrapClass.includes('pt-4')&&wrapClass.includes('md:pt-6')&&wrapClass.includes('xl:pt-6'),'Live More view should keep top-gap classes while Test tab is open');
      }
    },
    {
      id:'t2.layout.focus-review-responsive-markers',
      name:'Focus and Review sections keep responsive marker classes',
      tier:'T2',
      area:'Layout UX',
      async run({withStorageSnapshot,withSectionHarness,assertIncludes,assert}){
        await withStorageSnapshot(async()=>{
          await withSectionHarness(window.PH_BLOCK_C.FocusSection,{onTimerTick:()=>{},desk:true},async({mount})=>{
            const focusContent=mount.querySelector('[data-testid="focus-content"]');
            assert(focusContent,'Focus content container missing');
            assertIncludes(focusContent.className,'md:flex','Focus content should include md:flex for split layout');
          });
          await withSectionHarness(window.PH_BLOCK_C.ReviewSection,{wide:true},async({mount})=>{
            const reviewContent=mount.querySelector('[data-testid="review-content"]');
            assert(reviewContent,'Review content container missing');
            assertIncludes(reviewContent.className,'xl:grid','Review content should include xl:grid marker');
            assertIncludes(reviewContent.className,'xl:grid-cols-2','Review content should include xl:grid-cols-2 marker');
          });
        });
      }
    }
  ];

  const summarizeByTier=(tests,rows)=>{
    const summary={};
    for(const tier of TIER_ORDER)summary[tier]={total:0,passed:0,failed:0,skipped:0,passRate:0};
    for(const test of tests){if(!summary[test.tier])summary[test.tier]={total:0,passed:0,failed:0,skipped:0,passRate:0};summary[test.tier].total++;}
    for(const row of rows){
      const bucket=summary[row.tier]||{total:0,passed:0,failed:0,skipped:0,passRate:0};
      if(row.status==='passed')bucket.passed++;
      else if(row.status==='failed')bucket.failed++;
      else bucket.skipped++;
      summary[row.tier]=bucket;
    }
    for(const tier of Object.keys(summary)){
      const b=summary[tier];
      b.passRate=b.total>0?b.passed/b.total:0;
    }
    return summary;
  };

  const buildReportText=(r)=>{
    const lines=[];
    lines.push('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
    lines.push('‚ïë             PRODUCTIVITY HUB - MODERNIZED TEST REPORT               ‚ïë');
    lines.push(`‚ïë     Suite ${r.suiteVersion} | Baseline ${r.baselineDate} | App v${r.appVersion}              ‚ïë`);
    lines.push('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
    lines.push('');
    lines.push(`Date: ${new Date(r.timestamp).toLocaleString()}`);
    lines.push(`Browser: ${r.browser}`);
    lines.push('');
    lines.push('Summary');
    lines.push(`  Passed: ${r.summary.passed}`);
    lines.push(`  Failed: ${r.summary.failed}`);
    lines.push(`  Skipped: ${r.summary.skipped}`);
    lines.push(`  Total: ${r.summary.total}`);
    lines.push('');
    lines.push('Tier Summary');
    for(const tier of TIER_ORDER){
      const t=r.tiers[tier]||{passed:0,total:0,failed:0,passRate:0};
      lines.push(`  ${tier}: ${t.passed}/${t.total} passed, ${t.failed} failed (${Math.round((t.passRate||0)*100)}%)`);
    }
    lines.push('');
    lines.push('Gate Status');
    lines.push(`  T0 required 100%: ${r.gates.T0?'PASS':'FAIL'}`);
    lines.push(`  T1 required 100%: ${r.gates.T1?'PASS':'FAIL'}`);
    lines.push(`  T2 required >=90% + stable: ${r.gates.T2?'PASS':'FAIL'}`);
    lines.push(`  Uncategorized tests: ${r.gates.uncategorized?'PASS':'FAIL'}`);
    lines.push(`  Deterministic rerun consistency: ${r.gates.deterministic?'PASS':'FAIL'}`);
    lines.push(`  Overall: ${r.gates.overall?'PASS':'FAIL'}`);
    lines.push('');
    lines.push('Determinism');
    lines.push(`  Runs: ${r.consistency.runs}`);
    lines.push(`  Flaky tests: ${r.consistency.flakyTests.length}`);
    if(r.consistency.flakyTests.length>0){
      for(const f of r.consistency.flakyTests)lines.push(`    - ${f.id}: ${f.name}`);
    }
    lines.push('');
    lines.push('Detailed Results');
    for(const tier of TIER_ORDER){
      lines.push(`  [${tier}]`);
      for(const row of r.tests.filter(x=>x.tier===tier)){
        const mark=row.status==='passed'?'‚úÖ':row.status==='failed'?'‚ùå':'‚è≠Ô∏è';
        const base=`    ${mark} ${row.id} - ${row.name} (${row.duration}ms)`;
        lines.push(base);
        if(row.error)lines.push(`      Error: ${row.error}`);
      }
      lines.push('');
    }
    lines.push(`Generated by Productivity Hub v${r.appVersion}`);
    return lines.join('\n');
  };

  const runTests=async()=>{
    setRunning(true);
    setResults(null);
    window.__PH_TEST_MODE=true;

    const tests=runnerModel.loadTestCases(buildTestCases);
    const invalidTierTests=tests.filter(t=>!TIER_ORDER.includes(t.tier));
    const duplicateIds=tests.map(t=>t.id).filter((id,idx,arr)=>arr.indexOf(id)!==idx);
    const t2Tests=tests.filter(t=>t.tier==='T2');
    const totalSteps=tests.length+(t2Tests.length*2);
    setProgress({current:0,total:Math.max(totalSteps,1),step:'Preparing suite...'});

    const originalData=await S.exp();
    const report={
      suiteVersion:SUITE_VERSION,
      baselineDate:BASELINE_DATE,
      appVersion:APP_VERSION,
      timestamp:new Date().toISOString(),
      browser:navigator.userAgent,
      tests:[],
      summary:{passed:0,failed:0,skipped:0,total:0},
      tiers:{},
      gates:{T0:false,T1:false,T2:false,uncategorized:false,deterministic:false,overall:false},
      consistency:{runs:3,stable:false,flakyTests:[],runsDetail:[]},
      invalidTierTests:invalidTierTests.map(t=>t.id),
      duplicateIds:Array.from(new Set(duplicateIds))
    };

    const executeCase=async(test,stepIndex,stepTotal,label='Primary')=>{
      setProgress({current:stepIndex,total:stepTotal,step:`${label}: ${test.name}`});
      const started=performance.now();
      const cleanupRegistry=makeCleanupRegistry();
      const ctx={
        assert,assertEq,assertIncludes,waitFor,
        withDomFixture:(fn)=>withDomFixture(cleanupRegistry,fn),
        withStorageFixture:(fn)=>withStorageFixture(cleanupRegistry,fn),
        withStorageSnapshot:(fn)=>withStorageSnapshot(cleanupRegistry,fn),
        withAppDataHarness:(fn)=>withAppDataHarness(cleanupRegistry,fn),
        withSectionHarness:(SectionComp,sectionProps,fn)=>withSectionHarness(cleanupRegistry,SectionComp,sectionProps,fn),
        withSettingsHarness:(fn)=>withSettingsHarness(cleanupRegistry,fn),
        setInputValue,findByText,findButtonByText,tapElement,delay
      };

      let status='passed';
      let error=null;
      try{
        await runWithTimeout(Promise.resolve(test.run(ctx)),test.timeoutMs||7000,test.id);
      }catch(err){
        status='failed';
        error=normalizeErr(err);
      }

      try{
        if(typeof test.cleanup==='function')await test.cleanup(ctx);
      }catch(err){
        status='failed';
        const extra=`cleanup hook: ${normalizeErr(err)}`;
        error=error?`${error} | ${extra}`:extra;
      }

      try{await cleanupRegistry.runAll();}
      catch(err){
        status='failed';
        error=error?`${error} | ${normalizeErr(err)}`:normalizeErr(err);
      }

      return{id:test.id,name:test.name,tier:test.tier,area:test.area,status,error,duration:Math.round(performance.now()-started)};
    };

    const runCaseList=async(caseList,offset,label)=>{
      const out=[];
      for(let i=0;i<caseList.length;i++){
        out.push(await executeCase(caseList[i],offset+i+1,totalSteps,label));
      }
      return out;
    };

    try{
      const primaryRows=await runCaseList(tests,0,'Primary');
      report.tests=primaryRows;

      const baselineT2=new Map(primaryRows.filter(r=>r.tier==='T2').map(r=>[r.id,r.status]));
      const flakyMap=new Map();
      const run2=await runCaseList(t2Tests,tests.length,'Consistency #2');
      const run3=await runCaseList(t2Tests,tests.length+t2Tests.length,'Consistency #3');
      report.consistency.runsDetail=[run2,run3];
      for(const row of [...run2,...run3]){
        const baseline=baselineT2.get(row.id);
        if(baseline&&baseline!==row.status){
          if(!flakyMap.has(row.id))flakyMap.set(row.id,{id:row.id,name:row.name});
        }
      }
      report.consistency.flakyTests=[...flakyMap.values()];
      report.consistency.stable=report.consistency.flakyTests.length===0;

      report.summary={
        passed:primaryRows.filter(r=>r.status==='passed').length,
        failed:primaryRows.filter(r=>r.status==='failed').length,
        skipped:primaryRows.filter(r=>r.status==='skipped').length,
        total:primaryRows.length
      };
      report.tiers=summarizeByTier(tests,primaryRows);

      const t0=report.tiers.T0||{failed:0,total:0,passRate:0};
      const t1=report.tiers.T1||{failed:0,total:0,passRate:0};
      const t2=report.tiers.T2||{failed:0,total:0,passRate:0};
      report.gates={
        T0:t0.total>0&&t0.failed===0,
        T1:t1.total>0&&t1.failed===0,
        T2:t2.total>0&&t2.passRate>=TIER_TARGETS.T2&&report.consistency.flakyTests.length===0,
        uncategorized:invalidTierTests.length===0&&report.duplicateIds.length===0,
        deterministic:report.consistency.stable,
        overall:false
      };
      report.gates.overall=report.gates.T0&&report.gates.T1&&report.gates.T2&&report.gates.uncategorized&&report.gates.deterministic;

      setProgress({current:totalSteps,total:totalSteps,step:'Final cleanup...'});
      await delay(120);

      const afterData=await S.exp();
      for(const key of Object.keys(afterData))if(key.startsWith('__TEST__'))await S.set(key,undefined);
      await S.clr();
      await S.imp(originalData);
      document.documentElement.classList.remove('dark');

      setResults(report);
      onShowToast(`${report.gates.overall?'‚úÖ':'‚ö†Ô∏è'} Suite complete: ${report.summary.passed}/${report.summary.total} passed`);
    }catch(err){
      const msg=normalizeErr(err);
      report.summary.failed=report.summary.failed+1;
      report.tests.push({id:'suite.runtime',name:'Suite runtime execution',tier:'T0',area:'Harness',status:'failed',error:msg,duration:0});
      setResults(report);
      onShowToast(`‚ùå Test suite error: ${msg}`);
      try{
        await S.clr();
        await S.imp(originalData);
      }catch{}
    }finally{
      window.__PH_TEST_MODE=false;
      setRunning(false);
    }
  };

  const generateReport=()=>results?buildReportText(results):'';
  const copyReport=()=>{navigator.clipboard.writeText(generateReport());onShowToast('Report copied to clipboard');};
  const downloadReport=()=>{dlFile(generateReport(),`productivity-hub-test-report-${new Date().toISOString().split('T')[0]}.txt`,'text/plain');onShowToast('Report downloaded');};

  const suiteCounts=suiteManifest.counts;

  return(
    <div className="space-y-4" data-testid="test-runner-root">
      <div className="gcard rounded-2xl p-5">
        <div className="flex items-center gap-3 mb-4">
          <div className="w-12 h-12 rounded-2xl bg-lavender-100 flex items-center justify-center"><I.Test s={24} c="text-lavender-400"/></div>
          <div>
            <h3 className="font-bold text-bark-600 dark:text-sand-100">Tiered Test Suite</h3>
            <p className="text-xs text-bark-400 dark:text-sand-300">Suite {SUITE_VERSION} ‚Ä¢ Baseline {BASELINE_DATE} ‚Ä¢ file:// deterministic gate</p>
          </div>
        </div>

        <div className="bg-terracotta-50 dark:bg-terracotta-400/10 border border-terracotta-200 dark:border-terracotta-400/30 rounded-xl p-3 mb-4">
          <div className="flex items-start gap-2">
            <span className="text-lg">‚ö†Ô∏è</span>
            <div>
              <p className="text-sm font-semibold text-terracotta-600 dark:text-terracotta-300">Modernized In-App Runner</p>
              <p className="text-xs text-bark-500 dark:text-sand-200">T0/T1 require 100%, T2 requires ‚â•90% and zero flaky rerun variance across 3 runs.</p>
            </div>
          </div>
        </div>

        {running?(
          <div className="space-y-3">
            <div className="flex items-center justify-between text-sm">
              <span className="text-bark-500 dark:text-sand-200">{progress.step}</span>
              <span className="font-semibold text-sage-500">{progress.current}/{progress.total}</span>
            </div>
            <div className="h-2 bg-sand-200 dark:bg-bark-600 rounded-full overflow-hidden">
              <div className="h-full bg-sage-400 rounded-full transition-all duration-300" style={{width:`${progress.total?((progress.current/progress.total)*100):0}%`}}/>
            </div>
          </div>
        ):(
          <button onClick={runTests} className="w-full py-3 bg-lavender-400 hover:bg-lavender-500 text-white rounded-xl font-bold transition-colors flex items-center justify-center gap-2"><I.Play s={20}/>Run Tiered Suite</button>
        )}
      </div>

      {results&&(
        <div className="gcard rounded-2xl p-5 space-y-4">
          <h4 className="font-bold text-bark-600 dark:text-sand-100">Test Results</h4>

          <div className="grid grid-cols-3 gap-3">
            <div className="bg-sage-100 dark:bg-sage-400/20 rounded-xl p-3 text-center"><div className="text-2xl font-bold text-sage-600 dark:text-sage-300">{results.summary.passed}</div><div className="text-xs text-bark-500 dark:text-sand-200">Passed</div></div>
            <div className="bg-terracotta-100 dark:bg-terracotta-400/20 rounded-xl p-3 text-center"><div className="text-2xl font-bold text-terracotta-500 dark:text-terracotta-300">{results.summary.failed}</div><div className="text-xs text-bark-500 dark:text-sand-200">Failed</div></div>
            <div className="bg-sand-200 dark:bg-bark-500/30 rounded-xl p-3 text-center"><div className="text-2xl font-bold text-bark-500 dark:text-sand-200">{results.summary.total}</div><div className="text-xs text-bark-500 dark:text-sand-200">Total</div></div>
          </div>

          <div className="grid grid-cols-3 gap-2 text-xs">
            {TIER_ORDER.map(tier=>{
              const t=results.tiers[tier]||{passed:0,total:0,failed:0,passRate:0};
              return <div key={tier} className="section-card"><div className="font-bold text-bark-600 dark:text-sand-100">{tier}</div><div className="text-bark-500 dark:text-sand-200">{t.passed}/{t.total} passed</div><div className="text-bark-400/70 dark:text-sand-300/70">{Math.round((t.passRate||0)*100)}%</div></div>;
            })}
          </div>

          <div className={`rounded-xl p-3 border ${results.gates.overall?'bg-sage-50 dark:bg-sage-400/10 border-sage-300 dark:border-sage-500/40':'bg-terracotta-50 dark:bg-terracotta-400/10 border-terracotta-300 dark:border-terracotta-500/40'}`}>
            <div className="text-sm font-semibold text-bark-600 dark:text-sand-100">Gate Status: {results.gates.overall?'PASS':'FAIL'}</div>
            <div className="text-xs text-bark-500 dark:text-sand-200 mt-1">T0 {results.gates.T0?'‚úì':'‚úó'} ‚Ä¢ T1 {results.gates.T1?'‚úì':'‚úó'} ‚Ä¢ T2 {results.gates.T2?'‚úì':'‚úó'} ‚Ä¢ Determinism {results.gates.deterministic?'‚úì':'‚úó'} ‚Ä¢ Flaky {results.consistency.flakyTests.length}</div>
          </div>

          {results.summary.failed>0&&(
            <div className="bg-terracotta-50 dark:bg-terracotta-400/10 rounded-xl p-3">
              <h5 className="font-semibold text-terracotta-600 dark:text-terracotta-300 text-sm mb-2">Failed Tests</h5>
              <ul className="space-y-1">
                {results.tests.filter(t=>t.status==='failed').map(t=><li key={t.id} className="text-xs text-bark-500 dark:text-sand-200">‚Ä¢ <span className="font-semibold">{t.id}</span>: {t.error}</li>)}
              </ul>
            </div>
          )}

          <div className="flex gap-2">
            <button onClick={copyReport} className="flex-1 py-2.5 bg-ocean-100 text-ocean-500 rounded-xl font-semibold text-sm flex items-center justify-center gap-1"><I.Copy s={16}/>Copy Report</button>
            <button onClick={downloadReport} className="flex-1 py-2.5 bg-sage-100 text-sage-600 rounded-xl font-semibold text-sm flex items-center justify-center gap-1"><I.Download s={16}/>Download</button>
          </div>
        </div>
      )}

      <div className="section-card">
        <h4 className="font-semibold text-bark-600 dark:text-sand-100 text-sm mb-2">Coverage Model</h4>
        <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-bark-500 dark:text-sand-200">
          <div>‚Ä¢ Total tests: {suiteCounts.total}</div><div>‚Ä¢ T0 Contract/Boot: {suiteCounts.T0}</div>
          <div>‚Ä¢ T1 Core Workflow: {suiteCounts.T1}</div><div>‚Ä¢ T2 UX/Quality: {suiteCounts.T2}</div>
          <div>‚Ä¢ Suite version: {SUITE_VERSION}</div><div>‚Ä¢ Baseline date: {BASELINE_DATE}</div>
        </div>
      </div>
    </div>
  );
};

const TestRunner=(props)=>{
  const[RunnerComp,setRunnerComp]=useState(()=>peekTestRunner());
  useEffect(()=>{
    let cancelled=false;
    if(!RunnerComp){
      getTestRunner().then(comp=>{if(!cancelled)setRunnerComp(()=>comp);}).catch(()=>{});
    }
    return()=>{cancelled=true;};
  },[RunnerComp]);
  if(!RunnerComp)return<div className="section-card" data-testid="test-runner-loading">Loading test suite...</div>;
  return React.createElement(RunnerComp,props);
};

// Isolated FocusTimer Component with useReducer
const FocusTimer=React.memo(({tSet,onComplete,activeTaskId,activeTaskText,onTick})=>{
  const getDurationSec=useCallback((m)=>Math.max(0,Math.round((m==='work'?tSet.work:m==='shortBreak'?tSet.shortBreak:tSet.longBreak)*60)),[tSet]);
  const timerStoreKey='focusTimerState';
  const[state,setState]=usePersistedState(timerStoreKey,{mode:'work',left:getDurationSec('work'),run:false,wake:true,endAt:null,startAt:null,elapsed:0});
  const{mode,left,run,wake,endAt,startAt,elapsed}=state;
  const stateRef=useRef(state);
  const wakeRef=useRef(null);

  useEffect(()=>{stateRef.current=state;},[state]);

  // Ensure latest timer state is flushed even if unmount happens before debounced storage write.
  useEffect(()=>()=>{S.set(timerStoreKey,stateRef.current);},[timerStoreKey]);

  useEffect(()=>{
    setState(prev=>{
      if(prev&&typeof prev.left==='number')return prev;
      return{mode:'work',left:getDurationSec('work'),run:false,wake:true,endAt:null,startAt:null,elapsed:0};
    });
  },[getDurationSec]);

  const fmt=s=>{const m=Math.floor(s/60),sec=s%60;return`${m.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;};
  const prog=useMemo(()=>{const t=getDurationSec(mode)||1;return((t-left)/t)*100;},[left,mode,getDurationSec]);

  const playSoftDing=useCallback(()=>{
    const isTestMode=!!window.__PH_TEST_MODE;
    if(isTestMode)return;
    if('vibrate'in navigator)navigator.vibrate([80]);
    try{
      const Ctx=window.AudioContext||window.webkitAudioContext;
      if(!Ctx)return;
      const c=new Ctx();
      const now=c.currentTime;
      const g=c.createGain();
      g.gain.setValueAtTime(0.0001,now);
      g.gain.exponentialRampToValueAtTime(0.08,now+0.06);
      g.gain.exponentialRampToValueAtTime(0.0001,now+0.5);
      g.connect(c.destination);
      const tone=(freq,delay,duration)=>{
        const o=c.createOscillator();
        o.type='sine';
        o.frequency.setValueAtTime(freq,now+delay);
        o.connect(g);
        o.start(now+delay);
        o.stop(now+delay+duration);
      };
      tone(440,0,0.24);
      tone(554,0.16,0.26);
      setTimeout(()=>c.close().catch(()=>{}),900);
    }catch{}
  },[]);

  const switchMode=useCallback((m)=>{
    const d=getDurationSec(m);
    setState(prev=>({...prev,mode:m,left:d,run:false,endAt:null,startAt:null,elapsed:0}));
  },[getDurationSec,setState]);

  const completeMode=useCallback((completedMode)=>{
    setState(prev=>({...prev,run:false,endAt:null,startAt:null,elapsed:0,left:0}));
    playSoftDing();
    const elapsedSec=completedMode==='work'?Math.max(0,elapsed||Math.max(0,getDurationSec('work')-left)):getDurationSec(completedMode);
    if(completedMode==='work'){
      const nextMode=onComplete(completedMode,activeTaskId,elapsedSec);
      switchMode(nextMode==='longBreak'?'longBreak':'shortBreak');
    }else{
      switchMode('work');
      if(!window.__PH_TEST_MODE)notify('‚òÄÔ∏è Break Complete!','Ready to focus again?');
    }
  },[activeTaskId,elapsed,getDurationSec,left,onComplete,playSoftDing,switchMode]);

  useEffect(()=>{
    if(!run)return;
    const int=setInterval(()=>{
      const now=Date.now();
      setState(prev=>{
        if(!prev.run||!prev.endAt)return prev;
        const nLeft=Math.max(0,Math.ceil((prev.endAt-now)/1000));
        const next={...prev,left:nLeft};
        if(prev.mode==='work'&&prev.startAt)next.elapsed=Math.max(prev.elapsed,Math.floor((now-prev.startAt)/1000));
        return next;
      });
    },250);
    return()=>clearInterval(int);
  },[run,setState]);

  useEffect(()=>{
    if(run&&left<=0)completeMode(mode);
  },[run,left,mode,completeMode]);

  useEffect(()=>{
    const req=async()=>{if(wake&&run&&'wakeLock'in navigator){try{wakeRef.current=await navigator.wakeLock.request('screen');}catch{}}};
    const rel=()=>{wakeRef.current?.release();wakeRef.current=null;};
    if(wake&&run)req();else rel();
    return()=>rel();
  },[wake,run]);


  useEffect(()=>{
    if(run)return;
    const d=getDurationSec(mode);
    setState(prev=>({...prev,left:d}));
  },[tSet,mode,run,getDurationSec,setState]);

  useEffect(()=>{if(onTick)onTick({left,run,mode});},[left,run,mode,onTick]);

  const toggleRun=()=>{
    setState(prev=>{
      if(prev.run)return{...prev,run:false,endAt:null,elapsed:prev.mode==='work'&&prev.startAt?Math.floor((Date.now()-prev.startAt)/1000):prev.elapsed};
      const now=Date.now();
      const currentLeft=Math.max(0,prev.left||getDurationSec(prev.mode));
      return{...prev,run:true,left:currentLeft,startAt:prev.mode==='work'?now:prev.startAt,endAt:now+(currentLeft*1000)};
    });
  };
  
  return(
    <div className={`rounded-3xl p-6 md:p-8 relative overflow-hidden soft-shadow ${mode==='work'?'bg-gradient-to-br from-sage-300 to-sage-400':mode==='shortBreak'?'bg-gradient-to-br from-ocean-300 to-ocean-400':'bg-gradient-to-br from-lavender-300 to-lavender-400'}`}>
      <div className="absolute inset-0 bg-white/20 transition-all duration-1000 origin-left" style={{transform:`scaleX(${prog/100})`}}/>
      <div className="relative z-10">
        <div className="flex justify-center gap-2 md:gap-3 mb-5 md:mb-6">{['work','shortBreak','longBreak'].map(m=><button key={m} onClick={()=>switchMode(m)} className={`px-4 md:px-6 py-1.5 md:py-2 rounded-full text-sm md:text-base font-semibold transition-all ${mode===m?'bg-white/40 text-white':'bg-white/20 text-white/80'}`}>{m==='work'?'Focus':m==='shortBreak'?'Short':'Long'}</button>)}</div>
        <div className="text-7xl md:text-8xl font-extrabold text-center mb-3 md:mb-5 text-white drop-shadow-sm tracking-tight timer-display">{fmt(left)}</div>
        {activeTaskText&&<div className="text-center text-white/90 text-sm mb-4 font-medium sel">üéØ {activeTaskText}</div>}
        <div className="flex justify-center gap-3">
          <button onClick={toggleRun} aria-label={run?'Pause timer':'Start timer'} className="px-8 md:px-10 py-3 md:py-3.5 bg-white rounded-2xl font-bold flex items-center gap-2 text-lg md:text-xl text-bark-600 soft-shadow">{run?<><I.Pause s={22}/>Pause</>:<><I.Play s={22}/>Start</>}</button>
          <button onClick={()=>switchMode(mode)} aria-label="Reset timer" className="p-3 bg-white/30 rounded-2xl text-white"><I.Reset s={24}/></button>
        </div>
        <div className="flex items-center justify-center gap-2 mt-4"><span className="text-sm text-white/80 font-medium">Keep awake</span><button onClick={()=>setState(prev=>({...prev,wake:!prev.wake}))} aria-label={wake?'Disable keep awake':'Enable keep awake'} className={`w-11 h-6 rounded-full transition-colors p-0.5 ${wake?'bg-white/40':'bg-black/20'}`}><div className={`w-5 h-5 bg-white rounded-full transition-transform shadow-sm ${wake?'translate-x-5':'translate-x-0'}`}/></button></div>
      </div>
    </div>
  );
},(prev,next)=>prev.tSet===next.tSet&&prev.activeTaskId===next.activeTaskId&&prev.activeTaskText===next.activeTaskText&&prev.onTick===next.onTick);
window.PH_BLOCK_B=Object.freeze({
  Heatmap,Chart,TestRunner,FocusTimer,
  getTestRunner,peekTestRunner,createTestRunnerModel,
  __resetTestRunnerCache:__resetTestRunnerCacheForTests,
  __getTestRunnerCacheStats
});
})();
/* == END: Block B == */
</script>
<script type="text/babel">
/* == BEGIN: Block C == */
(()=>{
const PH_BLOCK_A_C=window.PH_BLOCK_A;
const PH_BLOCK_B_C=window.PH_BLOCK_B;
if(!PH_BLOCK_A_C||!PH_BLOCK_B_C)throw new Error('Block A/B exports missing. Cannot initialize Block C.');
const{
  useState,useEffect,useRef,useMemo,useCallback,createContext,useContext,
  APP_VERSION,initDB,S,uid,notify,reqNotifyPerm,PRESETS,QUADS,CATS,shareItem,genICS,dlFile,
  I,Empty,ThemeCtx,ThemeProv,useDesk,useWide,usePersistedState,useAnimatedClose,
  Subtasks,QuickAdd,SelCheck,BulkActionBar,ContextMenu,ConfirmDialog,StickyHeader,LinkPicker,EditModal,AboutModal
}=PH_BLOCK_A_C;
const{Heatmap,Chart,TestRunner,FocusTimer,getTestRunner,peekTestRunner}=PH_BLOCK_B_C;
// useAppData ‚Äî shared persisted data state and CRUD handlers (v16.2 refactor Step 1)
function useAppData(){
  // Data
  const[lists,setLists]=usePersistedState('lists',[]);
  const[todos,setTodos]=usePersistedState('todos',[]);
  const[reminders,setReminders]=usePersistedState('reminders',[]);
  const[notes,setNotes]=usePersistedState('notes',[]);
  const[focus,setFocus]=usePersistedState('focus',[]);
  const[activeF,setActiveF]=useState(null);

  // Timer
  const[preset,setPreset]=usePersistedState('preset','classic');
  const[customT,setCustomT]=usePersistedState('customT',{work:25,shortBreak:5,longBreak:15});
  const tSet=useMemo(()=>preset==='custom'?customT:PRESETS[preset],[preset,customT]);
  const[poms,setPoms]=usePersistedState('poms',0);

  // Metrics
  const[met,setMet]=usePersistedState('met',{d:{p:0,t:0,m:0,date:new Date().toDateString()},w:{p:0,t:0,m:0}});
  const[fHist,setFHist]=usePersistedState('fHist',[]);
  const[dHist,setDHist]=usePersistedState('dHist',[]);

  // Day rotation: archive yesterday's stats to dHist
  useEffect(()=>{
    const today=new Date().toDateString();
    if(met.d.date&&met.d.date!==today){
      if(met.d.p>0||met.d.t>0||met.d.m>0){
        setDHist(h=>{const filtered=h.filter(x=>x.date!==met.d.date);return[...filtered,{date:met.d.date,p:met.d.p,t:met.d.t,m:met.d.m}].slice(-180);});
      }
      const oldDate=new Date(met.d.date);
      const nowDate=new Date(today);
      const isNewWeek=nowDate.getDay()===0||oldDate.getDay()>nowDate.getDay()||(nowDate-oldDate)>=7*864e5;
      setMet(p=>({d:{p:0,t:0,m:0,date:today},w:isNewWeek?{p:0,t:0,m:0}:p.w}));
    }
  },[]);

  // Toast with auto-fade (last 500ms of 2000ms display)
  const[toast,setToast]=useState(null);
  const[toastFading,setToastFading]=useState(false);
  const toastTimers=useRef({fade:null,clear:null});
  const showT=m=>{clearTimeout(toastTimers.current.fade);clearTimeout(toastTimers.current.clear);setToast(m);setToastFading(false);toastTimers.current.fade=setTimeout(()=>setToastFading(true),1500);toastTimers.current.clear=setTimeout(()=>{setToast(null);setToastFading(false);},2000);};

  // Tab navigation
  const[tab,setTab]=usePersistedState('tab','notes');
  const[selList,setSelList]=usePersistedState('selList','');

  const toLoggedMinutes=(elapsedSec)=>Math.max(0,Math.floor((Number(elapsedSec)||0)/60));

  // Timer completion callbacks
  const handleTimerComplete=(mode,activeTaskId,elapsedSec)=>{
    const workedMinutes=toLoggedMinutes(elapsedSec);
    setFHist(h=>[...h.slice(-500),{hr:new Date().getHours()}]);
    const nc=poms+1;
    setPoms(nc);
    setMet(p=>({...p,d:{...p.d,p:p.d.p+1,m:p.d.m+workedMinutes},w:{...p.w,p:p.w.p+1,m:p.w.m+workedMinutes}}));
    if(activeTaskId){
      setFocus(f=>f.map(t=>t.id===activeTaskId?{...t,poms:(t.poms||0)+1}:t));
      setTodos(t=>t.map(x=>x.id===activeTaskId?{...x,poms:(x.poms||0)+1}:x));
    }
    notify('üåø Great Focus!',nc%4===0?'Time for a long break (15 min)':'Time for a short break (5 min)');
    showT('üåø Great focus!');
    return nc%4===0?'longBreak':'shortBreak';
  };

  // CRUD handlers
  const clearCompleted=(section)=>{
    if(section==='todos'){const cnt=todos.filter(t=>t.done).length;if(cnt===0)return showT('No completed tasks');setTodos(t=>t.filter(x=>!x.done));setFocus(f=>f.filter(x=>!todos.find(t=>t.id===x.id&&t.done)));showT(`üßπ ${cnt} cleared`);}
  };

  const addFocus=t=>{if(focus.length>=5)return showT('üåø Max 5');if(!focus.find(x=>x.id===t.id)){setFocus([...focus,{...t}]);showT('‚ú® Added');}};
  const doneFocus=id=>{setTodos(t=>t.map(x=>x.id===id?{...x,done:true}:x));setFocus(f=>f.filter(x=>x.id!==id));setMet(p=>({...p,d:{...p.d,t:p.d.t+1},w:{...p.w,t:p.w.t+1}}));if(activeF===id)setActiveF(null);showT('üéâ Done!');};
  const doneList=(lid,iid)=>{setLists(ls=>ls.map(l=>l.id===lid?{...l,items:l.items.map(i=>i.id===iid?{...i,done:!i.done}:i)}:l));};
  const doneTodo=id=>{setTodos(t=>t.map(x=>x.id===id?{...x,done:true}:x));setFocus(f=>f.filter(x=>x.id!==id));setMet(p=>({...p,d:{...p.d,t:p.d.t+1},w:{...p.w,t:p.w.t+1}}));showT('‚úÖ Done!');};
  const undoneTodo=id=>{setTodos(t=>t.map(x=>x.id===id?{...x,done:false}:x));showT('‚Ü©Ô∏è Restored');};
  const deleteTodo=id=>{setTodos(t=>t.filter(x=>x.id!==id));showT('üóë Deleted');};
  const linkTask=(taskId,listId)=>{setTodos(t=>t.map(x=>x.id===taskId?{...x,linkedList:listId}:x));showT('üìã Linked!');};
  const unlinkTask=(taskId)=>{setTodos(t=>t.map(x=>x.id===taskId?{...x,linkedList:undefined}:x));showT('Unlinked');};
  const openLinkedList=(task)=>{if(task.linkedList){setSelList(task.linkedList);setTab('lists');}};
  const createAndLink=(taskId,name)=>{const id=uid();setLists(ls=>[...ls,{id,name,items:[]}]);linkTask(taskId,id);setSelList(id);};
  const deleteListItem=(lid,iid)=>{setLists(ls=>ls.map(l=>l.id===lid?{...l,items:l.items.filter(i=>i.id!==iid)}:l));showT('üóë Deleted');};
  const deleteReminder=id=>{setReminders(r=>r.filter(x=>x.id!==id));showT('üóë Deleted');};

  const updateListName=(listId,newName)=>{
    if(!newName.trim())return;
    setLists(ls=>ls.map(l=>l.id===listId?{...l,name:newName.trim()}:l));
    showT('‚úèÔ∏è List renamed!');
  };

  const deleteList=(listId)=>{
    setLists(ls=>ls.filter(l=>l.id!==listId));
    if(selList===listId){
      const remaining=lists.filter(l=>l.id!==listId);
      if(remaining.length>0)setSelList(remaining[0].id);
    }
    showT('üóë List deleted!');
  };

  const saveItem=(type,item,listId=null)=>{
    if(type==='note'){if(item.id)setNotes(n=>n.map(x=>x.id===item.id?{...item,upAt:new Date().toISOString()}:x));else setNotes(n=>[...n,{...item,id:uid(),crAt:new Date().toISOString()}]);}
    else if(type==='list'){if(item.id)setLists(ls=>ls.map(l=>l.id===listId?{...l,items:l.items.map(i=>i.id===item.id?item:i)}:l));else setLists(ls=>ls.map(l=>l.id===listId?{...l,items:[...l.items,{...item,id:uid()}]}:l));}
    else if(type==='todo'){if(item.id){setTodos(t=>t.map(x=>x.id===item.id?item:x));setFocus(f=>f.map(x=>x.id===item.id?item:x));}else setTodos(t=>[...t,{...item,id:uid(),poms:0}]);}
    else if(type==='reminder'){if(item.id)setReminders(r=>r.map(x=>x.id===item.id?item:x));else setReminders(r=>[...r,{...item,id:uid(),on:true}]);}
    showT('‚ú® Saved!');
  };

  const seedSampleData=()=>{
    const now=new Date().toISOString();
    const today=new Date().toDateString();
    setTodos(t=>{if(t.length>0)return t;return[
      {id:uid(),text:'Try adding a task here',quad:'ui',pri:'high',cat:'personal',done:false,poms:0},
      {id:uid(),text:'Schedule tasks with deadlines',quad:'ni',pri:'medium',cat:'learning',done:false,poms:0},
      {id:uid(),text:'Use ‚òê header checkbox for bulk select',quad:'nn',pri:'low',cat:'personal',done:false,poms:0},
    ];});
    setNotes(n=>{if(n.length>0)return n;return[
      {id:uid(),text:'Welcome! Jot quick thoughts here',date:today,crAt:now},
      {id:uid(),text:'Tap any note to edit, use ‚ãÆ for actions',date:today,crAt:now},
    ];});
    setLists(ls=>{if(ls.some(l=>l.items.length>0))return ls;return[
      {id:uid(),name:'Getting Started',items:[{id:uid(),text:'Explore each tab',done:false},{id:uid(),text:'Start a Focus session',done:false},{id:uid(),text:'Check the Review tab',done:false}]},
    ];});
  };

  // Derived data
  const wkData=useMemo(()=>{const days=['S','M','T','W','T','F','S'],td=new Date();return Array.from({length:7},(_,i)=>{const d=new Date(td);d.setDate(d.getDate()-(6-i));const ds=d.toDateString(),dd=dHist.find(x=>x.date===ds);return{l:days[d.getDay()],v:ds===met.d.date?met.d.p:(dd?.p||0)};});},[dHist,met.d]);
  const doneCount=todos.filter(t=>t.done).length;

  return{
    // Data state
    lists,setLists,todos,setTodos,reminders,setReminders,notes,setNotes,
    focus,setFocus,activeF,setActiveF,
    // Timer config
    preset,setPreset,customT,setCustomT,tSet,poms,setPoms,
    // Metrics
    met,setMet,fHist,setFHist,dHist,setDHist,
    // Toast
    toast,showT,toastFading,
    // Tab/nav
    tab,setTab,selList,setSelList,
    // Handlers
    handleTimerComplete,clearCompleted,
    addFocus,doneFocus,doneList,doneTodo,undoneTodo,deleteTodo,
    linkTask,unlinkTask,openLinkedList,createAndLink,
    deleteListItem,deleteReminder,updateListName,deleteList,saveItem,
    seedSampleData,
    // Derived
    wkData,doneCount,
  };
}

// AppDataCtx ‚Äî shared data context (v16.2 refactor Step 2)
const AppDataCtx=React.createContext(null);
function AppDataProv({children}){
  const data=useAppData();
  return React.createElement(AppDataCtx.Provider,{value:data},children);
}
function useApp(){const ctx=useContext(AppDataCtx);if(!ctx)throw new Error('useApp must be inside AppDataProv');return ctx;}

// CaptureSection ‚Äî extracted from rNotes() (v16.2 refactor Step 3)
function CaptureSection({wide,selMode,selSection,selIds,toggleSelId,enterSelMode,exitSelMode}){
  const{notes,setNotes,todos,setTodos,showT}=useApp();
  const[newBullet,setNewBullet]=useState('');
  const[editingNote,setEditingNote]=useState(null);
  const[noteMenu,setNoteMenu]=useState(null);
  const bulletRef=React.useRef(null);
  const today=new Date().toISOString().split('T')[0];

  const notesByDate=useMemo(()=>{
    const groups={};
    notes.forEach(n=>{
      const d=n.date||new Date(n.crAt).toISOString().split('T')[0];
      if(!groups[d])groups[d]=[];
      groups[d].push(n);
    });
    return Object.entries(groups).sort((a,b)=>b[0].localeCompare(a[0]));
  },[notes]);

  const addBullet=(text)=>{
    if(!text.trim())return;
    const newNote={id:uid(),text:text.trim(),date:today,crAt:new Date().toISOString()};
    setNotes([newNote,...notes]);
  };

  const handleBulletKeyDown=(e)=>{
    if(e.key==='Enter'&&!e.shiftKey){
      e.preventDefault();
      addBullet(newBullet);
      setNewBullet('');
    }
  };

  const formatDateHeader=(dateStr)=>{
    const d=new Date(dateStr+'T12:00:00');
    const now=new Date();
    const todayStr=now.toISOString().split('T')[0];
    const yesterday=new Date(now);yesterday.setDate(yesterday.getDate()-1);
    const yesterdayStr=yesterday.toISOString().split('T')[0];
    if(dateStr===todayStr)return'Today';
    if(dateStr===yesterdayStr)return'Yesterday';
    return d.toLocaleDateString('en-US',{weekday:'short',month:'short',day:'numeric'});
  };

  const deleteBullet=(id)=>setNotes(notes.filter(n=>n.id!==id));
  const updateBullet=(id,text)=>{if(!text.trim()){deleteBullet(id);}else{setNotes(notes.map(n=>n.id===id?{...n,text:text.trim()}:n));}setEditingNote(null);};

  React.useEffect(()=>{
    const thirtyDays=30*24*60*60*1000;
    const now=Date.now();
    const toRemove=notes.filter(n=>n.struck&&n.struckAt&&(now-n.struckAt>thirtyDays));
    if(toRemove.length>0)setNotes(prev=>prev.filter(n=>!toRemove.find(r=>r.id===n.id)));
  },[notes.length]);

  const toggleStrike=(id)=>setNotes(notes.map(n=>n.id===id?{...n,struck:!n.struck,struckAt:!n.struck?Date.now():null}:n));
  const noteToTodo=(note)=>{setTodos(t=>[{id:uid(),text:note.text||note.title||note.content,quad:'nn',poms:0,done:false},...t]);setNotes(notes.map(n=>n.id===note.id?{...n,struck:true,struckAt:Date.now()}:n));showT('üìã Copied to Clarify + struck');};

  const inSel=selMode&&selSection==='notes';
  return(
    <div className="space-y-4">
      <StickyHeader>
        {inSel?<div className="flex items-center justify-center relative"><button onClick={exitSelMode} className="absolute left-0 px-3 py-1.5 bg-sand-200 dark:bg-bark-600 rounded-lg text-bark-600 dark:text-sand-100 text-sm font-semibold">‚úï Cancel</button><h2 className="text-lg md:text-xl font-bold text-sage-500">{selIds.size} selected</h2></div>
        :<div className="flex items-center justify-center relative">
          {notes.length>0&&<button onClick={()=>enterSelMode('notes',null)} className="absolute left-0 w-7 h-7 rounded-md border-2 border-bark-300 dark:border-sand-300 flex items-center justify-center hover:border-sage-400 transition-colors" aria-label="Select items"><span className="sr-only">Select</span></button>}
          <h2 className="text-lg md:text-xl font-bold text-bark-600 dark:text-sand-100">üìù Capture</h2>
        </div>}
      </StickyHeader>

      <div className="section-card capture-input">
        <div className="flex items-start gap-3">
          <span className="text-sage-400 mt-1 text-lg">‚Ä¢</span>
          <textarea
            ref={bulletRef}
            value={newBullet}
            onChange={e=>setNewBullet(e.target.value)}
            onKeyDown={handleBulletKeyDown}
            placeholder="Quick note... (Enter to add)"
            rows={1}
            className="flex-1 bg-transparent focus:outline-none text-bark-600 dark:text-sand-100 placeholder-bark-400/50 resize-none text-base leading-relaxed"
            style={{minHeight:'28px'}}
          />
        </div>
        {newBullet.trim()&&<div className="flex justify-end mt-2"><button onClick={()=>{addBullet(newBullet);setNewBullet('');}} className="px-4 py-1.5 bg-sage-400 rounded-lg text-white font-semibold text-sm">Add</button></div>}
      </div>

      {notesByDate.length===0?<Empty.Notes/>:notesByDate.map(([date,dayNotes])=>(
        <div key={date} className="space-y-2">
          <div className="flex items-center gap-2 px-1">
            <span className="text-sm font-bold text-bark-600/70 dark:text-sand-200/70 uppercase tracking-wider">{formatDateHeader(date)}</span>
            <div className="flex-1 h-px bg-sand-200 dark:bg-bark-500/50"/>
          </div>
          <div className="gcard rounded-2xl p-3 space-y-1">
            {dayNotes.map(n=>{
              const isSel=inSel&&selIds.has(n.id);
              let touchData={x:0,y:0,moved:false,menuTap:false};
              const onTS=(e)=>{const t=e.touches?e.touches[0]:null;if(t)touchData={x:t.clientX,y:t.clientY,moved:false,menuTap:false};};
              const onTM=(e)=>{const t=e.touches?e.touches[0]:null;if(t&&(Math.abs(t.clientX-touchData.x)>10||Math.abs(t.clientY-touchData.y)>10))touchData.moved=true;};
              const handleTap=(e)=>{if(touchData.moved||touchData.menuTap)return;if(e?.target?.closest?.('[data-menu-btn]'))return;if(inSel)toggleSelId(n.id);else if(!selMode&&!editingNote)setEditingNote({id:n.id,text:n.text||n.title||n.content||''});};
              return(
                <div key={n.id} onTouchStart={onTS} onTouchMove={onTM} onTouchEnd={handleTap} onContextMenu={e=>{e.preventDefault();setNoteMenu(n);}} onClick={(e)=>{if(e.target?.closest?.('[data-menu-btn]'))return;if(e.type==='click'&&!('ontouchstart' in window)){if(inSel)toggleSelId(n.id);else if(!selMode&&!editingNote)setEditingNote({id:n.id,text:n.text||n.title||n.content||''});}}} className={`flex items-center gap-2 py-2 px-2 rounded-lg cursor-pointer transition-all duration-200 ${isSel?'bg-sage-100 dark:bg-sage-400/20':'hover:bg-sand-100 dark:hover:bg-bark-600/50'}`}>
                  {inSel&&<SelCheck checked={isSel} onToggle={()=>toggleSelId(n.id)}/>}
                  {!inSel&&<span className={`flex-shrink-0 ${n.struck?'text-bark-400/40':'text-sage-400'}`}>‚Ä¢</span>}
                  {editingNote&&editingNote.id===n.id?
                    <input autoFocus type="text" value={editingNote.text} onChange={e=>setEditingNote({...editingNote,text:e.target.value})} onKeyDown={e=>{if(e.key==='Enter'){e.preventDefault();updateBullet(n.id,editingNote.text);}if(e.key==='Escape')setEditingNote(null);}} onBlur={()=>updateBullet(n.id,editingNote.text)} onClick={e=>e.stopPropagation()} className="flex-1 bg-transparent focus:outline-none text-bark-700 dark:text-sand-100 border-b-2 border-sage-400 font-medium"/>
                  :<span className={`flex-1 sel leading-relaxed ${n.struck?'line-through text-bark-400/50 dark:text-sand-300/40':'text-bark-700 dark:text-cream-100 font-medium'}`}>{n.text||n.title||n.content}</span>}
                  {!inSel&&!editingNote&&<button data-menu-btn onTouchStart={e=>{touchData.menuTap=true;}} onClick={e=>{e.stopPropagation();e.preventDefault();setNoteMenu(n);}} className="p-2 rounded-lg text-bark-600 dark:text-sand-200 hover:text-bark-700 dark:hover:text-white hover:bg-sand-200 dark:hover:bg-bark-500 transition-colors flex-shrink-0" aria-label="More options"><I.MoreV s={18}/></button>}
                </div>
              );
            })}
          </div>
        </div>
      ))}
      {noteMenu&&<ContextMenu title={noteMenu.text||noteMenu.title||noteMenu.content} onClose={()=>setNoteMenu(null)} items={[{icon:<I.Edit s={18} c="text-ocean-400"/>,label:'Edit',onClick:()=>{setEditingNote({id:noteMenu.id,text:noteMenu.text||noteMenu.title||noteMenu.content||''});}},{icon:<I.Copy s={18} c="text-bark-400"/>,label:'Copy Text',onClick:()=>{navigator.clipboard.writeText(noteMenu.text||noteMenu.title||noteMenu.content||'');showT('üìã Copied!');},borderTop:true},{icon:<I.Check s={18} c="text-sage-500"/>,label:'‚Üí Promote to Clarify',onClick:()=>noteToTodo(noteMenu),borderTop:true,extra:<span className="text-xs text-bark-400/50 ml-auto">copy + strike</span>},{icon:<span className="w-[18px] h-[18px] flex items-center justify-center font-bold text-sm text-bark-400 line-through">S</span>,label:noteMenu.struck?'Remove Strikethrough':'Strikethrough',onClick:()=>toggleStrike(noteMenu.id),borderTop:true},{icon:<I.Trash s={18} c="text-terracotta-400"/>,label:'Delete',onClick:()=>deleteBullet(noteMenu.id),variant:'danger',borderTop:true}]}/>}
    </div>
  );
}

// ClarifySection ‚Äî extracted from rTodos() (v16.2 refactor Step 4)
function ClarifySection({wide,desk,selMode,selSection,selIds,toggleSelId,enterSelMode,exitSelMode,setEdit,setLinkPicker}){
  const{todos,setTodos,doneTodo,undoneTodo,deleteTodo,addFocus,focus,openLinkedList,clearCompleted,doneCount,saveItem,showT}=useApp();
  const[expQ,setExpQ]=useState({ui:true,ni:true,un:true,nn:true});
  const[dragQ,setDragQ]=useState(null);
  const moveTodoQuad=(tid,nq)=>{setTodos(t=>t.map(x=>x.id===tid?{...x,quad:nq}:x));setDragQ(null);showT(`‚Üí ${QUADS.find(q=>q.id===nq)?.l}`);};
  const[taskMenu,setTaskMenu]=useState(null);

  const content=QUADS.map(q=>{
    const tasks=todos.filter(t=>t.quad===q.id).sort((a,b)=>(a.done?1:0)-(b.done?1:0));
    const isExp=expQ[q.id];
    const vis=isExp?tasks:tasks.slice(0,2);
    return(
      <div key={q.id} className={`rounded-2xl border-2 ${q.bdr} ${q.dbdr} overflow-hidden transition-all ${dragQ&&dragQ!==q.id?'ring-2 ring-sage-300 ring-offset-1':''}`}
        onDragOver={e=>{e.preventDefault();e.dataTransfer.dropEffect='move';}}
        onDrop={e=>{e.preventDefault();const tid=e.dataTransfer.getData('text/plain');if(tid&&q.id!==todos.find(x=>x.id===tid)?.quad)moveTodoQuad(tid,q.id);}}>
        <button onClick={()=>setExpQ({...expQ,[q.id]:!isExp})} className={`w-full p-2 md:p-3 bg-gradient-to-r ${q.clr} ${q.dclr} flex items-center justify-between`}><div><h3 className={`font-bold text-sm md:text-base ${q.txt} ${q.dtxt}`}>{q.l}</h3><p className="text-[11px] md:text-xs text-bark-500/60 dark:text-sand-300/50">{q.sub}</p></div><div className="flex items-center gap-2"><span className={`text-sm md:text-base font-semibold ${q.txt} ${q.dtxt}`}>{tasks.length}</span>{isExp?<I.Up s={16} c={`${q.txt} ${q.dtxt}`}/>:<I.Down s={16} c={`${q.txt} ${q.dtxt}`}/>}</div></button>
        <div className={`bg-white/40 dark:bg-white/5 ${tasks.length>0?'p-2 md:p-3':'p-1'}`}>
          {tasks.length===0?<Empty.Tasks/>:(
            <div className="space-y-1.5">
              {vis.map(t=>{
                const inSel=selMode&&selSection==='todos';
                const isSel=inSel&&selIds.has(t.id);
                return(
                  <div key={t.id} className="gcard rounded-xl overflow-hidden transition-all duration-200">
                  <div draggable={!t.done&&!selMode&&desk} onDragStart={e=>{e.dataTransfer.setData('text/plain',t.id);e.dataTransfer.effectAllowed='move';setDragQ(q.id);}} onDragEnd={()=>setDragQ(null)} onContextMenu={e=>{e.preventDefault();setTaskMenu(t);}} onClick={()=>{if(inSel)toggleSelId(t.id);else if(!selMode&&!t.done)doneTodo(t.id);else if(!selMode&&t.done)undoneTodo(t.id);}} className={`p-3 md:px-3 md:py-2 flex items-center gap-2 md:gap-2.5 transition-colors cursor-pointer ${t.done?'opacity-70':''} ${isSel?'ring-2 ring-sage-400 bg-sage-50 dark:bg-sage-400/10':'hover:bg-sand-50 dark:hover:bg-bark-600/50'}`}>
                    {inSel&&<SelCheck checked={isSel} onToggle={()=>toggleSelId(t.id)}/>}
                    {!inSel&&<button onClick={e=>{e.stopPropagation();t.done?undoneTodo(t.id):doneTodo(t.id);}} className={`w-6 h-6 md:w-5 md:h-5 rounded-full border-2 flex items-center justify-center group flex-shrink-0 transition-all ${t.done?'bg-sage-400 border-sage-400':'border-sage-400 hover:bg-sage-400'}`}><span className={`text-sm md:text-xs font-semibold ${t.done?'text-white':'text-sage-400 group-hover:text-white'}`}>‚úì</span></button>}
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2">
                        <span className={`font-semibold sel md:text-sm md:leading-snug leading-relaxed ${t.done?'line-through text-bark-400 dark:text-sand-300':'text-bark-700 dark:text-cream-100'}`}>{t.text}</span>
                        {t.linkedList&&<span className="text-xs opacity-60" title="Linked checklist">üìã</span>}
                      </div>
                      {(t.cat||t.deadline||t.subtasks?.length>0)&&(
                        <div className="flex items-center gap-2 flex-wrap text-xs mt-1">
                          {t.cat&&<span className="px-2 py-0.5 rounded-full bg-sage-100 dark:bg-sage-400/20 text-sage-600 dark:text-sage-300 font-medium">{CATS.find(c=>c.id===t.cat)?.e} {CATS.find(c=>c.id===t.cat)?.l}</span>}
                          {t.deadline&&<span className="px-2 py-0.5 rounded-full bg-ocean-100 dark:bg-ocean-400/20 text-ocean-500 dark:text-ocean-300 font-medium">üìÖ {t.deadline}</span>}
                          {t.subtasks?.length>0&&<span className="px-2 py-0.5 rounded-full bg-lavender-100 dark:bg-lavender-400/20 text-lavender-500 dark:text-lavender-300 font-medium">‚òëÔ∏è {t.subtasks.filter(x=>x.done).length}/{t.subtasks.length}</span>}
                        </div>
                      )}
                      {t.poms>0&&<div className="flex items-center gap-1.5 mt-1"><span className="text-terracotta-400 font-bold text-sm">üçÖ {t.poms}</span></div>}
                    </div>
                    {!inSel&&<button onClick={e=>{e.stopPropagation();setTaskMenu(t);}} className="p-1.5 rounded-lg text-bark-600 dark:text-sand-200 hover:text-bark-700 dark:hover:text-white hover:bg-sand-200 dark:hover:bg-bark-500 transition-colors flex-shrink-0" aria-label="More options"><I.MoreV s={18}/></button>}
                  </div>
                </div>
              );})}
              {tasks.length>2&&!isExp&&<button onClick={()=>setExpQ({...expQ,[q.id]:true})} className="w-full py-2 text-center text-sm text-bark-400/60 font-medium">Show {tasks.length-2} more...</button>}
            </div>
          )}
        </div>
      </div>
    );
  });
  return(
    <div className="space-y-4">
      <StickyHeader>
        {selMode&&selSection==='todos'?<div className="flex items-center justify-center relative"><button onClick={exitSelMode} className="absolute left-0 px-3 py-1.5 bg-sand-200 dark:bg-bark-600 rounded-lg text-bark-600 dark:text-sand-100 text-sm font-semibold">‚úï Cancel</button><h2 className="text-lg md:text-xl font-bold text-sage-500">{selIds.size} selected</h2></div>:
        <div className="flex items-center justify-center relative">
          {todos.length>0&&<button onClick={()=>enterSelMode('todos',null)} className="absolute left-0 w-7 h-7 rounded-md border-2 border-bark-300 dark:border-sand-300 flex items-center justify-center hover:border-sage-400 transition-colors" aria-label="Select items"><span className="sr-only">Select</span></button>}
          <h2 className="text-lg md:text-xl font-bold text-bark-600 dark:text-sand-100">üìã Clarify</h2>
          <div className="absolute right-0 flex items-center gap-2">{doneCount>0&&<button onClick={()=>clearCompleted('todos')} className="px-3 py-1.5 rounded-lg bg-sand-200 dark:bg-bark-600 text-bark-500 dark:text-sand-200 text-xs font-semibold hover:bg-terracotta-100 hover:text-terracotta-500 transition-colors" aria-label="Clear completed tasks">üßπ {doneCount}</button>}<button onClick={()=>setEdit({type:'todo',item:{}})} aria-label="Add new task" className="p-2 rounded-xl bg-sage-400 text-white shadow-sm hover:bg-sage-500 transition-colors"><I.Plus s={20}/></button></div>
        </div>}
      </StickyHeader>
      <div className="space-y-3 md:grid md:grid-cols-2 md:gap-4 md:space-y-0">{content}</div>
      <div className="md:max-w-[calc(50%-0.5rem)]"><QuickAdd placeholder="Quick add task..." onAdd={text=>saveItem('todo',{text,quad:'nn',poms:0})}/></div>
      {taskMenu&&<ContextMenu title={taskMenu.text} onClose={()=>setTaskMenu(null)} items={[...(taskMenu.done?[{icon:<I.Restore s={18} c="text-ocean-400"/>,label:'Mark Undone',onClick:()=>undoneTodo(taskMenu.id)}]:[{icon:<I.Done s={18} c="text-sage-500"/>,label:'Mark Done',onClick:()=>doneTodo(taskMenu.id)}]),...(!taskMenu.done?[{icon:<I.Edit s={18} c="text-ocean-400"/>,label:'Edit',onClick:()=>setEdit({type:'todo',item:taskMenu}),borderTop:true}]:[]),...(!taskMenu.done&&!focus.find(x=>x.id===taskMenu.id)?[{icon:<I.Focus s={18} c="text-sage-500"/>,label:'‚Üí Focus Queue',onClick:()=>addFocus(taskMenu),borderTop:true}]:[]),...(!taskMenu.done&&!taskMenu.linkedList?[{icon:<I.List s={18} c="text-terracotta-400"/>,label:'üìã Link Checklist',onClick:()=>setLinkPicker(taskMenu),borderTop:true}]:[]),...(taskMenu.linkedList?[{icon:<I.List s={18} c="text-sage-500"/>,label:'üìã Open Checklist',onClick:()=>openLinkedList(taskMenu),borderTop:true}]:[]),{icon:<I.Trash s={18} c="text-terracotta-400"/>,label:'Delete',onClick:()=>deleteTodo(taskMenu.id),variant:'danger',borderTop:true}]}/>}
    </div>
  );
}

// FocusSection ‚Äî extracted from rFocus() (v16.2 refactor Step 5)
function FocusSection({wide,desk,onTimerTick}){
  const{tSet,poms,met,focus,setFocus,activeF,setActiveF,handleTimerComplete,doneFocus}=useApp();
  const[dragI,setDragI]=useState(null);
  const[dragO,setDragO]=useState(null);
  const handleDS=i=>setDragI(i);
  const handleDO=(e,i)=>{e.preventDefault();setDragO(i);};
  const handleDE=()=>{if(dragI!==null&&dragO!==null&&dragI!==dragO){const n=[...focus],[d]=n.splice(dragI,1);n.splice(dragO,0,d);setFocus(n);}setDragI(null);setDragO(null);};

  const statsCards=[{v:poms,l:'Session',i:'üçÖ',c:'text-terracotta-400'},{v:met.d.t,l:'Tasks',i:'‚úì',c:'text-sage-500'},{v:`${met.d.m}m`,l:'Focus',i:'‚è±',c:'text-ocean-400'}];

  const renderQueue=(compact)=>(<>
    <div className="flex items-center justify-between mb-3 px-1"><h3 className="font-bold text-bark-600 dark:text-sand-100 flex items-center gap-2"><I.Focus s={20} c="text-sage-500"/>Focus Queue<span className="text-sm font-normal text-bark-400/50 dark:text-sand-300/50">({focus.length}/5)</span></h3><span className="text-xs text-bark-400/50 dark:text-sand-300/50 font-medium">Drag to reorder</span></div>
    <div className="space-y-2">
      {focus.map((t,i)=>(
        <div key={t.id} draggable={desk} onDragStart={()=>handleDS(i)} onDragOver={e=>handleDO(e,i)} onDragEnd={handleDE} onClick={()=>setActiveF(t.id===activeF?null:t.id)} className={`gcard ${compact?'rounded-2xl px-3 py-2':'rounded-2xl p-4'} focus-item flex items-center gap-${compact?'2.5':'3 md:gap-4'} cursor-grab active:cursor-grabbing transition-all ${activeF===t.id?'ring-2 ring-sage-400':''} ${dragI===i?'opacity-50':''} ${dragO===i?'ring-2 ring-sage-300':''}`}>
          <div className="text-bark-400/30 dark:text-sand-300/30" aria-hidden="true"><I.Drag s={20}/></div>
          <button onClick={e=>{e.stopPropagation();doneFocus(t.id);}} aria-label="Complete task" className="w-7 h-7 rounded-full border-2 border-sage-400 hover:bg-sage-400 flex items-center justify-center transition-colors flex-shrink-0 group"><span className="text-sage-400 group-hover:text-white text-sm">‚úì</span></button>
          <div className="flex-1 min-w-0"><span className="block truncate text-bark-600 dark:text-sand-100 font-medium sel">{t.text}</span>{t.cat&&<span className="text-xs text-bark-400/60 dark:text-sand-300/60">{CATS.find(c=>c.id===t.cat)?.e} {CATS.find(c=>c.id===t.cat)?.l}</span>}</div>
          {t.poms>0&&<span className="text-terracotta-400 text-sm font-semibold">üçÖ{t.poms}</span>}
          <button onClick={e=>{e.stopPropagation();setFocus(focus.filter(x=>x.id!==t.id));if(activeF===t.id)setActiveF(null);}} aria-label="Remove from focus queue" className="text-bark-400/40 hover:text-terracotta-400 transition-colors">‚Üê</button>
        </div>
      ))}
      {focus.length===0&&<Empty.Focus/>}
    </div>
  </>);

  return(
    <div className="space-y-5">
      <StickyHeader>
        <h2 className="text-lg md:text-xl font-bold text-bark-600 dark:text-sand-100 text-center">üéØ Focus</h2>
      </StickyHeader>
      <div data-testid="focus-content" className="md:flex md:gap-6 md:items-start">
        <div className="flex-1 min-w-0 space-y-4 md:space-y-4">
          <FocusTimer tSet={tSet} onComplete={handleTimerComplete} activeTaskId={activeF} activeTaskText={activeF?focus.find(t=>t.id===activeF)?.text:null} onTick={onTimerTick}/>
          <div className="grid grid-cols-3 gap-3 md:gap-2">{statsCards.map((s,i)=><div key={i} className="gcard rounded-2xl md:rounded-xl p-4 md:p-3 text-center"><div className={`text-2xl md:text-xl font-bold ${s.c}`}>{s.v}</div><div className="text-xs md:text-[11px] text-bark-400/60 dark:text-sand-300/60 font-medium">{s.i} {s.l}</div></div>)}</div>
        </div>
        <div className="flex-1 min-w-0 mt-5 md:mt-0">{renderQueue(desk)}</div>
      </div>
    </div>
  );
}

// ConfirmSection ‚Äî extracted from rLists() + rListContent() (v16.2 refactor Step 6)
function ConfirmSection({wide,desk,selMode,selSection,selIds,toggleSelId,enterSelMode,exitSelMode,setEdit}){
  const{lists,setLists,todos,selList,setSelList,doneList,doneTodo,saveItem,showT,setTab}=useApp();
  const{updateListName,deleteList}=useApp();
  const[newList,setNewList]=useState('');
  const[showNew,setShowNew]=useState(false);
  const[listMenu,setListMenu]=useState(null);
  const[editListId,setEditListId]=useState(null);
  const[editListName,setEditListName]=useState('');
  const[deleteConfirm,setDeleteConfirm]=useState(null);
  const handleUpdateListName=(listId,newName)=>{updateListName(listId,newName);setEditListId(null);setEditListName('');};
  const handleDeleteList=(listId)=>{deleteList(listId);setDeleteConfirm(null);};

  const rListContent=(cl,isSecondary)=>{
    if(!cl)return null;
    const secs=[...new Set(cl.items.map(i=>i.section)||[])];
    const linkedTask=todos.find(t=>t.linkedList===cl.id);
    const allDone=cl.items.length>0&&cl.items.every(i=>i.done);
    return(
      <div className="space-y-3">
        <div className="flex items-center justify-between px-1">
          <h3 className="font-bold text-bark-600 dark:text-sand-100 text-sm md:text-base truncate">{cl.name}</h3>
          <button onClick={()=>setEdit({type:'list',item:{},listId:cl.id})} className="p-1.5 rounded-lg bg-sage-400 text-white hover:bg-sage-500 transition-colors flex-shrink-0"><I.Plus s={16}/></button>
        </div>
        {linkedTask&&<div className={`p-2.5 rounded-xl flex items-center justify-between ${allDone?'bg-sage-100 dark:bg-sage-400/20 border border-sage-300 dark:border-sage-400/40':'gcard'}`}><div className="flex items-center gap-2 min-w-0"><span className="text-xs">üéØ</span><span className="text-sm font-medium text-bark-600 dark:text-sand-100 truncate">{linkedTask.text}</span></div>{allDone&&!linkedTask.done?<button onClick={()=>{doneTodo(linkedTask.id);showT('üéâ Task completed!');}} className="px-3 py-1 bg-sage-400 text-white rounded-lg text-xs font-bold flex-shrink-0 ml-2">‚úì Done</button>:<button onClick={()=>{setTab('todos');}} className="text-xs text-ocean-400 font-medium flex-shrink-0 ml-2">View ‚Üí</button>}</div>}
        {secs.length>0?secs.map(s=>(
          <div key={s} className="space-y-1.5">
            <h4 className="text-xs font-bold text-bark-400/60 dark:text-sand-300/50 uppercase tracking-wider px-2">{s}</h4>
            <div className="space-y-1.5">
            {cl.items.filter(i=>i.section===s).sort((a,b)=>(a.done?1:0)-(b.done?1:0)).map(item=>{
              const inSel=selMode&&selSection==='lists';
              const isSel=inSel&&selIds.has(item.id);
              return(
                <div key={item.id} className="gcard rounded-xl overflow-hidden transition-all duration-200">
                <div onClick={()=>{if(inSel)toggleSelId(item.id);else if(!selMode)doneList(cl.id,item.id);}} onContextMenu={e=>{e.preventDefault();setEdit({type:'list',item,listId:cl.id});}} className={`p-3 md:px-3 md:py-2 flex items-center gap-2 md:gap-2.5 cursor-pointer transition-colors ${item.done?'opacity-70':''} ${isSel?'ring-2 ring-sage-400 bg-sage-50 dark:bg-sage-400/10':'hover:bg-sand-50 dark:hover:bg-bark-600/50'}`}>
                  {inSel&&<SelCheck checked={isSel} onToggle={()=>toggleSelId(item.id)}/>}
                  {!inSel&&<button onClick={e=>{e.stopPropagation();doneList(cl.id,item.id);}} className={`w-6 h-6 md:w-5 md:h-5 rounded-full border-2 flex items-center justify-center transition-all flex-shrink-0 ${item.done?'bg-sage-400 border-sage-400':'border-bark-300 dark:border-sand-300 hover:border-sage-400'}`}>{item.done&&<span className="text-white text-sm md:text-xs">‚úì</span>}</button>}
                  <div className="flex-1 min-w-0">
                    <span className={`block font-medium sel md:text-sm ${item.done?'line-through text-bark-400/60':'text-bark-700 dark:text-cream-100'}`}>{item.text}</span>
                    {item.notes&&<p className="text-xs text-bark-500 dark:text-sand-300 mt-1 truncate sel">üìù {item.notes}</p>}
                  </div>
                  {!inSel&&<button onClick={e=>{e.stopPropagation();setEdit({type:'list',item,listId:cl.id});}} className="p-1.5 rounded-lg text-bark-600 dark:text-sand-200 hover:text-bark-700 dark:hover:text-white hover:bg-sand-200 dark:hover:bg-bark-500 transition-colors flex-shrink-0" aria-label="More options"><I.MoreV s={18}/></button>}
                </div>
              </div>
            );})}
            </div>
          </div>
        )):<Empty.List/>}
        <QuickAdd placeholder="Quick add item..." onAdd={text=>saveItem('list',{text},cl.id)}/>
      </div>
    );
  };

  if(lists.length>0&&!lists.find(l=>l.id===selList))setSelList(lists[0].id);
  const cl=lists.find(l=>l.id===selList);
  const otherLists=lists.filter(l=>l.id!==selList);
  const secondList=otherLists.length>0?otherLists[0]:null;

  if(lists.length===0){
    return(
      <div className="space-y-4">
        <StickyHeader>
          <div className="flex items-center justify-between mb-3">
            <h2 className="text-lg md:text-xl font-bold text-bark-600 dark:text-sand-100">‚úÖ Confirm</h2>
          </div>
        </StickyHeader>
        <Empty.NoLists onCreate={()=>setShowNew(true)}/>
        {showNew&&<div className="flex gap-2 mb-4"><input type="text" value={newList} onChange={e=>setNewList(e.target.value)} placeholder="Checklist name..." className="flex-1 gcard rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100" onKeyDown={e=>{if(e.key==='Enter'&&newList.trim()){const id=uid();setLists([...lists,{id,name:newList,items:[]}]);setSelList(id);setNewList('');setShowNew(false);}}}/><button onClick={()=>{if(newList.trim()){const id=uid();setLists([...lists,{id,name:newList,items:[]}]);setSelList(id);setNewList('');setShowNew(false);}}} className="px-4 py-2 bg-sage-400 rounded-xl text-white font-semibold">Add</button><button onClick={()=>setShowNew(false)} className="px-3 py-2 gcard rounded-xl text-bark-500" aria-label="Cancel">‚úï</button></div>}
      </div>
    );
  }

  return(
    <div className="space-y-4">
      <StickyHeader>
        <div className="flex items-center justify-between mb-3">
          {selMode&&selSection==='lists'?<div className="flex items-center justify-center relative w-full"><button onClick={exitSelMode} className="absolute left-0 px-3 py-1.5 bg-sand-200 dark:bg-bark-600 rounded-lg text-bark-600 dark:text-sand-100 text-sm font-semibold">‚úï Cancel</button><h2 className="text-lg md:text-xl font-bold text-sage-500">{selIds.size} selected</h2></div>:<>
          <div className="flex items-center justify-center relative w-full">
            {cl&&cl.items.length>0&&<button onClick={()=>enterSelMode('lists',null)} className="absolute left-0 w-7 h-7 rounded-md border-2 border-bark-300 dark:border-sand-300 flex items-center justify-center hover:border-sage-400 transition-colors" aria-label="Select items"><span className="sr-only">Select</span></button>}
            <h2 className="text-lg md:text-xl font-bold text-bark-600 dark:text-sand-100">‚úÖ Confirm</h2>
            <button onClick={()=>setEdit({type:'list',item:{},listId:selList})} aria-label="Add item to list" className="absolute right-0 p-2 rounded-xl bg-sage-400 text-white shadow-sm hover:bg-sage-500 transition-colors"><I.Plus s={20}/></button>
          </div></>}
        </div>
        {editListId?<div className="flex gap-2 mb-2"><input type="text" value={editListName} onChange={e=>setEditListName(e.target.value)} onKeyDown={e=>{if(e.key==='Enter')handleUpdateListName(editListId,editListName);if(e.key==='Escape'){setEditListId(null);setEditListName('');}}} autoFocus className="flex-1 gcard rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100" placeholder="Checklist name..."/><button onClick={()=>handleUpdateListName(editListId,editListName)} className="px-4 py-2 bg-sage-400 rounded-xl text-white font-semibold">Save</button><button onClick={()=>{setEditListId(null);setEditListName('');}} className="px-3 py-2 gcard rounded-xl text-bark-500" aria-label="Cancel">‚úï</button></div>:null}
        <div className="flex gap-2 overflow-x-auto pb-2 hide-sb">{lists.map(l=>{
          return <button key={l.id} onClick={()=>setSelList(l.id)} onContextMenu={e=>{e.preventDefault();const rect=e.currentTarget.getBoundingClientRect();setListMenu({list:l,x:rect.left,y:rect.bottom+5});}} className={`px-4 md:px-5 py-2 md:py-2.5 rounded-2xl whitespace-nowrap font-semibold transition-all flex items-center gap-2 md:text-base ${selList===l.id?'bg-sage-400 text-white soft-shadow':'bg-sand-100 dark:bg-bark-600 text-bark-600 dark:text-sand-100'}`}>{l.name}{l.items.length>0&&<span className={`px-2 py-0.5 rounded-full text-xs ${selList===l.id?'bg-white/30':'bg-sage-100 dark:bg-sage-400/30 text-sage-600 dark:text-sage-300'}`}>{l.items.filter(i=>!i.done).length}</span>}</button>;
        })}<button onClick={()=>setShowNew(true)} aria-label="Create new list" className="px-4 py-2 rounded-2xl bg-sand-100 dark:bg-bark-600 whitespace-nowrap text-bark-600 dark:text-sand-100 font-semibold"><I.Plus s={18} c="inline"/></button></div>
      </StickyHeader>
      {showNew&&<div className="flex gap-2 mb-4"><input type="text" value={newList} onChange={e=>setNewList(e.target.value)} placeholder="Checklist name..." className="flex-1 gcard rounded-xl px-4 py-2 focus:outline-none focus:ring-2 focus:ring-sage-400 text-bark-600 dark:text-sand-100" onKeyDown={e=>{if(e.key==='Enter'&&newList.trim()){const id=uid();setLists([...lists,{id,name:newList,items:[]}]);setSelList(id);setNewList('');setShowNew(false);}}}/><button onClick={()=>{if(newList.trim()){const id=uid();setLists([...lists,{id,name:newList,items:[]}]);setSelList(id);setNewList('');setShowNew(false);}}} className="px-4 py-2 bg-sage-400 rounded-xl text-white font-semibold">Add</button><button onClick={()=>setShowNew(false)} className="px-3 py-2 gcard rounded-xl text-bark-500" aria-label="Cancel">‚úï</button></div>}
      {cl&&<button onClick={()=>{let t=`üìã ${cl.name}\n${'‚îÄ'.repeat(20)}\n\n`;[...new Set(cl.items.map(i=>i.section))].forEach(s=>{t+=`„Äê${s}„Äë\n`;cl.items.filter(i=>i.section===s).forEach(i=>{t+=`${i.done?'‚úÖ':'‚òê'} ${i.text}\n`;});t+='\n';});if(navigator.share)navigator.share({title:cl.name,text:t}).catch(()=>{});else{navigator.clipboard.writeText(t);showT('üìã Copied!');}}} className="w-full py-2.5 gcard rounded-2xl text-ocean-400 text-sm font-semibold flex items-center justify-center gap-2 mb-4 md:hidden"><I.Share s={18}/>Share "{cl.name}"</button>}
      <div className="md:grid md:grid-cols-2 md:gap-6 md:items-start">
        <div>{rListContent(cl)}</div>
        {secondList&&<div className="hidden md:block">{rListContent(secondList,true)}</div>}
      </div>
      {listMenu&&<ContextMenu position={{x:listMenu.x,y:listMenu.y}} onClose={()=>setListMenu(null)} items={[{icon:<I.Edit s={18} c="text-ocean-400"/>,label:'Edit Name',onClick:()=>{setEditListId(listMenu.list.id);setEditListName(listMenu.list.name);}},{icon:<I.Trash s={18} c="text-terracotta-400"/>,label:'Delete Checklist',onClick:()=>setDeleteConfirm(listMenu.list),variant:'danger',borderTop:true}]}/>}
      {deleteConfirm&&<ConfirmDialog icon={lists.length===1?<I.Info s={32} c="text-ocean-400"/>:<I.Trash s={32} c="text-terracotta-400"/>} iconBg={lists.length===1?'bg-ocean-100 dark:bg-ocean-400/20':'bg-terracotta-100 dark:bg-terracotta-400/20'} title={lists.length===1?'Cannot Delete Last Checklist':`Delete "${deleteConfirm.name}"?`} message={lists.length===1?'You need at least one checklist. Create another first, then you can delete this one.':`This will permanently delete the checklist and all ${deleteConfirm.items.length} item${deleteConfirm.items.length!==1?'s':''} in it.`} confirmLabel="Delete" onConfirm={()=>handleDeleteList(deleteConfirm.id)} onCancel={()=>setDeleteConfirm(null)} variant={lists.length===1?'info':'danger'}/>}
    </div>
  );
}

// ReviewSection ‚Äî extracted from rReview() (v16.2 refactor Step 7)
function ReviewSection({wide}){
  const{todos,notes,focus,met,dHist,wkData}=useApp();
  const qc=QUADS.map(q=>({...q,n:todos.filter(t=>t.quad===q.id&&!t.done).length}));
  const cc=CATS.map(c=>({...c,n:todos.filter(t=>t.cat===c.id&&!t.done).length})).filter(c=>c.n>0);
  const active=todos.filter(t=>!t.done).length;
  const done=todos.filter(t=>t.done).length;
  const overdue=todos.filter(t=>!t.done&&t.deadline&&t.deadline<new Date().toISOString().split('T')[0]);
  const nWeek=notes.filter(n=>{const d=new Date(n.crAt||n.date);return Date.now()-d.getTime()<7*864e5;}).length;
  const struck=notes.filter(n=>n.struck).length;

  const ins=[];
  if(qc[0].n>5)ins.push({e:'üî•',t:'Overloaded',m:`${qc[0].n} urgent+important tasks. Delegate or schedule some.`});
  if(qc[3].n>3)ins.push({e:'üóë',t:'Clean up',m:`${qc[3].n} tasks in Eliminate. Review if still needed.`});
  if(overdue.length>0)ins.push({e:'‚è∞',t:`${overdue.length} overdue`,m:overdue.map(t=>t.text).slice(0,2).join(', ')+(overdue.length>2?'...':'')});
  if(focus.length===0&&active>0)ins.push({e:'üéØ',t:'Empty focus queue',m:'Pick 1‚Äì3 tasks to focus on today.'});
  if(focus.length>=4)ins.push({e:'üåø',t:'Focus queue full',m:'Finish current tasks before adding more.'});
  if(struck>3)ins.push({e:'üìù',t:'Struck notes',m:`${struck} struck notes. Clear or convert to tasks.`});
  if(nWeek>10)ins.push({e:'üí°',t:'Active capture',m:`${nWeek} notes this week. Promote the best to Clarify.`});
  if(done>0&&active>0)ins.push({e:'üìä',t:'Completion',m:`${done}/${done+active} (${Math.round(done/(done+active)*100)}%)`});
  if(met.w.p>0)ins.push({e:'üçÖ',t:`${met.w.p} pomodoros`,m:`${Math.floor(met.w.m/60)}h ${met.w.m%60}m deep focus this week.`});
  if(ins.length===0)ins.push({e:'‚ú®',t:'Looking good!',m:'No issues found. Keep it up.'});

  const sug=[];
  if(qc[1].n>0)sug.push(`Schedule time for ${qc[1].n} important task${qc[1].n>1?'s':''}`);
  if(overdue.length>0)sug.push('Reschedule or complete overdue tasks');
  if(active>10)sug.push('Eliminate low-value tasks to reduce overwhelm');
  if(focus.length<3&&active>0)sug.push('Add top priorities to Focus queue');
  if(struck>0)sug.push(`Convert or delete ${struck} struck notes`);

  const weekStats=<div className="section-card"><h3 className="font-bold text-bark-600 dark:text-sand-100 mb-3">This Week</h3><div className="grid grid-cols-3 gap-3 text-center"><div><div className="text-2xl font-bold text-terracotta-400">{met.w.p}</div><div className="text-xs text-bark-400/50 dark:text-sand-300/50">üçÖ Pomodoros</div></div><div><div className="text-2xl font-bold text-sage-500">{met.w.t}</div><div className="text-xs text-bark-400/50 dark:text-sand-300/50">‚úì Tasks</div></div><div><div className="text-2xl font-bold text-ocean-400">{Math.floor(met.w.m/60)}h{met.w.m%60>0?`${met.w.m%60}m`:''}</div><div className="text-xs text-bark-400/50 dark:text-sand-300/50">‚è± Focus</div></div></div></div>;
  const matrixCard=<div className="section-card"><h3 className="font-bold text-bark-600 dark:text-sand-100 mb-3">Matrix Overview</h3><div className="grid grid-cols-2 gap-2">{qc.map(q=><div key={q.id} className={`rounded-xl p-3 bg-gradient-to-r ${q.clr} ${q.dclr} border ${q.bdr} ${q.dbdr}`}><div className={`text-lg font-bold ${q.txt} ${q.dtxt}`}>{q.n}</div><div className="text-xs text-bark-500/70 dark:text-sand-300/50">{q.l}</div></div>)}</div>{cc.length>0&&<div className="flex flex-wrap gap-2 mt-3">{cc.map(c=><span key={c.id} className="px-2 py-1 rounded-full text-xs font-medium bg-sand-100 dark:bg-bark-600 text-bark-600 dark:text-sand-200">{c.e} {c.l}: {c.n}</span>)}</div>}</div>;
  const insightsCard=<div className="section-card"><h3 className="font-bold text-bark-600 dark:text-sand-100 mb-3">Insights</h3><div className="space-y-2">{ins.map((x,i)=><div key={i} className="flex items-start gap-3 p-3 rounded-xl bg-sand-50 dark:bg-bark-600/50"><span className="text-lg">{x.e}</span><div><div className="font-semibold text-sm text-bark-600 dark:text-sand-100">{x.t}</div><div className="text-xs text-bark-500 dark:text-sand-300">{x.m}</div></div></div>)}</div></div>;
  const actionsCard=sug.length>0?<div className="section-card"><h3 className="font-bold text-bark-600 dark:text-sand-100 mb-3">üí° Next Actions</h3><div className="space-y-2">{sug.map((s,i)=><div key={i} className="flex items-start gap-2 text-sm text-bark-600 dark:text-sand-100"><span className="text-sage-500 mt-0.5">‚Üí</span><span>{s}</span></div>)}</div></div>:null;

  return(
    <div className="space-y-4">
      <StickyHeader>
        <h2 className="text-lg md:text-xl font-bold text-bark-600 dark:text-sand-100 text-center">üìä Review</h2>
      </StickyHeader>
      <div data-testid="review-content" className="space-y-4 xl:grid xl:grid-cols-2 xl:gap-4 xl:space-y-0">
        <div className="space-y-4">{weekStats}<Chart data={wkData} label="Weekly Pomodoros üçÖ" clr="bg-terracotta-400"/>{matrixCard}</div>
        <div className="space-y-4"><Heatmap dHist={dHist} met={met}/>{insightsCard}{actionsCard}</div>
      </div>
    </div>
  );
}

// SettingsSection ‚Äî extracted from rMore() (v16.2 refactor Step 8)
function SettingsSection({desk}){
  const{theme,setTheme}=useContext(ThemeCtx);
  const{preset,setPreset,customT,setCustomT,showT}=useApp();
  const[moreSub,setMoreSub]=useState('settings');
  const[settExp,setSettExp]=useState({});
  const[helpExp,setHelpExp]=useState({});
  const[testRunnerComp,setTestRunnerComp]=useState(()=>peekTestRunner());
  const[isTestRunnerLoading,setIsTestRunnerLoading]=useState(false);
  const[testRunnerError,setTestRunnerError]=useState(null);
  const toggleHelp=(k)=>setHelpExp(s=>({...s,[k]:!s[k]}));
  const ensureTestRunnerLoaded=useCallback(async()=>{
    if(testRunnerComp||isTestRunnerLoading)return;
    setTestRunnerError(null);
    setIsTestRunnerLoading(true);
    try{
      const runner=await getTestRunner();
      setTestRunnerComp(()=>runner);
    }catch(err){
      setTestRunnerError(err&&err.message?err.message:'Failed to load test suite');
    }finally{
      setIsTestRunnerLoading(false);
    }
  },[testRunnerComp,isTestRunnerLoading]);
  const onMoreSubSelect=useCallback((id)=>{
    setMoreSub(id);
    if(id==='test')ensureTestRunnerLoaded();
  },[ensureTestRunnerLoaded]);

  const themeCard=<div className="section-card"><h3 className="font-bold mb-3 text-bark-600 dark:text-sand-100 flex items-center gap-2"><I.Sun s={20} c="text-terracotta-400"/>Theme</h3><div className="flex gap-2">{[{id:'light',i:<I.Sun s={18}/>,l:'Light'},{id:'dark',i:<I.Moon s={18}/>,l:'Dark'},{id:'system',i:<I.Phone s={18}/>,l:'System'}].map(t=><button key={t.id} onClick={()=>setTheme(t.id)} className={`flex-1 py-2.5 rounded-xl font-semibold transition-all flex items-center justify-center gap-1.5 ${theme===t.id?'bg-sage-400 text-white':'bg-sand-100 dark:bg-bark-600 text-bark-600 dark:text-sand-100'}`}>{t.i}{t.l}</button>)}</div></div>;
  const timerCard=<div className="section-card"><h3 className="font-bold mb-3 text-bark-600 dark:text-sand-100 flex items-center gap-2"><I.Focus s={20} c="text-sage-500"/>Timer Duration</h3><div className="space-y-2">{Object.entries(PRESETS).map(([k,p])=><button key={k} onClick={()=>setPreset(k)} className={`w-full py-3 rounded-xl font-semibold transition-all text-left px-4 ${preset===k?'bg-sage-400 text-white':'bg-sand-100 dark:bg-bark-600 text-bark-600 dark:text-sand-100'}`}>{p.l} ({p.work}/{p.shortBreak}/{p.longBreak})</button>)}</div>{preset==='custom'&&<div className="mt-4 space-y-3">{[{k:'work',l:'Focus (min)'},{k:'shortBreak',l:'Short Break'},{k:'longBreak',l:'Long Break'}].map(({k,l})=><div key={k} className="flex items-center justify-between"><span className="text-bark-500/70 dark:text-sand-300 font-medium">{l}</span><input type="number" min="1" max="120" value={customT[k]} onChange={e=>setCustomT({...customT,[k]:parseInt(e.target.value)||1})} className="w-20 bg-sand-100 dark:bg-bark-600 rounded-xl px-3 py-2 text-center text-bark-600 dark:text-sand-100 font-semibold"/></div>)}</div>}</div>;
  const dataCard=<div className="section-card"><h3 className="font-bold mb-3 text-bark-600 dark:text-sand-100">üíæ Data</h3><div className="space-y-2"><button onClick={async()=>{const data=await S.exp();dlFile(JSON.stringify(data,null,2),`backup-${new Date().toISOString().split('T')[0]}.json`,'application/json');showT('üíæ Saved!');}} className="w-full py-3 bg-ocean-100 text-ocean-400 rounded-xl font-semibold">üì§ Export Backup</button><label className="w-full py-3 bg-sage-100 text-sage-600 rounded-xl font-semibold flex items-center justify-center cursor-pointer">üì• Import Backup<input type="file" accept=".json" onChange={async e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=async ev=>{try{await S.imp(JSON.parse(ev.target.result));showT('‚úÖ Done!');setTimeout(()=>location.reload(),1000);}catch{showT('‚ùå Error');}};r.readAsText(f);}} className="hidden"/></label><button onClick={async()=>{if(confirm('Reset all data?')){await S.clr();location.reload();}}} className="w-full py-3 bg-terracotta-100 text-terracotta-500 rounded-xl font-semibold">üóë Reset All</button></div></div>;
  const installScopeNote=<div className="bg-sand-100 dark:bg-bark-600/50 rounded-xl p-3"><p className="text-xs text-bark-500 dark:text-sand-200 leading-relaxed"><span className="font-semibold text-bark-600 dark:text-sand-100">Note:</span> `file://` mode uses a limited blob service worker fallback. For reliable install and offline support, deploy on HTTPS with `manifest.json` and `sw.js`.</p></div>;
  const installCard=<div className="section-card"><h3 className="font-bold text-bark-600 dark:text-sand-100 mb-3">üì≤ Install as App</h3><div className="space-y-2"><div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-3"><span className="font-semibold text-bark-600 dark:text-sand-100">üçé iOS:</span><span className="text-sm text-bark-500 dark:text-sand-200 ml-2">Safari ‚Üí Share ‚Üí Add to Home Screen</span></div><div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-3"><span className="font-semibold text-bark-600 dark:text-sand-100">ü§ñ Android:</span><span className="text-sm text-bark-500 dark:text-sand-200 ml-2">Chrome ‚Üí ‚ãÆ ‚Üí Add to Home screen</span></div><div className="bg-lavender-50 dark:bg-bark-600/50 rounded-xl p-3"><span className="font-semibold text-bark-600 dark:text-sand-100">üíª Desktop:</span><span className="text-sm text-bark-500 dark:text-sand-200 ml-2">Chrome/Edge ‚Üí Install icon in URL bar</span></div>{installScopeNote}</div></div>;
  const deskModeCard=<div className="section-card"><h3 className="font-bold text-bark-600 dark:text-sand-100 mb-3">üñ•Ô∏è Desktop Mode</h3><p className="text-sm text-bark-500 dark:text-sand-200 mb-2">At 768px+ the app uses tablet layout. At 1280px+ a full desktop layout with sidebar.</p><div className="space-y-2"><div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-3"><h4 className="font-semibold text-bark-600 dark:text-sand-100 text-sm mb-1">Layouts</h4><ul className="text-xs text-bark-500 dark:text-sand-200 space-y-0.5"><li>‚Ä¢ Sidebar replaces bottom tab bar</li><li>‚Ä¢ Focus: timer + queue side-by-side</li><li>‚Ä¢ Clarify/Confirm: 2-column grids</li><li>‚Ä¢ Review: 2-column dashboard</li></ul></div><div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-3"><h4 className="font-semibold text-bark-600 dark:text-sand-100 text-sm mb-1">Interactions</h4><ul className="text-xs text-bark-500 dark:text-sand-200 space-y-0.5"><li>‚Ä¢ Right-click ‚Üí action menu on any item</li><li>‚Ä¢ Drag-and-drop in Focus Queue & matrix</li><li>‚Ä¢ Live timer countdown in Focus tab label</li></ul></div></div></div>;

  const helpSection=(key,title,content)=>(
    <div className="gcard rounded-2xl overflow-hidden">
      <button onClick={()=>!desk&&toggleHelp(key)} className={`w-full ${desk?'p-5':'p-4'} flex items-center justify-between text-left`}>
        <h3 className="text-xl font-bold text-bark-600 dark:text-sand-100">{title}</h3>
        {!desk&&(helpExp[key]?<I.Up s={16} c="text-bark-400 dark:text-sand-300"/>:<I.Down s={16} c="text-bark-400 dark:text-sand-300"/>)}
      </button>
      {(desk||helpExp[key])&&<div className={`${desk?'px-5 pb-5':'px-4 pb-4'}`}>{content}</div>}
    </div>
  );

  return(
    <div className="space-y-4">
      <div className="flex gap-2 md:gap-3 overflow-x-auto hide-sb">{[{id:'settings',l:'‚öôÔ∏è Settings'},{id:'help',l:'üìñ Explainer'},{id:'test',l:'üß™ Test'}].map(t=><button key={t.id} onClick={()=>onMoreSubSelect(t.id)} className={`px-4 md:px-5 py-2 md:py-2.5 rounded-2xl whitespace-nowrap font-semibold transition-all md:text-base more-sub-btn ${moreSub===t.id?'bg-sage-400 text-white soft-shadow':'gcard text-bark-600 dark:text-sand-100'}`}>{t.l}</button>)}</div>
      {moreSub==='settings'&&(
        desk?(
        <div className="flex gap-4">
          <div className="flex-1 min-w-0 space-y-4">{themeCard}{dataCard}{deskModeCard}</div>
          <div className="flex-1 min-w-0 space-y-4">{timerCard}{installCard}</div>
        </div>
        ):(
        <div className="space-y-4">
          {themeCard}{timerCard}{dataCard}
          <div className="gcard rounded-2xl overflow-hidden"><button onClick={()=>setSettExp(s=>({...s,pwa:!s.pwa}))} className="w-full p-4 flex items-center justify-between"><h3 className="font-bold text-bark-600 dark:text-sand-100">üì≤ Install as App</h3>{settExp.pwa?<I.Up s={16} c="text-bark-400 dark:text-sand-300"/>:<I.Down s={16} c="text-bark-400 dark:text-sand-300"/>}</button>{settExp.pwa&&<div className="px-4 pb-4 space-y-2"><div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-3"><span className="font-semibold text-bark-600 dark:text-sand-100">üçé iOS:</span><span className="text-sm text-bark-500 dark:text-sand-200 ml-2">Safari ‚Üí Share ‚Üí Add to Home Screen</span></div><div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-3"><span className="font-semibold text-bark-600 dark:text-sand-100">ü§ñ Android:</span><span className="text-sm text-bark-500 dark:text-sand-200 ml-2">Chrome ‚Üí ‚ãÆ ‚Üí Add to Home screen</span></div><div className="bg-lavender-50 dark:bg-bark-600/50 rounded-xl p-3"><span className="font-semibold text-bark-600 dark:text-sand-100">üíª Desktop:</span><span className="text-sm text-bark-500 dark:text-sand-200 ml-2">Chrome/Edge ‚Üí Install icon in URL bar</span></div>{installScopeNote}</div>}</div>
          <div className="gcard rounded-2xl overflow-hidden"><button onClick={()=>setSettExp(s=>({...s,desk:!s.desk}))} className="w-full p-4 flex items-center justify-between"><h3 className="font-bold text-bark-600 dark:text-sand-100">üñ•Ô∏è Desktop Mode</h3>{settExp.desk?<I.Up s={16} c="text-bark-400 dark:text-sand-300"/>:<I.Down s={16} c="text-bark-400 dark:text-sand-300"/>}</button>{settExp.desk&&<div className="px-4 pb-4 space-y-2"><p className="text-sm text-bark-500 dark:text-sand-200 mb-1">At 1280px+, the app uses a desktop-optimized layout.</p><div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-3"><h4 className="font-semibold text-bark-600 dark:text-sand-100 text-sm mb-1">Layouts</h4><ul className="text-xs text-bark-500 dark:text-sand-200 space-y-0.5"><li>‚Ä¢ Sidebar replaces bottom tab bar</li><li>‚Ä¢ Focus: timer + queue side-by-side</li><li>‚Ä¢ Clarify/Confirm: 2-column grids</li><li>‚Ä¢ Review: 2-column dashboard</li></ul></div><div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-3"><h4 className="font-semibold text-bark-600 dark:text-sand-100 text-sm mb-1">Interactions</h4><ul className="text-xs text-bark-500 dark:text-sand-200 space-y-0.5"><li>‚Ä¢ Right-click ‚Üí action menu on any item</li><li>‚Ä¢ Drag-and-drop in Focus Queue & matrix</li><li>‚Ä¢ Live timer countdown in Focus tab label</li></ul></div></div>}</div>
        </div>
        )
      )}
      {moreSub==='settings'&&<div className="text-center text-sm text-bark-400/60 dark:text-sand-300/50 pt-2"><p>Productivity Hub v{APP_VERSION}</p></div>}
      {moreSub==='help'&&(
        <div className={`pb-8 ${desk?'max-w-5xl mx-auto':''}`}>
          <div className="gcard rounded-2xl p-6 mb-6">
            <h2 className="text-2xl font-extrabold text-bark-600 dark:text-sand-100 mb-4">üìö Complete Guide</h2>
            <p className="text-bark-500 dark:text-sand-200">Productivity Hub combines the Bullet Journal method, GTD (Getting Things Done), Deep Work, and the Eisenhower Matrix into one seamless workflow.</p>
          </div>
          <div className={`${desk?'grid grid-cols-2 gap-5':'space-y-3'}`}>
          {helpSection('wf','üîÑ The Workflow',<>
            <p className="text-bark-500 dark:text-sand-200 mb-4">Every productivity system follows one cycle. Ours has five steps, each mapped to a tab:</p>
            <div className="space-y-3">
              <div className="bg-lavender-50 dark:bg-bark-600/50 rounded-xl p-4"><div className="flex items-start gap-3"><span className="text-2xl">üìù</span><div><div className="font-bold text-bark-600 dark:text-sand-100">1. Capture</div><div className="text-sm text-bark-500 dark:text-sand-200">Get everything out of your head. Jot quick bullet notes ‚Äî ideas, tasks, thoughts, anything. Don't organize yet, just capture. Tap to edit inline, use ‚ãÆ menu for actions (promote to Clarify, strikethrough, delete), or use the ‚òê header checkbox for bulk operations.</div></div></div></div>
              <div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-4"><div className="flex items-start gap-3"><span className="text-2xl">üìã</span><div><div className="font-bold text-bark-600 dark:text-sand-100">2. Clarify</div><div className="text-sm text-bark-500 dark:text-sand-200">Decide what each item means. Place tasks in the Eisenhower Matrix: Do First, Schedule, Delegate, or Eliminate. Add categories, deadlines, and subtasks. Drag tasks between quadrants to re-prioritize. Tap any task to toggle done/undone. Use ‚ãÆ menu or right-click (desktop) for actions: edit, add to Focus Queue, link a checklist, or delete.</div></div></div></div>
              <div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-4"><div className="flex items-start gap-3"><span className="text-2xl">üéØ</span><div><div className="font-bold text-bark-600 dark:text-sand-100">3. Focus</div><div className="text-sm text-bark-500 dark:text-sand-200">Pick 3‚Äì5 tasks for today's Focus Queue. Use the Pomodoro timer: 25 min work, 5 min break. After 4 cycles, take a longer break. On desktop, timer and queue display side-by-side. When the timer is running, a live countdown replaces the Focus tab label.</div></div></div></div>
              <div className="bg-terracotta-50 dark:bg-bark-600/50 rounded-xl p-4"><div className="flex items-start gap-3"><span className="text-2xl">‚úÖ</span><div><div className="font-bold text-bark-600 dark:text-sand-100">4. Confirm</div><div className="text-sm text-bark-500 dark:text-sand-200">Use checklists to break tasks into steps. Link a checklist to a Clarify task via ‚ãÆ menu ‚Üí Link Checklist. When all items are checked, you'll be prompted to mark the task done. Tap items to toggle done, use ‚ãÆ to edit or delete, and ‚òê header checkbox for bulk operations.</div></div></div></div>
              <div className="bg-sand-100 dark:bg-bark-600/50 rounded-xl p-4"><div className="flex items-start gap-3"><span className="text-2xl">üìä</span><div><div className="font-bold text-bark-600 dark:text-sand-100">5. Review</div><div className="text-sm text-bark-500 dark:text-sand-200">Check your weekly stats, matrix balance, and insights. The Review tab analyzes your patterns ‚Äî overloaded quadrants, overdue tasks, unprocessed notes ‚Äî and suggests next actions. On desktop, displays as a 2-column dashboard. Do this weekly.</div></div></div></div>
            </div>
          </>)}
          {helpSection('daily','üöÄ Daily Workflow',<div className="space-y-3">
              <div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Morning (5 min)</h4><ol className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>1. Open <strong>Capture</strong> ‚Äî jot anything on your mind</li><li>2. Go to <strong>Clarify</strong> ‚Äî review matrix, drag tasks to correct quadrants</li><li>3. Tap ‚Üí on 3‚Äì5 tasks to add them to <strong>Focus</strong> queue</li><li>4. Optionally check <strong>Confirm</strong> for any process checklists</li></ol></div>
              <div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Work Sessions (2‚Äì4 hours)</h4><ol className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>1. Open <strong>Focus</strong>, tap a task to activate it</li><li>2. Start Pomodoro ‚Äî 25 min of deep work</li><li>3. Take 5 min break, then repeat</li><li>4. After 4 pomodoros, take a 15 min long break</li><li>5. Quick-capture stray thoughts in <strong>Capture</strong> to stay focused</li></ol></div>
              <div className="bg-terracotta-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">End of Day (5 min)</h4><ol className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>1. Clear completed tasks (üßπ button in Clarify)</li><li>2. Process any unread <strong>Capture</strong> notes ‚Üí strikethrough or ‚Üí Clarify</li><li>3. Glance at <strong>Review</strong> for today's pomodoro count and streak</li><li>4. Set priorities for tomorrow in <strong>Clarify</strong></li></ol></div>
            </div>)}
          {helpSection('bj','üìì Bullet Journal Method',<>
            <p className="text-bark-500 dark:text-sand-200 mb-4">The Capture tab is inspired by Ryder Carroll's Bullet Journal ‚Äî a rapid logging system that clears your mind so you can focus.</p>
            <div className="space-y-3">
              <div className="bg-lavender-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Rapid Logging</h4><ul className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>‚Ä¢ <strong>Capture everything</strong> ‚Äî tasks, ideas, thoughts, questions</li><li>‚Ä¢ <strong>One bullet per thought</strong> ‚Äî keep it short and atomic</li><li>‚Ä¢ <strong>Press Enter</strong> to add instantly, no friction</li><li>‚Ä¢ <strong>Don't organize yet</strong> ‚Äî that's what Clarify is for</li></ul></div>
              <div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Migration (Processing Notes)</h4><ul className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>‚Ä¢ <strong>Tap:</strong> Edit a note inline ‚Äî refine its text instantly</li><li>‚Ä¢ <strong>‚ãÆ Menu:</strong> Tap the 3-dot icon for Edit, Promote to Clarify, Strikethrough, or Delete</li><li>‚Ä¢ <strong>Right-click (desktop):</strong> Opens the same action menu as ‚ãÆ</li><li>‚Ä¢ <strong>‚òê Checkbox (top-right):</strong> Enter selection mode for bulk actions ‚Äî Move to Clarify, Strikethrough, Delete</li><li>‚Ä¢ <strong>Auto-clear:</strong> Struck-through notes are automatically removed after 30 days</li></ul></div>
              <div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Day Sections</h4><p className="text-sm text-bark-500 dark:text-sand-200">Notes are automatically grouped by day ‚Äî Today, Yesterday, and past dates. This creates a natural timeline of your thinking, just like a physical journal.</p></div>
            </div>
          </>)}
          {helpSection('gtd','üìä GTD Weekly Review',<>
            <p className="text-bark-500 dark:text-sand-200 mb-4">David Allen's Getting Things Done weekly review is the "critical success factor" of the system. The Review tab makes this easy.</p>
            <div className="space-y-3">
              <div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Weekly Review Checklist</h4><ol className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>1. <strong>Get Clear</strong> ‚Äî Process all Capture notes (migrate or strike)</li><li>2. <strong>Get Current</strong> ‚Äî Review Clarify matrix, update or delete stale tasks</li><li>3. <strong>Get Creative</strong> ‚Äî Check Review insights, act on suggestions</li></ol></div>
              <div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">What the Review Tab Shows</h4><ul className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>‚Ä¢ <strong>Weekly stats:</strong> Pomodoros, tasks completed, focus time</li><li>‚Ä¢ <strong>Streak heatmap:</strong> GitHub-style 13-week grid ‚Äî darker = more pomodoros. Tap any day for details</li><li>‚Ä¢ <strong>Streak counter:</strong> Current consecutive active days and your longest streak</li><li>‚Ä¢ <strong>Matrix overview:</strong> How many active tasks in each quadrant</li><li>‚Ä¢ <strong>Insights:</strong> Overloaded quadrants, overdue tasks, unprocessed notes</li><li>‚Ä¢ <strong>Next actions:</strong> Specific suggestions based on your patterns</li></ul></div>
              <div className="bg-terracotta-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">The Review Loop</h4><p className="text-sm text-bark-500 dark:text-sand-200">Review closes the loop. Insights from Review feed back into Capture and Clarify ‚Äî tasks you need to add, priorities to shift, habits to change. This is what makes the system self-improving.</p></div>
            </div>
          </>)}
          {helpSection('pom','üçÖ Pomodoro Technique',<>
            <p className="text-bark-500 dark:text-sand-200 mb-4">The Pomodoro Technique breaks work into focused 25-minute intervals with breaks, preventing burnout and improving concentration.</p>
            <div className="space-y-3">
              <div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">How It Works</h4><ul className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>‚Ä¢ Work Session: 25 minutes of focused work</li><li>‚Ä¢ Short Break: 5 minutes to rest</li><li>‚Ä¢ Repeat 4 times</li><li>‚Ä¢ Long Break: 15 minutes after 4 cycles</li></ul></div>
              <div className="bg-ocean-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Using the Timer</h4><ol className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>1. Tap Focus tab</li><li>2. Tap a task from Focus Queue to activate it</li><li>3. Press Start for 25-minute session</li><li>4. Take break when timer ends</li><li>5. Customize durations in More ‚Üí Settings</li></ol></div>
            </div>
          </>)}
          {helpSection('dw','üéØ Deep Work & Focus Queue',<>
            <p className="text-bark-500 dark:text-sand-200 mb-4">Deep Work (Cal Newport) means sustained concentration on cognitively demanding tasks. Our Focus Queue limits you to 3-5 tasks to maximize focus.</p>
            <div className="space-y-3">
              <div className="bg-lavender-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Why Limit Tasks?</h4><ul className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>‚Ä¢ Forces prioritization of what truly matters</li><li>‚Ä¢ Reduces context-switching mental overhead</li><li>‚Ä¢ Prevents overwhelm and decision fatigue</li><li>‚Ä¢ Improves focus quality and depth</li></ul></div>
              <div className="bg-terracotta-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">Choose Your Limit</h4><p className="text-sm text-bark-500 dark:text-sand-200 mb-2"><strong>3 Tasks:</strong> For highly complex work, maximum focus, easily distracted</p><p className="text-sm text-bark-500 dark:text-sand-200"><strong>5 Tasks:</strong> For varied responsibilities, 8+ hour days, need flexibility</p></div>
            </div>
          </>)}
          {helpSection('matrix','üìä Urgent/Important Matrix',<>
            <p className="text-bark-500 dark:text-sand-200 mb-4">The Eisenhower Box helps categorize tasks by urgency and importance to focus on what truly matters.</p>
            <div className="grid grid-cols-2 gap-2 mb-4">
              <div className="bg-terracotta-100 dark:bg-terracotta-400/20 rounded-xl p-3"><div className="font-bold text-terracotta-600 dark:text-terracotta-300 mb-1">Q1: Do First</div><div className="text-xs text-bark-500 dark:text-sand-200">Urgent & Important</div><div className="text-xs text-bark-400 dark:text-sand-300 mt-1">Crises, deadlines</div></div>
              <div className="bg-sage-100 dark:bg-sage-400/20 rounded-xl p-3"><div className="font-bold text-sage-600 dark:text-sage-300 mb-1">Q2: Schedule</div><div className="text-xs text-bark-500 dark:text-sand-200">Not Urgent & Important</div><div className="text-xs text-bark-400 dark:text-sand-300 mt-1">Planning, prevention</div></div>
              <div className="bg-ocean-100 dark:bg-ocean-400/20 rounded-xl p-3"><div className="font-bold text-ocean-600 dark:text-ocean-300 mb-1">Q3: Delegate</div><div className="text-xs text-bark-500 dark:text-sand-200">Urgent & Not Important</div><div className="text-xs text-bark-400 dark:text-sand-300 mt-1">Interruptions, emails</div></div>
              <div className="bg-sand-200 dark:bg-bark-500/20 rounded-xl p-3"><div className="font-bold text-bark-600 dark:text-sand-200 mb-1">Q4: Eliminate</div><div className="text-xs text-bark-500 dark:text-sand-200">Not Urgent & Not Important</div><div className="text-xs text-bark-400 dark:text-sand-300 mt-1">Time wasters</div></div>
            </div>
            <div className="bg-sage-50 dark:bg-bark-600/50 rounded-xl p-4"><h4 className="font-bold text-bark-600 dark:text-sand-100 mb-2">In Productivity Hub</h4><ul className="space-y-1 text-sm text-bark-500 dark:text-sand-200"><li>‚Ä¢ <strong>Q1:</strong> High Priority, Due Today</li><li>‚Ä¢ <strong>Q2:</strong> Medium Priority, add to Focus Queue</li><li>‚Ä¢ <strong>Q3:</strong> Low Priority or Delegate</li><li>‚Ä¢ <strong>Q4:</strong> New tasks default here ‚Äî drag upward as priorities become clear</li></ul></div>
          </>)}
          </div>
          <div className="text-center text-sm text-bark-400 dark:text-sand-300 mt-6">
            <p>Tap <strong>? icon</strong> (top-right) for quick App Navigation reference</p>
          </div>
        </div>
      )}
      {moreSub==='test'&&(
        <>
          {isTestRunnerLoading&&<div className="section-card text-sm text-bark-500 dark:text-sand-200" data-testid="test-runner-loading">Loading test suite...</div>}
          {!isTestRunnerLoading&&testRunnerError&&<div className="section-card text-sm text-terracotta-500 dark:text-terracotta-300" data-testid="test-runner-error">App failed to load tests: {testRunnerError}</div>}
          {!isTestRunnerLoading&&testRunnerComp&&React.createElement(testRunnerComp,{onShowToast:showT})}
          {!isTestRunnerLoading&&!testRunnerComp&&!testRunnerError&&<div className="section-card text-sm text-bark-500 dark:text-sand-200" data-testid="test-runner-loading">Loading test suite...</div>}
          <div className="text-center pt-4"><span className="text-xs font-normal text-lavender-400 bg-lavender-100 dark:bg-lavender-400/20 px-3 py-1 rounded-full">v{APP_VERSION}</span></div>
        </>
      )}
    </div>
  );
}
window.PH_BLOCK_C=Object.freeze({
  useAppData,AppDataCtx,AppDataProv,useApp,
  CaptureSection,ClarifySection,FocusSection,ConfirmSection,ReviewSection,SettingsSection
});
})();
/* == END: Block C == */
</script>
<script type="text/babel">
/* == BEGIN: Block D == */
(()=>{
const PH_BLOCK_A_D=window.PH_BLOCK_A;
const PH_BLOCK_C_D=window.PH_BLOCK_C;
if(!PH_BLOCK_A_D||!PH_BLOCK_C_D)throw new Error('Block A/C exports missing. Cannot initialize Block D.');
const{
  useState,useEffect,useRef,useMemo,useCallback,createContext,useContext,
  APP_VERSION,initDB,S,uid,notify,reqNotifyPerm,PRESETS,QUADS,CATS,shareItem,genICS,dlFile,
  I,Empty,ThemeCtx,ThemeProv,useDesk,useWide,usePersistedState,useAnimatedClose,
  Subtasks,QuickAdd,SelCheck,BulkActionBar,ContextMenu,ConfirmDialog,StickyHeader,LinkPicker,EditModal,AboutModal
}=PH_BLOCK_A_D;
const{AppDataProv,useApp,CaptureSection,ClarifySection,FocusSection,ConfirmSection,ReviewSection,SettingsSection}=PH_BLOCK_C_D;
const STICKY_HEADER_TAB_IDS=new Set(['notes','todos','focus','lists','review']);
const STICKY_TAB_TOP_PAD_CLASS='pt-0 md:pt-0 xl:pt-0';
const MORE_TAB_TOP_PAD_CLASS='pt-4 md:pt-6 xl:pt-6';
const getMainContentTopPadClass=(tabId)=>STICKY_HEADER_TAB_IDS.has(tabId)?STICKY_TAB_TOP_PAD_CLASS:MORE_TAB_TOP_PAD_CLASS;
// Main App ‚Äî thin layout shell (sidebar/tab-bar + content area) (v16.2 refactor Step 9)
function App(){
  const desk=useDesk();
  const wide=useWide();
  const{lists,setLists,todos,setTodos,notes,setNotes,
    setFocus,setMet,
    toast,showT,toastFading,tab,setTab,selList,
    linkTask,unlinkTask,createAndLink,
    deleteListItem,saveItem,seedSampleData}=useApp();

  const[timerInfo,setTimerInfo]=useState({left:0,run:false,mode:'work'});
  const onTimerTick=useCallback((info)=>setTimerInfo(info),[]);
  useEffect(()=>{
    let cancelled=false;
    const syncFromStorage=async()=>{
      try{
        const st=await S.get('focusTimerState',null);
        if(cancelled||!st)return;
        if(st.run&&st.endAt){
          const left=Math.max(0,Math.ceil((st.endAt-Date.now())/1000));
          setTimerInfo({left,run:left>0,mode:st.mode||'work'});
          return;
        }
        if(!st.run)setTimerInfo(prev=>prev.run?{left:st.left||0,run:false,mode:st.mode||'work'}:prev);
      }catch{}
    };
    syncFromStorage();
    const id=setInterval(syncFromStorage,1000);
    return()=>{cancelled=true;clearInterval(id);};
  },[]);
  const fmtSidebar=s=>{const m=Math.floor(s/60),sec=s%60;return`${m}:${sec.toString().padStart(2,'0')}`;};
  const[showHelp,setShowHelp]=useState(false);
  const[seenAbout,setSeenAbout]=usePersistedState('seenAbout',false);
  const[showWelcome,setShowWelcome]=useState(false);
  const[seenChecked,setSeenChecked]=useState(false);
  useEffect(()=>{S.get('seenAbout',false).then(v=>{if(v===false)setShowWelcome(true);setSeenChecked(true);});},[]);

  const[edit,setEdit]=useState(null);
  const[selMode,setSelMode]=useState(false);
  const[selSection,setSelSection]=useState(null);
  const[selIds,setSelIds]=useState(new Set());
  const[bulkConfirm,setBulkConfirm]=useState(null);
  const exitSelMode=()=>{setSelMode(false);setSelSection(null);setSelIds(new Set());};
  const toggleSelId=(id)=>setSelIds(prev=>{const n=new Set(prev);if(n.has(id))n.delete(id);else n.add(id);return n;});
  const enterSelMode=(section,firstId)=>{setSelMode(true);setSelSection(section);setSelIds(firstId?new Set([firstId]):new Set());};
  const getAllIdsForSection=()=>{
    if(selSection==='todos')return todos.map(t=>t.id);
    if(selSection==='lists'){const cl=lists.find(l=>l.id===selList);return cl?cl.items.map(i=>i.id):[];}
    if(selSection==='notes')return notes.map(n=>n.id);
    return[];
  };
  const selectAll=()=>setSelIds(new Set(getAllIdsForSection()));
  const deselectAll=()=>setSelIds(new Set());
  const executeBulk=(action,sIds,sec)=>{
    const ids=[...sIds];const cnt=ids.length;
    if(sec==='todos'){
      if(action==='done'){setTodos(t=>t.map(x=>sIds.has(x.id)?{...x,done:true}:x));setFocus(f=>f.filter(x=>!sIds.has(x.id)));setMet(p=>({...p,d:{...p.d,t:p.d.t+cnt},w:{...p.w,t:p.w.t+cnt}}));showT(`‚úÖ ${cnt} task${cnt>1?'s':''} done`);}
      if(action==='delete'){setTodos(t=>t.filter(x=>!sIds.has(x.id)));setFocus(f=>f.filter(x=>!sIds.has(x.id)));showT(`üóë ${cnt} deleted`);}
    }else if(sec==='lists'){
      const lid=selList;
      if(action==='done'){setLists(ls=>ls.map(l=>l.id===lid?{...l,items:l.items.map(i=>sIds.has(i.id)?{...i,done:!i.done}:i)}:l));showT(`‚úÖ ${cnt} toggled`);}
      if(action==='delete'){setLists(ls=>ls.map(l=>l.id===lid?{...l,items:l.items.filter(i=>!sIds.has(i.id))}:l));showT(`üóë ${cnt} deleted`);}
    }else if(sec==='notes'){
      if(action==='delete'){setNotes(n=>n.filter(x=>!sIds.has(x.id)));showT(`üóë ${cnt} deleted`);}
      if(action==='strike'){setNotes(n=>n.map(x=>sIds.has(x.id)?{...x,struck:!x.struck}:x));showT(`${cnt} toggled`);}
      if(action==='clarify'){const toMove=notes.filter(x=>sIds.has(x.id));setTodos(t=>[...toMove.map(x=>({id:uid(),text:x.text||x.title||x.content,quad:'nn',poms:0,done:false})),...t]);setNotes(n=>n.map(x=>sIds.has(x.id)?{...x,struck:true,struckAt:Date.now()}:x));showT(`üìã ${cnt} copied to Clarify`);}
    }
    exitSelMode();
  };
  const bulkAction=(action)=>{
    if(selIds.size===0)return;
    if(action==='delete'&&selIds.size>=3){setBulkConfirm({ids:new Set(selIds),section:selSection});return;}
    executeBulk(action,selIds,selSection);
  };
  const confirmBulkDelete=()=>{if(bulkConfirm){executeBulk('delete',bulkConfirm.ids,bulkConfirm.section);setBulkConfirm(null);}};
  const cancelBulkDelete=()=>setBulkConfirm(null);
  const[linkPicker,setLinkPicker]=useState(null);
  const tabs=[{id:'notes',Ic:I.Notes,l:'Capture'},{id:'todos',Ic:I.Check,l:'Clarify'},{id:'focus',Ic:I.Focus,l:'Focus'},{id:'lists',Ic:I.List,l:'Confirm'},{id:'review',Ic:I.Review,l:'Review'},{id:'more',Ic:I.Settings,l:'More'}];
  const mainContentTopPadClass=getMainContentTopPadClass(tab);
  const bulkLabel=bulkConfirm?(bulkConfirm.section==='todos'?'task':bulkConfirm.section==='lists'?'item':'note'):null;
  const bulkCount=bulkConfirm?bulkConfirm.ids.size:0;

  return(
    <div className="min-h-screen xl:flex xl:h-screen xl:overflow-hidden">
      {/* ===== Sidebar (hidden below 1280px, visible above) ===== */}
      <div data-testid="sidebar-nav" className="hidden xl:flex xl:flex-col w-56 flex-shrink-0 glass border-r border-sand-200/50 dark:border-bark-500/30" style={{paddingTop:'max(12px, env(safe-area-inset-top))'}}>
        <div className="px-5 py-4 border-b border-sand-200/30 dark:border-bark-500/20">
          <h1 className="text-lg font-extrabold text-bark-600 dark:text-sand-100">Productivity Hub <span className="text-[10px] font-normal text-lavender-400 bg-lavender-100 dark:bg-lavender-400/20 px-1.5 py-0.5 rounded-full ml-1">Œ±</span></h1>
        </div>
        <nav className="flex-1 py-3 px-3 space-y-1 overflow-y-auto">
          {tabs.map(({id,Ic,l})=>{
            const isFR=id==='focus'&&timerInfo.run&&timerInfo.left>0&&tab!=='focus';
            return(
            <button key={id} onClick={()=>{setTab(id);if(selMode)exitSelMode();}} className={`w-full flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-semibold transition-all ${tab===id?'bg-sage-400/15 text-sage-600 dark:text-sage-300':'text-bark-500 dark:text-sand-300 hover:bg-sand-100 dark:hover:bg-bark-600/50'}`}>
              <Ic s={20}/>
              <span className="flex-1 text-left">{isFR?fmtSidebar(timerInfo.left):l}</span>
              {isFR&&<span className={`w-2 h-2 rounded-full flex-shrink-0 ${timerInfo.mode==='work'?'bg-sage-400':'bg-ocean-400'} animate-pulse`}/>}
            </button>
            );
          })}
        </nav>
        <div className="px-3 py-3 border-t border-sand-200/30 dark:border-bark-500/20">
          <button onClick={()=>setShowHelp(true)} className="w-full flex items-center gap-3 px-3 py-2 rounded-xl text-sm font-medium text-bark-400 dark:text-sand-300 hover:bg-sand-100 dark:hover:bg-bark-600/50 transition-colors"><I.Help s={18}/><span>Help</span></button>
        </div>
      </div>
      {/* ===== Main content area ===== */}
      <div className="flex-1 xl:overflow-y-auto">
        {/* Mobile/Tablet header (hidden at 1280px+) */}
        <div className="glass px-4 md:px-8 py-3 md:py-4 sticky top-0 z-20 flex items-center justify-between xl:hidden" style={{paddingTop:'max(12px, env(safe-area-inset-top))'}}>
          <div className="w-10 md:w-12"/>
          <h1 className="text-xl md:text-2xl font-extrabold text-center text-bark-600 dark:text-sand-100">Productivity Hub <span className="text-xs md:text-sm font-normal text-lavender-400 bg-lavender-100 dark:bg-lavender-400/20 px-2 py-0.5 rounded-full ml-1">Œ±</span></h1>
          <button onClick={()=>setShowHelp(true)} aria-label="Show help" className="w-10 h-10 md:w-12 md:h-12 flex items-center justify-center text-bark-400 dark:text-sand-300 hover:text-sage-500 transition-colors"><I.Help s={26}/></button>
        </div>
        <div data-testid="main-content-wrap" className={`px-4 md:px-8 xl:px-8 ${mainContentTopPadClass} pb-28 md:pb-32 xl:pb-6 max-w-lg md:max-w-5xl xl:max-w-none mx-auto`}>
          <div key={tab} className="anim-in" data-testid="tab-content">
            {tab==='focus'&&<div className="max-w-2xl mx-auto xl:max-w-none"><FocusSection wide={wide} desk={desk} onTimerTick={onTimerTick}/></div>}
            {tab==='lists'&&<ConfirmSection wide={wide} desk={desk} selMode={selMode} selSection={selSection} selIds={selIds} toggleSelId={toggleSelId} enterSelMode={enterSelMode} exitSelMode={exitSelMode} setEdit={setEdit}/>}
            {tab==='todos'&&<ClarifySection wide={wide} desk={desk} selMode={selMode} selSection={selSection} selIds={selIds} toggleSelId={toggleSelId} enterSelMode={enterSelMode} exitSelMode={exitSelMode} setEdit={setEdit} setLinkPicker={setLinkPicker}/>}
            {tab==='notes'&&<CaptureSection wide={wide} selMode={selMode} selSection={selSection} selIds={selIds} toggleSelId={toggleSelId} enterSelMode={enterSelMode} exitSelMode={exitSelMode}/>}
            {tab==='review'&&<ReviewSection wide={wide}/>}
            {tab==='more'&&<SettingsSection desk={desk}/>}
          </div>
        </div>
        {selMode&&<BulkActionBar count={selIds.size} section={selSection} allCount={getAllIdsForSection().length} onSelectAll={selectAll} onDeselectAll={deselectAll} onAction={bulkAction} onCancel={exitSelMode}/>}
      </div>
      {/* ===== Bottom tab bar (hidden at 1280px+) ===== */}
      <div data-testid="bottom-tab-bar" className="fixed bottom-0 left-0 right-0 glass border-t border-sand-200/50 dark:border-bark-500/30 xl:hidden" style={{paddingBottom:'max(16px, env(safe-area-inset-bottom))'}}>
        <div className="flex justify-around max-w-lg md:max-w-5xl mx-auto py-2 tab-bar-inner">
          {tabs.map(({id,Ic,l})=>{
            const isFR=id==='focus'&&timerInfo.run&&timerInfo.left>0&&tab!=='focus';
            return(
            <button key={id} onClick={()=>{setTab(id);if(selMode)exitSelMode();}} className={`flex-1 py-2 flex flex-col items-center gap-1 transition-all ${tab===id?'text-sage-500':'text-bark-400 dark:text-sand-200'}`}>
              <div className="relative"><Ic s={28}/>{isFR&&<span className={`absolute -top-0.5 -right-0.5 w-2 h-2 rounded-full ${timerInfo.mode==='work'?'bg-sage-400':'bg-ocean-400'} animate-pulse`}/>}</div>
              <span className={`text-xs font-bold ${tab===id?'':'opacity-70'}`}>{isFR?fmtSidebar(timerInfo.left):l}</span>
            </button>
            );
          })}
        </div>
      </div>
      {toast&&<div className="fixed top-20 left-4 right-4 z-50 flex justify-center toast-wrap"><div className={`gcard px-5 py-3 rounded-2xl anim-in text-bark-600 dark:text-sand-100 font-semibold transition-opacity duration-500 ${toastFading?'opacity-0':'opacity-100'}`}>{toast}</div></div>}
      {showHelp&&<AboutModal onClose={()=>setShowHelp(false)} isWelcome={false}/>}
      {showWelcome&&<AboutModal onClose={()=>{setShowWelcome(false);setSeenAbout(true);seedSampleData();}} isWelcome={true}/>}
      {edit&&<EditModal item={edit.item} type={edit.type} onSave={item=>saveItem(edit.type,item,edit.listId)} onClose={()=>setEdit(null)} onDelete={edit.type==='list'&&edit.item?.id?()=>{deleteListItem(edit.listId,edit.item.id);}:undefined}/>}
      {linkPicker&&<LinkPicker task={linkPicker} lists={lists} onLink={linkTask} onCreate={createAndLink} onUnlink={unlinkTask} onClose={()=>setLinkPicker(null)}/>}
      {bulkConfirm&&<ConfirmDialog icon={<I.Trash s={32} c="text-terracotta-400"/>} iconBg="bg-terracotta-100 dark:bg-terracotta-400/20" title={`Delete ${bulkCount} ${bulkLabel}${bulkCount!==1?'s':''}?`} message={`This will permanently delete ${bulkCount} ${bulkLabel}${bulkCount!==1?'s':''}. This action cannot be undone.`} confirmLabel={`Delete ${bulkCount}`} onConfirm={confirmBulkDelete} onCancel={cancelBulkDelete} variant="danger"/>}
    </div>
  );
}

class AppErrorBoundary extends React.Component{
  constructor(props){super(props);this.state={err:null};}
  static getDerivedStateFromError(err){return{err};}
  componentDidCatch(err){
    window.__PH_BOOT_FAIL&&window.__PH_BOOT_FAIL(`Render failed: ${err?.message||err}`);
  }
  render(){
    if(this.state.err){
      const msg=this.state.err?.message||String(this.state.err);
      return(
        <div style={{maxWidth:'760px',margin:'48px auto',padding:'20px',border:'1px solid #e5e7eb',borderRadius:'12px',background:'#fff',fontFamily:'Nunito,sans-serif',lineHeight:'1.5'}}>
          <h2 style={{margin:'0 0 8px'}}>App failed to render</h2>
          <p style={{margin:'0 0 8px'}}>A runtime error occurred while rendering React components.</p>
          <p style={{margin:0,color:'#b91c1c',fontFamily:'monospace',fontSize:'12px',whiteSpace:'pre-wrap'}}>{msg}</p>
        </div>
      );
    }
    return this.props.children;
  }
}
window.PH_BLOCK_D=Object.freeze({
  getMainContentTopPadClass,
  STICKY_TAB_TOP_PAD_CLASS,
  MORE_TAB_TOP_PAD_CLASS
});
try{
  ReactDOM.createRoot(document.getElementById('root')).render(
    <AppErrorBoundary>
      <ThemeProv><AppDataProv><App/></AppDataProv></ThemeProv>
    </AppErrorBoundary>
  );
}catch(err){
  window.__PH_BOOT_FAIL&&window.__PH_BOOT_FAIL(`Render bootstrap failed: ${err.message||err}`);
  throw err;
}
})();
/* == END: Block D == */
</script>
</body>
</html>
